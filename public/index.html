<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Attappadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 5px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for the timeline */
        .timeline-wrapper {
            position: relative;
        }
        .timeline-item {
            position: relative;
            padding-left: 2.5rem; /* Space for the line and dot */
            min-height: 4.5rem; /* 72px - Min height for positioning */
        }
        /* Static dot for each stop */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.25rem;
            top: 0.25rem;
            height: 0.75rem;
            width: 0.75rem;
            background-color: #dbeafe; /* blue-100 */
            border: 2px solid #93c5fd; /* blue-300 */
            border-radius: 9999px;
            z-index: 1;
        }
        /* Timeline connector line */
        .timeline-connector {
            position: absolute;
            left: 1.5625rem; /* Aligns with the center of the dot */
            top: 0.25rem;
            bottom: -0.25rem;
            width: 2px;
            background-color: #bfdbfe; /* blue-200 */
        }
        /* This rule hides the connector line for the last stop in the list */
        .timeline-item:last-of-type > .timeline-connector {
            display: none;
        }
        /* Style for passed stops */
        .timeline-item.passed::before {
             background-color: #3b82f6; /* blue-500 */
             border-color: #3b82f6;
        }
        .timeline-item.passed .timeline-connector {
            background-color: #3b82f6; /* blue-500 */
        }
        /* Stop Name Text Styling */
        .stop-name {
            color: #374151; /* gray-700 */
            font-weight: 500;
        }
         .timeline-item.passed .stop-name {
            color: #9ca3af; /* gray-400 */
        }
        /* Live dot icon style */
        .live-dot-icon {
            position: absolute;
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            background-color: #3b82f6;
            border-radius: 9999px;
            z-index: 10;
            transition: top 2s linear;
            left: calc(1.625rem - 0.5rem); /* Center the dot over the line */
            top: -0.25rem; /* Initial position adjustment */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        /* Edit Mode Button Styles */
        .edit-btn {
            background-color: #e5e7eb; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 0.375rem;
        }
        .delete-btn {
            background-color: #fecaca; color: #dc2626; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 0.375rem;
        }
        /* Custom message box for alerts */
        #message-box {
            transition: opacity 0.3s, transform 0.3s;
        }
        /* Sidebar Styles */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #sidebar.open {
            transform: translateX(0);
        }
        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .nav-link.active {
            background-color: #eff6ff; /* blue-50 */
            color: #2563eb; /* blue-600 */
            font-weight: 600;
        }
        .nav-link.active svg {
            color: #2563eb; /* blue-600 */
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center">

    <div class="w-full max-w-md bg-white min-h-screen shadow-lg">
        <!-- Header -->
        <header class="bg-white sticky top-0 z-20 p-4 border-b border-gray-200 text-center shadow-sm">
             <div class="flex justify-between items-center">
                 <div class="w-16">
                     <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-100">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                         </svg>
                     </button>
                 </div>
                 <div class="text-center">
                     <h1 class="text-xl font-bold text-gray-800">Digital Attappadi</h1>
                     <p class="text-xs text-gray-500">Makkal Raja Transport Corporation</p>
                     <p id="live-clock" class="text-xs text-gray-500 font-mono mt-1"></p>
                 </div>
                 <div class="w-16"></div> <!-- Spacer to keep title centered -->
             </div>
        </header>
        
        <div id="page-container">
            <!-- Home Page Content -->
            <div id="home-page">
                <!-- Search Bar -->
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" id="search-bar" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Search by bus name, origin, or destination...">
                    </div>
                </div>

                <!-- Bus Schedule List -->
                <main id="schedule-list" class="divide-y divide-gray-200">
                     <p id="status-message" class="p-8 text-center text-gray-500">Initializing...</p>
                </main>
                
                <div id="add-bus-container" class="p-4 hidden">
                     <button id="add-bus-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded">Add New Bus</button>
                </div>
            </div>

            <!-- About Page Content -->
            <div id="about-page" class="hidden p-6">
                <h2 class="text-xl font-bold mb-4">About Digital Attappadi</h2>
                <p class="text-gray-700 mb-4">
                    This application provides real-time bus schedule information for the Attappadi region, powered by Makkal Raja Transport Corporation. Our goal is to make travel easier and more predictable for residents and visitors alike.
                </p>
                <p class="text-gray-700">
                    You can track upcoming buses, view their routes, and get estimated arrival times for key locations. The schedule is updated in real-time to provide the most accurate information possible.
                </p>
            </div>

            <!-- Contact Page Content -->
            <div id="contact-page" class="hidden p-6">
                 <h2 class="text-xl font-bold mb-4">Contact Information</h2>
                 <div class="space-y-4 text-gray-700">
                     <p>For inquiries, feedback, or support, please reach out to us:</p>
                     <p><strong>Makkal Raja Transport Corporation</strong></p>
                     <p>Email: <a href="mailto:contact@makkalraja.com" class="text-blue-600 hover:underline">contact@makkalraja.com</a></p>
                     <p>Phone: +91 123 456 7890</p>
                     <p>Address: Bus Stand, Agali, Attappadi, Kerala</p>
                 </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-40">
        <div class="p-4 border-b flex items-center space-x-3">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
               <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
             </svg>
            <h2 class="text-base font-bold">Digital Attappadi</h2>
        </div>
        <nav class="p-2 space-y-1">
            <a href="#" data-page="home" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Bus Schedule</span>
            </a>
            <a href="#" data-page="about" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>About</span>
            </a>
            <a href="#" data-page="contact" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <span>Contact</span>
            </a>
            <div class="border-t my-2"></div>
            <a href="#" id="admin-nav-link" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span id="admin-link-text">Admin Login</span>
            </a>
        </nav>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">Edit Details</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="edit-form" class="space-y-4">
                        <!-- Form fields will be injected here -->
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-save" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                     <button id="modal-cancel" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-40 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Are you sure?</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirmation-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">
                        Close
                    </button>
                    <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        <p id="message-text"></p>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Canvas Environment Integration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'digital-attapadi-dev';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAKzzQ9QLz6J09B9MZxubTtsnMjAJ6u7zU",
            authDomain: "digital-attappadi.firebaseapp.com",
            projectId: "digital-attapadi",
            storageBucket: "digital-attappadi.appspot.com",
            messagingSenderId: "580499598706",
            appId: "1:580499598706:web:67aea3df47c453ee41c1eb",
            measurementId: "G-Z7TGEXE8GY"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Firebase Services ---
        let app, db, auth, analytics, busCollection;

        document.addEventListener('DOMContentLoaded', function() {
          try {
            // --- STATE ---
            let busData = [];
            const openDropdowns = new Set();
            let isAdmin = false;
            let currentUserId = null;
            let isAuthReady = false;
            let unsubscribeFromBuses = null;
            let modalResolve = null;
            let modalReject = null;
            let searchQuery = '';
            
            // --- DOM ELEMENTS ---
            const scheduleList = document.getElementById('schedule-list');
            const statusMessage = document.getElementById('status-message');
            const addBusContainer = document.getElementById('add-bus-container');
            const addBusBtn = document.getElementById('add-bus-btn');
            const searchBar = document.getElementById('search-bar');
            const menuBtn = document.getElementById('menu-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const pageContainer = document.getElementById('page-container');
            const liveClock = document.getElementById('live-clock');
            const adminNavLink = document.getElementById('admin-nav-link');
            const adminLinkText = document.getElementById('admin-link-text');
            
            // Modals
            const editModal = document.getElementById('edit-modal');
            const modalTitle = document.getElementById('modal-title');
            const editForm = document.getElementById('edit-form');
            const modalSaveBtn = document.getElementById('modal-save');
            const modalCancelBtn = document.getElementById('modal-cancel');
            
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            // --- DATA CONSTANTS ---
            const adminUsers = [
                { username: 'dhayaceoda', password: '90474470770', name: 'Dhaya(Thangakutty)' },
                { username: 'poonutty', password: '0313', name: 'Madhu(Poonutty)' }
            ];
            const predefinedBusNames = ['KSRTC', 'SPR', 'SRG', 'KMS', 'RPC', 'Abirami'];
            const predefinedOriginStops = ['Anaikkatty', 'Sholayur', 'Goolikkadavu Jn', 'Mannarkkad', 'Palakkad'];
            const predefinedDestinationStops = ['Anaikkatty', 'Goolikkadavu Jn', 'Mannarkkad', 'Palakkad'];
            const predefinedStops = ['Anaikatti', 'Kottathara', 'Agali Jn', 'Goolikkadavu Jn', 'Thavalam', 'Mukkali', 'Mannarkkad', 'Palakkad'];
            
            // --- HELPER FUNCTIONS ---
            const setStatus = (message, isError = false) => {
                if (statusMessage) {
                    statusMessage.textContent = message;
                    statusMessage.className = `p-8 text-center ${isError ? 'text-red-500' : 'text-gray-500'}`;
                    scheduleList.innerHTML = ''; // Clear list
                    scheduleList.appendChild(statusMessage);
                }
            };

            const parseTime = (timeString) => {
                const now = new Date();
                const [hours, minutes] = timeString.split(':');
                now.setHours(hours, minutes, 0, 0);
                return now;
            };

            const formatTime = (dateObject) => dateObject.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            const formatEta = (minutes, prefix = '') => {
                if (minutes <= 1) return 'Now';
                if (minutes < 60) return `${prefix}${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                if (remainingMinutes === 0) return `${prefix}${hours}h`;
                return `${prefix}${hours}h ${remainingMinutes}m`;
            };
            
            const to12Hour = (time24) => {
                let [hours, minutes] = time24.split(':');
                hours = parseInt(hours, 10);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                let hour12 = hours % 12;
                if (hour12 === 0) hour12 = 12;
                return { hour: hour12, minute: minutes, ampm: ampm };
            };

            const to24Hour = (hour, minute, ampm) => {
                hour = parseInt(hour, 10);
                minute = String(minute).padStart(2, '0');
                if (ampm.toUpperCase() === 'PM' && hour < 12) hour += 12;
                if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0;
                return `${String(hour).padStart(2, '0')}:${minute}`;
            };
            
            const showMessage = (message) => {
                messageText.textContent = message;
                messageBox.classList.remove('hidden', 'opacity-0', 'translate-y-2');
                setTimeout(() => {
                    messageBox.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => messageBox.classList.add('hidden'), 3000);
                }, 2000);
            };

            // --- PAGE NAVIGATION ---
            const showPage = (pageId) => {
                Array.from(pageContainer.children).forEach(page => {
                    page.classList.add('hidden');
                });
                document.getElementById(pageId).classList.remove('hidden');
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === pageId.replace('-page', '')) {
                        link.classList.add('active');
                    }
                });

                closeSidebar();
            };

            const openSidebar = () => {
                sidebar.classList.add('open');
                sidebarOverlay.classList.remove('hidden');
                sidebarOverlay.classList.add('opacity-100');
            };

            const closeSidebar = () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('opacity-100');
                sidebarOverlay.classList.add('hidden');
            };

            // --- AUTHENTICATION ---
            const checkAdminStatus = () => {
                isAdmin = localStorage.getItem('isAdmin') === 'true';
                renderAuthControls();
                updateAndRenderSchedule();
            };

            const login = async () => {
                closeSidebar();
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-gray-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" required></div>`;
                try {
                    const data = await showModal('Admin Login', formHtml, 'Login');
                    const user = adminUsers.find(u => u.username === data.username && u.password === data.password);
                    
                    if (user) {
                        localStorage.setItem('isAdmin', 'true');
                        localStorage.setItem('adminUser', user.name);
                        showMessage(`Admin mode enabled for ${user.name}.`);
                    } else {
                        localStorage.removeItem('isAdmin');
                        localStorage.removeItem('adminUser');
                        showMessage("Incorrect username or password.");
                    }
                    checkAdminStatus();
                } catch (error) {
                    console.log("Login modal cancelled.");
                }
            };

            const logout = () => {
                const adminName = localStorage.getItem('adminUser');
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminUser');
                showMessage(`Admin ${adminName || ''} logged out.`);
                openDropdowns.clear();
                checkAdminStatus();
                closeSidebar();
            };

            const renderAuthControls = () => {
                if (isAdmin) {
                    const adminName = localStorage.getItem('adminUser');
                    adminLinkText.textContent = `Logout (${adminName || 'Admin'})`;
                    adminNavLink.onclick = (e) => { e.preventDefault(); logout(); };
                } else {
                    adminLinkText.textContent = 'Admin Login';
                    adminNavLink.onclick = (e) => { e.preventDefault(); login(); };
                }
                addBusContainer.classList.toggle('hidden', !isAdmin);
            };

            const updateClock = () => {
                if (liveClock) {
                    const timeString = new Date().toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                    liveClock.textContent = `Live: ${timeString}`;
                }
            };

            // --- MODAL & DIALOG LOGIC (PROMISE-BASED) ---
            const handleModalSaveClick = () => {
                if (editForm.checkValidity()) {
                    const formData = new FormData(editForm);
                    let data = Object.fromEntries(formData.entries());
                    if(data.busNumber === 'custom') data.busNumber = data.custom_busNumber;
                    if(data.origin === 'custom') data.origin = data.custom_origin;
                    if(data.destination === 'custom') data.destination = data.custom_destination;
                    if(data.name === 'custom') data.name = data.custom_name;
                    
                    ['custom_busNumber', 'custom_origin', 'custom_destination', 'custom_name'].forEach(key => delete data[key]);
                    
                    if (modalResolve) modalResolve(data);
                    hideModal();
                } else {
                    editForm.reportValidity();
                }
            };
            
            const handleModalCancelClick = () => {
                if (modalReject) modalReject(new Error("Modal cancelled by user."));
                hideModal();
            };

            const showModal = (title, formHtml, saveButtonText = 'Save Changes') => {
                modalTitle.textContent = title;
                editForm.innerHTML = formHtml;
                modalSaveBtn.textContent = saveButtonText;
                
                modalSaveBtn.addEventListener('click', handleModalSaveClick);
                modalCancelBtn.addEventListener('click', handleModalCancelClick);
                
                editModal.classList.remove('hidden');
                
                const setupCustomSelectListener = (selectId, containerId) => {
                    const selectEl = editForm.querySelector(selectId);
                    const containerEl = editForm.querySelector(containerId);
                    if (selectEl) {
                        selectEl.onchange = () => {
                            const isCustom = selectEl.value === 'custom';
                            containerEl.classList.toggle('hidden', !isCustom);
                            containerEl.querySelector('input').required = isCustom;
                        };
                        if(selectEl.value === 'custom') selectEl.onchange();
                    }
                };

                setupCustomSelectListener('#bus-name-select', '#custom-bus-name-container');
                setupCustomSelectListener('#origin-select', '#custom-origin-container');
                setupCustomSelectListener('#destination-select', '#custom-destination-container');
                setupCustomSelectListener('#stop-name-select', '#custom-stop-name-container');

                return new Promise((resolve, reject) => {
                    modalResolve = resolve;
                    modalReject = reject;
                });
            };
            
            const hideModal = () => {
                editModal.classList.add('hidden');
                editForm.innerHTML = '';
                modalSaveBtn.removeEventListener('click', handleModalSaveClick);
                modalCancelBtn.removeEventListener('click', handleModalCancelClick);
                modalResolve = null;
                modalReject = null;
            };

            const showConfirmation = (message, onConfirm) => {
                confirmationMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                confirmActionBtn.onclick = () => {
                    onConfirm();
                    hideConfirmation();
                };
            };

            const hideConfirmation = () => {
                confirmationModal.classList.add('hidden');
                confirmActionBtn.onclick = null;
            };

            // --- FIRESTORE CRUD OPERATIONS ---
            const addSampleDataIfNeeded = async () => {
                if (busData.length > 0) return; // Don't add if data exists
                console.log("Database is empty. Adding sample bus routes.");
                const sampleBuses = [
                    {
                        busNumber: "KSRTC",
                        origin: "Palakkad",
                        destination: "Anaikkatty",
                        stops: [
                            { name: "Palakkad", scheduledTime: "08:00" },
                            { name: "Mannarkkad", scheduledTime: "09:00" },
                            { name: "Goolikkadavu Jn", scheduledTime: "10:00" },
                            { name: "Kottathara", scheduledTime: "10:30" },
                            { name: "Anaikatti", scheduledTime: "11:00" },
                        ]
                    },
                    {
                        busNumber: "SPR",
                        origin: "Anaikkatty",
                        destination: "Mannarkkad",
                        stops: [
                            { name: "Anaikatti", scheduledTime: "13:00" },
                            { name: "Agali Jn", scheduledTime: "13:30" },
                            { name: "Goolikkadavu Jn", scheduledTime: "14:00" },
                            { name: "Mukkali", scheduledTime: "14:45" },
                            { name: "Mannarkkad", scheduledTime: "15:15" },
                        ]
                    },
                    {
                        busNumber: "SRG",
                        origin: "Mannarkkad",
                        destination: "Anaikkatty",
                        stops: [
                            { name: "Mannarkkad", scheduledTime: "17:30" },
                            { name: "Mukkali", scheduledTime: "18:00" },
                            { name: "Goolikkadavu Jn", scheduledTime: "18:45" },
                            { name: "Agali Jn", scheduledTime: "19:15" },
                            { name: "Anaikatti", scheduledTime: "19:45" },
                        ]
                    }
                ];

                try {
                    for (const bus of sampleBuses) {
                        await addDoc(busCollection, bus);
                    }
                    showMessage("Added sample bus routes to get you started!");
                } catch (error) {
                    console.error("Error adding sample data:", error);
                    showMessage("Could not add sample data.");
                }
            };

            const handleAddBus = async () => {
                if (!isAuthReady || !busCollection) {
                    showMessage("Connecting to the database... Please try again in a moment.");
                    return;
                }
                const busNameOptions = predefinedBusNames.map(s => `<option value="${s}">${s}</option>`).join('');
                const originOptions = predefinedOriginStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const destinationOptions = predefinedDestinationStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-gray-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Bus Name</option>${busNameOptions}<option value="custom">Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Origin</option>${originOptions}<option value="custom">Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Destination</option>${destinationOptions}<option value="custom">Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Departure Time from Origin:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                `;
                try {
                    const data = await showModal('Add New Bus', formHtml);
                    const scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const firstStop = { name: data.origin, scheduledTime: scheduledTime };
                    const newBus = { 
                        busNumber: data.busNumber, origin: data.origin, destination: data.destination,
                        stops: [firstStop]
                    };
                    await addDoc(busCollection, newBus);
                    showMessage("New bus route added successfully.");
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add bus operation cancelled.");
                    } else {
                        console.error("Error during add bus operation:", error);
                        showMessage(`Error: Could not add bus. ${error.message}`);
                    }
                }
            };

            const handleEditBus = async (busId) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                const bus = busData.find(b => b.id === busId);
                const busNameOptions = predefinedBusNames.map(s => `<option value="${s}" ${s === bus.busNumber ? 'selected' : ''}>${s}</option>`).join('');
                const originOptions = predefinedOriginStops.map(s => `<option value="${s}" ${s === bus.origin ? 'selected' : ''}>${s}</option>`).join('');
                const destinationOptions = predefinedDestinationStops.map(s => `<option value="${s}" ${s === bus.destination ? 'selected' : ''}>${s}</option>`).join('');
                const formHtml = `
                    <input type="hidden" name="id" value="${bus.id}">
                    <div><label class="block text-left text-sm font-medium text-gray-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded">${busNameOptions}<option value="custom">Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name" value="${predefinedBusNames.includes(bus.busNumber) ? '' : bus.busNumber}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded">${originOptions}<option value="custom">Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin" value="${predefinedOriginStops.includes(bus.origin) ? '' : bus.origin}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded">${destinationOptions}<option value="custom">Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination" value="${predefinedDestinationStops.includes(bus.destination) ? '' : bus.destination}"></div></div>
                `;
                try {
                    const data = await showModal('Edit Bus Route', formHtml);
                    const busDocRef = doc(db, busCollection.path, busId);
                    await updateDoc(busDocRef, {
                        busNumber: data.busNumber,
                        origin: data.origin,
                        destination: data.destination
                    });
                    showMessage("Bus details updated.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit bus operation cancelled.");
                    } else {
                        console.error("Error updating bus:", error);
                        showMessage(`Error: Could not update bus. ${error.message}`);
                    }
                }
            };

            const handleDeleteBus = (busId) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                showConfirmation("This will permanently delete the entire bus route and all its stops. This action cannot be undone.", async () => {
                    try {
                        await deleteDoc(doc(db, busCollection.path, busId));
                        showMessage("Bus route deleted.");
                    } catch(error) {
                        console.error("Error deleting bus:", error);
                        showMessage(`Error: Could not delete bus. ${error.message}`);
                    }
                });
            };
            
            const handleAddStop = async (busId) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                const bus = busData.find(b => b.id === busId);
                const stopOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-gray-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select a stop</option>${stopOptions}<option value="custom">Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>`;
                try {
                    const data = await showModal('Add Stop', formHtml);
                    data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const newStops = [...bus.stops, { name: data.name, scheduledTime: data.scheduledTime }];
                    newStops.sort((a, b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                    showMessage("Stop added to route.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add stop operation cancelled.");
                    } else {
                        console.error("Error adding stop:", error);
                        showMessage(`Error: Could not add stop. ${error.message}`);
                    }
                }
            };

            const handleEditStop = async (busId, stopIndex) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                const bus = busData.find(b => b.id === busId);
                const stop = bus.stops[stopIndex];
                const stopOptions = predefinedStops.map(s => `<option value="${s}" ${s === stop.name ? 'selected' : ''}>${s}</option>`).join('');
                const time12 = to12Hour(stop.scheduledTime);
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-gray-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required>${stopOptions}<option value="custom">Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name" value="${predefinedStops.includes(stop.name) ? '' : stop.name}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" value="${time12.hour}" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" value="${time12.minute}" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option ${time12.ampm === 'AM' ? 'selected' : ''}>AM</option><option ${time12.ampm === 'PM' ? 'selected' : ''}>PM</option></select></div></div>`;
                try {
                    const data = await showModal('Edit Stop', formHtml);
                    data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const newStops = [...bus.stops];
                    newStops[stopIndex] = { name: data.name, scheduledTime: data.scheduledTime };
                    newStops.sort((a,b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                    showMessage("Stop details updated.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit stop operation cancelled.");
                    } else {
                        console.error("Error updating stop:", error);
                        showMessage(`Error: Could not update stop. ${error.message}`);
                    }
                }
            };
            
            const handleDeleteStop = (busId, stopIndex) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                showConfirmation("This will remove the stop from the route. Are you sure?", async () => {
                    try {
                        const bus = busData.find(b => b.id === busId);
                        const newStops = [...bus.stops];
                        newStops.splice(stopIndex, 1);
                        await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                        showMessage("Stop removed from route.");
                    } catch(error) {
                        console.error("Error deleting stop:", error);
                        showMessage(`Error: Could not delete stop. ${error.message}`);
                    }
                });
            };

            // --- RENDER FUNCTIONS ---
            const renderSchedule = (data) => {
                scheduleList.innerHTML = ''; 
                
                const adminViewHidden = sessionStorage.getItem('adminViewHidden') === 'true';
                const showAdminControls = isAdmin && !adminViewHidden;

                if (data.length === 0) {
                    if (searchQuery) {
                        setStatus(`No results found for "${searchQuery}".`);
                    } else {
                        const message = isAdmin
                            ? "No buses found for today's schedule. Please add a bus in Admin mode."
                            : "No buses found for today's schedule.";
                        setStatus(message);
                    }
                    return;
                }
                
                data.forEach(bus => {
                    let arrivalText, arrivalColor, arrivalSize;

                    if (bus.etaAtGoolikkadavu === null) {
                        arrivalText = 'N/A';
                        arrivalColor = 'text-gray-500 font-semibold';
                        arrivalSize = 'text-sm';
                    } else if (bus.etaAtGoolikkadavu < 0) {
                        arrivalText = 'Departed';
                        arrivalColor = 'text-gray-500 font-semibold';
                        arrivalSize = 'text-xs';
                    } else {
                        arrivalText = formatEta(bus.etaAtGoolikkadavu);
                        arrivalColor = bus.etaAtGoolikkadavu <= 1 ? 'text-red-600 font-bold' : 'text-gray-900 font-semibold';
                        arrivalSize = 'text-sm';
                    }
                    
                    const isDropdownOpen = openDropdowns.has(bus.id);
                    const itemHeight = 72;
                    const liveIconTopPosition = bus.liveIconPositionIndex * itemHeight;

                    let stopsHtml = '';
                    bus.stops.forEach((stop, index) => {
                        const stopDepartureTime = parseTime(stop.scheduledTime);
                        const stopEta = Math.round((stopDepartureTime - new Date()) / 60000);
                        let stopArrivalText = `Scheduled ${formatEta(stopEta, 'in ')}`;
                        if(stopEta <=1 && stopEta >= 0) stopArrivalText = `Scheduled Now`;
                        else if (stopEta < 0) stopArrivalText = `Departed`;
                        
                        const isPassed = stopEta < 0;
                        const passedClass = isPassed ? 'passed' : '';
                        
                        const editButtons = showAdminControls ? `
                            <div class="flex items-center space-x-2">
                                <button class="edit-stop-btn edit-btn" data-bus-id="${bus.id}" data-stop-index="${index}">Edit</button>
                                <button class="delete-stop-btn delete-btn" data-bus-id="${bus.id}" data-stop-index="${index}">Del</button>
                            </div>
                        ` : `
                            <p class="text-sm font-medium text-gray-600">${formatTime(stopDepartureTime)}</p>
                        `;

                        stopsHtml += `
                            <div class="timeline-item ${passedClass}">
                                <div class="timeline-connector"></div>
                                <div class="flex justify-between items-start">
                                    <div><p class="stop-name">${stop.name}</p><p class="text-xs text-gray-500">${stopArrivalText}</p></div>
                                    ${editButtons}
                                </div>
                            </div>`;
                    });
                    
                    if (showAdminControls) {
                        stopsHtml += `<div class="pl-10 pt-2"><button class="add-stop-btn edit-btn" data-bus-id="${bus.id}">+ Add Stop</button></div>`;
                    }

                    const editBusButtons = showAdminControls ? `
                        <div class="absolute top-2 right-2 flex space-x-2">
                            <button class="edit-bus-btn edit-btn" data-bus-id="${bus.id}">Edit</button>
                            <button class="delete-bus-btn delete-btn" data-bus-id="${bus.id}">Del</button>
                        </div>
                    `: '';

                    const subtext = bus.etaAtGoolikkadavu === null 
                        ? `<span class="text-yellow-600"> - Add 'Goolikkadavu Jn' stop to track.</span>`
                        : `<span>- Schedule on time</span>`;

                    const listItem = document.createElement('div');
                    listItem.className = 'bus-item relative';
                    listItem.innerHTML = `
                        ${editBusButtons}
                        <div class="bus-header p-4 flex items-center cursor-pointer" data-bus-id="${bus.id}">
                            <span class="text-3xl mr-4"></span>
                            <div class="flex-grow">
                                 <div class="flex items-baseline mb-1"><p class="font-bold text-xs text-gray-800">${bus.busNumber}</p><p class="text-xs font-medium text-gray-600 ml-2"><span class="inline-block bg-gray-100 text-gray-800 px-2 py-0.5 rounded">${bus.origin} - ${bus.destination}</span></p></div>
                                 <div class="flex items-center space-x-1 text-xs text-gray-500">${subtext}</div>
                            </div>
                            <div class="text-right"><p class="${arrivalColor} ${arrivalSize}">${arrivalText}</p></div>
                        </div>
                        <div id="details-${bus.id}" class="bus-details px-4 pb-4 ${isDropdownOpen ? '' : 'hidden'}">
                            <div class="timeline-wrapper">
                                ${stopsHtml}
                                ${bus.stops.length > 0 ? `<span class="live-dot-icon" style="top: ${liveIconTopPosition}px;"></span>` : ''}
                            </div>
                        </div>`;
                    scheduleList.appendChild(listItem);
                });
            };

            const updateAndRenderSchedule = () => {
                if (!isAuthReady) return; 
                const currentTime = new Date();
                
                let liveBusData = busData.map(bus => {
                    if (!bus.stops || bus.stops.length === 0) {
                        return { ...bus, stops: [], etaAtGoolikkadavu: null, liveIconPositionIndex: 0 };
                    }
                    
                    const goolikkadavuStop = bus.stops.find(stop => stop.name === 'Goolikkadavu Jn');
                    
                    let etaAtGoolikkadavu = null;
                    if (goolikkadavuStop) {
                        const goolikkadavuArrivalTime = parseTime(goolikkadavuStop.scheduledTime);
                        etaAtGoolikkadavu = Math.round((goolikkadavuArrivalTime - currentTime) / 60000);
                    }

                    let liveIconPositionIndex = 0;
                    const nextStopIndex = bus.stops.findIndex(stop => parseTime(stop.scheduledTime) > currentTime);

                    if (nextStopIndex === -1) {
                        liveIconPositionIndex = bus.stops.length;
                    } else if (nextStopIndex > 0) {
                        const lastStop = bus.stops[nextStopIndex - 1];
                        const nextStop = bus.stops[nextStopIndex];
                        const lastStopTime = parseTime(lastStop.scheduledTime).getTime();
                        const nextStopTime = parseTime(nextStop.scheduledTime).getTime();
                        const segmentDuration = nextStopTime - lastStopTime;
                        if (segmentDuration > 0) {
                            const progressInSegment = (currentTime.getTime() - lastStopTime) / segmentDuration;
                            liveIconPositionIndex = (nextStopIndex - 1) + Math.min(1, Math.max(0, progressInSegment));
                        } else {
                            liveIconPositionIndex = nextStopIndex -1;
                        }
                    } else {
                         liveIconPositionIndex = 0;
                    }
                    
                    return { ...bus, etaAtGoolikkadavu, liveIconPositionIndex };
                });

                // Filter based on search query
                let filteredBusData = liveBusData;
                if (searchQuery) {
                    filteredBusData = liveBusData.filter(bus => {
                        const busName = bus.busNumber.toLowerCase();
                        const origin = bus.origin.toLowerCase();
                        const destination = bus.destination.toLowerCase();
                        return busName.includes(searchQuery) || origin.includes(searchQuery) || destination.includes(searchQuery);
                    });
                }
                
                // Sort the filtered data chronologically by departure time
                filteredBusData.sort((a, b) => {
                    const timeA = a.stops.length > 0 ? parseTime(a.stops[0].scheduledTime) : 0;
                    const timeB = b.stops.length > 0 ? parseTime(b.stops[0].scheduledTime) : 0;
                    
                    if (!timeA && !timeB) return 0;
                    if (!timeA) return 1;
                    if (!timeB) return -1;

                    return timeA - timeB;
                });
                
                renderSchedule(filteredBusData);
            };
            
            // --- EVENT LISTENERS ---
            confirmCancelBtn.addEventListener('click', hideConfirmation);
            addBusBtn.addEventListener('click', handleAddBus);
            searchBar.addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                updateAndRenderSchedule();
            });
            
            scheduleList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                const header = e.target.closest('.bus-header');

                if (button) {
                    const busId = button.dataset.busId;
                    const stopIndex = button.dataset.stopIndex;

                    if (button.matches('.edit-bus-btn')) handleEditBus(busId);
                    if (button.matches('.delete-bus-btn')) handleDeleteBus(busId);
                    if (button.matches('.edit-stop-btn')) handleEditStop(busId, parseInt(stopIndex, 10));
                    if (button.matches('.delete-stop-btn')) handleDeleteStop(busId, parseInt(stopIndex, 10));
                    if (button.matches('.add-stop-btn')) handleAddStop(busId);
                } else if (header) {
                    const busId = header.dataset.busId;
                    const details = document.getElementById(`details-${busId}`);
                    if (details) {
                        details.classList.toggle('hidden');
                        if (openDropdowns.has(busId)) {
                            openDropdowns.delete(busId);
                        } else {
                            openDropdowns.add(busId);
                        }
                    }
                }
            });

            menuBtn.addEventListener('click', openSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);
            sidebar.addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (navLink && navLink.id !== 'admin-nav-link') {
                    e.preventDefault();
                    showPage(navLink.dataset.page + '-page');
                }
            });

            // --- INITIALIZATION ---
            const init = () => {
                setStatus("Connecting to server...");
                app = initializeApp(firebaseConfig);
                analytics = getAnalytics(app);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                showPage('home-page'); // Show home page by default

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        currentUserId = user.uid;
                        isAuthReady = true;
                        setStatus("Connected. Loading schedule...");

                        busCollection = collection(db, 'artifacts', appId, 'public', 'data', 'buses');
                        if (unsubscribeFromBuses) unsubscribeFromBuses();

                        unsubscribeFromBuses = onSnapshot(busCollection, (snapshot) => {
                            busData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            // Ensure stops is always an array
                            busData.forEach(bus => {
                                if (!bus.stops) {
                                    bus.stops = [];
                                }
                            });
                            
                            if (snapshot.docs.length === 0) {
                                addSampleDataIfNeeded();
                            } else {
                                updateAndRenderSchedule();
                            }
                        }, (error) => {
                            console.error("Error fetching bus data:", error);
                            setStatus(`Error loading schedule. The database connection failed. Please check permissions and try again.`, true);
                        });

                    } else {
                        console.log("No user signed in, attempting to sign in...");
                        isAuthReady = false;
                        if (initialAuthToken) {
                            try {
                                console.log("Attempting to sign in with custom token...");
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (error) {
                                console.warn(`Custom token sign-in failed with code: ${error.code}. This can happen if the token is invalid or expired. The application will fall back to anonymous sign-in.`);
                                console.log("Falling back to anonymous sign-in.");
                                await signInAnonymously(auth);
                            }
                        } else {
                             console.log("No custom token found, signing in anonymously.");
                            await signInAnonymously(auth);
                        }
                    }
                });

                checkAdminStatus();
                setInterval(updateClock, 1000); // Update clock every second
                setInterval(updateAndRenderSchedule, 5000); // Update schedule every 5 seconds
            };

            init();
          } catch (error) {
              console.error("A critical error occurred in the script:", error);
              const statusMsg = document.getElementById('status-message');
              if(statusMsg) {
                  statusMsg.textContent = "A critical error occurred. Please check the console.";
                  statusMsg.className = "p-8 text-center text-red-500";
              }
          }
        });
    </script>

</body>
</html>
