<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Attappadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 5px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for the timeline */
        .timeline-wrapper {
            position: relative;
        }
        .timeline-item {
            position: relative;
            padding-left: 2.5rem; /* Space for the line and dot */
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        /* Static dot for each stop */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.25rem;
            top: 1rem;
            height: 0.75rem;
            width: 0.75rem;
            background-color: #dbeafe; /* blue-100 */
            border: 2px solid #93c5fd; /* blue-300 */
            border-radius: 9999px;
            z-index: 1;
        }
        /* Timeline connector line */
        .timeline-item:not(:last-of-type)::after {
            content: '';
            position: absolute;
            left: 1.5625rem; /* Aligns with the center of the dot */
            top: 1.5rem; /* Start below the dot */
            bottom: -1.5rem; /* Extend to the next dot */
            width: 2px;
            background-color: #bfdbfe; /* blue-200 */
        }
        
        /* Style for passed stops */
        .timeline-item.passed::before {
             background-color: #3b82f6; /* blue-500 */
             border-color: #3b82f6;
        }
        .timeline-item.passed:not(:last-of-type)::after {
            background-color: #3b82f6; /* blue-500 */
        }
        /* Stop Name Text Styling */
        .stop-name {
            color: #374151; /* gray-700 */
            font-weight: 500;
        }
         .timeline-item.passed .stop-name {
            color: #9ca3af; /* gray-400 */
        }
        /* Live dot icon style */
        .live-dot-icon {
            position: absolute;
            width: 1rem; /* 16px */
            height: 1rem; /* 16px */
            background-color: #3b82f6;
            border-radius: 9999px;
            z-index: 10;
            transition: top 2s linear;
            left: calc(1.625rem - 0.5rem); /* Center the dot over the line */
            top: -0.25rem; /* Initial position adjustment */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        /* Edit Mode Button Styles */
        .edit-btn {
            background-color: #e5e7eb; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 0.375rem;
        }
        .delete-btn {
            background-color: #fecaca; color: #dc2626; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 0.375rem;
        }
        /* Custom message box for alerts */
        #message-box {
            transition: opacity 0.3s, transform 0.3s;
        }
        /* Sidebar Styles */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #sidebar.open {
            transform: translateX(0);
        }
        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .nav-link.active {
            background-color: #eff6ff; /* blue-50 */
            color: #2563eb; /* blue-600 */
            font-weight: 600;
        }
        .nav-link.active svg {
            color: #2563eb; /* blue-600 */
        }
        .filter-option.active {
            background-color: #eff6ff;
            color: #2563eb;
            font-weight: 600;
        }
        .bus-item.watched > .bus-header {
            background-color: #eff6ff; /* Tailwind's blue-50 */
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Quill editor styles */
        #editor-container {
            height: 250px;
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center">

    <div class="w-full max-w-md bg-white min-h-screen shadow-lg">
        <!-- Header -->
        <header class="bg-white sticky top-0 z-20 p-4 border-b border-gray-200 text-center shadow-sm">
             <div class="flex justify-between items-center">
                 <div class="w-16">
                     <button id="menu-btn" class="p-2 rounded-full hover:bg-gray-100">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                         </svg>
                     </button>
                 </div>
                 <div class="text-center">
                     <h1 class="text-xl font-bold text-gray-800">Digital Attappadi</h1>
                     <p class="text-xs text-gray-500">Makkal Raja Transport Corporation</p>
                 </div>
                 <div class="w-16"></div> <!-- Spacer to keep title centered -->
             </div>
        </header>
        
        <div id="page-container">
            <!-- Home Page Content -->
            <div id="home-page">
                <!-- Search and Filter Bar -->
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <div class="flex items-center space-x-2">
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="text" id="search-bar" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Search by bus name or origin...">
                        </div>
                        <div class="relative">
                            <button id="filter-btn" class="p-2 border border-gray-300 rounded-md bg-white hover:bg-gray-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                </svg>
                            </button>
                            <div id="filter-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 py-1">
                                <!-- Filter options will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bus Schedule List -->
                <main id="schedule-list" class="divide-y divide-gray-200">
                     <div id="status-message" class="p-8 text-center text-gray-500">
                         <div class="flex justify-center items-center">
                             <div class="spinner h-8 w-8 border-4 border-gray-200 rounded-full"></div>
                             <span class="ml-3">Initializing...</span>
                         </div>
                     </div>
                </main>
                
                <div id="add-bus-container" class="p-4 hidden">
                     <button id="add-bus-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded">Add New Bus</button>
                </div>
            </div>

            <!-- Fare Calculator Page -->
            <div id="fare-calculator-page" class="hidden p-6">
                <h2 class="text-xl font-bold mb-4">Fare Calculator</h2>
                <div class="space-y-4">
                    <div>
                        <label for="fare-from-stop" class="block text-sm font-medium text-gray-700">From</label>
                        <select id="fare-from-stop" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="fare-to-stop" class="block text-sm font-medium text-gray-700">To</label>
                        <select id="fare-to-stop" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <button id="calculate-fare-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded">Calculate Fare</button>
                </div>
                <div id="fare-result-container" class="mt-6">
                    <!-- Fare results will be displayed here -->
                </div>
            </div>

            <!-- Manage Fares Page -->
            <div id="manage-fares-page" class="hidden p-6">
                <h2 class="text-xl font-bold mb-4">Manage Fares</h2>
                <div class="space-y-4">
                    <div>
                        <label for="manage-fares-bus-select" class="block text-sm font-medium text-gray-700">Select Bus Route</label>
                        <select id="manage-fares-bus-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div id="fare-overrides-container" class="space-y-2">
                        <!-- Fare override inputs will be displayed here -->
                    </div>
                     <button id="save-fares-btn" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded hidden">Save Fares</button>
                </div>
            </div>

            <!-- About Page Content -->
            <div id="about-page" class="hidden p-6">
                 <div id="about-content-container" class="prose">
                    <!-- About content will be dynamically inserted here -->
                 </div>
            </div>
            
            <!-- Manage About Page -->
            <div id="manage-about-page" class="hidden p-6">
                 <h2 class="text-xl font-bold mb-4">Manage About Page</h2>
                 <form id="about-form" class="space-y-4">
                     <div>
                       <label for="editor-container" class="block text-sm font-medium text-gray-700">Page Content</label>
                       <div id="editor-container" class="mt-1"></div>
                   </div>
                   <button id="save-about-btn" type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded">Save About Page</button>
                 </form>
            </div>


            <!-- Contact Page Content -->
            <div id="contact-page" class="hidden p-6">
                 <h2 class="text-xl font-bold mb-4">Contact Information</h2>
                 <div id="contact-info-container" class="space-y-4 text-gray-700">
                     <p>For inquiries, feedback, or support, please reach out to us:</p>
                     <p><strong>Makkal Raja Transport Corporation</strong></p>
                     <p>Email: <a href="mailto:contact@makkalraja.com" class="text-blue-600 hover:underline">contact@makkalraja.com</a></p>
                     <p>Phone: +91 123 456 7890</p>
                     <p>Address: Bus Stand, Agali, Attappadi, Kerala</p>
                 </div>
            </div>
            
            <!-- Manage Contact Page -->
            <div id="manage-contact-page" class="hidden p-6">
                 <h2 class="text-xl font-bold mb-4">Manage Contact Details</h2>
                 <form id="contact-form" class="space-y-4">
                   <div>
                       <label for="edit-contact-email" class="block text-sm font-medium text-gray-700">Email</label>
                       <input type="email" id="edit-contact-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                   </div>
                     <div>
                       <label for="edit-contact-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                       <input type="tel" id="edit-contact-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                   </div>
                     <div>
                       <label for="edit-contact-address" class="block text-sm font-medium text-gray-700">Address</label>
                       <textarea id="edit-contact-address" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required></textarea>
                   </div>
                   <button id="save-contact-btn" type="submit" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded">Save Contact Details</button>
                 </form>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-40">
        <div class="p-4 border-b flex items-center space-x-3">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
               <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
             </svg>
            <h2 class="text-base font-bold">Digital Attappadi</h2>
        </div>
        <nav id="sidebar-nav" class="p-2 space-y-1">
            <a href="#" data-page="home" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Bus Schedule</span>
            </a>
            <a href="#" data-page="fare-calculator" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3m6 0h-3m-3 6v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3" />
                </svg>
                <span>Fare Calculator</span>
            </a>
            <a href="#" data-page="about" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>About</span>
            </a>
            <a href="#" data-page="contact" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <span>Contact</span>
            </a>
            <div id="admin-menu-items">
                <!-- Admin-only items will be injected here -->
            </div>
        </nav>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">Edit Details</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="edit-form" class="space-y-4">
                        <!-- Form fields will be injected here -->
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-save" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                     <button id="modal-cancel" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-40 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Are you sure?</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirmation-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">
                        Close
                    </button>
                    <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stop Filter Modal -->
    <div id="stop-filter-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Select your Stop</h3>
                <div id="stop-filter-list" class="mt-4 max-h-80 overflow-y-auto">
                    <!-- Stop list will be injected here -->
                </div>
                <div class="items-center px-4 py-3">
                    <button id="stop-filter-cancel" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Stops Modal -->
    <div id="manage-stops-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Manage Filter Stops</h3>
                <div id="manage-stops-list" class="mt-4 max-h-60 overflow-y-auto divide-y">
                    <!-- Manageable stop list will be injected here -->
                </div>
                <div class="mt-4">
                    <select id="add-stop-select" class="w-full px-3 py-2 border rounded-md"></select>
                    <div id="custom-filter-stop-container" class="hidden mt-2">
                         <input type="text" id="custom-filter-stop-input" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name">
                    </div>
                    <button id="add-filter-stop-btn" class="mt-2 w-full bg-blue-500 text-white font-bold py-2 px-4 rounded">Add Stop to Filter</button>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="manage-stops-close-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        <p id="message-text"></p>
    </div>
    
    <!-- Quill Rich Text Editor JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // These variables are provided by the environment.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Firebase Services ---
        let app, db, auth, busCollection, filterStopsDocRef, contactDocRef, aboutDocRef;

        document.addEventListener('DOMContentLoaded', function() {
          try {
            // --- STATE ---
            let allBuses = [];
            let filterableStops = [];
            let watchedBuses = [];
            let notifiedBuses = [];
            const openDropdowns = new Set();
            let isAdmin = false;
            let currentUserId = null;
            let isAuthReady = false;
            let unsubscribeFromBuses = null;
            let unsubscribeFromFilters = null;
            let unsubscribeFromContact = null;
            let unsubscribeFromAbout = null;
            let modalResolve = null;
            let modalReject = null;
            let searchQuery = '';
            let currentFilter = 'all'; // 'all', 'live', or a stop name
            let pressTimer = null;
            let longPress = false;
            let quill = null;
            
            // --- DOM ELEMENTS ---
            const scheduleList = document.getElementById('schedule-list');
            const statusMessage = document.getElementById('status-message');
            const addBusContainer = document.getElementById('add-bus-container');
            const addBusBtn = document.getElementById('add-bus-btn');
            const searchBar = document.getElementById('search-bar');
            const menuBtn = document.getElementById('menu-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarNav = document.getElementById('sidebar-nav');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const pageContainer = document.getElementById('page-container');
            const adminMenuItems = document.getElementById('admin-menu-items');
            const filterBtn = document.getElementById('filter-btn');
            const filterDropdown = document.getElementById('filter-dropdown');
            const contactInfoContainer = document.getElementById('contact-info-container');
            const contactForm = document.getElementById('contact-form');
            const editContactEmail = document.getElementById('edit-contact-email');
            const editContactPhone = document.getElementById('edit-contact-phone');
            const editContactAddress = document.getElementById('edit-contact-address');
            const aboutContentContainer = document.getElementById('about-content-container');
            const aboutForm = document.getElementById('about-form');
            const fareFromStop = document.getElementById('fare-from-stop');
            const fareToStop = document.getElementById('fare-to-stop');
            const calculateFareBtn = document.getElementById('calculate-fare-btn');
            const fareResultContainer = document.getElementById('fare-result-container');
            const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
            const fareOverridesContainer = document.getElementById('fare-overrides-container');
            const saveFaresBtn = document.getElementById('save-fares-btn');
            
            // Modals
            const editModal = document.getElementById('edit-modal');
            const modalTitle = document.getElementById('modal-title');
            const editForm = document.getElementById('edit-form');
            const modalSaveBtn = document.getElementById('modal-save');
            const modalCancelBtn = document.getElementById('modal-cancel');
            
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            const stopFilterModal = document.getElementById('stop-filter-modal');
            const stopFilterList = document.getElementById('stop-filter-list');
            const stopFilterCancelBtn = document.getElementById('stop-filter-cancel');

            const manageStopsModal = document.getElementById('manage-stops-modal');
            const manageStopsList = document.getElementById('manage-stops-list');
            const addStopSelect = document.getElementById('add-stop-select');
            const addFilterStopBtn = document.getElementById('add-filter-stop-btn');
            const manageStopsCloseBtn = document.getElementById('manage-stops-close-btn');

            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            // --- DATA CONSTANTS ---
            const adminUsers = [
                { username: 'dhayaceoda', password: '90474470770', name: 'Dhaya(Thangakutty)' },
                { username: 'poonutty', password: '0313', name: 'Madhu(Poonutty)' }
            ];
            const predefinedBusNames = ['KSRTC', 'SPR', 'SRG', 'KMS', 'RPC', 'Abirami'];
            const predefinedOriginStops = ['Anaikkatty', 'Sholayur', 'Goolikkadavu Jn', 'Mannarkkad', 'Palakkad'];
            const predefinedDestinationStops = ['Anaikkatty', 'Goolikkadavu Jn', 'Mannarkkad', 'Palakkad'];
            const predefinedStops = ['Anaikatti', 'Kottathara', 'Agali Jn', 'Goolikkadavu Jn', 'Thavalam', 'Mukkali', 'Mannarkkad', 'Palakkad'];
            
            // --- HELPER FUNCTIONS ---
            const setStatus = (message, isError = false) => {
                if (statusMessage) {
                    statusMessage.innerHTML = `<p class="p-8 text-center ${isError ? 'text-red-500' : 'text-gray-500'}">${message}</p>`;
                }
            };

            const parseTime = (timeString) => {
                const now = new Date();
                const [hours, minutes] = timeString.split(':');
                now.setHours(hours, minutes, 0, 0);
                return now;
            };

            const formatTime = (dateObject) => dateObject.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            const formatEta = (minutes, prefix = '') => {
                if (minutes <= 1) return 'Now';
                if (minutes < 60) return `${prefix}${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                if (remainingMinutes === 0) return `${prefix}${hours}h`;
                return `${prefix}${hours}h ${remainingMinutes}m`;
            };
            
            const to12Hour = (time24) => {
                let [hours, minutes] = time24.split(':');
                hours = parseInt(hours, 10);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                let hour12 = hours % 12;
                if (hour12 === 0) hour12 = 12;
                return { hour: hour12, minute: minutes, ampm: ampm };
            };

            const to24Hour = (hour, minute, ampm) => {
                hour = parseInt(hour, 10);
                minute = String(minute).padStart(2, '0');
                if (ampm.toUpperCase() === 'PM' && hour < 12) hour += 12;
                if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0;
                return `${String(hour).padStart(2, '0')}:${minute}`;
            };
            
            const showMessage = (message) => {
                messageText.textContent = message;
                messageBox.classList.remove('hidden', 'opacity-0', 'translate-y-2');
                setTimeout(() => {
                    messageBox.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => messageBox.classList.add('hidden'), 3000);
                }, 2000);
            };

            // --- PAGE NAVIGATION ---
            const showPage = (pageId) => {
                Array.from(pageContainer.children).forEach(page => {
                    page.classList.add('hidden');
                });
                const newPage = document.getElementById(`${pageId}-page`);
                if(newPage) newPage.classList.remove('hidden');
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === pageId) {
                        link.classList.add('active');
                    }
                });

                if (pageId === 'manage-about' && !quill) {
                    quill = new Quill('#editor-container', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['link', 'clean']
                            ]
                        }
                    });
                     // Load existing content into Quill after initialization
                    getDoc(aboutDocRef).then(docSnap => {
                        if (docSnap.exists() && quill) {
                            quill.root.innerHTML = docSnap.data().html;
                        }
                    });
                } else if (pageId === 'fare-calculator') {
                    populateFareCalculatorStops();
                } else if (pageId === 'manage-fares') {
                    populateManageFaresBusSelect();
                }

                closeSidebar();
            };

            const openSidebar = () => {
                sidebar.classList.add('open');
                sidebarOverlay.classList.remove('hidden');
                sidebarOverlay.style.opacity = '1';
            };

            const closeSidebar = () => {
                sidebar.classList.remove('open');
                sidebarOverlay.style.opacity = '0';
                setTimeout(() => sidebarOverlay.classList.add('hidden'), 300);
            };

            // --- AUTHENTICATION ---
            const checkAdminStatus = () => {
                isAdmin = localStorage.getItem('isAdmin') === 'true';
                renderAuthControls();
                updateAndRenderSchedule();
            };

            const login = async () => {
                closeSidebar();
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-gray-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" required></div>`;
                try {
                    const data = await showModal('Admin Login', formHtml, 'Login');
                    const user = adminUsers.find(u => u.username === data.username && u.password === data.password);
                    
                    if (user) {
                        localStorage.setItem('isAdmin', 'true');
                        localStorage.setItem('adminUser', user.name);
                        showMessage(`Admin mode enabled for ${user.name}.`);
                        checkAdminStatus();
                    } else {
                        showMessage("Incorrect username or password.");
                    }
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Admin login cancelled.");
                    } else {
                        console.error("Login error:", error);
                    }
                }
            };

            const logout = () => {
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminUser');
                showMessage(`Admin logged out.`);
                openDropdowns.clear();
                checkAdminStatus();
                closeSidebar();
            };

            const renderAuthControls = () => {
                adminMenuItems.innerHTML = ''; // Clear previous items
                if (isAdmin) {
                    const adminName = localStorage.getItem('adminUser');
                    adminMenuItems.innerHTML = `
                        <div class="border-t my-2"></div>
                         <a href="#" data-page="manage-fares" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3m6 0h-3m-3 6v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3" /></svg>
                            <span>Manage Fares</span>
                        </a>
                         <a href="#" data-page="manage-about" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span>Manage About</span>
                        </a>
                        <a href="#" data-page="manage-contact" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h2m4 0h-4m4 0l-4-4m4 4l4 4" /></svg>
                            <span>Manage Contact</span>
                        </a>
                        <a href="#" id="manage-stops-link" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            <span>Manage Stops</span>
                        </a>
                        <div class="border-t my-2"></div>
                        <a href="#" id="admin-logout-link" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            <span>Logout (${adminName || 'Admin'})</span>
                        </a>
                    `;
                    document.getElementById('admin-logout-link').addEventListener('click', logout);
                    document.getElementById('manage-stops-link').addEventListener('click', showManageStopsModal);
                } else {
                    adminMenuItems.innerHTML = `
                        <div class="border-t my-2"></div>
                        <a href="#" id="admin-login-link" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            <span>Admin Login</span>
                        </a>
                    `;
                    document.getElementById('admin-login-link').addEventListener('click', login);
                }
                addBusContainer.classList.toggle('hidden', !isAdmin);
            };

            // --- MODAL & DIALOG LOGIC ---
            const handleModalSaveClick = () => {
                if (editForm.checkValidity()) {
                    const formData = new FormData(editForm);
                    let data = Object.fromEntries(formData.entries());
                    if(data.busNumber === 'custom') data.busNumber = data.custom_busNumber;
                    if(data.origin === 'custom') data.origin = data.custom_origin;
                    if(data.destination === 'custom') data.destination = data.custom_destination;
                    if(data.name === 'custom') data.name = data.custom_name;
                    
                    ['custom_busNumber', 'custom_origin', 'custom_destination', 'custom_name'].forEach(key => delete data[key]);
                    
                    if (modalResolve) modalResolve(data);
                    hideModal();
                } else {
                    editForm.reportValidity();
                }
            };
            
            const handleModalCancelClick = () => {
                if (modalReject) modalReject(new Error("Modal cancelled by user."));
                hideModal();
            };

            const showModal = (title, formHtml, saveButtonText = 'Save Changes') => {
                modalTitle.textContent = title;
                editForm.innerHTML = formHtml;
                modalSaveBtn.textContent = saveButtonText;
                
                modalSaveBtn.addEventListener('click', handleModalSaveClick);
                modalCancelBtn.addEventListener('click', handleModalCancelClick);
                
                editModal.classList.remove('hidden');
                
                const setupCustomSelectListener = (selectId, containerId) => {
                    const selectEl = editForm.querySelector(selectId);
                    const containerEl = editForm.querySelector(containerId);
                    if (selectEl && containerEl) {
                        selectEl.onchange = () => {
                            const isCustom = selectEl.value === 'custom';
                            containerEl.classList.toggle('hidden', !isCustom);
                            const input = containerEl.querySelector('input');
                            if (input) input.required = isCustom;
                        };
                        // Trigger on load if a custom value was pre-filled
                        if (selectEl.value && ![...selectEl.options].some(o => o.value === selectEl.value)) {
                           selectEl.value = 'custom';
                        }
                        selectEl.onchange();
                    }
                };

                setupCustomSelectListener('#bus-name-select', '#custom-bus-name-container');
                setupCustomSelectListener('#origin-select', '#custom-origin-container');
                setupCustomSelectListener('#destination-select', '#custom-destination-container');
                setupCustomSelectListener('#stop-name-select', '#custom-stop-name-container');

                // Specific listener for status modal
                const statusTypeSelect = editForm.querySelector('#status-type');
                if (statusTypeSelect) {
                    statusTypeSelect.onchange = () => {
                        const statusContainer = editForm.querySelector('#status-minutes-container');
                        if(statusContainer) {
                            statusContainer.classList.toggle('hidden', statusTypeSelect.value === 'on-time');
                        }
                    };
                    statusTypeSelect.onchange(); // Initial check
                }

                return new Promise((resolve, reject) => {
                    modalResolve = resolve;
                    modalReject = reject;
                });
            };
            
            const hideModal = () => {
                editModal.classList.add('hidden');
                editForm.innerHTML = '';
                modalSaveBtn.removeEventListener('click', handleModalSaveClick);
                modalCancelBtn.removeEventListener('click', handleModalCancelClick);
                modalResolve = null;
                modalReject = null;
            };

            const showConfirmation = (message, onConfirm) => {
                confirmationMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                confirmActionBtn.onclick = () => {
                    onConfirm();
                    hideConfirmation();
                };
            };

            const hideConfirmation = () => {
                confirmationModal.classList.add('hidden');
                confirmActionBtn.onclick = null;
            };

            const showStopFilterModal = () => {
                stopFilterList.innerHTML = filterableStops.map(stop => 
                    `<a href="#" data-filter="${stop}" class="filter-option ${currentFilter === stop ? 'active' : ''} block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">${stop}</a>`
                ).join('');
                stopFilterModal.classList.remove('hidden');
            };

            const hideStopFilterModal = () => {
                stopFilterModal.classList.add('hidden');
            };

            const showManageStopsModal = () => {
                closeSidebar();
                manageStopsList.innerHTML = filterableStops.map(stop => `
                    <div class="flex justify-between items-center p-2">
                        <span>${stop}</span>
                        <button data-stop-name="${stop}" class="remove-filter-stop-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `).join('');

                const allStops = new Set(predefinedStops);
                allBuses.forEach(bus => {
                    if (bus.stops) {
                        bus.stops.forEach(stop => allStops.add(stop.name))
                    }
                });
                const availableStops = [...allStops].filter(s => !filterableStops.includes(s)).sort();
                
                addStopSelect.innerHTML = availableStops.map(stop => `<option value="${stop}">${stop}</option>`).join('') + '<option value="custom">Other...</option>';
                
                const customContainer = document.getElementById('custom-filter-stop-container');
                const customInput = document.getElementById('custom-filter-stop-input');
                
                addStopSelect.onchange = () => {
                    if (addStopSelect.value === 'custom') {
                        customContainer.classList.remove('hidden');
                        customInput.focus();
                    } else {
                        customContainer.classList.add('hidden');
                    }
                };
                addStopSelect.onchange(); // Initial check

                manageStopsModal.classList.remove('hidden');
            };

            const hideManageStopsModal = () => {
                manageStopsModal.classList.add('hidden');
            };

            // --- FIRESTORE CRUD OPERATIONS ---
            const addSampleDataIfNeeded = async () => {
                if (!busCollection) return;
                const busSnapshot = await getDocs(busCollection);
                if (busSnapshot.empty) {
                    console.log("Database is empty. Adding sample bus routes.");
                    const sampleBuses = [
                        {
                            busNumber: "KSRTC",
                            origin: "Palakkad",
                            destination: "Anaikkatty",
                            seatCapacity: 48,
                            status: { type: 'on-time', minutes: 0 },
                            stops: [
                                { name: "Palakkad", scheduledTime: "08:00", fare: 0, waitingTime: 0 },
                                { name: "Mannarkkad", scheduledTime: "09:00", fare: 45, waitingTime: 5 },
                                { name: "Goolikkadavu Jn", scheduledTime: "10:00", fare: 45, waitingTime: 0 },
                                { name: "Kottathara", scheduledTime: "10:30", fare: 20, waitingTime: 0 },
                                { name: "Anaikatti", scheduledTime: "11:00", fare: 20, waitingTime: 0 },
                            ]
                        }
                    ];

                    try {
                        for (const bus of sampleBuses) {
                            await addDoc(busCollection, bus);
                        }
                    } catch (error) {
                        console.error("Error adding sample bus data:", error);
                    }
                }

                if (!aboutDocRef) return;
                const aboutSnapshot = await getDoc(aboutDocRef);
                if (!aboutSnapshot.exists()) {
                     console.log("About page content is empty. Adding default content.");
                     const defaultAboutContent = {
                        html: `<h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome to Digital Attappadi</h2>
                        <p class="text-gray-700 mb-4">
                            This platform is a community-driven initiative to provide reliable, real-time bus tracking for the Makkal Raja Transport Corporation. Our mission is to connect the vibrant communities of the Attappadi region by making travel simpler, more transparent, and predictable for everyone.
                        </p>
                        <p class="text-gray-700 mb-4">
                            With Digital Attappadi, you can effortlessly track live bus locations, view detailed routes with all the stops, and get accurate estimated arrival times (ETAs). Whether you're a daily commuter or a visitor exploring the beautiful landscapes of Attappadi, our goal is to ensure you have the most up-to-date information right at your fingertips.
                        </p>
                         <p class="text-gray-700">
                            We are continuously working to improve this service. Thank you for being a part of our community. We wish you a safe and pleasant journey!
                        </p>`
                     };
                     try {
                        await setDoc(aboutDocRef, defaultAboutContent);
                     } catch(error) {
                        console.error("Error adding default about content:", error);
                     }
                }
            };

            const handleAddBus = async () => {
                if (!isAuthReady || !busCollection) {
                    showMessage("Connecting to the database... Please try again in a moment.");
                    return;
                }
                const busNameOptions = predefinedBusNames.map(s => `<option value="${s}">${s}</option>`).join('');
                const originOptions = predefinedOriginStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const destinationOptions = predefinedDestinationStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-gray-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Bus Name</option>${busNameOptions}<option value="custom">Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48"></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Origin</option>${originOptions}<option value="custom">Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Destination</option>${destinationOptions}<option value="custom">Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Departure Time from Origin:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                `;
                try {
                    const data = await showModal('Add New Bus', formHtml);
                    const scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const firstStop = { name: data.origin, scheduledTime: scheduledTime, fare: 0, waitingTime: 0 };
                    const newBus = { 
                        busNumber: data.busNumber, 
                        origin: data.origin, 
                        destination: data.destination,
                        seatCapacity: Number(data.seatCapacity) || null,
                        stops: [firstStop],
                        status: { type: 'on-time', minutes: 0 }
                    };
                    await addDoc(busCollection, newBus);
                    showMessage("New bus route added successfully.");
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add bus operation cancelled.");
                    } else {
                        console.error("Error during add bus operation:", error);
                        showMessage(`Error: Could not add bus. ${error.message}`);
                    }
                }
            };

            const handleEditBus = async (busId) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                const bus = allBuses.find(b => b.id === busId);
                const isCustomBusName = !predefinedBusNames.includes(bus.busNumber);
                const isCustomOrigin = !predefinedOriginStops.includes(bus.origin);
                const isCustomDestination = !predefinedDestinationStops.includes(bus.destination);

                const busNameOptions = predefinedBusNames.map(s => `<option value="${s}" ${!isCustomBusName && s === bus.busNumber ? 'selected' : ''}>${s}</option>`).join('');
                const originOptions = predefinedOriginStops.map(s => `<option value="${s}" ${!isCustomOrigin && s === bus.origin ? 'selected' : ''}>${s}</option>`).join('');
                const destinationOptions = predefinedDestinationStops.map(s => `<option value="${s}" ${!isCustomDestination && s === bus.destination ? 'selected' : ''}>${s}</option>`).join('');
                
                const formHtml = `
                    <input type="hidden" name="id" value="${bus.id}">
                    <div><label class="block text-left text-sm font-medium text-gray-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded">${busNameOptions}<option value="custom" ${isCustomBusName ? 'selected' : ''}>Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name" value="${isCustomBusName ? bus.busNumber : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48" value="${bus.seatCapacity || ''}"></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded">${originOptions}<option value="custom" ${isCustomOrigin ? 'selected' : ''}>Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin" value="${isCustomOrigin ? bus.origin : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded">${destinationOptions}<option value="custom" ${isCustomDestination ? 'selected' : ''}>Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination" value="${isCustomDestination ? bus.destination : ''}"></div></div>
                `;
                try {
                    const data = await showModal('Edit Bus Route', formHtml);
                    const busDocRef = doc(db, busCollection.path, busId);
                    await updateDoc(busDocRef, {
                        busNumber: data.busNumber,
                        origin: data.origin,
                        destination: data.destination,
                        seatCapacity: Number(data.seatCapacity) || null
                    });
                    showMessage("Bus details updated.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit bus operation cancelled.");
                    } else {
                        console.error("Error updating bus:", error);
                        showMessage(`Error: Could not update bus. ${error.message}`);
                    }
                }
            };

            const handleDeleteBus = (busId) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                showConfirmation("This will permanently delete the entire bus route and all its stops. This action cannot be undone.", async () => {
                    try {
                        await deleteDoc(doc(db, busCollection.path, busId));
                        showMessage("Bus route deleted.");
                    } catch(error) {
                        console.error("Error deleting bus:", error);
                        showMessage(`Error: Could not delete bus. ${error.message}`);
                    }
                });
            };
            
            const handleAddStop = async (busId) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                const bus = allBuses.find(b => b.id === busId);
                const stopOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-gray-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select a stop</option>${stopOptions}<option value="custom">Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Fare from Previous Stop ():</label><input type="number" name="fare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="0" required></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="0"></div>
                `;
                try {
                    const data = await showModal('Add Stop', formHtml);
                    data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const newStops = [...bus.stops, { name: data.name, scheduledTime: data.scheduledTime, fare: Number(data.fare) || 0, waitingTime: Number(data.waitingTime) || 0 }];
                    newStops.sort((a, b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                    showMessage("Stop added to route.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add stop operation cancelled.");
                    } else {
                        console.error("Error adding stop:", error);
                        showMessage(`Error: Could not add stop. ${error.message}`);
                    }
                }
            };

            const handleEditStop = async (busId, stopIndex) => {
                if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                const bus = allBuses.find(b => b.id === busId);
                const stop = bus.stops[stopIndex];
                const isCustomStop = !predefinedStops.includes(stop.name);
                const stopOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomStop && s === stop.name ? 'selected' : ''}>${s}</option>`).join('');
                const time12 = to12Hour(stop.scheduledTime);
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-gray-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required>${stopOptions}<option value="custom" ${isCustomStop ? 'selected' : ''}>Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name" value="${isCustomStop ? stop.name : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" value="${time12.hour}" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" value="${time12.minute}" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option ${time12.ampm === 'AM' ? 'selected' : ''}>AM</option><option ${time12.ampm === 'PM' ? 'selected' : ''}>PM</option></select></div></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Fare from Previous Stop ():</label><input type="number" name="fare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="${stop.fare || 0}" required></div>
                    <div><label class="block text-left text-sm font-medium text-gray-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="${stop.waitingTime || 0}"></div>
                `;
                try {
                    const data = await showModal('Edit Stop', formHtml);
                    data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const newStops = [...bus.stops];
                    newStops[stopIndex] = { ...newStops[stopIndex], name: data.name, scheduledTime: data.scheduledTime, fare: Number(data.fare) || 0, waitingTime: Number(data.waitingTime) || 0 };
                    newStops.sort((a,b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                    showMessage("Stop details updated.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit stop operation cancelled.");
                    } else {
                        console.error("Error updating stop:", error);
                        showMessage(`Error: Could not update stop. ${error.message}`);
                    }
                }
            };
            
            const handleDeleteStop = async (busId, stopIndex) => {
                 if (!isAuthReady) { showMessage("Not connected. Please wait."); return; }
                 showConfirmation("This will remove the stop from the route. Are you sure?", async () => {
                     try {
                         const bus = allBuses.find(b => b.id === busId);
                         const newStops = [...bus.stops];
                         newStops.splice(stopIndex, 1);
                         await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                         showMessage("Stop removed.");
                     } catch(error) {
                         console.error("Error deleting stop:", error);
                         showMessage(`Error: Could not delete stop. ${error.message}`);
                     }
                 });
            };

            const addFilterStop = async (stopName) => {
                if (!stopName) return;
                const newStops = [...new Set([...filterableStops, stopName])].sort();
                await setDoc(filterStopsDocRef, { stops: newStops });
                showMessage(`Added "${stopName}" to filters.`);
                showManageStopsModal(); // Refresh the modal
            };

            const removeFilterStop = async (stopName) => {
                const newStops = filterableStops.filter(s => s !== stopName);
                await setDoc(filterStopsDocRef, { stops: newStops });
                showMessage(`Removed "${stopName}" from filters.`);
                showManageStopsModal(); // Refresh the modal
            };

            const handleUpdateStatus = async (busId) => {
                const bus = allBuses.find(b => b.id === busId);
                const currentStatus = bus.status || { type: 'on-time', minutes: 0 };
                
                const formHtml = `
                    <div>
                        <label class="block text-left text-sm font-medium text-gray-700">Status</label>
                        <select id="status-type" name="type" class="mt-1 w-full px-3 py-2 border rounded">
                            <option value="on-time" ${currentStatus.type === 'on-time' ? 'selected' : ''}>On time</option>
                            <option value="late" ${currentStatus.type === 'late' ? 'selected' : ''}>Late</option>
                            <option value="early" ${currentStatus.type === 'early' ? 'selected' : ''}>Early</option>
                        </select>
                    </div>
                    <div id="status-minutes-container" class="${currentStatus.type === 'on-time' ? 'hidden' : ''}">
                        <label class="block text-left text-sm font-medium text-gray-700">Minutes</label>
                        <input type="number" name="minutes" class="mt-1 w-full px-3 py-2 border rounded" value="${currentStatus.minutes || 0}">
                    </div>
                `;

                try {
                    const data = await showModal('Update Bus Status', formHtml, 'Update');
                    const newStatus = {
                        type: data.type,
                        minutes: data.type === 'on-time' ? 0 : Number(data.minutes) || 0
                    };
                    await updateDoc(doc(db, busCollection.path, busId), { status: newStatus });
                    showMessage('Bus status updated.');
                } catch(error) {
                     if (error.message.includes("Modal cancelled")) {
                        console.log("Update status operation cancelled.");
                    } else {
                        console.error("Error updating status:", error);
                        showMessage(`Error: Could not update status. ${error.message}`);
                    }
                }
            };

            // --- FARE CALCULATION AND MANAGEMENT LOGIC (NEWLY ADDED/FIXED) ---
            const populateFareCalculatorStops = () => {
                if (!fareFromStop || !fareToStop || allBuses.length === 0) return;

                const allStops = new Set();
                allBuses.forEach(bus => {
                    if (bus.stops) {
                        bus.stops.forEach(stop => allStops.add(stop.name));
                    }
                });

                const sortedStops = [...allStops].sort((a, b) => a.localeCompare(b));

                fareFromStop.innerHTML = '<option value="">-- Select From --</option>';
                fareToStop.innerHTML = '<option value="">-- Select To --</option>';

                sortedStops.forEach(stopName => {
                    const option1 = document.createElement('option');
                    option1.value = stopName;
                    option1.textContent = stopName;
                    fareFromStop.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = stopName;
                    option2.textContent = stopName;
                    fareToStop.appendChild(option2);
                });
            };

            const calculateAndDisplayFare = () => {
                const fromStopName = fareFromStop.value;
                const toStopName = fareToStop.value;

                fareResultContainer.innerHTML = ''; // Clear previous results

                if (!fromStopName || !toStopName) {
                    fareResultContainer.innerHTML = `<p class="text-yellow-600">Please select both a starting and destination stop.</p>`;
                    return;
                }

                if (fromStopName === toStopName) {
                    fareResultContainer.innerHTML = `<p class="text-yellow-600">Starting and destination stops cannot be the same.</p>`;
                    return;
                }

                let totalFare = -1;
                let foundRoute = null;

                // Find a bus route that contains both stops
                for (const bus of allBuses) {
                    if(!bus.stops) continue;
                    let fromIndex = bus.stops.findIndex(s => s.name === fromStopName);
                    let toIndex = bus.stops.findIndex(s => s.name === toStopName);
                    let isReversed = false;

                    // Check for reverse direction
                    if (fromIndex > toIndex) {
                        // For this simple model, we assume the fare is the same in reverse.
                        // A more complex model might have different fare stages for each direction.
                        [fromIndex, toIndex] = [toIndex, fromIndex]; // Swap them for calculation
                        isReversed = true;
                    }

                    // Check if both stops are on this route
                    if (fromIndex !== -1 && toIndex !== -1) {
                        foundRoute = bus;
                        totalFare = 0;
                        // Sum the fares from the stop after the 'from' stop up to the 'to' stop
                        for (let i = fromIndex + 1; i <= toIndex; i++) {
                            totalFare += bus.stops[i].fare || 0;
                        }
                        break; // Found a valid route, so we can stop searching
                    }
                }

                if (foundRoute) {
                    fareResultContainer.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-lg font-semibold text-green-800">Estimated Fare: ${totalFare}</p>
                            <p class="text-sm text-gray-600 mt-1">On bus route: ${foundRoute.busNumber} (${foundRoute.origin} - ${foundRoute.destination})</p>
                        </div>
                    `;
                } else {
                    fareResultContainer.innerHTML = `
                         <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p class="text-lg font-semibold text-red-800">No direct route found.</p>
                            <p class="text-sm text-gray-600 mt-1">No single bus route was found that travels from "${fromStopName}" to "${toStopName}".</p>
                        </div>
                    `;
                }
            };

            const populateManageFaresBusSelect = () => {
                if (!manageFaresBusSelect) return;
                manageFaresBusSelect.innerHTML = '<option value="">-- Select a Bus Route --</option>';
                allBuses.forEach(bus => {
                    const option = document.createElement('option');
                    option.value = bus.id;
                    option.textContent = `${bus.busNumber}: ${bus.origin} - ${bus.destination}`;
                    manageFaresBusSelect.appendChild(option);
                });
                fareOverridesContainer.innerHTML = '';
                saveFaresBtn.classList.add('hidden');
            };

            const renderFareOverrides = (busId) => {
                fareOverridesContainer.innerHTML = '';
                if (!busId) {
                    saveFaresBtn.classList.add('hidden');
                    return;
                }
                const bus = allBuses.find(b => b.id === busId);
                if (!bus || !bus.stops) {
                    saveFaresBtn.classList.add('hidden');
                    return;
                }
                const stopsHtml = bus.stops.map((stop, index) => {
                    if (index === 0) {
                        return `<div class="p-2 bg-gray-100 rounded-md"><strong>${stop.name}:</strong> Fare is always 0 (Origin)</div>`;
                    }
                    return `
                        <div class="flex items-center space-x-2">
                            <label for="fare-override-${index}" class="flex-1 text-sm">${stop.name}</label>
                            <span class="text-sm"></span>
                            <input type="number" id="fare-override-${index}" data-stop-index="${index}" class="w-24 px-2 py-1 border rounded" value="${stop.fare || 0}" min="0">
                        </div>
                    `;
                }).join('');
                fareOverridesContainer.innerHTML = stopsHtml;
                saveFaresBtn.classList.remove('hidden');
            };

            const handleSaveFares = async () => {
                const busId = manageFaresBusSelect.value;
                if (!busId) { showMessage("No bus selected.", true); return; }
                const bus = allBuses.find(b => b.id === busId);
                if (!bus) { showMessage("Selected bus not found.", true); return; }

                const newStops = JSON.parse(JSON.stringify(bus.stops)); // Deep copy
                let hasError = false;

                fareOverridesContainer.querySelectorAll('input[type="number"]').forEach(input => {
                    if (hasError) return;
                    const stopIndex = parseInt(input.dataset.stopIndex, 10);
                    const newFare = parseInt(input.value, 10);
                    if (isNaN(newFare) || newFare < 0) {
                        showMessage(`Invalid fare for stop #${stopIndex + 1}. Please enter a valid number.`, true);
                        hasError = true;
                    }
                    if (newStops[stopIndex]) {
                        newStops[stopIndex].fare = newFare;
                    }
                });

                if (hasError) return;
                try {
                    const busDocRef = doc(db, busCollection.path, busId);
                    await updateDoc(busDocRef, { stops: newStops });
                    showMessage("Fares updated successfully!");
                } catch (error) {
                    console.error("Error updating fares:", error);
                    showMessage("Failed to update fares.", true);
                }
            };
            
            // --- RENDER FUNCTIONS ---
            const updateFilterDropdown = () => {
                const stopFilterOption = isAdmin 
                    ? `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">Manage Stops...</a>`
                    : `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">Select your Stop...</a>`;

                let optionsHtml = `
                    <a href="#" data-filter="all" class="filter-option ${currentFilter === 'all' ? 'active' : ''} block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">All Buses</a>
                    <a href="#" data-filter="live" class="filter-option ${currentFilter === 'live' ? 'active' : ''} block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md">Live Buses</a>
                    ${stopFilterOption}
                `;
                filterDropdown.innerHTML = optionsHtml;
            };

            const renderSchedule = (data) => {
                scheduleList.innerHTML = ''; 
                
                const showAdminControls = isAdmin;

                if (data.length === 0) {
                    if (searchQuery || currentFilter !== 'all') {
                        setStatus(`No results found.`);
                    } else {
                        const message = isAdmin
                            ? "No buses found. Click 'Add New Bus' to create a schedule."
                            : "No buses found for today's schedule.";
                        setStatus(message);
                    }
                    return;
                }
                
                data.forEach(bus => {
                    let arrivalText, arrivalColor, arrivalSize;

                    if (bus.etaAtGoolikkadavu === null) {
                        arrivalText = 'N/A';
                        arrivalColor = 'text-gray-500 font-semibold';
                        arrivalSize = 'text-sm';
                    } else if (bus.etaAtGoolikkadavu < 0) {
                        arrivalText = 'Departed';
                        arrivalColor = 'text-gray-500 font-semibold';
                        arrivalSize = 'text-xs';
                    } else {
                        arrivalText = formatEta(bus.etaAtGoolikkadavu);
                        arrivalColor = bus.etaAtGoolikkadavu <= 1 ? 'text-red-600 font-bold' : 'text-gray-900 font-semibold';
                        arrivalSize = 'text-sm';
                    }
                    
                    const isDropdownOpen = openDropdowns.has(bus.id);
                    const itemHeight = 72; // Approximate height of a timeline item
                    const liveIconTopPosition = bus.liveIconPositionIndex * itemHeight;

                    let stopsHtml = '';
                    let cumulativeFare = 0;
                    bus.stops.forEach((stop, index) => {
                        cumulativeFare += stop.fare || 0;
                        const stopDepartureTime = parseTime(stop.scheduledTime);
                        const stopEta = Math.round((stopDepartureTime - new Date()) / 60000);
                        let stopArrivalText = `Scheduled ${formatTime(stopDepartureTime)}`;
                        if(stopEta <=1 && stopEta >= 0) stopArrivalText = `Scheduled Now`;
                        else if (stopEta < 0) stopArrivalText = `Departed`;
                        
                        const isPassed = stopEta < 0;
                        const passedClass = isPassed ? 'passed' : '';
                        
                        const fareText = index > 0 ? `<p class="text-xs text-green-600 font-semibold">${cumulativeFare}</p>` : '';
                        const waitTimeText = stop.waitingTime > 0 ? `<p class="text-xs text-blue-600 mt-1"> Take Coffee Cup  ${stop.waitingTime} min wait</p>` : '';

                        const editButtons = showAdminControls ? `
                            <div class="flex items-center space-x-2">
                                ${fareText}
                                <button class="edit-stop-btn edit-btn" data-bus-id="${bus.id}" data-stop-index="${index}">Edit</button>
                                <button class="delete-stop-btn delete-btn" data-bus-id="${bus.id}" data-stop-index="${index}">Del</button>
                            </div>
                        ` : `
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-600">${formatTime(stopDepartureTime)}</p>
                                ${fareText}
                            </div>
                        `;
                        
                        stopsHtml += `
                            <div class="timeline-item ${passedClass}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="stop-name">${stop.name}</p>
                                        <p class="text-xs text-gray-500">${stopArrivalText}</p>
                                        ${waitTimeText}
                                    </div>
                                    ${editButtons}
                                </div>
                            </div>`;
                    });
                    
                    let addStopButtonHtml = '';
                    if (showAdminControls) {
                        addStopButtonHtml = `<div class="p-2 border-t mt-2 flex justify-around"><button class="add-stop-btn edit-btn" data-bus-id="${bus.id}">+ Add Stop</button><button class="update-status-btn edit-btn" data-bus-id="${bus.id}">Update Status</button></div>`;
                    }

                    const editBusButtons = showAdminControls ? `
                        <div class="absolute top-2 right-2 flex space-x-2">
                            <button class="edit-bus-btn edit-btn" data-bus-id="${bus.id}">Edit</button>
                            <button class="delete-bus-btn delete-btn" data-bus-id="${bus.id}">Del</button>
                        </div>
                    `: '';

                    let subtext = '';
                    if (bus.status && bus.status.type !== 'on-time') {
                        subtext = `<span class="${bus.status.type === 'late' ? 'text-red-600' : 'text-blue-600'}">${bus.status.minutes} min ${bus.status.type}</span>`;
                    } else {
                        subtext = `<span class="text-green-600">On time</span>`;
                    }
                    
                    if (bus.seatCapacity) {
                        subtext += ` <span class="text-gray-500 mx-1">|</span> <span> ${bus.seatCapacity}</span>`;
                    }

                    const isWatched = watchedBuses.includes(bus.id);
                    const watchedClass = isWatched ? 'watched' : '';

                    const listItem = document.createElement('div');
                    listItem.className = `bus-item relative border-b ${watchedClass}`;
                    listItem.innerHTML = `
                        ${editBusButtons}
                        <div class="bus-header p-4 flex items-center cursor-pointer" data-bus-id="${bus.id}">
                            <span class="text-3xl mr-4"></span>
                            <div class="flex-grow">
                                 <div class="flex items-baseline mb-1"><p class="font-bold text-sm text-gray-800">${bus.busNumber}</p><p class="text-xs font-medium text-gray-600 ml-2"><span class="inline-block bg-gray-100 text-gray-800 px-2 py-0.5 rounded">${bus.origin} - ${bus.destination}</span></p></div>
                                 <div class="flex items-center space-x-1 text-xs font-medium">${subtext}</div>
                            </div>
                            <div class="text-right"><p class="${arrivalColor} ${arrivalSize}">${arrivalText}</p></div>
                        </div>
                        <div id="details-${bus.id}" class="bus-details bg-gray-50 px-4 pb-4 ${isDropdownOpen ? '' : 'hidden'}">
                            <div class="timeline-wrapper">
                                ${stopsHtml}
                                ${bus.stops.length > 0 && !bus.isFinished ? `<span class="live-dot-icon" style="top: ${liveIconTopPosition}px;"></span>` : ''}
                            </div>
                            ${addStopButtonHtml}
                        </div>`;
                    scheduleList.appendChild(listItem);
                });
            };

            const updateAndRenderSchedule = () => {
                if (!isAuthReady) return; 
                const currentTime = new Date();
                
                let liveBusData = allBuses.map(bus => {
                    const status = bus.status || { type: 'on-time', minutes: 0 };
                    let statusOffset = 0;
                    if (status.type === 'late') {
                        statusOffset = status.minutes * 60000;
                    } else if (status.type === 'early') {
                        statusOffset = -status.minutes * 60000;
                    }

                    if (!bus.stops || bus.stops.length === 0) {
                        return { ...bus, stops: [], etaAtGoolikkadavu: null, liveIconPositionIndex: 0, isFinished: true };
                    }
                    
                    let cumulativeWait = 0;
                    let goolikkadavuArrivalTime = null;
                    for(const stop of bus.stops) {
                        const stopArrivalTime = parseTime(stop.scheduledTime).getTime() + cumulativeWait + statusOffset;
                        if (stop.name === 'Goolikkadavu Jn') {
                            goolikkadavuArrivalTime = stopArrivalTime;
                            break;
                        }
                        cumulativeWait += (stop.waitingTime || 0) * 60000;
                    }

                    let etaAtGoolikkadavu = null;
                    if (goolikkadavuArrivalTime !== null) {
                        etaAtGoolikkadavu = Math.round((goolikkadavuArrivalTime - currentTime.getTime()) / 60000);
                    }

                    let liveIconPositionIndex = 0;
                    const nextStopIndex = bus.stops.findIndex(stop => (parseTime(stop.scheduledTime).getTime() + statusOffset) > currentTime.getTime());
                    const isFinished = nextStopIndex === -1;

                    if (isFinished) {
                        liveIconPositionIndex = bus.stops.length;
                    } else if (nextStopIndex > 0) {
                        const lastStop = bus.stops[nextStopIndex - 1];
                        const nextStop = bus.stops[nextStopIndex];
                        
                        const lastStopArrivalTime = parseTime(lastStop.scheduledTime).getTime() + statusOffset;
                        const lastStopDepartureTime = lastStopArrivalTime + (lastStop.waitingTime || 0) * 60000;
                        
                        const nextStopArrivalTime = parseTime(nextStop.scheduledTime).getTime() + statusOffset;
                        
                        if (currentTime.getTime() >= lastStopArrivalTime && currentTime.getTime() < lastStopDepartureTime) {
                            liveIconPositionIndex = nextStopIndex - 1;
                        } else {
                            const segmentDuration = nextStopArrivalTime - lastStopDepartureTime;
                            if (segmentDuration > 0) {
                                const progressInSegment = (currentTime.getTime() - lastStopDepartureTime) / segmentDuration;
                                liveIconPositionIndex = (nextStopIndex - 1) + Math.min(1, Math.max(0, progressInSegment));
                            } else {
                                liveIconPositionIndex = nextStopIndex - 1;
                            }
                        }
                    } else {
                         liveIconPositionIndex = 0;
                    }

                    // Check for notifications
                    if (watchedBuses.includes(bus.id) && !notifiedBuses.includes(bus.id) && etaAtGoolikkadavu !== null && etaAtGoolikkadavu <= 5 && etaAtGoolikkadavu > 0) {
                        showMessage(`Bus ${bus.busNumber} is approx. ${etaAtGoolikkadavu} minutes away!`);
                        notifiedBuses.push(bus.id);
                    }
                    
                    return { ...bus, etaAtGoolikkadavu, liveIconPositionIndex, isFinished };
                });

                // Filter based on search query
                let filteredBusData = liveBusData;
                if (searchQuery) {
                    filteredBusData = filteredBusData.filter(bus => {
                        const busName = bus.busNumber.toLowerCase();
                        const origin = bus.origin.toLowerCase();
                        return busName.includes(searchQuery) || origin.includes(searchQuery);
                    });
                }
                
                // Apply the main filter
                if (currentFilter === 'live') {
                    filteredBusData = filteredBusData.filter(bus => !bus.isFinished);
                } else if (currentFilter !== 'all') {
                    filteredBusData = filteredBusData.filter(bus => 
                        bus.stops.some(stop => stop.name === currentFilter)
                    );
                }

                // Sort the filtered data chronologically by departure time
                filteredBusData.sort((a, b) => {
                    const timeA = a.stops.length > 0 ? parseTime(a.stops[0].scheduledTime) : 0;
                    const timeB = b.stops.length > 0 ? parseTime(b.stops[0].scheduledTime) : 0;
                    
                    if (!timeA && !timeB) return 0;
                    if (!timeA) return 1;
                    if (!timeB) return -1;

                    return timeA - timeB;
                });
                
                renderSchedule(filteredBusData);
            };
            
            // --- EVENT LISTENERS ---
            confirmCancelBtn.addEventListener('click', hideConfirmation);
            addBusBtn.addEventListener('click', handleAddBus);
            searchBar.addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                updateAndRenderSchedule();
            });
            
            scheduleList.addEventListener('mousedown', (e) => {
                const header = e.target.closest('.bus-header');
                if (!header) return;

                longPress = false; 
                pressTimer = window.setTimeout(() => {
                    longPress = true;
                    const busId = header.dataset.busId;
                    const bus = allBuses.find(b => b.id === busId);
                    if (!bus || bus.etaAtGoolikkadavu === null) {
                        showMessage("Can only watch buses with a calculable ETA.");
                        return;
                    }

                    const index = watchedBuses.indexOf(busId);
                    if (index > -1) {
                        watchedBuses.splice(index, 1);
                        showMessage(`Notifications turned OFF for ${bus.busNumber}.`);
                    } else {
                        watchedBuses.push(busId);
                        showMessage(`Notifications turned ON for ${bus.busNumber}.`);
                    }
                    localStorage.setItem('watchedBuses', JSON.stringify(watchedBuses));
                    updateAndRenderSchedule();
                }, 500);
            });

            scheduleList.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
            });
            
            scheduleList.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
            });

            scheduleList.addEventListener('click', (e) => {
                if (longPress) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                const header = e.target.closest('.bus-header');
                const button = e.target.closest('button');

                if (header && !button) {
                    const busId = header.dataset.busId;
                    const details = document.getElementById(`details-${busId}`);
                    if (details) {
                        details.classList.toggle('hidden');
                        if (openDropdowns.has(busId)) {
                            openDropdowns.delete(busId);
                        } else {
                            openDropdowns.add(busId);
                        }
                    }
                } else if (button) {
                    const busId = button.dataset.busId;
                    const stopIndex = button.dataset.stopIndex;

                    if (button.matches('.edit-bus-btn')) handleEditBus(busId);
                    else if (button.matches('.delete-bus-btn')) handleDeleteBus(busId);
                    else if (button.matches('.edit-stop-btn')) handleEditStop(busId, parseInt(stopIndex, 10));
                    else if (button.matches('.delete-stop-btn')) handleDeleteStop(busId, parseInt(stopIndex, 10));
                    else if (button.matches('.add-stop-btn')) handleAddStop(busId);
                    else if (button.matches('.update-status-btn')) handleUpdateStatus(busId);
                }
            });

            scheduleList.addEventListener('contextmenu', e => {
                if (e.target.closest('.bus-header')) {
                    e.preventDefault();
                }
            });

            sidebarNav.addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (!navLink) return;
                
                e.preventDefault();
                
                const pageId = navLink.dataset.page;
                if (pageId) {
                    showPage(pageId);
                }
            });

            menuBtn.addEventListener('click', openSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);
            
            filterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                filterDropdown.classList.toggle('hidden');
            });

            filterDropdown.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.filter-option');
                if (!target) return;

                const filterValue = target.dataset.filter;
                if (filterValue === 'select-stop') {
                    if (isAdmin) {
                        showManageStopsModal();
                    } else {
                        showStopFilterModal();
                    }
                } else {
                    currentFilter = filterValue;
                    updateAndRenderSchedule();
                    updateFilterDropdown();
                }
                filterDropdown.classList.add('hidden');
            });

            stopFilterList.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.filter-option');
                if (!target) return;

                currentFilter = target.dataset.filter;
                updateAndRenderSchedule();
                hideStopFilterModal();
            });

            stopFilterCancelBtn.addEventListener('click', hideStopFilterModal);

            manageStopsCloseBtn.addEventListener('click', hideManageStopsModal);
            
            addFilterStopBtn.addEventListener('click', () => {
                const customInput = document.getElementById('custom-filter-stop-input');
                let stopToAdd;
                if (addStopSelect.value === 'custom') {
                    stopToAdd = customInput.value.trim();
                    if (!stopToAdd) {
                        showMessage("Please enter a custom stop name.");
                        return;
                    }
                } else {
                    stopToAdd = addStopSelect.value;
                }
                
                if (filterableStops.includes(stopToAdd)) {
                    showMessage(`"${stopToAdd}" is already in the filter list.`);
                    return;
                }

                addFilterStop(stopToAdd);
                customInput.value = '';
                document.getElementById('custom-filter-stop-container').classList.add('hidden');
            });

            manageStopsList.addEventListener('click', e => {
                const target = e.target.closest('.remove-filter-stop-btn');
                if (target) {
                    removeFilterStop(target.dataset.stopName);
                }
            });
            
            contactForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newContact = {
                    email: editContactEmail.value,
                    phone: editContactPhone.value,
                    address: editContactAddress.value
                };
                try {
                    await setDoc(contactDocRef, newContact);
                    showMessage("Contact details updated successfully!");
                } catch (error) {
                    console.error("Error updating contact details:", error);
                    showMessage("Failed to update contact details.");
                }
            });

            aboutForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newAboutContent = {
                    html: quill.root.innerHTML,
                };
                try {
                    await setDoc(aboutDocRef, newAboutContent);
                    showMessage("About page updated successfully!");
                } catch (error) {
                    console.error("Error updating about page:", error);
                    showMessage("Failed to update about page.");
                }
            });

            // Event listener for Manage Fares dropdown
            manageFaresBusSelect.addEventListener('change', (e) => {
                renderFareOverrides(e.target.value);
            });
            // Event listener for Save Fares button
            saveFaresBtn.addEventListener('click', handleSaveFares);

            // Event listeners for Fare Calculator
            calculateFareBtn.addEventListener('click', calculateAndDisplayFare);
            fareFromStop.addEventListener('change', () => fareResultContainer.innerHTML = '');
            fareToStop.addEventListener('change', () => fareResultContainer.innerHTML = '');

            window.addEventListener('click', (e) => {
                if (!filterBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
                    filterDropdown.classList.add('hidden');
                }
            });

            // --- INITIALIZATION ---
            const initializeAppAndData = async () => {
                // Load watched buses from local storage
                watchedBuses = JSON.parse(localStorage.getItem('watchedBuses')) || [];

                // Initialize Firebase
                if (!firebaseConfig.apiKey) {
                    setStatus("Firebase configuration is missing. The app cannot start.", true);
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Authenticated User ID:", currentUserId);
                        
                        // Define Firestore paths after user is authenticated
                        const publicDataPath = `artifacts/${appId}/public/data`;
                        busCollection = collection(db, `${publicDataPath}/buses`);
                        filterStopsDocRef = doc(db, `${publicDataPath}/config/filterStops`);
                        contactDocRef = doc(db, `${publicDataPath}/config/contact`);
                        aboutDocRef = doc(db, `${publicDataPath}/config/about`);


                        // Detach old listeners if they exist
                        if (unsubscribeFromBuses) unsubscribeFromBuses();
                        if (unsubscribeFromFilters) unsubscribeFromFilters();
                        if (unsubscribeFromContact) unsubscribeFromContact();
                        if (unsubscribeFromAbout) unsubscribeFromAbout();

                        // Attach new listeners
                        unsubscribeFromBuses = onSnapshot(busCollection, (snapshot) => {
                            allBuses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            if (!isAuthReady) {
                                isAuthReady = true; // Mark as ready once we get data
                                addSampleDataIfNeeded(); // Check for sample data only on first load
                            }
                            updateAndRenderSchedule();
                        }, (error) => {
                            console.error("Error fetching bus data:", error);
                            setStatus("Error loading schedule. Please check connection.", true);
                        });

                        unsubscribeFromFilters = onSnapshot(filterStopsDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                filterableStops = docSnap.data().stops || [];
                            } else {
                                filterableStops = [];
                            }
                            updateFilterDropdown();
                            updateAndRenderSchedule();
                        }, (error) => {
                            console.error("Error fetching filter stops:", error);
                        });

                        unsubscribeFromContact = onSnapshot(contactDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const contact = docSnap.data();
                                contactInfoContainer.innerHTML = `
                                    <p>For inquiries, feedback, or support, please reach out to us:</p>
                                    <p><strong>Makkal Raja Transport Corporation</strong></p>
                                    <p>Email: <a href="mailto:${contact.email}" class="text-blue-600 hover:underline">${contact.email}</a></p>
                                    <p>Phone: ${contact.phone}</p>
                                    <p>Address: ${contact.address}</p>
                                `;
                                editContactEmail.value = contact.email;
                                editContactPhone.value = contact.phone;
                                editContactAddress.value = contact.address;
                            }
                        });

                        unsubscribeFromAbout = onSnapshot(aboutDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const about = docSnap.data();
                                aboutContentContainer.innerHTML = about.html;
                                if (quill) {
                                    quill.root.innerHTML = about.html;
                                }
                            }
                        });


                    } else {
                        console.log("User is signed out.");
                        // Handle signed-out state if necessary
                    }
                });

                // Sign in the user
                try {
                    console.log("Attempting to sign in...");
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase connection successful!");
                } catch (error) {
                    console.error("Authentication failed:", error);
                    setStatus("Could not connect to the server. Check console for details.", true);
                }
            };

            // Start the application
            initializeAppAndData();
            checkAdminStatus();
            setInterval(updateAndRenderSchedule, 30000); // Refresh every 30 seconds
            showPage('home');
            updateFilterDropdown();
          } catch(e) {
            console.error("A critical error occurred in the main script:", e);
            const statusMessage = document.getElementById('status-message');
            if (statusMessage) {
                statusMessage.textContent = "An unexpected error occurred. Please refresh the page.";
                statusMessage.className = 'p-8 text-center text-red-500';
            }
          }
        });
    </script>
</body>
</html>
