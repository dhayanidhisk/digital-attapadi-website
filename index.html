<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Attappadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-900: #0c4a6e;

            --secondary-50: #ecfdf5;
            --secondary-100: #d1fae5;
            --secondary-500: #10b981;
            --secondary-600: #059669;

            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334152;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--slate-100);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--slate-200); }
        ::-webkit-scrollbar-thumb { background: var(--slate-400); border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--slate-500); }

        /* General Button Style */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: var(--primary-600);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-700);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .btn-secondary {
            background-color: var(--slate-200);
            color: var(--slate-800);
        }
        .btn-secondary:hover {
            background-color: var(--slate-300);
        }

        /* Timeline Styles */
        .timeline-wrapper { position: relative; }
        .timeline-item { position: relative; padding-left: 2.5rem; padding-bottom: 2rem; }
        
        .timeline-item:not(:last-of-type)::after {
            content: '';
            position: absolute;
            left: calc(1.5rem - 1px);
            top: 1.75rem;
            bottom: -2rem;
            width: 2px;
            background-color: var(--slate-200);
            z-index: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.1875rem;
            top: 1rem;
            height: 0.75rem;
            width: 0.75rem;
            background-color: white;
            border: 2px solid var(--slate-300);
            border-radius: 9999px;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-item.passed::before {
            background-color: var(--primary-600);
            border-color: var(--primary-600);
        }
        .timeline-item.passed:not(:last-of-type)::after {
            background-color: var(--primary-600);
        }
        .stop-name { color: var(--slate-700); font-weight: 600; }
        .timeline-item.passed .stop-name { color: var(--slate-400); font-weight: 500; text-decoration: line-through; }

        /* Live Dot Animation */
        .live-dot-icon {
            position: absolute;
            width: 1rem; height: 1rem;
            background-color: var(--primary-500);
            border-radius: 9999px;
            z-index: 10;
            transition: top 2s linear;
            left: 1.0625rem;
            top: -0.25rem;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%  { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }

        /* Sidebar & Navigation */
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; backdrop-filter: blur(4px); }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active {
            background-color: var(--primary-50);
            color: var(--primary-700);
            font-weight: 700;
        }
        .nav-link.active svg { color: var(--primary-600); }

        /* Bus Card Expansion */
        .bus-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
        }
        .bus-details.open {
            max-height: 1000px; /* A large enough value to accommodate content */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        /* Spinner */
        .spinner {
            border-top-color: var(--primary-600);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Quill Editor */
        #editor-container { height: 250px; }
        .ql-toolbar.ql.snow { border-radius: 0.5rem 0.5rem 0 0; }
        .ql-container.ql.snow { border-radius: 0 0 0.5rem 0.5rem; }

        /* Fare Matrix Table */
        .fare-matrix-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .fare-matrix-table th, .fare-matrix-table td { border: 1px solid var(--slate-200); padding: 0.5rem; text-align: center; }
        .fare-matrix-table th { background-color: var(--slate-100); }
        .fare-matrix-table .header-cell { font-weight: 600; color: var(--slate-600); }
        .fare-matrix-table .disabled-cell { background-color: var(--slate-100); }

        /* Announcement Banner */
        #announcement-banner { overflow: hidden; white-space: nowrap; }
        #announcement-text.scrolling {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0%  { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .video-ad-container {
            position: relative;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden; /* Ensures the iframe corners are clipped */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .mute-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            z-index: 10;
            background-color: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 9999px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* New CSS for single line origin/destination with horizontal scroll */
        .bus-route-text {
            display: flex; /* Make it a flex container for its content spans */
            white-space: nowrap; /* Keep content on a single line */
            animation: marquee-route linear infinite;
            /* Initial position will be handled by keyframes */
        }

        /* This is the actual content that will scroll */
        .bus-route-text .marquee-content {
            flex-shrink: 0; /* Prevent content from shrinking */
            padding-right: var(--marquee-gap-px); /* Add a gap between repetitions */
        }

        /* Hide scrollbar for Webkit browsers (Chrome, Safari) */
        .bus-route-text::-webkit-scrollbar {
            display: none;
        }

        @keyframes marquee-route {
            0%   { transform: translateX(0); }
            100% { transform: translateX(var(--marquee-distance)); }
        }

        /* Ensure bus-header clips overflowing content */
        .bus-header {
            overflow: hidden; /* This is the key change */
        }
    </style>
</head>
<body class="flex justify-center">

    <div id="app-container" class="w-full max-w-md bg-white min-h-screen shadow-2xl">
        <!-- Header -->
        <header class="bg-gradient-to-r from-sky-600 to-cyan-500 sticky top-0 z-20 p-4 text-white shadow-lg">
             <div class="flex justify-between items-center">
                 <div class="w-16">
                     <button id="menu-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                         </svg>
                     </button>
                 </div>
                 <div class="text-center">
                     <h1 class="text-2xl font-extrabold tracking-tight">Digital Attappadi</h1>
                     <p class="text-xs text-sky-100 opacity-90">Makkal Raja Transport Corporation</p>
                 </div>
                 <div class="w-16"></div> <!-- Spacer -->
             </div>
        </header>
        
        <div id="announcement-banner" class="hidden bg-blue-100 border-b-2 border-blue-300 text-blue-800 text-sm font-medium p-2">
            <p id="announcement-text"></p>
        </div>

        <div id="page-container">
            <!-- Home Page Content -->
            <div id="home-page">
                <!-- Search and Filter Bar -->
                <div class="p-4 bg-slate-50 border-b border-slate-200">
                    <div class="flex items-center space-x-2">
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="text" id="search-bar" class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Search by bus name or origin...">
                        </div>
                        <div class="relative">
                            <button id="filter-btn" class="p-2.5 border border-slate-300 rounded-lg bg-white hover:bg-slate-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                </svg>
                            </button>
                            <div id="filter-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-10 py-1 ring-1 ring-black ring-opacity-5">
                                <!-- Filter options populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bus Schedule List -->
                <main id="schedule-list" class="divide-y divide-slate-200">
                     <div id="status-message" class="p-8 text-center text-slate-500">
                             <div class="flex flex-col justify-center items-center">
                                 <div class="spinner h-8 w-8 border-4 border-slate-200 rounded-full"></div>
                                 <span class="ml-3 mt-3">Initializing...</span>
                             </div>
                     </div>
                </main>
                
                <div id="add-bus-container" class="p-4 hidden">
                    <button id="add-bus-btn" class="w-full btn btn-primary">Add New Bus</button>
                </div>
            </div>

            <!-- Other Pages (Fare Calculator, Manage Fares, etc.) -->
            <div id="fare-calculator-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Fare Calculator</h2>
                <div class="space-y-4">
                    <div>
                        <label for="fare-from-stop" class="block text-sm font-medium text-slate-700">From</label>
                        <select id="fare-from-stop" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="fare-to-stop" class="block text-sm font-medium text-slate-700">To</label>
                        <select id="fare-to-stop" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md"></select>
                    </div>
                    <button id="calculate-fare-btn" class="w-full btn btn-primary">Calculate Fare</button>
                </div>
                <div id="fare-result-container" class="mt-6"></div>
            </div>
            
            <div id="manage-fares-page" class="hidden p-6">
                 <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Fares</h2>
                 <div class="space-y-4">
                     <div>
                         <label for="manage-fares-bus-select" class="block text-sm font-medium text-slate-700">Select Bus Route</label>
                         <select id="manage-fares-bus-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md"></select>
                     </div>
                     <div id="fare-matrix-container" class="overflow-x-auto"></div>
                     <div class="flex space-x-2 mt-4">
                         <button id="download-csv-btn" class="w-full btn btn-secondary hidden">Download CSV</button>
                         <button id="upload-csv-btn" class="w-full btn btn-secondary hidden">Upload CSV</button>
                         <input type="file" id="csv-upload-input" class="hidden" accept=".csv">
                     </div>
                      <button id="save-fares-btn" class="w-full btn btn-primary hidden">Save Fares</button>
                 </div>
            </div>

            <div id="manage-announcements-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Announcements</h2>
                <div class="space-y-4">
                    <div>
                        <label for="announcement-input" class="block text-sm font-medium text-slate-700">Announcement Message</label>
                        <textarea id="announcement-input" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="e.g., Service delays due to heavy rain..."></textarea>
                    </div>
                    <button id="publish-announcement-btn" class="w-full btn btn-primary">Publish Announcement</button>
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-medium text-slate-900">Current Announcement</h3>
                        <div id="current-announcement-container" class="mt-2 p-3 bg-slate-50 rounded-md text-sm text-slate-700 min-h-[40px]"></div>
                        <button id="clear-announcement-btn" class="mt-2 w-full btn btn-danger">Clear Announcement</button>
                    </div>
                </div>
            </div>

             <div id="manage-ads-page" class="hidden p-6">
                 <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Advertisements</h2>
                 <div class="space-y-6">
                     <div>
                         <h3 class="text-lg font-medium text-slate-900">Current Ads</h3>
                         <div id="ads-list-container" class="mt-2 space-y-4">
                             <!-- List of ads will be populated here -->
                         </div>
                     </div>
                     <div class="border-t pt-6">
                             <h3 class="text-lg font-medium text-slate-900">Add New Ad</h3>
                           <form id="ad-form" class="space-y-4 mt-2">
                                 <div>
                                     <label for="ad-type-select" class="block text-sm font-medium text-slate-700">Ad Type</label>
                                     <select id="ad-type-select" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                                         <option value="image" selected>Image Ad</option>
                                         <option value="video">Video Ad</option>
                                     </select>
                                 </div>
                                 <div id="ad-image-inputs">
                                     <div>
                                         <label for="ad-image-url-input" class="block text-sm font-medium text-slate-700">Image URL</label>
                                         <input type="url" id="ad-image-url-input" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://example.com/image.png">
                                     </div>
                                     <div class="mt-4">
                                         <label for="ad-link-input" class="block text-sm font-medium text-slate-700">Link URL (when image is clicked)</label>
                                         <input type="url" id="ad-link-input" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://example.com">
                                     </div>
                                 </div>
                                 <div id="ad-video-inputs" class="hidden">
                                     <label for="ad-video-url-input" class="block text-sm font-medium text-slate-700">YouTube Video URL</label>
                                     <input type="url" id="ad-video-url-input" class="mt-1 block w-full px-3 py-2 border rounded" placeholder="https://www.youtube.com/watch?v=...">
                                 </div>
                                 <div class="mt-4">
                                     <label for="ad-position-input" class="block text-sm font-medium text-slate-700">Position (After which bus number)</label>
                                     <input type="number" id="ad-position-input" class="mt-1 block w-full px-3 py-2 border rounded" placeholder="e.g., 3" min="1" required>
                                 </div>
                                 <button id="publish-ad-btn" type="submit" class="w-full btn btn-primary">Publish Ad</button>
                           </form>
                     </div>
                 </div>
             </div>

            <div id="about-page" class="hidden p-6">
                <div id="about-content-container" class="prose max-w-none"></div>
            </div>
            
            <div id="manage-about-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage About Page</h2>
                <form id="about-form" class="space-y-4">
                    <div>
                        <label for="editor-container" class="block text-sm font-medium text-slate-700">Page Content</label>
                        <div id="editor-container" class="mt-1"></div>
                    </div>
                    <button id="save-about-btn" type="submit" class="w-full btn btn-primary">Save About Page</button>
                </form>
            </div>

            <div id="contact-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Contact Information</h2>
                <div id="contact-info-container" class="space-y-4 text-slate-700"></div>
            </div>
            
            <div id="manage-contact-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Contact Details</h2>
                <form id="contact-form" class="space-y-4">
                    <div>
                        <label for="edit-contact-email" class="block text-sm font-medium text-slate-700">Email</label>
                        <input type="email" id="edit-contact-email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="edit-contact-phone" class="block text-sm font-medium text-slate-700">Phone</label>
                        <input type="tel" id="edit-contact-phone" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="edit-contact-address" class="block text-sm font-medium text-slate-700">Address</label>
                        <textarea id="edit-contact-address" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required></textarea>
                    </div>
                    <button id="save-contact-btn" type="submit" class="w-full btn btn-primary">Save Contact Details</button>
                </form>
            </div>

            <div id="manage-admins-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Admins</h2>
                <div id="admin-list-container" class="space-y-4">
                    <!-- Admin list will be populated here -->
                </div>
                <div class="mt-6">
                    <button id="add-admin-btn" class="w-full btn btn-primary">Add New Admin</button>
                </div>
            </div>

            <!-- My Profile Page -->
            <div id="my-profile-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">My Profile</h2>
                <div id="my-profile-content" class="space-y-4">
                    <!-- Profile details will be rendered here -->
                </div>
            </div>

            <!-- Audit Logs Page -->
            <div id="audit-logs-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Audit Logs</h2>
                <div id="audit-logs-list" class="space-y-4">
                    <p class="text-slate-500">Loading audit logs...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-30"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-40">
        <div class="p-4 border-b flex items-center space-x-3">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-sky-600" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
             </svg>
            <h2 class="text-lg font-bold text-slate-800">Digital Attappadi</h2>
        </div>
        <nav id="sidebar-nav" class="p-2 space-y-1">
            <a href="#" data-page="home" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Bus Schedule</span>
            </a>
            <a href="#" data-page="fare-calculator" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3m6 0h-3m-3 6v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3" />
                </svg>
                <span>Fare Calculator</span>
            </a>
            <a href="#" data-page="about" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>About</span>
            </a>
            <a href="#" data-page="contact" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <span>Contact</span>
            </a>
            <div id="admin-menu-items"></div>
        </nav>
    </div>

    <!-- Modals (Edit, Confirmation, etc.) -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-40 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
            <div class="text-center">
                <h3 id="modal-title" class="text-xl leading-6 font-bold text-slate-900">Edit Details</h3>
                <div class="mt-4 px-2 py-3">
                    <form id="edit-form" class="space-y-4"></form>
                </div>
                <div class="items-center px-4 py-3 space-y-2">
                    <button id="modal-save" class="w-full btn btn-primary"></button>
                    <button id="modal-cancel" class="w-full btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-slate-900 mt-2">Are you sure?</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirmation-message" class="text-sm text-slate-500"></p>
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="confirm-cancel-btn" class="w-full btn btn-secondary">Close</button>
                    <button id="confirm-action-btn" class="w-full btn btn-danger">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="stop-filter-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-5 border rounded-xl bg-white shadow-2xl">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900 text-center">Select your Stop</h3>
                <div id="stop-filter-list" class="mt-4 max-h-80 overflow-y-auto space-y-2"></div>
                <div class="items-center px-4 py-3">
                    <button id="stop-filter-cancel" class="mt-2 w-full btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="manage-stops-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-5 border rounded-xl bg-white shadow-2xl">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900 text-center">Manage Filter Stops</h3>
                <div id="manage-stops-list" class="mt-4 max-h-60 overflow-y-auto divide-y"></div>
                <div class="mt-4">
                    <select id="add-stop-select" class="w-full px-3 py-2 border rounded"></select>
                    <div id="custom-filter-stop-container" class="hidden mt-2">
                        <input type="text" id="custom-filter-stop-input" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name">
                    </div>
                    <button id="add-filter-stop-btn" class="mt-2 w-full btn btn-primary">Add Stop to Filter</button>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="manage-stops-close-btn" class="mt-2 w-full btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50 transition-all duration-300">
        <p id="message-text"></p>
    </div>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, arrayUnion, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Import serverTimestamp

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Fallback for local development
            apiKey: "AIzaSyAXfcrRz76kWgTfz_lgdFkcWxKl3k-ufac",
            authDomain: "digital-attappadi-live.firebaseapp.com",
            projectId: "digital-attappadi-live",
            storageBucket: "digital-attappadi-live.firebasestorage.app",
            messagingSenderId: "165166679967",
            appId: "1:165166679967:web:6b96e0d85a757393af5faa",
            measurementId: "G-FKXLPE1Y0Q"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'digital-attappadi-live';

        // --- Firebase Services ---
        let app, db, auth, analytics, busCollection, configDocRef, filterStopsDocRef, contactDocRef, aboutDocRef, announcementDocRef, adsCollection, adminsCollection, auditLogsCollection;

        // --- STATE ---
        let allBuses = [];
        let filterableStops = [];
        let allAds = [];
        let allAdmins = []; // Stores all admin data from Firestore
        let allAuditLogs = []; // Stores all audit logs
        let currentAdmin = null; // Stores the logged-in admin's data
        let currentAdminPermissions = {}; // Stores permissions of the logged-in admin
        let openDropdownId = null; 
        let isAdmin = false; // General flag if any admin is logged in
        let isSuperAdmin = false; // Flag for super admin
        let currentUserId = null;
        let isAuthReady = false;
        let unsubscribeListeners = [];
        let modalResolve = null;
        let modalReject = null;
        let searchQuery = '';
        let currentFilter = 'all';
        let quill = null;
        let predefinedBusNames = [];
        let predefinedStops = [];
        let videoPlayers = {};

        // --- DEFAULT MARQUEE SETTINGS (used if not defined per bus) ---
        const DEFAULT_MARQUEE_SPEED_PX_PER_SEC = 50; 
        const DEFAULT_MARQUEE_REPEAT_DELAY_SEC = 2; 

        // --- DATA CONSTANTS ---
        const SUPER_ADMIN_USERNAME = 'dhayaceoda';
        const SUPER_ADMIN_PASSWORD = '90474470770'; // WARNING: Plaintext password. NOT FOR PRODUCTION.
        const SUPER_ADMIN_NAME = 'Dhaya(Thangakutty)';

        const DEFAULT_PERMISSIONS = {
            manageAnnouncements: false,
            manageFares: false,
            manageAds: false,
            manageAbout: false,
            manageContact: false,
            manageStops: false,
            manageAdmins: false, // Only Super Admin gets this by default, or explicitly granted
            viewAuditLogs: false // New permission for viewing audit logs
        };

        const BLOOD_GROUPS = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const scheduleList = document.getElementById('schedule-list');
            const statusMessage = document.getElementById('status-message');
            const addBusContainer = document.getElementById('add-bus-container');
            const searchBar = document.getElementById('search-bar');
            const filterDropdown = document.getElementById('filter-dropdown');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const adminListContainer = document.getElementById('admin-list-container');
            const addAdminBtn = document.getElementById('add-admin-btn');
            const myProfileContent = document.getElementById('my-profile-content');
            const auditLogsList = document.getElementById('audit-logs-list');


            // --- All functions are defined here before being called ---

            const setStatus = (message, isError = false) => {
                if (statusMessage) {
                    statusMessage.innerHTML = `<p class="p-8 text-center ${isError ? 'text-red-500' : 'text-slate-500'}">${message}</p>`;
                }
            };

            const parseTime = (timeString) => {
                const now = new Date();
                const [hours, minutes] = timeString.split(':');
                now.setHours(hours, minutes, 0, 0);
                return now;
            };

            const formatTime = (dateObject) => dateObject.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            const formatEta = (minutes, prefix = '') => {
                if (minutes <= 1) return 'Now';
                if (minutes < 60) return `${prefix}${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                if (remainingMinutes === 0) return `${prefix}${hours}h`;
                return `${prefix}${hours}h ${remainingMinutes}m`;
            };
            
            const to12Hour = (time24) => {
                let [hours, minutes] = time24.split(':');
                hours = parseInt(hours, 10);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                let hour12 = hours % 12;
                if (hour12 === 0) hour12 = 12; // 12 PM or 12 AM
                return { hour: hour12, minute: minutes, ampm: ampm };
            };

            const to24Hour = (hour, minute, ampm) => {
                hour = parseInt(hour, 10);
                minute = String(minute).padStart(2, '0');
                if (ampm.toUpperCase() === 'PM' && hour < 12) hour += 12;
                if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0; // Midnight case
                return `${String(hour).padStart(2, '0')}:${minute}`;
            };
            
            const showMessage = (message) => {
                messageText.textContent = message;
                messageBox.classList.remove('hidden', 'opacity-0', 'translate-y-2');
                setTimeout(() => {
                    messageBox.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => messageBox.classList.add('hidden'), 300);
                }, 2700);
            };

            const updateFilterDropdown = () => {
                let stopFilterOption = '';
                // Only show "Manage Stops" if Super Admin, otherwise "Select your Stop" if any filterable stops exist
                if (isSuperAdmin && currentAdminPermissions.manageStops) {
                    stopFilterOption = `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Manage Stops...</a>`;
                } else if (filterableStops.length > 0) {
                    stopFilterOption = `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Select your Stop...</a>`;
                }

                let optionsHtml = `
                    <a href="#" data-filter="all" class="filter-option ${currentFilter === 'all' ? 'active' : ''} block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">All Buses</a>
                    <a href="#" data-filter="live" class="filter-option ${currentFilter === 'live' ? 'active' : ''} block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Live Buses</a>
                    ${stopFilterOption}
                `;
                filterDropdown.innerHTML = optionsHtml;
            };

            const renderFareMatrix = (busId) => {
                const fareMatrixContainer = document.getElementById('fare-matrix-container');
                const saveFaresBtn = document.getElementById('save-fares-btn');
                const downloadCsvBtn = document.getElementById('download-csv-btn');
                const uploadCsvBtn = document.getElementById('upload-csv-btn');

                fareMatrixContainer.innerHTML = '';
                if (!busId) {
                    saveFaresBtn.classList.add('hidden');
                    downloadCsvBtn.classList.add('hidden');
                    uploadCsvBtn.classList.add('hidden');
                    return;
                }
                const bus = allBuses.find(b => b.id === busId);
                if (!bus || !bus.stops || bus.stops.length < 2) {
                    fareMatrixContainer.innerHTML = '<p class="text-slate-500">This route needs at least two stops to set up fares.</p>';
                    saveFaresBtn.classList.add('hidden');
                    downloadCsvBtn.classList.add('hidden');
                    uploadCsvBtn.classList.add('hidden');
                    return;
                }

                let tableHtml = '<table class="fare-matrix-table"><thead><tr><th class="header-cell">From/To</th>';
                bus.stops.forEach(stop => {
                    tableHtml += `<th class="header-cell">${stop.name}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';

                bus.stops.forEach((fromStop, i) => {
                    let row = fromStop.name;
                    bus.stops.forEach((toStop, j) => {
                        row += ",";
                        if (i >= j) {
                            tableHtml += '<td class="disabled-cell"></td>';
                        } else {
                            const fareKey = `${fromStop.name}_${toStop.name}`;
                            const fareValue = (bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) ? bus.fareMatrix[fareKey] : '';
                            tableHtml += `<td><input type="number" class="fare-input" data-key="${fareKey}" value="${fareValue}" min="0"></td>`;
                        }
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';
                fareMatrixContainer.innerHTML = tableHtml;
                // Only show save/download/upload buttons if the current admin has permission
                if (currentAdminPermissions.manageFares) {
                    saveFaresBtn.classList.remove('hidden');
                    downloadCsvBtn.classList.remove('hidden');
                    uploadCsvBtn.classList.remove('hidden');
                } else {
                    saveFaresBtn.classList.add('hidden');
                    downloadCsvBtn.classList.add('hidden');
                    uploadCsvBtn.classList.add('hidden');
                }
            };

            const populateManageFaresBusSelect = () => {
                const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
                if (!manageFaresBusSelect) return;
                const selectedBusId = manageFaresBusSelect.value;
                manageFaresBusSelect.innerHTML = '<option value="">-- Select a Bus Route --</option>';
                allBuses
                    .sort((a,b) => parseTime(a.stops[0].scheduledTime) - parseTime(b.stops[0].scheduledTime))
                    .forEach(bus => {
                        const option = document.createElement('option');
                        option.value = bus.id;
                        const departureTime = to12Hour(bus.stops[0].scheduledTime);
                        
                        // --- NEW: Use the unique admin-facing name in the dropdown ---
                        let displayName = `${bus.busNumber}`;
                        if (bus.vehicleId && bus.tripNumber) {
                            displayName = `${bus.busNumber} ${bus.vehicleId}${bus.tripNumber}`;
                        }
                        
                        option.textContent = `${departureTime.hour}:${departureTime.minute} ${departureTime.ampm} - ${displayName}: ${bus.origin} to ${bus.destination}`;
                        manageFaresBusSelect.appendChild(option);
                    });
                manageFaresBusSelect.value = selectedBusId;
                renderFareMatrix(selectedBusId);
            };

            const populateFareCalculatorStops = () => {
                const fareFromStop = document.getElementById('fare-from-stop');
                const fareToStop = document.getElementById('fare-to-stop');
                if (!fareFromStop || !fareToStop || allBuses.length === 0) return;

                const allStops = new Set();
                allBuses.forEach(bus => {
                    if (bus.stops) {
                        bus.stops.forEach(stop => allStops.add(stop.name));
                    }
                });

                const sortedStops = [...allStops].sort((a, b) => a.localeCompare(b));

                fareFromStop.innerHTML = '<option value="">-- Select From --</option>';
                fareToStop.innerHTML = '<option value="">-- Select To --</option>';

                sortedStops.forEach(stopName => {
                    const option1 = document.createElement('option');
                    option1.value = stopName;
                    option1.textContent = stopName;
                    fareFromStop.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = stopName;
                    option2.textContent = stopName;
                    fareToStop.appendChild(option2);
                });
            };

            const showPage = (pageId, fromHistory = false) => {
                const pageContainer = document.getElementById('page-container');
                Array.from(pageContainer.children).forEach(page => {
                    page.classList.add('hidden');
                });
                const newPage = document.getElementById(`${pageId}-page`);
                if(newPage) newPage.classList.remove('hidden');
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === pageId) {
                        link.classList.add('active');
                    }
                });

                if (!fromHistory) {
                    history.pushState({ pageId: pageId }, '', `#${pageId}`);
                }

                if (pageId === 'manage-about' && !quill) {
                    quill = new Quill('#editor-container', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['link', 'clean']
                            ]
                        }
                    });
                    getDoc(aboutDocRef).then(docSnap => {
                        if (docSnap.exists() && quill) {
                            quill.root.innerHTML = docSnap.data().html;
                        }
                    });
                } else if (pageId === 'fare-calculator') {
                    populateFareCalculatorStops();
                } else if (pageId === 'manage-fares') {
                    populateManageFaresBusSelect();
                } else if (pageId === 'manage-ads') {
                    renderAdsList();
                } else if (pageId === 'manage-admins') {
                    renderAdminsList();
                } else if (pageId === 'my-profile') {
                    renderMyProfile(); // Render the profile when the page is shown
                } else if (pageId === 'audit-logs') {
                    renderAuditLogs();
                }
                closeSidebar();
            };

            const openSidebar = () => {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebar-overlay').classList.remove('hidden');
                document.getElementById('sidebar-overlay').style.opacity = '1';
            };

            const closeSidebar = () => {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('sidebar-overlay').classList.add('hidden'), 300);
            };

            // Helper function to log admin actions
            const logAdminAction = async (actionType, details, entityId = null, entityType = null) => {
                if (!currentAdmin || !currentAdmin.name) return; // Only log if an admin is logged in
                try {
                    await addDoc(auditLogsCollection, {
                        timestamp: serverTimestamp(),
                        adminName: currentAdmin.name,
                        actionType: actionType,
                        details: details,
                        entityId: entityId,
                        entityType: entityType
                    });
                } catch (error) {
                    console.error("Error logging admin action:", error);
                }
            };

            const renderAuthControls = () => {
                const adminMenuItems = document.getElementById('admin-menu-items');
                adminMenuItems.innerHTML = '';
                if (isAdmin) {
                    const adminName = currentAdmin ? currentAdmin.name : 'Admin';
                    let adminMenuHtml = `<div class="border-t my-2"></div>`;

                    // Add "My Profile" link
                    adminMenuHtml += `
                        <a href="#" data-page="my-profile" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            <span>My Profile</span>
                        </a>`;

                    if (currentAdminPermissions.manageAnnouncements) {
                        adminMenuHtml += `
                            <a href="#" data-page="manage-announcements" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6 3 3 0 000 6z" /></svg>
                                <span>Announcements</span>
                            </a>`;
                    }
                    if (currentAdminPermissions.manageFares) {
                        adminMenuHtml += `
                            <a href="#" data-page="manage-fares" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3m6 0h-3m-3 6v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3" /></svg>
                                <span>Manage Fares</span>
                            </a>`;
                    }
                    if (currentAdminPermissions.manageAds) {
                        adminMenuHtml += `
                            <a href="#" data-page="manage-ads" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" /></svg>
                                <span>Manage Ads</span>
                            </a>`;
                    }
                    if (currentAdminPermissions.manageAbout) {
                        adminMenuHtml += `
                            <a href="#" data-page="manage-about" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span>Manage About</span>
                            </a>`;
                    }
                    if (currentAdminPermissions.manageContact) {
                        adminMenuHtml += `
                            <a href="#" data-page="manage-contact" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h2m4 0h-4m4 0l-4-4m4 4l4 4" /></svg>
                                <span>Manage Contact</span>
                            </a>`;
                    }
                    if (currentAdminPermissions.manageStops) {
                        adminMenuHtml += `
                            <a href="#" data-page="manage-stops" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span>Manage Stops</span>
                            </a>`;
                    }
                    // The "Manage Admins" link is ONLY visible to the Super Admin
                    if (isSuperAdmin) {
                        adminMenuHtml += `
                            <a href="#" data-page="manage-admins" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h10a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0H9m7 4h-4m-0 0l-4-4m4 4l4 4" /></svg>
                                <span>Manage Admins</span>
                            </a>`;
                    }
                    if (currentAdminPermissions.viewAuditLogs) {
                        adminMenuHtml += `
                            <a href="#" data-page="audit-logs" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 2v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                <span>Audit Logs</span>
                            </a>`;
                    }

                    adminMenuHtml += `
                        <div class="border-t my-2"></div>
                        <a href="#" id="admin-logout-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            <span>Logout (${adminName})</span>
                        </a>
                    `;
                    adminMenuItems.innerHTML = adminMenuHtml;
                } else {
                    adminMenuItems.innerHTML = `
                        <div class="border-t my-2"></div>
                        <a href="#" id="admin-login-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            <span>Admin Login</span>
                        </a>
                        <a href="#" id="super-admin-login-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12.79V21a2 2 0 01-2 2H5a2 2 0 01-2-2V3a2 2 0 012-2h10.79M17 8l-2-2m0 0l-2 2m2-2V2m-5 10H3v7a2 2 0 002 2h14a2 2 0 002-2v-7h-5z" /></svg>
                             <span>Office Login</span>
                           </a>
                    `;
                }
                addBusContainer.classList.toggle('hidden', !isAdmin);
            };

            // This function is now responsible for setting isAdmin and isSuperAdmin flags
            const checkAdminStatus = () => {
                isAdmin = currentAdmin !== null;
                isSuperAdmin = isAdmin && currentAdmin.username === SUPER_ADMIN_USERNAME;
                renderAuthControls();
                updateAndRenderSchedule();
                if (document.getElementById('my-profile-page').classList.contains('hidden') === false) {
                    renderMyProfile(); // Re-render profile if on that page
                }
                if (document.getElementById('audit-logs-page').classList.contains('hidden') === false) {
                    renderAuditLogs(); // Re-render audit logs if on that page
                }
            };

            const login = async (isSuperAdminLogin = false) => {
                closeSidebar();
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" required></div>`;
                try {
                    const data = await showModal(`${isSuperAdminLogin ? 'Office' : 'Admin'} Login`, formHtml, 'Login');
                    
                    // Query Firestore for the admin
                    const q = query(adminsCollection, 
                                    where("username", "==", data.username), 
                                    where("password", "==", data.password)); // WARNING: Plaintext password match. NOT FOR PRODUCTION.
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const loggedInAdmin = querySnapshot.docs[0].data();
                        currentAdmin = { id: querySnapshot.docs[0].id, ...loggedInAdmin };
                        currentAdminPermissions = loggedInAdmin.permissions || {};

                        // If it's a super admin login attempt, ensure it's the actual super admin
                        if (isSuperAdminLogin && loggedInAdmin.username !== SUPER_ADMIN_USERNAME) {
                            showMessage("Invalid Office Login credentials.", true);
                            currentAdmin = null;
                            currentAdminPermissions = {};
                            return;
                        }

                        localStorage.setItem('adminUser', loggedInAdmin.name); // Store name for display
                        showMessage(`${isSuperAdminLogin ? 'Office' : 'Admin'} mode enabled for ${loggedInAdmin.name}.`);
                        logAdminAction('LOGIN', `${loggedInAdmin.name} logged in.`);
                        checkAdminStatus(); // Update UI based on new admin status
                    } else {
                        showMessage("Incorrect username or password.");
                        currentAdmin = null;
                        currentAdminPermissions = {};
                    }
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Login cancelled.");
                    } else {
                        console.error("Login error:", error);
                    }
                }
            };

            const logout = () => {
                if (currentAdmin) {
                    logAdminAction('LOGOUT', `${currentAdmin.name} logged out.`);
                }
                currentAdmin = null;
                currentAdminPermissions = {};
                localStorage.removeItem('adminUser');
                showMessage(`Logged out.`);
                openDropdownId = null;
                checkAdminStatus(); // Update UI based on logged out status
                closeSidebar();
            };

            const showModal = (title, formHtml, saveButtonText = 'Save Changes') => {
                const editModal = document.getElementById('edit-modal');
                const modalTitle = document.getElementById('modal-title');
                const editForm = document.getElementById('edit-form');
                const modalSaveBtn = document.getElementById('modal-save');
                
                modalTitle.textContent = title;
                editForm.innerHTML = formHtml;
                modalSaveBtn.textContent = saveButtonText;
                
                editModal.classList.remove('hidden');
                
                const setupCustomSelectListener = (selectId, containerId) => {
                    const selectEl = editForm.querySelector(selectId);
                    const containerEl = editForm.querySelector(containerId);
                    if (selectEl && containerEl) {
                        const toggleVisibility = () => {
                            const isCustom = selectEl.value === 'custom';
                            containerEl.classList.toggle('hidden', !isCustom);
                            const input = containerEl.querySelector('input');
                            if (input) input.required = isCustom;
                        };
                        selectEl.addEventListener('change', toggleVisibility);
                        toggleVisibility();
                    }
                };

                setupCustomSelectListener('#bus-name-select', '#custom-bus-name-container');
                setupCustomSelectListener('#origin-select', '#custom-origin-container');
                setupCustomSelectListener('#destination-select', '#custom-destination-container');
                setupCustomSelectListener('#stop-name-select', '#custom-stop-name-container');

                const statusTypeSelect = editForm.querySelector('#status-type');
                if (statusTypeSelect) {
                    const toggleStatusMinutes = () => {
                        const statusContainer = editForm.querySelector('#status-minutes-container');
                        if(statusContainer) {
                            statusContainer.classList.toggle('hidden', statusTypeSelect.value === 'on-time');
                        }
                    };
                    statusTypeSelect.addEventListener('change', toggleVisibility);
                    toggleVisibility(); // Call initially to set correct state
                }
                // For admin permissions checkboxes
                const permissionCheckboxes = editForm.querySelectorAll('input[type="checkbox"][name^="permission_"]');
                if (permissionCheckboxes.length > 0) {
                    permissionCheckboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', () => {
                            // No direct action needed here, form data will be collected on save
                        });
                    });
                }

                return new Promise((resolve, reject) => {
                    modalResolve = resolve;
                    modalReject = reject;
                });
            };
            
            const hideModal = () => {
                const editModal = document.getElementById('edit-modal');
                editModal.classList.add('hidden');
                document.getElementById('edit-form').innerHTML = '';
                modalResolve = null;
                modalReject = null;
            };

            const showConfirmation = (message) => {
                return new Promise((resolve) => {
                    const confirmationModal = document.getElementById('confirmation-modal');
                    const confirmMessage = document.getElementById('confirmation-message');
                    const confirmActionBtn = document.getElementById('confirm-action-btn');
                    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                    confirmMessage.textContent = message;
                    confirmationModal.classList.remove('hidden');

                    const handleConfirm = () => {
                        cleanup();
                        resolve(true);
                    };
                    const handleCancel = () => {
                        cleanup();
                        resolve(false);
                    };
                    
                    const cleanup = () => {
                        confirmationModal.classList.add('hidden');
                        confirmActionBtn.removeEventListener('click', handleConfirm);
                        confirmCancelBtn.removeEventListener('click', handleCancel);
                    };

                    confirmActionBtn.addEventListener('click', handleConfirm, { once: true });
                    confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
                });
            };

            const showStopFilterModal = () => {
                const stopFilterModal = document.getElementById('stop-filter-modal');
                const stopFilterList = document.getElementById('stop-filter-list');
                stopFilterList.innerHTML = filterableStops.map(stop => 
                    `<a href="#" data-filter="${stop}" class="filter-option ${currentFilter === stop ? 'active' : ''} flex justify-between items-center p-3 text-left w-full text-sm text-slate-800 rounded-lg hover:bg-sky-50 border border-slate-200">
                        <span>${stop}</span>
                        <span class="text-sky-500 font-bold">&rarr;</span>
                    </a>`
                ).join('');
                stopFilterModal.classList.remove('hidden');
            };

            const hideStopFilterModal = () => {
                document.getElementById('stop-filter-modal').classList.add('hidden');
            };

            const showManageStopsModal = () => {
                closeSidebar();
                const manageStopsModal = document.getElementById('manage-stops-modal');
                const manageStopsList = document.getElementById('manage-stops-list');
                const addStopSelect = document.getElementById('add-stop-select');
                
                manageStopsList.innerHTML = filterableStops.map(stop => `
                    <div class="flex justify-between items-center p-2">
                        <span>${stop}</span>
                        <button data-stop-name="${stop}" class="remove-filter-stop-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `).join('');

                const allStops = new Set(predefinedStops);
                allBuses.forEach(bus => {
                    if (bus.stops) {
                        bus.stops.forEach(stop => allStops.add(stop.name))
                    }
                });
                const availableStops = [...allStops].filter(s => !filterableStops.includes(s)).sort();
                
                addStopSelect.innerHTML = `<option value="">-- Select Stop to Add --</option>` + availableStops.map(stop => `<option value="${stop}">${stop}</option>`).join('') + '<option value="custom">Other...</option>';
                
                const customContainer = document.getElementById('custom-filter-stop-container');
                const customInput = document.getElementById('custom-filter-stop-input');
                
                const toggleCustomInput = () => {
                    if (addStopSelect.value === 'custom') {
                        customContainer.classList.remove('hidden');
                        customInput.focus();
                    } else {
                        customContainer.classList.add('hidden');
                    }
                };
                addStopSelect.onchange = toggleCustomInput;
                toggleCustomInput(); 

                manageStopsModal.classList.remove('hidden');
            };

            const hideManageStopsModal = () => {
                document.getElementById('manage-stops-modal').classList.add('hidden');
            };

            const addSampleDataIfNeeded = async () => {
                const busSnapshot = await getDocs(busCollection);
                if (busSnapshot.empty) {
                    console.log("Database is empty. Adding sample bus routes.");
                    const sampleBuses = [
                        {
                            busNumber: "KSRTC",
                            origin: "Palakkad",
                            destination: "Anaikkatty",
                            seatCapacity: 48,
                            status: { type: 'on-time', minutes: 0 },
                            stops: [
                                { name: "Palakkad", scheduledTime: "08:00", waitingTime: 0, displayFare: 0 },
                                { name: "Mannarkkad", scheduledTime: "09:00", waitingTime: 5, displayFare: 45 },
                                { name: "Goolikkadavu Jn", scheduledTime: "10:00", waitingTime: 0, displayFare: 45 },
                                { name: "Kottathara", scheduledTime: "10:30", waitingTime: 0, displayFare: 20 },
                                { name: "Anaikkatty", scheduledTime: "11:00", waitingTime: 0, displayFare: 20 },
                            ],
                            fareMatrix: {
                                "Palakkad_Mannarkkad": 45, "Palakkad_Goolikkadavu Jn": 90, "Palakkad_Kottathara": 110, "Palakkad_Anaikkatty": 130,
                                "Mannarkkad_Goolikkadavu Jn": 45, "Mannarkkad_Kottathara": 65, "Mannarkkad_Anaikkatty": 85,
                                "Goolikkadavu Jn_Kottathara": 20, "Goolikkadavu Jn_Anaikkatty": 40,
                                "Kottathara_Anaikkatty": 20
                            },
                            marqueeSpeedPxPerSec: DEFAULT_MARQUEE_SPEED_PX_PER_SEC, // Add default marquee speed
                            marqueeRepeatDelaySec: DEFAULT_MARQUEE_REPEAT_DELAY_SEC // Add default marquee interval
                        }
                    ];
                    try {
                        for (const bus of sampleBuses) {
                            await addDoc(busCollection, bus);
                        }
                    } catch (error) {
                        console.error("Error adding sample bus data:", error);
                    }
                }

                const aboutSnapshot = await getDoc(aboutDocRef);
                if (!aboutSnapshot.exists()) {
                    console.log("About page content is empty. Adding default content.");
                    const defaultAboutContent = {
                        html: `<h2 class="text-2xl font-bold text-slate-800 mb-4">Welcome to Digital Attappadi</h2><p class="text-slate-700 mb-4">This platform is a community-driven initiative to provide reliable, real-time bus tracking for the Makkal Raja Transport Corporation. Our mission is to connect the vibrant communities of the Attappadi region by making travel simpler, more transparent, and predictable for everyone.</p><p class="text-slate-700 mb-4">With Digital Attappadi, you can effortlessly track live bus locations, view detailed routes with all the stops, and get accurate estimated arrival times (ETAs). Whether you're a daily commuter or a visitor exploring the beautiful landscapes of Attappadi, our goal is to ensure you have the most up-to-date information right at your fingertips.</p><p class="text-slate-700">We are continuously working to improve this service. Thank you for being a part of our community. We wish you a safe and pleasant journey!</p>`
                    };
                    try {
                        await setDoc(aboutDocRef, defaultAboutContent);
                    } catch(error) {
                        console.error("Error adding default about content:", error);
                    }
                }

                const configSnapshot = await getDoc(configDocRef);
                if (!configSnapshot.exists()) {
                    console.log("Config document is empty. Adding default lists.");
                    const defaultConfig = {
                        busNames: ['KSRTC', 'SPR', 'SRG', 'KMS', 'RPC', 'Abirami'],
                        stops: ['Anaikkatty', 'Kottathara', 'Agali Jn', 'Goolikkadavu Jn', 'Thavalam', 'Mukkali', 'Mannarkkad', 'Palakkad', 'Coimbatore']
                    };
                    await setDoc(configDocRef, defaultConfig);
                }

                // Add Super Admin if admins collection is empty
                const adminsSnapshot = await getDocs(adminsCollection);
                if (adminsSnapshot.empty) {
                    console.log("Admins collection is empty. Adding Super Admin.");
                    await addDoc(adminsCollection, {
                        username: SUPER_ADMIN_USERNAME,
                        password: SUPER_ADMIN_PASSWORD, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                        name: SUPER_ADMIN_NAME,
                        permissions: { // Super Admin gets all permissions
                            manageAnnouncements: true,
                            manageFares: true,
                            manageAds: true,
                            manageAbout: true,
                            manageContact: true,
                            manageStops: true,
                            manageAdmins: true,
                            viewAuditLogs: true // Super Admin can view audit logs
                        }
                    });
                }

            };

            const handleAddBus = async () => {
                // Check permission before showing modal
                if (!isAdmin) { showMessage("Permission denied.", true); return; }

                const busNameOptions = predefinedBusNames.map(s => `<option value="${s}">${s}</option>`).join('');
                const originOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const destinationOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');

                // --- NEW: Updated form with Vehicle ID and a placeholder for dynamic content ---
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Bus Name:</label>
                        <select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded" required>
                            <option value="" disabled selected>Select Bus Name</option>
                            ${busNameOptions}
                            <option value="custom">Other...</option>
                        </select>
                        <div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name"></div>
                    </div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Vehicle ID (2-3 Letters, e.g., HJ)</label>
                        <input type="text" name="vehicleId" id="new-vehicle-id" class="mt-1 w-full px-3 py-2 border rounded uppercase" required pattern="[A-Z]{2,3}" title="Please enter 2 or 3 uppercase letters.">
                    </div>
                                        <div id="dynamic-trip-section" class="space-y-2 mt-2"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Origin</option>${originOptions}<option value="custom">Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Destination</option>${destinationOptions}<option value="custom">Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Departure Time from Origin:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                `;

                try {
                    // --- NEW: Setup the live validation after showing the modal ---
                    const modalPromise = showModal('Add New Bus', formHtml, 'Add Bus');
                    const vehicleIdInput = document.getElementById('new-vehicle-id');
                    const dynamicSection = document.getElementById('dynamic-trip-section');
                    const saveButton = document.getElementById('modal-save');
                    const originSelect = document.getElementById('origin-select');
                    const destinationSelect = document.getElementById('destination-select');
                    const busNameSelect = document.getElementById('bus-name-select');

                    saveButton.disabled = true; // Disable save button initially

                    vehicleIdInput.addEventListener('input', () => {
                        const idValue = vehicleIdInput.value.toUpperCase();
                        vehicleIdInput.value = idValue;
                        dynamicSection.innerHTML = ''; // Clear previous state
                        saveButton.disabled = true; // Disable by default

                        if (idValue.length < 2 || idValue.length > 3) {
                            return; // Don't do anything until length is valid
                        }

                        const existingBuses = allBuses.filter(bus => bus.vehicleId === idValue);

                        if (existingBuses.length > 0) {
                            // --- Vehicle ID Exists: Change the form ---
                            const highestTrip = Math.max(...existingBuses.map(bus => bus.tripNumber || 0));
                            const nextTrip = highestTrip + 1;
                            const lastTripDetails = existingBuses.find(bus => bus.tripNumber === highestTrip);

                            dynamicSection.innerHTML = `
                                <div class="p-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 text-sm">
                                    <p>Vehicle ID '${idValue}' already exists. Highest trip is #${highestTrip}.</p>
                                </div>
                                <div>
                  _E001_               <label class="block text-left text-sm font-medium text-slate-700">New Trip Number</label>
                                    <input type="number" name="tripNumber" class="mt-1 w-full px-3 py-2 border rounded" value="${nextTrip}" required min="1">
                                </div>
                            `;
                            // Auto-fill details from the last trip
                            if(lastTripDetails) {
                                busNameSelect.value = lastTripDetails.busNumber;
                                originSelect.value = lastTripDetails.origin;
                                destinationSelect.value = lastTripDetails.destination;
                                busNameSelect.disabled = true; // Lock the bus name
                            }
                        } else {
                            // --- Vehicle ID is New: Reset the form ---
                            busNameSelect.disabled = false;
                        }
                        saveButton.disabled = false;
                    });

                    // --- NEW: Updated save logic ---
                    const data = await modalPromise;
                    
                    const scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    let busData;
                    let logMessage;

                    if (data.tripNumber) {
                        // --- This is a NEW TRIP for an EXISTING vehicle ---
                        const existingBuses = allBuses.filter(bus => bus.vehicleId === data.vehicleId);
                        const lastTrip = existingBuses.sort((a,b) => b.tripNumber - a.tripNumber)[0];
                        
                        // Copy data from the last trip, but update time and trip number
                        busData = { ...lastTrip }; // Copy all details including stops and fares
                        delete busData.id; // Remove the old ID to create a new document
                        busData.tripNumber = Number(data.tripNumber);
                        busData.seatCapacity = Number(data.seatCapacity) || null;
                        busData.status = { type: 'on-time', minutes: 0 }; // Reset status
                        
                        // Update the departure time for the first stop
                        if (busData.stops && busData.stops.length > 0) {
                            busData.stops[0].scheduledTime = scheduledTime;
                        }
                        logMessage = `Added Trip #${busData.tripNumber} to Vehicle ID ${busData.vehicleId}`;
                    } else {
                        // --- This is a BRAND NEW vehicle (Trip 1) ---
                        const firstStop = { name: data.origin, scheduledTime: scheduledTime, waitingTime: 0, displayFare: 0 };
                        busData = {
                            busNumber: data.busNumber,
                            vehicleId: data.vehicleId,
                            tripNumber: 1,
                            origin: data.origin,
                            destination: data.destination,
                            seatCapacity: Number(data.seatCapacity) || null,
                            stops: [firstStop],
                            status: { type: 'on-time', minutes: 0 },
                            fareMatrix: {},
                            marqueeSpeedPxPerSec: DEFAULT_MARQUEE_SPEED_PX_PER_SEC,
                            marqueeRepeatDelaySec: DEFAULT_MARQUEE_REPEAT_DELAY_SEC
                        };
                        logMessage = `Added new vehicle ${busData.vehicleId} (Trip #1)`;
                    }

                    if (data.busNumber && !predefinedBusNames.includes(data.busNumber)) {
                        await updateDoc(configDocRef, { busNames: arrayUnion(data.busNumber) });
                    }
                    if (data.origin && !predefinedStops.includes(data.origin)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.origin) });
                    }
                    if (data.destination && !predefinedStops.includes(data.destination)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.destination) });
                    }
                    
                    const docRef = await addDoc(busCollection, busData);
                    showMessage("New bus trip added successfully.");
                    logAdminAction('ADD_BUS_TRIP', logMessage, docRef.id, 'bus');

                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add bus operation cancelled.");
                    } else {
                        console.error("Error during add bus operation:", error);
                        showMessage(`Error: Could not add bus. ${error.message}`);
                    }
                }
            };

            const handleEditBus = async (busId) => {
                if (!isAdmin) { showMessage("Permission denied.", true); return; }
                const bus = allBuses.find(b => b.id === busId);
                const isCustomBusName = !predefinedBusNames.includes(bus.busNumber);
                const isCustomOrigin = !predefinedStops.includes(bus.origin);
                const isCustomDestination = !predefinedStops.includes(bus.destination);

                const busNameOptions = predefinedBusNames.map(s => `<option value="${s}" ${!isCustomBusName && s === bus.busNumber ? 'selected' : ''}>${s}</option>`).join('');
                const originOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomOrigin && s === bus.origin ? 'selected' : ''}>${s}</option>`).join('');
                const destinationOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomDestination && s === bus.destination ? 'selected' : ''}>${s}</option>`).join('');
                
                // --- NEW: Added Vehicle ID and Trip Number fields to the form ---
                const formHtml = `
                    <input type="hidden" name="id" value="${bus.id}">
                    <div><label class="block text-left text-sm font-medium text-slate-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded">${busNameOptions}<option value="custom" ${isCustomBusName ? 'selected' : ''}>Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name" value="${isCustomBusName ? bus.busNumber : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Vehicle ID</label><input type="text" name="vehicleId" class="mt-1 w-full px-3 py-2 border rounded uppercase" value="${bus.vehicleId || ''}" required pattern="[A-Z]{2,3}"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Trip Number</label><input type="number" name="tripNumber" class="mt-1 w-full px-3 py-2 border rounded" value="${bus.tripNumber || ''}" required min="1"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48" value="${bus.seatCapacity || ''}"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded">${originOptions}<option value="custom" ${isCustomOrigin ? 'selected' : ''}>Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin" value="${isCustomOrigin ? bus.origin : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded">${destinationOptions}<option value="custom" ${isCustomDestination ? 'selected' : ''}>Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination" value="${isCustomDestination ? bus.destination : ''}"></div></div>
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-md font-medium text-slate-800 mb-2">Marquee Display Settings</h4>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Marquee Speed (pixels/second):</label><input type="number" name="marqueeSpeedPxPerSec" class="mt-1 w-full px-3 py-2 border rounded" min="1" value="${bus.marqueeSpeedPxPerSec || DEFAULT_MARQUEE_SPEED_PX_PER_SEC}" required></div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Marquee Repeat Delay (seconds):</label><input type="number" name="marqueeRepeatDelaySec" class="mt-1 w-full px-3 py-2 border rounded" step="0.1" min="0" value="${bus.marqueeRepeatDelaySec || DEFAULT_MARQUEE_REPEAT_DELAY_SEC}" required></div>
                    </div>
                `;
                try {
                    const data = await showModal('Edit Bus Route', formHtml);
                    
                    if (data.busNumber && !predefinedBusNames.includes(data.busNumber)) {
                        await updateDoc(configDocRef, { busNames: arrayUnion(data.busNumber) });
                    }
                    if (data.origin && !predefinedStops.includes(data.origin)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.origin) });
                    }
                    if (data.destination && !predefinedStops.includes(data.destination)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.destination) });
                    }

                    const busDocRef = doc(db, busCollection.path, busId);
                    // --- NEW: Save the new fields to the database ---
                    await updateDoc(busDocRef, {
                        busNumber: data.busNumber,
                        vehicleId: data.vehicleId.toUpperCase(),
                        tripNumber: Number(data.tripNumber),
                        origin: data.origin,
                        destination: data.destination,
                        seatCapacity: Number(data.seatCapacity) || null,
                        marqueeSpeedPxPerSec: Number(data.marqueeSpeedPxPerSec),
                        marqueeRepeatDelaySec: Number(data.marqueeRepeatDelaySec)
                    });
                    showMessage("Bus details updated.");
                    logAdminAction('EDIT_BUS', `Edited bus route: ${bus.busNumber} ${bus.vehicleId}${bus.tripNumber}`, busId, 'bus');
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit bus operation cancelled.");
                    } else {
                        console.error("Error updating bus:", error);
                      _E001_  showMessage(`Error: Could not update bus. ${error.message}`);
                    }
                }
            };

            const handleEditStop = async (busId, stopIndex) => {
                if (!isAdmin) { showMessage("Permission denied.", true); return; }
                const bus = allBuses.find(b => b.id === busId);
                const stop = bus.stops[stopIndex];
                const isCustomStop = !predefinedStops.includes(stop.name);
                const stopOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomStop && s === stop.name ? 'selected' : ''}>${s}</option>`).join('');
                const time12 = to12Hour(stop.scheduledTime);
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required>${stopOptions}<option value="custom" ${isCustomStop ? 'selected' : ''}>Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name" value="${isCustomStop ? stop.name : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" value="${time12.hour}" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" value="${time12.minute}" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Display Fare for this segment (₹):</label><input type="number" name="displayFare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="${stop.displayFare || 0}" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="0"></div>
                `;
                try {
                    const data = await showModal('Edit Stop', formHtml);
                    
                    if (data.name && !predefinedStops.includes(data.name)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.name) });
                    }

                    data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const newStops = [...bus.stops];
                    newStops[stopIndex] = { ...newStops[stopIndex], name: data.name, scheduledTime: data.scheduledTime, displayFare: Number(data.displayFare) || 0, waitingTime: Number(data.waitingTime) || 0 };
                    newStops.sort((a,b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                    showMessage("Stop details updated. Please review fares in 'Manage Fares'.");
                    logAdminAction('EDIT_STOP', `Edited stop "${stop.name}" on bus ${bus.busNumber} to "${data.name}"`, busId, 'bus_stop');
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit stop operation cancelled.");
                    } else {
                        console.error("Error updating stop:", error);
                        showMessage(`Error: Could not update stop. ${error.message}`);
                    }
                }
            };
        

            const handleAddStop = async (busId) => {
                if (!isAdmin) { showMessage("Permission denied.", true); return; }
                const bus = allBuses.find(b => b.id === busId);
                const stopOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select a stop</option>${stopOptions}<option value="custom">Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Display Fare for this segment (₹):</label><input type="number" name="displayFare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="0" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="0"></div>
                `;
                try {
                    const data = await showModal('Add Stop', formHtml, 'Add Stop');
                    
                    if (data.name && !predefinedStops.includes(data.name)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.name) });
                    }

                    data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const newStops = [...bus.stops];
                    newStops.push({ name: data.name, scheduledTime: data.scheduledTime, displayFare: Number(data.displayFare) || 0, waitingTime: Number(data.waitingTime) || 0 });
                    newStops.sort((a,b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                    showMessage("Stop added. Please review fares in 'Manage Fares'.");
                    logAdminAction('ADD_STOP', `Added stop "${data.name}" to bus ${bus.busNumber}`, busId, 'bus_stop');
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add stop operation cancelled.");
                    } else {
                        console.error("Error adding stop:", error);
                        showMessage(`Error: Could not add stop. ${error.message}`);
                    }
                }
            };
            
            const handleUpdateStatus = async (busId) => {
                if (!isAdmin) { showMessage("Permission denied.", true); return; }
                const bus = allBuses.find(b => b.id === busId);
                const currentStatus = bus.status || { type: 'on-time', minutes: 0 };
                
                const formHtml = `
                    <div>
                        <label class="block text-left text-sm font-medium text-slate-700">Status</label>
                        <select id="status-type" name="type" class="mt-1 w-full px-3 py-2 border rounded">
                            <option value="on-time" ${currentStatus.type === 'on-time' ? 'selected' : ''}>On time</option>
                            <option value="late" ${currentStatus.type === 'late' ? 'selected' : ''}>Late</option>
                            <option value="early" ${currentStatus.type === 'early' ? 'selected' : ''}>Early</option>
                        </select>
                    </div>
                    <div id="status-minutes-container" class="${currentStatus.type === 'on-time' ? 'hidden' : ''}">
                        <label class="block text-left text-sm font-medium text-slate-700">Minutes</label>
                        <input type="number" name="minutes" class="mt-1 w-full px-3 py-2 border rounded" value="${currentStatus.minutes || 0}">
                    </div>
                `;

                try {
                    const data = await showModal('Update Bus Status', formHtml, 'Update');
                    const newStatus = {
                        type: data.type,
                        minutes: data.type === 'on-time' ? 0 : Number(data.minutes) || 0
                    };
                    await updateDoc(doc(db, busCollection.path, busId), { status: newStatus });
                    showMessage('Bus status updated.');
                    logAdminAction('UPDATE_BUS_STATUS', `Updated status for bus ${bus.busNumber} to ${newStatus.type} (${newStatus.minutes} min)`, busId, 'bus');
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Update status operation cancelled.");
                    } else {
                        console.error("Error updating status:", error);
                        showMessage(`Error: Could not update status. ${error.message}`);
                    }
                }
            };
            
            const calculateAndDisplayFare = () => {
                const fareFromStop = document.getElementById('fare-from-stop');
                const fareToStop = document.getElementById('fare-to-stop');
                const fareResultContainer = document.getElementById('fare-result-container');
                const fromStopName = fareFromStop.value;
                const toStopName = fareToStop.value;

                fareResultContainer.innerHTML = ''; 

                if (!fromStopName || !toStopName) {
                    fareResultContainer.innerHTML = `<p class="text-yellow-600">Please select both a starting and destination stop.</p>`;
                    return;
                }

                if (fromStopName === toStopName) {
                    fareResultContainer.innerHTML = `<p class="text-yellow-600">Starting and destination stops cannot be the same.</p>`;
                    return;
                }

                let totalFare = -1;
                let foundRoute = null;
                const fareKey = `${fromStopName}_${toStopName}`;
                const reverseFareKey = `${toStopName}_${fromStopName}`;

                for (const bus of allBuses) {
                    if(bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) {
                        foundRoute = bus;
                        totalFare = bus.fareMatrix[fareKey];
                        break;
                    }
                    if(bus.fareMatrix && bus.fareMatrix[reverseFareKey] !== undefined) {
                        foundRoute = bus;
                        totalFare = bus.fareMatrix[reverseFareKey];
                        break;
                    }
                }

                if (foundRoute) {
                    fareResultContainer.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-lg font-semibold text-green-800">Fare: ₹${totalFare}</p>
                            <p class="text-sm text-slate-600 mt-1">On bus route: ${foundRoute.busNumber} (${foundRoute.origin} - ${foundRoute.destination})</p>
                        </div>
                    `;
                } else {
                    fareResultContainer.innerHTML = `
                             <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                                 <p class="text-lg font-semibold text-red-800">No direct route found.</p>
                                 <p class="text-sm text-slate-600 mt-1">No fare has been set for the trip from "${fromStopName}" to "${toStopName}".</p>
                             </div>
                           `;
                }
            };

            const handleSaveFares = async () => {
                if (!currentAdminPermissions.manageFares) { showMessage("Permission denied.", true); return; }
                const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
                const busId = manageFaresBusSelect.value;
                if (!busId) { showMessage("No bus selected.", true); return; }
                
                const newFareMatrix = {};
                let hasError = false;

                document.querySelectorAll('#fare-matrix-container .fare-input').forEach(input => {
                    if (hasError) return;
                    const fareKey = input.dataset.key;
                    const fareValue = input.value;
                    if (fareValue !== '') {
                        const parsedFare = parseInt(fareValue, 10);
                        if (isNaN(parsedFare) || parsedFare < 0) {
                            showMessage(`Invalid fare for ${fareKey.replace('_', ' to ')}. Please enter a valid number.`, true);
                            hasError = true;
                        }
                        newFareMatrix[fareKey] = parsedFare;
                    }
                });

                if (hasError) return;
                try {
                    const busDocRef = doc(db, busCollection.path, busId);
                    await updateDoc(busDocRef, { fareMatrix: newFareMatrix });
                    showMessage("Fares updated successfully!");
                    const bus = allBuses.find(b => b.id === busId);
                    logAdminAction('UPDATE_FARES', `Updated fare matrix for bus ${bus.busNumber}`, busId, 'bus');
                } catch (error) {
                    console.error("Error updating fares:", error);
                    showMessage("Failed to update fares.", true);
                }
            };

            const handleDownloadCSV = () => {
                if (!currentAdminPermissions.manageFares) { showMessage("Permission denied.", true); return; }
                const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
                const busId = manageFaresBusSelect.value;
                if (!busId) {
                    showMessage("Please select a bus route to download fares.", true);
                    return;
                }

                const bus = allBuses.find(b => b.id === busId);
                if (!bus || !bus.stops || bus.stops.length < 2) {
                    showMessage("Not enough data to generate a CSV.", true);
                    return;
                }

                const stops = bus.stops.map(s => s.name);
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Header Row
                csvContent += "From/To," + stops.join(",") + "\r\n";

                // Data Rows
                bus.stops.forEach((fromStop, i) => {
                    let row = fromStop.name;
                    bus.stops.forEach((toStop, j) => {
                        row += ",";
                        if (i < j) {
                            const fareKey = `${fromStop.name}_${toStop.name}`;
                            const fare = (bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) ? bus.fareMatrix[fareKey] : "";
                            row += fare;
                        }
                    });
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const fileName = `${bus.busNumber.replace(/\s+/g, '_')}_fares.csv`;
                link.setAttribute("download", fileName);
                document.body.appendChild(link); // Required for Firefox

                link.click();
                document.body.removeChild(link);
                showMessage("Fare matrix download started.");
                logAdminAction('DOWNLOAD_FARES_CSV', `Downloaded fare matrix CSV for bus ${bus.busNumber}`, busId, 'bus');
            };
            
            const getYoutubeVideoId = (url) => {
                try {
                    const urlObj = new URL(url);
                    if (urlObj.hostname === 'youtu.be') {
                        return urlObj.pathname.slice(1);
                    } else if (urlObj.hostname.includes('youtube.com')) {
                        return urlObj.searchParams.get('v');
                    }
                } catch (e) {
                    console.error("Invalid video URL", e);
                    return null;
                }
                return null;
            };
            
            const initializeVideoAds = () => {
                const videoPlaceholders = document.querySelectorAll('[data-video-id]');
                videoPlaceholders.forEach(placeholder => {
                    const adId = placeholder.dataset.adId;
                    const videoId = placeholder.dataset.videoId;
                    if (videoId && !videoPlayers[adId]) {
                        const player = new YT.Player(placeholder.id, {
                            videoId: videoId,
                            playerVars: {
                                'autoplay': 1,
                                'mute': 1,
                                'controls': 0,
                                'loop': 1,
                                'playlist': videoId,
                                'playsinline': 1,
                                'modestbranding': 1
                            },
                            events: {
                                'onReady': (event) => {
                                    videoPlayers[adId] = event.target;
                                }
                            }
                        });
                    }
                });
            };
            
            const renderAdsList = () => {
                const adsListContainer = document.getElementById('ads-list-container');
                adsListContainer.innerHTML = '';
                if (allAds.length === 0) {
                    adsListContainer.innerHTML = '<p class="text-slate-500">No advertisements have been added yet.</p>';
                    return;
                }
                allAds.forEach(ad => {
                    const adElement = document.createElement('div');
                    adElement.className = 'p-4 border rounded-lg flex items-center justify-between';
                    
                    let adContentHtml = '';
                    if (ad.adType === 'video') {
                        adContentHtml = `
                            <div>
                                <p class="font-semibold text-sm">▶️ Video Ad</p>
                                <p class="font-semibold">Position: After bus #${ad.position}</p>
                                <a href="${ad.videoUrl}" target="_blank" class="text-xs text-sky-600 hover:underline truncate">${ad.videoUrl}</a>
                            </div>
                        `;
                    } else {
                        adContentHtml = `
                            <div class="flex items-center space-x-4">
                                <img src="${ad.imageUrl}" class="h-16 w-16 object-cover rounded-md" onerror="this.src='https://placehold.co/64x64/e2e8f0/475569?text=Image'"/>
                                <div>
                                    <p class="font-semibold text-sm">🖼️ Image Ad</p>
                                    <p class="font-semibold">Position: After bus #${ad.position}</p>
                                    <a href="${ad.link}" target="_blank" class="text-xs text-sky-600 hover:underline truncate">${ad.link || 'No link'}</a>
                                </div>
                            </div>
                        `;
                    }

                    adElement.innerHTML = `
                        ${adContentHtml}
                        <button data-ad-id="${ad.id}" class="remove-ad-btn p-2 rounded-full hover:bg-red-100 text-red-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    adsListContainer.appendChild(adElement);
                });
            };

            const renderSchedule = (data) => {
                videoPlayers = {}; // Clear old player references
                scheduleList.innerHTML = ''; 
                const adsByPosition = allAds.reduce((acc, ad) => {
                    acc[ad.position] = ad;
                    return acc;
                }, {});

                const showAdminControls = isAdmin;

                if (data.length === 0) {
                    if (searchQuery || currentFilter !== 'all') {
                        setStatus(`No results found.`);
                    } else {
                        const message = isAdmin
                            ? "No buses found. Click 'Add New Bus' to create a schedule."
                            : "No buses found for today's schedule.";
                        setStatus(message);
                    }
                    return;
                }
                
                data.forEach((bus, busIndex) => {
                    let arrivalText, arrivalColor, arrivalSize;

                    if (bus.isFinished) {
                        arrivalText = 'Completed';
                        arrivalColor = 'text-slate-500 font-semibold';
                        arrivalSize = 'text-xs';
                    } else if (bus.etaAtGoolikkadavu === null) {
                        arrivalText = 'N/A';
                        arrivalColor = 'text-slate-500 font-semibold';
                        arrivalSize = 'text-sm';
                    } else if (bus.etaAtGoolikkadavu < 0) {
                        arrivalText = 'Departed';
                        arrivalColor = 'text-slate-500 font-semibold';
                        arrivalSize = 'text-xs';
                    }
                    else {
                        arrivalText = formatEta(bus.etaAtGoolikkadavu);
                        arrivalColor = bus.etaAtGoolikkadavu <= 10 ? 'text-red-600 font-bold' : 'text-slate-900 font-semibold';
                        arrivalSize = 'text-sm';
                    }
                    
                    const isDropdownOpen = openDropdownId === bus.id;

                    let stopsHtml = '';
                    bus.stops.forEach((stop, index) => {
                        const passedClass = stop.isPassed ? 'passed' : '';
                        
                        const fareText = index > 0 ? `<p class="text-xs text-green-600 font-semibold">₹${stop.displayFare || 0}</p>` : '';
                        const waitTimeText = stop.waitingTime > 0 ? `<p class="text-xs text-sky-600 mt-1">☕ Take Coffee Cup 🕒 ${stop.waitingTime} min wait</p>` : '';

                        const editButtons = showAdminControls ? `
                            <div class="flex items-center space-x-2">
                                ${fareText}
                                <button class="edit-stop-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded" data-bus-id="${bus.id}" data-stop-index="${index}">Edit</button>
                                <button class="delete-stop-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded" data-bus-id="${bus.id}" data-stop-index="${index}">Del</button>
                            </div>
                        ` : `
                            <div class="text-right">
                                <p class="text-sm font-medium text-slate-600">${formatTime(new Date(stop.actualArrivalTime))}</p>
                                ${fareText}
                            </div>
                        `;
                        
                        stopsHtml += `
                            <div class="timeline-item ${passedClass}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="stop-name">${stop.name}</p>
                                        <p class="text-xs text-slate-500">${stop.stopArrivalText}</p>
                                        ${waitTimeText}
                                    </div>
                                    ${editButtons}
                                </div>
                            </div>`;
                    });
                    
                    let addStopButtonHtml = '';
                    if (showAdminControls) {
                        addStopButtonHtml = `<div class="p-2 border-t mt-2 flex justify-around"><button class="add-stop-btn text-sm font-medium text-sky-600 hover:text-sky-800" data-bus-id="${bus.id}">+ Add Stop</button><button class="update-status-btn text-sm font-medium text-sky-600 hover:text-sky-800" data-bus-id="${bus.id}">Update Status</button></div>`;
                    }
                    
                    // --- NEW: Removed the duplicate button from this section ---
                    const editBusButtons = showAdminControls ? `
                        <div class="absolute top-2 right-2 flex space-x-1">
                            <button title="Edit Bus" class="edit-bus-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button title="Delete Bus" class="delete-bus-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>
                    `: '';

                    let subtext = '';
                    if (bus.status && bus.status.type !== 'on-time') {
                        subtext = `<span class="${bus.status.type === 'late' ? 'text-red-600' : 'text-blue-600'}">${bus.status.minutes} min ${bus.status.type}</span>`;
                    } else {
                        subtext = `<span class="text-green-600">On time</span>`;
                    }
                    
                    if (bus.seatCapacity) {
                        subtext += ` <span class="text-slate-400 mx-1">|</span> <span>💺 ${bus.seatCapacity}</span>`;
                    }
                    
                    // --- NEW: Logic to show different names for admins and users ---
                    let displayName = bus.busNumber;
                    if (isAdmin && bus.vehicleId && bus.tripNumber) {
                        displayName = `${bus.busNumber} ${bus.vehicleId}${bus.tripNumber}`;
                    }

                    const listItem = document.createElement('div');
                    listItem.className = `bus-item relative border-b border-slate-200`;
                    listItem.dataset.busId = bus.id;
                    listItem.innerHTML = `
                        ${editBusButtons}
                        <div class="bus-header p-4 flex items-center cursor-pointer hover:bg-slate-50 transition-colors" data-bus-id="${bus.id}">
                            <span class="text-4xl mr-4 flex-shrink-0">🚍</span>
                            <div class="flex-grow min-w-0">
                                 <div class="flex items-baseline mb-1 space-x-2">
                                     <p class="font-bold text-sm text-slate-800 flex-shrink-0">${displayName}:</p>
                                     <div class="relative flex-grow overflow-hidden">
                                         <div class="bus-route-text text-sm font-medium text-slate-600" data-original-route="${bus.origin} &rarr; ${bus.destination}">
                                             <span class="marquee-content">${bus.origin} &rarr; ${bus.destination}</span>
              _E001_                      </div>
                                     </div>
                                 </div>
                                 <div class="flex items-center space-x-1 text-xs font-medium mt-1">${subtext}</div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="${arrivalColor} ${arrivalSize}" data-eta-text-id="${bus.id}">${arrivalText}</p>
                            </div>
                        </div>
                        <div id="details-${bus.id}" class="bus-details bg-slate-50 px-4 ${isDropdownOpen ? 'open' : ''}">
                            <div class="timeline-wrapper">
                                ${stopsHtml}
                                ${bus.stops.length > 0 && !bus.isFinished ? `<span class="live-dot-icon" data-live-dot-id="${bus.id}"></span>` : ''}
                            </div>
                            ${addStopButtonHtml}
            _E001_         </div>`;
                    scheduleList.appendChild(listItem);

                    const ad = adsByPosition[busIndex + 1];
                    if (ad) {
                        const adItem = document.createElement('div');
                        adItem.className = 'p-4 border-b border-slate-200';
                        let adHtml = '';

                        if (ad.adType === 'video' && ad.videoUrl) {
                            const videoId = getYoutubeVideoId(ad.videoUrl);
                            if (videoId) {
                                adHtml = `
                                    <div class="video-ad-container">
                                        <div class="video-container">
                                            <div id="youtube-player-${ad.id}" data-video-id="${videoId}" data-ad-id="${ad.id}"></div>
                                        </div>
                                        <button class="mute-btn" data-ad-id="${ad.id}" title="Toggle Sound">
                                            <svg class="h-5 w-5" id="mute-icon-on-${ad.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l-2.25-2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                                            <svg class="h-5 w-5 hidden" id="mute-icon-off-${ad.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                                        </button>
                                    </div>
                                `;
                            }
                        } else if (ad.adType === 'image' && ad.imageUrl) {
                            adHtml = `<a href="${ad.link || '#'}" target="_blank" rel="noopener noreferrer"><img src="${ad.imageUrl}" alt="Advertisement" class="w-full h-auto rounded-lg" onerror="this.parentElement.style.display='none'"></a>`;
                        }
                        
                        adItem.innerHTML = adHtml;
                        scheduleList.appendChild(adItem);
                    }

                    // Automatic scrolling for bus route text
                    const busRouteTextWrapper = listItem.querySelector('.bus-route-text').parentElement; // This is the new overflow-hidden div
                    const busRouteTextElement = listItem.querySelector('.bus-route-text'); // This is the flex container
                    const marqueeContentSpan = busRouteTextElement.querySelector('.marquee-content'); // Get one of the content spans

                    if (marqueeContentSpan && busRouteTextWrapper) {
                        // Use setTimeout to ensure layout calculation is complete
                        setTimeout(() => {
                            const singleTextWidth = marqueeContentSpan.scrollWidth; // Width of one copy of the text
                            const containerWidth = busRouteTextWrapper.clientWidth;

                            // Use bus-specific marquee settings, or fall back to defaults
                            const currentMarqueeSpeed = bus.marqueeSpeedPxPerSec !== undefined ? bus.marqueeSpeedPxPerSec : DEFAULT_MARQUEE_SPEED_PX_PER_SEC;
                            const currentMarqueeDelay = bus.marqueeRepeatDelaySec !== undefined ? bus.marqueeRepeatDelaySec : DEFAULT_MARQUEE_REPEAT_DELAY_SEC;

                            // Only apply marquee if text is wider than container
                            if (singleTextWidth > containerWidth) {
                                // Add a second span for continuous loop if it doesn't exist
                                let secondMarqueeContent = busRouteTextElement.children[1];
                                if (!secondMarqueeContent) {
                                    secondMarqueeContent = document.createElement('span');
                                    secondMarqueeContent.className = 'marquee-content';
                                    secondMarqueeContent.setAttribute('aria-hidden', 'true'); // Hide from screen readers
                                    secondMarqueeContent.textContent = busRouteTextElement.dataset.originalRoute;
                                    busRouteTextElement.appendChild(secondMarqueeContent);
                                }

                                const gapPx = currentMarqueeDelay * currentMarqueeSpeed; // Distance traveled during the delay period

                                // The animation needs to move the combined content by the width of one text plus the gap
                                const totalScrollDistance = singleTextWidth + gapPx;
                                const animationDuration = totalScrollDistance / currentMarqueeSpeed;

                                busRouteTextElement.style.setProperty('--marquee-gap-px', `${gapPx}px`);
                                busRouteTextElement.style.setProperty('--marquee-distance', `-${totalScrollDistance}px`);
                                busRouteTextElement.style.animationDuration = `${animationDuration}s`;
                                busRouteTextElement.classList.add('scrolling-route');
                            } else {
                                // No need to scroll, remove animation classes/styles and ensure only one content span
                                busRouteTextElement.classList.remove('scrolling-route');
                                busRouteTextElement.style.animationDuration = '';
                                busRouteTextElement.style.removeProperty('--marquee-gap-px');
                                busRouteTextElement.style.removeProperty('--marquee-distance');
                                // Remove the duplicated span if it exists
                                if (busRouteTextElement.children.length > 1) {
                                    busRouteTextElement.removeChild(busRouteTextElement.children[1]);
                                }
                            }
                        }, 0); // Use 0ms timeout to defer execution until after render
                    }
                });
                
                // Initialize any new video players
                if (typeof YT !== 'undefined' && YT.Player) {
                    initializeVideoAds();
                }
            };

            const updateAndRenderSchedule = () => {
                if (!isAuthReady) return; 
                const liveBusData = calculateLiveBusData();
                let filteredBusData = filterAndSortBuses(liveBusData);
                renderSchedule(filteredBusData);
            };
            
            const updateLiveElements = () => {
                if (!isAuthReady) return;
                const liveBusData = calculateLiveBusData();
                let filteredBusData = filterAndSortBuses(liveBusData);

                filteredBusData.forEach(bus => {
                    const busElement = document.querySelector(`.bus-item[data-bus-id="${bus.id}"]`);
                    if (!busElement) return; // Element not on screen, skip it

                    // Update ETA Text
                    const etaElement = busElement.querySelector(`[data-eta-text-id="${bus.id}"]`);
                    if (etaElement) {
                        let arrivalText, arrivalColor, arrivalSize;
                            if (bus.isFinished) {
                                arrivalText = 'Completed';
                                arrivalColor = 'text-slate-500 font-semibold';
                                arrivalSize = 'text-xs';
                            } else if (bus.etaAtGoolikkadavu === null) {
                                arrivalText = 'N/A';
                                arrivalColor = 'text-slate-500 font-semibold';
                                arrivalSize = 'text-sm';
                            } else if (bus.etaAtGoolikkadavu < 0) {
                                arrivalText = 'Departed';
                                arrivalColor = 'text-slate-500 font-semibold';
                                arrivalSize = 'text-xs';
                            } else {
                                arrivalText = formatEta(bus.etaAtGoolikkadavu);
                                arrivalColor = bus.etaAtGoolikkadavu <= 10 ? 'text-red-600 font-bold' : 'text-slate-900 font-semibold';
                                arrivalSize = 'text-sm';
                            }
                        etaElement.textContent = arrivalText;
                        etaElement.className = `${arrivalColor} ${arrivalSize}`;
                    }
                    
                    // Update Live Dot Position
                    const liveDot = busElement.querySelector(`[data-live-dot-id="${bus.id}"]`);
                    if (liveDot) {
                        const timelineItems = busElement.querySelectorAll('.timeline-item');
                        const index = bus.liveIconPositionIndex;
                        const floorIndex = Math.min(Math.floor(index), timelineItems.length - 1);
                        const fraction = index - floorIndex;

                        if (timelineItems.length > floorIndex && floorIndex >= 0) {
                            const centerAlignmentOffset = 14; 
                            const floorItem = timelineItems[floorIndex];
                            const floorTop = floorItem.offsetTop + centerAlignmentOffset;
                            let topPosition = floorTop;
                            if (fraction > 0 && floorIndex < timelineItems.length - 1) {
                                const ceilItem = timelineItems[floorIndex + 1];
                                const ceilTop = ceilItem.offsetTop + centerAlignmentOffset;
                                topPosition = floorTop + (ceilTop - floorTop) * fraction;
                            }
                            liveDot.style.top = `${topPosition}px`;
                        }
                    }
                });
            };

            const calculateLiveBusData = () => {
                const currentTime = new Date();
                return allBuses.map(bus => {
                    const status = bus.status || { type: 'on-time', minutes: 0 };
                    let statusOffset = 0;
                    if (status.type === 'late') {
                        statusOffset = status.minutes * 60000;
                    } else if (status.type === 'early') {
                        statusOffset = -status.minutes * 60000;
                    }

                    if (!bus.stops || bus.stops.length === 0) {
                        return { ...bus, stops: [], etaAtGoolikkadavu: null, liveIconPositionIndex: 0, isFinished: true };
                    }
                    
                    const processedStops = bus.stops.map(stop => {
                        const actualArrivalTime = new Date(parseTime(stop.scheduledTime).getTime() + statusOffset);
                        const departureTime = new Date(actualArrivalTime.getTime() + (stop.waitingTime || 0) * 60000);
                        const isPassed = departureTime.getTime() < currentTime.getTime();
                        let stopArrivalText = `Scheduled ${formatTime(actualArrivalTime)}`;
                        if (isPassed) {
                            stopArrivalText = 'Departed';
                        } else if (actualArrivalTime.getTime() < currentTime.getTime()) {
                            stopArrivalText = 'Arrived';
                        }
                        return { ...stop, isPassed, stopArrivalText, actualArrivalTime, departureTime };
                    });

                    const goolikkadavuStop = processedStops.find(stop => stop.name === 'Goolikkadavu Jn');
                    let etaAtGoolikkadavu = null;
                    if (goolikkadavuStop) {
                        etaAtGoolikkadavu = Math.round((goolikkadavuStop.actualArrivalTime.getTime() - currentTime.getTime()) / 60000);
                    }

                    const isFinished = processedStops.every(stop => stop.isPassed);

                    let liveIconPositionIndex = 0;
                    const nextStopIndex = processedStops.findIndex(stop => !stop.isPassed);
                    
                    if (isFinished) {
                        liveIconPositionIndex = processedStops.length;
                    } else if (nextStopIndex > 0) {
                        const lastStop = processedStops[nextStopIndex - 1];
                        const currentNextStop = processedStops[nextStopIndex];
                        const lastStopDepartureTime = lastStop.departureTime.getTime();
                        const nextStopArrivalTime = currentNextStop.actualArrivalTime.getTime();
                        
                        if (currentTime.getTime() >= lastStop.actualArrivalTime.getTime() && currentTime.getTime() < lastStopDepartureTime) {
                            liveIconPositionIndex = nextStopIndex - 1;
                        } else {
                            const segmentDuration = nextStopArrivalTime - lastStopDepartureTime;
                            if (segmentDuration > 0) {
                                const progressInSegment = (currentTime.getTime() - lastStopDepartureTime) / segmentDuration;
                                liveIconPositionIndex = (nextStopIndex - 1) + Math.min(1, Math.max(0, progressInSegment));
                            } else {
                                liveIconPositionIndex = nextStopIndex - 1;
                            }
                        }
                    } else if (nextStopIndex === 0) {
                            const firstStop = processedStops[0];
                            const departureTime = parseTime(bus.stops[0].scheduledTime).getTime() + statusOffset;
                            const arrivalTime = firstStop.actualArrivalTime.getTime();
                            const segmentDuration = arrivalTime - departureTime;
                            if(segmentDuration > 0) {
                                   const progressInSegment = (currentTime.getTime() - departureTime) / segmentDuration;
                                   liveIconPositionIndex = progressInSegment;
                                   liveIconPositionIndex = Math.min(1, Math.max(0, liveIconPositionIndex));
                            } else {
                                   liveIconPositionIndex = 0;
                            }
                    }
                    
                    return { ...bus, stops: processedStops, etaAtGoolikkadavu, liveIconPositionIndex, isFinished };
                });
            };

            const filterAndSortBuses = (liveBusData) => {
                let filteredBusData = liveBusData;
                if (searchQuery) {
                    filteredBusData = filteredBusData.filter(bus => {
                        const busName = bus.busName.toLowerCase();
                        const origin = bus.origin.toLowerCase();
                        return busName.includes(searchQuery) || origin.includes(searchQuery);
                    });
                }
                
                if (currentFilter === 'live') {
                    filteredBusData = filteredBusData.filter(bus => !bus.isFinished);
                } else if (currentFilter !== 'all') {
                    filteredBusData = filteredBusData.filter(bus => 
                        bus.stops.some(stop => stop.name === currentFilter)
                    );
                }

                filteredBusData.sort((a, b) => {
                    const sortA = a.isFinished ? Infinity : a.etaAtGoolikkadavu;
                    const sortB = b.isFinished ? Infinity : b.etaAtGoolikkadavu;
                    const finalSortA = sortA === null ? Infinity - 1 : sortA;
                    const finalSortB = sortB === null ? Infinity - 1 : sortB;

                    if (finalSortA < finalSortB) return -1;
                    if (finalSortA > finalSortB) return 1;

                    const timeA = a.stops.length > 0 ? parseTime(a.stops[0].scheduledTime) : 0;
                    const timeB = b.stops.length > 0 ? parseTime(b.stops[0].scheduledTime) : 0;
                    return timeA - timeB;
                });
                return filteredBusData;
            };

            const renderAdminsList = () => {
                adminListContainer.innerHTML = '';
                if (!isSuperAdmin) {
                    adminListContainer.innerHTML = '<p class="text-red-500">You do not have permission to manage admins.</p>';
                    addAdminBtn.classList.add('hidden');
                    return;
                }
                addAdminBtn.classList.remove('hidden');

                if (allAdmins.length === 0) {
                    adminListContainer.innerHTML = '<p class="text-slate-500">No admin accounts found.</p>';
                    return;
                }

                allAdmins.forEach(admin => {
                    const permissionsSummary = Object.keys(admin.permissions || {})
                        .filter(key => admin.permissions[key])
                        .map(key => key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim())
                        .join(', ');

                    const profileImageHtml = admin.profileImageUrl ? 
                        `<img src="${admin.profileImageUrl}" alt="Profile" class="w-16 h-16 rounded-full object-cover mr-4" onerror="this.src='https://placehold.co/64x64/e2e8f0/475569?text=Admin'"/>` :
                        `<div class="w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xl font-bold mr-4">👤</div>`;

                    const adminElement = document.createElement('div');
                    adminElement.className = 'p-4 border rounded-lg flex items-center justify-between';
                    adminElement.innerHTML = `
                        <div class="flex items-center">
                            ${profileImageHtml}
                            <div>
                                <p class="font-semibold text-slate-800">${admin.name} (${admin.username})</p>
                                <p class="text-sm text-slate-600">Father: ${admin.fatherName || 'N/A'}</p>
                                <p class="text-sm text-slate-600">Contact: ${admin.contactNumber || 'N/A'}</p>
                                <p class="text-sm text-slate-600">Email: ${admin.email || 'N/A'}</p>
                                <p class="text-sm text-slate-600">Blood Group: ${admin.bloodGroup || 'N/A'}</p>
                                <p class="text-sm text-slate-600">Permissions: ${permissionsSummary || 'None'}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button data-admin-id="${admin.id}" class="edit-admin-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" title="Edit Admin">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            ${admin.username !== SUPER_ADMIN_USERNAME ? `
                            <button data-admin-id="${admin.id}" class="delete-admin-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" title="Delete Admin">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>` : ''}
                        </div>
                    `;
                    adminListContainer.appendChild(adminElement);
                });
            };

            const handleAddAdmin = async () => {
                if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
                const permissionOptions = Object.keys(DEFAULT_PERMISSIONS).map(key => {
                    const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
                    return `<div class="flex items-center"><input type="checkbox" name="permission_${key}" id="permission_${key}" class="h-4 w-4 text-sky-600 border-gray-300 rounded"><label for="permission_${key}" class="ml-2 text-sm text-slate-700">${label}</label></div>`;
                }).join('');

                const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}">${group}</option>`).join('');

                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" required></div>
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName"></div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber"></div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email"></div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                            <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                                <option value="">-- Select Blood Group --</option>
                                ${bloodGroupOptions}
                            </select>
                        </div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL (for now)</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg"></div>
                    </div>
                    <div class="mt-4"><p class="block text-left text-sm font-medium text-slate-700">Permissions:</p><div class="grid grid-cols-2 gap-2 mt-2">${permissionOptions}</div></div>
                `;
                try {
                    const data = await showModal('Add New Admin', formHtml, 'Add Admin');
                    const newPermissions = {};
                    Object.keys(DEFAULT_PERMISSIONS).forEach(key => {
                        newPermissions[key] = data[`permission_${key}`] === 'on';
                    });

                    // Ensure manageAdmins permission is only granted to Super Admin
                    if (!isSuperAdmin) {
                        newPermissions.manageAdmins = false;
                    }

                    const newAdmin = {
                        username: data.username,
                        password: data.password, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                        name: data.name,
                        fatherName: data.fatherName || '',
                        contactNumber: data.contactNumber || '',
                        email: data.email || '',
                        bloodGroup: data.bloodGroup || '',
                        profileImageUrl: data.profileImageUrl || '',
                        permissions: newPermissions
                    };
                    const docRef = await addDoc(adminsCollection, newAdmin);
                    showMessage("New admin added successfully.");
                    logAdminAction('ADD_ADMIN', `Added new admin: ${newAdmin.name} (${newAdmin.username})`, docRef.id, 'admin');
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add admin operation cancelled.");
                    } else {
                        console.error("Error adding admin:", error);
                        showMessage(`Error: Could not add admin. ${error.message}`);
                    }
                }
            };

            const handleEditAdmin = async (adminId) => {
                if (!isAdmin) { showMessage("Permission denied.", true); return; }
                const adminToEdit = allAdmins.find(a => a.id === adminId);
                if (!adminToEdit) { showMessage("Admin not found.", true); return; }

                const permissionOptions = Object.keys(DEFAULT_PERMISSIONS).map(key => {
                    const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
                    const isChecked = adminToEdit.permissions && adminToEdit.permissions[key] ? 'checked' : '';
                    const isDisabled = (adminToEdit.username === SUPER_ADMIN_USERNAME && key === 'manageAdmins') ? 'disabled' : ''; // Super Admin always has manageAdmins
                    return `<div class="flex items-center"><input type="checkbox" name="permission_${key}" id="permission_${key}" class="h-4 w-4 text-sky-600 border-gray-300 rounded" ${isChecked} ${isDisabled}><label for="permission_${key}" class="ml-2 text-sm text-slate-700">${label}</label></div>`;
                }).join('');

                const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}" ${adminToEdit.bloodGroup === group ? 'selected' : ''}>${group}</option>`).join('');

                const formHtml = `
                    <input type="hidden" name="id" value="${adminToEdit.id}">
                    <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded bg-slate-100" type="text" name="username" value="${adminToEdit.username}" readonly></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" value="${adminToEdit.password}" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" value="${adminToEdit.name}" required></div>
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName" value="${adminToEdit.fatherName || ''}"></div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber" value="${adminToEdit.contactNumber || ''}"></div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email" value="${adminToEdit.email || ''}"></div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                            <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                                <option value="">-- Select Blood Group --</option>
                                ${bloodGroupOptions}
                            </select>
                        </div>
                        <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL (for now)</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg" value="${adminToEdit.profileImageUrl || ''}"></div>
                    </div>
                    <div class="mt-4"><p class="block text-left text-sm font-medium text-slate-700">Permissions:</p><div class="grid grid-cols-2 gap-2 mt-2">${permissionOptions}</div></div>
                `;
                try {
                    const data = await showModal('Edit Admin', formHtml, 'Save Changes');
                    const updatedPermissions = {};
                    Object.keys(DEFAULT_PERMISSIONS).forEach(key => {
                        updatedPermissions[key] = data[`permission_${key}`] === 'on';
                    });

                    // Ensure Super Admin always has manageAdmins permission, even if unchecked in form
                    if (adminToEdit.username === SUPER_ADMIN_USERNAME) {
                        updatedPermissions.manageAdmins = true;
                    }

                    await updateDoc(doc(db, adminsCollection.path, adminId), {
                        password: data.password, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                        name: data.name,
                        fatherName: data.fatherName || '',
                        contactNumber: data.contactNumber || '',
                        email: data.email || '',
                        bloodGroup: data.bloodGroup || '',
                        profileImageUrl: data.profileImageUrl || '',
                        permissions: updatedPermissions
                    });
                    showMessage("Admin updated successfully.");
                    logAdminAction('EDIT_ADMIN', `Edited admin: ${adminToEdit.name} (${adminToEdit.username})`, adminId, 'admin');
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit admin operation cancelled.");
                    } else {
                        console.error("Error updating admin:", error);
                        showMessage(`Error: Could not update admin. ${error.message}`);
                    }
                }
            };

            const handleDeleteAdmin = async (adminId) => {
                if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
                const adminToDelete = allAdmins.find(a => a.id === adminId);
                if (!adminToDelete) { showMessage("Admin not found.", true); return; }

                if (adminToDelete.username === SUPER_ADMIN_USERNAME) {
                    showMessage("The Super Admin account cannot be deleted.", true);
                    return;
                }

                if (await showConfirmation(`Are you sure you want to delete admin "${adminToDelete.name}"? This action cannot be undone.`)) {
                    try {
                        await deleteDoc(doc(db, adminsCollection.path, adminId));
                        showMessage("Admin deleted successfully.");
                        logAdminAction('DELETE_ADMIN', `Deleted admin: ${adminToDelete.name} (${adminToDelete.username})`, adminId, 'admin');
                    }
                    catch (error) {
                        console.error("Error deleting admin:", error);
                        showMessage(`Error: Could not delete admin. ${error.message}`);
                    }
                }
            };
            
            const renderMyProfile = () => {
                myProfileContent.innerHTML = ''; // Clear previous content
                if (!currentAdmin) {
                    myProfileContent.innerHTML = '<p class="text-slate-500">Please log in to view your profile.</p>';
                    return;
                }

                const profileImageHtml = currentAdmin.profileImageUrl ?
                    `<img src="${currentAdmin.profileImageUrl}" alt="Profile" class="w-24 h-24 rounded-full object-cover mx-auto mb-4" onerror="this.src='https://placehold.co/96x96/e2e8f0/475569?text=Admin'"/>` :
                    `<div class="w-24 h-24 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-4xl font-bold mx-auto mb-4">👤</div>`;

                const permissionsListHtml = Object.keys(currentAdmin.permissions || {})
                    .filter(key => currentAdmin.permissions[key])
                    .map(key => {
                        const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
                        return `<li class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>${label}</li>`;
                    })
                    .join('');
                
                // Conditionally render clickable links, ensuring values are not empty strings
                const contactNumberHtml = (currentAdmin.contactNumber && String(currentAdmin.contactNumber).trim() !== '') ? `<a href="tel:${currentAdmin.contactNumber}" class="text-sky-600 hover:underline">${currentAdmin.contactNumber}</a>` : 'N/A';
                const emailHtml = (currentAdmin.email && String(currentAdmin.email).trim() !== '') ? `<a href="mailto:${currentAdmin.email}" class="text-sky-600 hover:underline">${currentAdmin.email}</a>` : 'N/A';

                let profileHtml = `
                    <div class="text-center">
                        ${profileImageHtml}
                        <h3 class="text-xl font-bold text-slate-900">${currentAdmin.name}</h3>
                        <p class="text-sm text-slate-600">@${currentAdmin.username}</p>
                    </div>
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                        <p class="text-sm text-slate-700"><strong>Father's Name:</strong> ${currentAdmin.fatherName || 'N/A'}</p>
                        <p class="text-sm text-slate-700"><strong>Contact Number:</strong> ${contactNumberHtml}</p>
                        <p class="text-sm text-slate-700"><strong>Email:</strong> ${emailHtml}</p>
                        <p class="text-sm text-slate-700"><strong>Blood Group:</strong> ${currentAdmin.bloodGroup || 'N/A'}</p>
                    </div>
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-md font-medium text-slate-800 mb-2">Permissions</h4>
                        <ul class="list-none p-0 m-0 text-sm text-slate-700">
                            ${permissionsListHtml || '<li class="text-slate-500">No specific permissions assigned.</li>'}
                        </ul>
                    </div>
                    <div class="mt-6 space-y-3">
                        <button id="edit-my-profile-btn" class="w-full btn btn-primary">Edit Profile</button>
                        <button id="change-my-password-btn" class="w-full btn btn-secondary">Change Password</button>
                    </div>
                `;
                myProfileContent.innerHTML = profileHtml;
            };

            const handleEditMyProfile = async () => {
                if (!currentAdmin) { showMessage("Not logged in as admin.", true); return; }

                const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}" ${currentAdmin.bloodGroup === group ? 'selected' : ''}>${group}</option>`).join('');

                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" value="${currentAdmin.name || ''}" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName" value="${currentAdmin.fatherName || ''}"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber" value="${currentAdmin.contactNumber || ''}"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email" value="${currentAdmin.email || ''}"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                        <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                            <option value="">-- Select Blood Group --</option>
                            ${bloodGroupOptions}
                        </select>
                    </div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg" value="${currentAdmin.profileImageUrl || ''}"></div>
                `;

                try {
                    const data = await showModal('Edit My Profile', formHtml, 'Save Changes');
                    await updateDoc(doc(db, adminsCollection.path, currentAdmin.id), {
                        name: data.name,
                        fatherName: data.fatherName || '',
                        contactNumber: data.contactNumber || '',
                        email: data.email || '',
                        bloodGroup: data.bloodGroup || '',
                        profileImageUrl: data.profileImageUrl || ''
                    });
                    showMessage("Profile updated successfully.");
                    logAdminAction('EDIT_MY_PROFILE', `Updated own profile details`, currentAdmin.id, 'admin');
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit profile cancelled.");
                    } else {
                        console.error("Error updating profile:", error);
                        showMessage(`Error updating profile: ${error.message}`, true);
                    }
                }
            };

            const handleChangeMyPassword = async () => {
                if (!currentAdmin) { showMessage("Not logged in as admin.", true); return; }

                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Old Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="oldPassword" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">New Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="newPassword" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Confirm New Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="confirmNewPassword" required></div>
                `;

                try {
                    const data = await showModal('Change Password', formHtml, 'Change Password');

                    if (data.oldPassword !== currentAdmin.password) { // WARNING: Plaintext comparison
                        showMessage("Old password is incorrect.", true);
                        return;
                    }
                    if (data.newPassword !== data.confirmNewPassword) {
                        showMessage("New passwords do not match.", true);
                        return;
                    }
                    if (data.newPassword.length < 6) {
                        showMessage("New password must be at least 6 characters long.", true);
                        return;
                    }

                    await updateDoc(doc(db, adminsCollection.path, currentAdmin.id), {
                        password: data.newPassword // WARNING: Plaintext update
                    });
                    showMessage("Password changed successfully.");
                    logAdminAction('CHANGE_MY_PASSWORD', `Changed own password`, currentAdmin.id, 'admin');
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Change password cancelled.");
                    } else {
                        console.error("Error changing password:", error);
                        showMessage(`Error changing password: ${error.message}`, true);
                    }
                }
            };

            const renderAuditLogs = () => {
                auditLogsList.innerHTML = '';
                if (!currentAdminPermissions.viewAuditLogs) {
                    auditLogsList.innerHTML = '<p class="text-red-500">You do not have permission to view audit logs.</p>';
                    return;
                }

                if (allAuditLogs.length === 0) {
                    auditLogsList.innerHTML = '<p class="text-slate-500">No audit logs available.</p>';
                    return;
                }

                const logsHtml = allAuditLogs.map(log => {
                    const timestamp = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                    return `
                        <div class="p-3 border rounded-lg bg-slate-50">
                            <p class="text-xs text-slate-500">${timestamp}</p>
                            <p class="text-sm text-slate-800"><strong>${log.adminName || 'Unknown Admin'}</strong>: ${log.details}</p>
                            ${log.entityType ? `<p class="text-xs text-slate-600">Entity: ${log.entityType} (ID: ${log.entityId})</p>` : ''}
                        </div>
                    `;
                }).join('');
                auditLogsList.innerHTML = logsHtml;
            };

            const setupEventListeners = () => {
                // Use event delegation on the document for all clicks
                document.addEventListener('click', async (e) => {
                    const target = e.target;
                    const button = target.closest('button');
                    const navLink = target.closest('.nav-link');
                    const header = target.closest('.bus-header');
                    const filterOption = target.closest('.filter-option');

                    // Sidebar controls
                    if (target.closest('#menu-btn')) openSidebar();
                    if (target.id === 'sidebar-overlay') closeSidebar();
                    if (navLink) {
                        e.preventDefault();
                        const pageId = navLink.dataset.page || (navLink.id ? navLink.id.replace('-link', '') : null);
                        if (pageId === 'admin-logout') logout();
                        else if (pageId === 'admin-login') login(false); // Regular admin login
                        else if (pageId === 'super-admin-login') login(true); // Office login (formerly Super Admin)
                        else if (pageId === 'manage-stops') showManageStopsModal();
                        else if (pageId) showPage(pageId);
                    }

                    // Filter Dropdown options
                    if (filterOption) {
                            e.preventDefault();
                            const filterValue = filterOption.dataset.filter;
                            if (filterValue === 'select-stop') {
                                if (isSuperAdmin && currentAdminPermissions.manageStops) showManageStopsModal();
                                else showStopFilterModal(); // Non-admin users or admins without manageStops permission see this
                            } else {
                                currentFilter = filterValue;
                                updateAndRenderSchedule();
                                updateFilterDropdown();
                            }
                            filterDropdown.classList.add('hidden');
                    }

                    // Main page controls
                    if (button) {
                        // Mute button
                        if (button.matches('.mute-btn')) {
                            const adId = button.dataset.adId;
                            const player = videoPlayers[adId];
                            if (player && typeof player.isMuted === 'function') {
                                const onIcon = document.getElementById(`mute-icon-on-${adId}`);
                                const offIcon = document.getElementById(`mute-icon-off-${adId}`);
                                if (player.isMuted()) {
                                    player.unMute();
                                    onIcon.classList.add('hidden');
                                    offIcon.classList.remove('hidden');
                                } else {
                                    player.mute();
                                    onIcon.classList.remove('hidden');
                                    offIcon.classList.add('hidden');
                                }
                            }
                        }
                        
                        // Home page buttons
                        if (button.id === 'add-bus-btn') handleAddBus(); // Permission check inside function
                        if (button.id === 'filter-btn') {
                            e.stopPropagation();
                            filterDropdown.classList.toggle('hidden');
                        }
                        
                        // Bus item admin buttons
                        const busId = button.dataset.busId;
                        if (busId) {
                            const stopIndex = parseInt(button.dataset.stopIndex, 10);
                            if (button.matches('.edit-bus-btn')) handleEditBus(busId); // Permission check inside function
                            else if (button.matches('.delete-bus-btn')) {
                                if (!isAdmin) { showMessage("Permission denied.", true); return; }
                                if (await showConfirmation("This will permanently delete the entire bus route. This action cannot be undone.")) {
                                    await deleteDoc(doc(db, busCollection.path, busId));
                                    showMessage("Bus route deleted.");
                                    const bus = allBuses.find(b => b.id === busId);
                                    logAdminAction('DELETE_BUS', `Deleted bus route: ${bus.busNumber} (${bus.origin} to ${bus.destination})`, busId, 'bus');
                                }
                            }
                            else if (button.matches('.duplicate-bus-btn')) handleDuplicateBus(busId); // Permission check inside function
                            else if (button.matches('.add-stop-btn')) handleAddStop(busId); // Permission check inside function
                            else if (button.matches('.edit-stop-btn')) handleEditStop(busId, stopIndex); // Permission check inside function
                            else if (button.matches('.delete-stop-btn')) {
                                if (!isAdmin) { showMessage("Permission denied.", true); return; }
                                if (await showConfirmation("This will remove the stop from the route. Are you sure?")) {
                                    const bus = allBuses.find(b => b.id === busId);
                                    const stopName = bus.stops[stopIndex].name;
                                    const newStops = [...bus.stops];
                                    newStops.splice(stopIndex, 1);
                                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                                    showMessage("Stop removed.");
                                    logAdminAction('DELETE_STOP', `Removed stop "${stopName}" from bus ${bus.busNumber}`, busId, 'bus_stop');
                                }
                            }
                            else if (button.matches('.update-status-btn')) handleUpdateStatus(busId); // Permission check inside function
                        }

                        // Modal buttons
                        if (button.id === 'modal-save') {
                            const editForm = document.getElementById('edit-form');
                            if (editForm.checkValidity()) {
                                const formData = new FormData(editForm);
                                let data = Object.fromEntries(formData.entries());
                                if(data.busNumber === 'custom') data.busNumber = data.custom_busNumber;
                                if(data.origin === 'custom') data.origin = data.custom_origin;
                                if(data.destination === 'custom') data.destination = data.custom_destination;
                                if(data.name === 'custom') data.name = data.custom_name;
                                ['custom_busNumber', 'custom_origin', 'custom_destination', 'custom_name'].forEach(key => delete data[key]);
                                if (modalResolve) modalResolve(data);
                                hideModal();
                            } else {
                                editForm.reportValidity();
                            }
                        }
                        if (button.id === 'modal-cancel') {
                            if (modalReject) modalReject(new Error("Modal cancelled by user."));
                            hideModal();
                        }
                        if (button.id === 'confirm-cancel-btn') document.getElementById('confirmation-modal').classList.add('hidden');
                        if (button.id === 'stop-filter-cancel') hideStopFilterModal();
                        if (button.id === 'manage-stops-close-btn') hideManageStopsModal();
                        
                        // Other page buttons
                        if (button.id === 'calculate-fare-btn') calculateAndDisplayFare();
                        if (button.id === 'save-fares-btn') handleSaveFares(); // Permission check inside function
                        if (button.id === 'download-csv-btn') handleDownloadCSV(); // Permission check inside function
                        if (button.id === 'upload-csv-btn') document.getElementById('csv-upload-input').click(); // Permission check inside function
                        if (button.id === 'publish-announcement-btn') {
                            if (!currentAdminPermissions.manageAnnouncements) { showMessage("Permission denied.", true); return; }
                            const text = document.getElementById('announcement-input').value.trim();
                            if (text) {
                                await setDoc(announcementDocRef, { text: text, active: true });
                                showMessage("Announcement published.");
                                document.getElementById('announcement-input').value = '';
                                logAdminAction('PUBLISH_ANNOUNCEMENT', `Published announcement: "${text}"`);
                            }
                        }
                        if (button.id === 'clear-announcement-btn') {
                            if (!currentAdminPermissions.manageAnnouncements) { showMessage("Permission denied.", true); return; }
                            await setDoc(announcementDocRef, { text: '', active: false });
                            showMessage("Announcement cleared.");
                            logAdminAction('CLEAR_ANNOUNCEMENT', `Cleared active announcement.`);
                        }
                        if (button.matches('.remove-ad-btn')) {
                            if (!currentAdminPermissions.manageAds) { showMessage("Permission denied.", true); return; }
                            const adId = button.dataset.adId;
                            const ad = allAds.find(a => a.id === adId);
                            if (await showConfirmation("Are you sure you want to remove this advertisement?")) {
                                await deleteDoc(doc(db, adsCollection.path, adId));
                                showMessage("Advertisement removed successfully.");
                                logAdminAction('DELETE_AD', `Removed ad (Type: ${ad.adType}, Position: ${ad.position})`, adId, 'ad');
                           }
                        }
                        if (button.id === 'add-filter-stop-btn') {
                            if (!currentAdminPermissions.manageStops) { showMessage("Permission denied.", true); return; }
                            const addStopSelect = document.getElementById('add-stop-select');
                            const customInput = document.getElementById('custom-filter-stop-input');
                            let stopToAdd = addStopSelect.value === 'custom' ? customInput.value.trim() : addStopSelect.value;
                            if (stopToAdd && !filterableStops.includes(stopToAdd)) {
                                const newStops = [...new Set([...filterableStops, stopToAdd])].sort();
                                await setDoc(filterStopsDocRef, { stops: newStops });
                                showMessage(`Added "${stopToAdd}" to filters.`);
                                logAdminAction('ADD_FILTER_STOP', `Added "${stopToAdd}" to filterable stops.`, null, 'filter_stop');
                                showManageStopsModal();
                            } else if (!stopToAdd) {
                                showMessage("Please select or enter a stop name.");
                            } else {
                                showMessage(`"${stopToAdd}" is already in the filter list.`);
                            }
                        }
                        if (button.matches('.remove-filter-stop-btn')) {
                            if (!currentAdminPermissions.manageStops) { showMessage("Permission denied.", true); return; }
                            const stopName = button.dataset.stopName;
                            const newStops = filterableStops.filter(s => s !== stopName);
                            await setDoc(filterStopsDocRef, { stops: newStops });
                            showMessage(`Removed "${stopName}" from filters.`);
                            logAdminAction('REMOVE_FILTER_STOP', `Removed "${stopName}" from filterable stops.`, null, 'filter_stop');
                            showManageStopsModal();
                        }
                        // Admin management buttons
                        if (button.id === 'add-admin-btn') handleAddAdmin(); // Permission check inside function
                        if (button.matches('.edit-admin-btn')) handleEditAdmin(button.dataset.adminId); // Permission check inside function
                        if (button.matches('.delete-admin-btn')) handleDeleteAdmin(button.dataset.adminId); // Permission check inside function
                        // My Profile buttons
                        if (button.id === 'edit-my-profile-btn') handleEditMyProfile();
                        if (button.id === 'change-my-password-btn') handleChangeMyPassword();
                    }
                    
                    // Bus header click for accordion
                    if (header && !button) {
                        const busId = header.dataset.busId;
                        openDropdownId = openDropdownId === busId ? null : busId;
                        updateAndRenderSchedule();
                    }
                });

                // Form Submissions
                document.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    if (form.id === 'ad-form') {
                        if (!currentAdminPermissions.manageAds) { showMessage("Permission denied.", true); return; }
                        const adType = form.querySelector('#ad-type-select').value;
                        const position = form.querySelector('#ad-position-input').value;
                        let newAd = { position: Number(position), adType };
                        
                        if (adType === 'image') {
                            newAd.imageUrl = form.querySelector('#ad-image-url-input').value.trim();
                            newAd.link = form.querySelector('#ad-link-input').value.trim();
                            if (!newAd.imageUrl) {
                                showMessage("Image URL is required for an image ad.", true);
                                return;
                            }
                        } else { // video
                            newAd.videoUrl = form.querySelector('#ad-video-url-input').value.trim();
                            if (!newAd.videoUrl) {
                                showMessage("Video URL is required for a video ad.", true);
                                return;
                            }
                        }

                        if (!newAd.position) {
                            showMessage("Position is a required field.", true);
                            return;
                        }

                        const docRef = await addDoc(adsCollection, newAd);
                        showMessage("Advertisement published.");
                        form.reset();
                        // Manually trigger the change event to reset the form view
                        document.getElementById('ad-type-select').dispatchEvent(new Event('change'));
                        logAdminAction('PUBLISH_AD', `Published new ad (Type: ${newAd.adType}, Position: ${newAd.position})`, docRef.id, 'ad');
                    }
                    if (form.id === 'about-form') {
                        if (!currentAdminPermissions.manageAbout) { showMessage("Permission denied.", true); return; }
                        await setDoc(aboutDocRef, { html: quill.root.innerHTML });
                        showMessage("About page updated.");
                        logAdminAction('UPDATE_ABOUT_PAGE', `Updated "About Us" page content.`);
                    }
                    if (form.id === 'contact-form') {
                        if (!currentAdminPermissions.manageContact) { showMessage("Permission denied.", true); return; }
                        const email = form.querySelector('#edit-contact-email').value;
                        const phone = form.querySelector('#edit-contact-phone').value;
                        const address = form.querySelector('#edit-contact-address').value;
                        await setDoc(contactDocRef, { email, phone, address });
                        showMessage("Contact details updated.");
                        logAdminAction('UPDATE_CONTACT_INFO', `Updated contact information (Email: ${email}, Phone: ${phone}).`);
                    }
                });

                // Other specific input listeners
                searchBar.addEventListener('input', (e) => {
                    searchQuery = e.target.value.toLowerCase();
                    updateAndRenderSchedule();
                });

                document.getElementById('manage-fares-bus-select').addEventListener('change', (e) => {
                    renderFareMatrix(e.target.value);
                });
                
                document.getElementById('ad-type-select').addEventListener('change', (e) => {
                    const adType = e.target.value;
                    const imageInputs = document.getElementById('ad-image-inputs');
                    const videoInputs = document.getElementById('ad-video-inputs');
                    const imageUrlInput = document.getElementById('ad-image-url-input');
                    const videoUrlInput = document.getElementById('ad-video-url-input');

                    if (adType === 'image') {
                        imageInputs.classList.remove('hidden');
                        videoInputs.classList.add('hidden');
                        imageUrlInput.required = true;
                        videoUrlInput.required = false;
                    } else {
                        imageInputs.classList.add('hidden');
                        videoInputs.classList.remove('hidden');
                        imageUrlInput.required = false;
                        videoUrlInput.required = true;
                    }
                });
            };

            const initializeAppAndData = async () => {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                try {
                    analytics = getAnalytics(app);
                } catch (e) {
                    console.log("Analytics not available in this environment.");
                }

                // Define collections and document references
                const publicDataPath = `artifacts/${appId}/public/data`;
                busCollection = collection(db, `${publicDataPath}/buses`);
                configDocRef = doc(db, `${publicDataPath}/config/predefined`);
                filterStopsDocRef = doc(db, `${publicDataPath}/config/filterStops`);
                contactDocRef = doc(db, `${publicDataPath}/config/contact`);
                aboutDocRef = doc(db, `${publicDataPath}/config/about`);
                announcementDocRef = doc(db, `${publicDataPath}/config/announcement`);
                adsCollection = collection(db, `${publicDataPath}/advertisements`);
                adminsCollection = collection(db, `${publicDataPath}/admins`);
                auditLogsCollection = collection(db, `${publicDataPath}/auditLogs`); // New: Audit Logs collection

                onAuthStateChanged(auth, (user) => {
                    unsubscribeListeners.forEach(unsub => unsub());
                    unsubscribeListeners = [];

                    if (user) {
                        currentUserId = user.uid;
                        console.log("Authenticated User ID:", currentUserId);
                        
                        // Listen to admins collection to update currentAdmin and permissions
                        const unsubAdmins = onSnapshot(adminsCollection, (snapshot) => {
                            allAdmins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            // If an admin was logged in, try to find their updated data
                            if (currentAdmin) {
                                const updatedAdmin = allAdmins.find(a => a.username === currentAdmin.username);
                                if (updatedAdmin) {
                                    currentAdmin = updatedAdmin;
                                    currentAdminPermissions = updatedAdmin.permissions || {};
                                } else {
                                    // Current admin was deleted from Firestore
                                    logout();
                                }
                            }
                            checkAdminStatus(); // Re-evaluate admin status and render controls
                            renderAdminsList(); // Re-render admin list if on that page
                        });
                        unsubscribeListeners.push(unsubAdmins);

                        const unsubConfig = onSnapshot(configDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const configData = docSnap.data();
                                predefinedBusNames = configData.busNames || [];
                                predefinedStops = configData.stops || [];
                                // No longer update global marquee settings from config, as they are now per-bus
                            }
                        });
                        unsubscribeListeners.push(unsubConfig);

                        const unsubBuses = onSnapshot(busCollection, (snapshot) => {
                            allBuses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            if (!isAuthReady) {
                                isAuthReady = true;
                                addSampleDataIfNeeded(); // This will also initialize Super Admin if needed
                            }
                            updateAndRenderSchedule();
                            const activePageId = document.querySelector('#page-container > div:not(.hidden)')?.id.replace('-page', '');
                            if (activePageId === 'manage-fares') populateManageFaresBusSelect();
                            if (activePageId === 'fare-calculator') populateFareCalculatorStops();
                        }, (error) => {
                            console.error("Error fetching bus data:", error);
                            setStatus("Error loading schedule. Please check connection.", true);
                        });
                        unsubscribeListeners.push(unsubBuses);

                        const unsubAds = onSnapshot(adsCollection, (snapshot) => {
                            allAds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderAdsList();
                            updateAndRenderSchedule();
                        });
                        unsubscribeListeners.push(unsubAds);

                        const unsubAnnouncements = onSnapshot(announcementDocRef, (docSnap) => {
                            const textEl = document.getElementById('announcement-text');
                            const bannerEl = document.getElementById('announcement-banner');
                            if (docSnap.exists() && docSnap.data().active && docSnap.data().text) {
                                const text = docSnap.data().text;
                                textEl.textContent = text;
                                bannerEl.classList.remove('hidden');

                                setTimeout(() => {
                                    if (textEl.scrollWidth > bannerEl.clientWidth) {
                                        textEl.classList.add('scrolling');
                                        const duration = textEl.scrollWidth / 40; 
                                        textEl.style.animationDuration = `${duration}s`;
                                    } else {
                                        textEl.classList.remove('scrolling');
                                        textEl.style.animationDuration = '';
                                        textEl.style.removeProperty('--scroll-end-position');
                                    }
                                }, 100);

                                if (isAdmin && currentAdminPermissions.manageAnnouncements) {
                                    document.getElementById('current-announcement-container').textContent = text;
                                }
                            } else {
                                bannerEl.classList.add('hidden');
                                textEl.classList.remove('scrolling');
                                if (isAdmin && currentAdminPermissions.manageAnnouncements) {
                                    document.getElementById('current-announcement-container').textContent = 'No active announcement.';
                                }
                            }
                        });
                        unsubscribeListeners.push(unsubAnnouncements);

                        const unsubFilters = onSnapshot(filterStopsDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                filterableStops = docSnap.data().stops || [];
                            } else {
                                filterableStops = [];
                            }
                            updateFilterDropdown();
                        });
                        unsubscribeListeners.push(unsubFilters);

                        const unsubContact = onSnapshot(contactDocRef, (docSnap) => {
                            const contactInfoContainer = document.getElementById('contact-info-container');
                            const editContactEmail = document.getElementById('edit-contact-email');
                            const editContactPhone = document.getElementById('edit-contact-phone');
                            const editContactAddress = document.getElementById('edit-contact-address');

                            if (docSnap.exists()) {
                                const contact = docSnap.data();
                                contactInfoContainer.innerHTML = `
                                    <p>For inquiries, feedback, or support, please reach out to us:</p>
                                    <p><strong>Makkal Raja Transport Corporation</strong></p>
                                    <p>Email: <a href="mailto:${contact.email}" class="text-sky-600 hover:underline">${contact.email}</a></p>
                                    <p>Phone: <a href="tel:${contact.phone}" class="text-sky-600 hover:underline">${contact.phone}</a></p>
                                    <p>Address: ${contact.address}</p>
                                `;
                                if (isAdmin && currentAdminPermissions.manageContact) {
                                    editContactEmail.value = contact.email;
                                    editContactPhone.value = contact.phone;
                                    editContactAddress.value = contact.address;
                                }
                            }
                        });
                        unsubscribeListeners.push(unsubContact);

                        const unsubAbout = onSnapshot(aboutDocRef, (docSnap) => {
                            const aboutContentContainer = document.getElementById('about-content-container');
                            if (docSnap.exists()) {
                                const about = docSnap.data();
                                aboutContentContainer.innerHTML = about.html;
                                if (quill && isAdmin && currentAdminPermissions.manageAbout) {
                                    quill.root.innerHTML = about.html;
                                }
                            }
                        });
                        unsubscribeListeners.push(unsubAbout);

                        // New: Listener for Audit Logs
                        const unsubAuditLogs = onSnapshot(query(auditLogsCollection, orderBy('timestamp', 'desc')), (snapshot) => {
                            allAuditLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderAuditLogs(); // Re-render audit logs whenever they change
                        });
                        unsubscribeListeners.push(unsubAuditLogs);

                    } else {
                        console.log("User is signed out.");
                        currentAdmin = null;
                        currentAdminPermissions = {};
                        isAdmin = false;
                        isSuperAdmin = false;
                        isAuthReady = false; // Reset auth ready flag on sign out
                        setStatus("Authenticating...", false);
                        renderAuthControls(); // Ensure controls are updated for signed out state
                        updateAndRenderSchedule(); // Re-render schedule for public view
                        renderAuditLogs(); // Clear audit logs on logout
                    }
                });

                try {
                    console.log("Attempting to sign in...");
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Firebase connection successful with custom token!");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase connection successful anonymously!");
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    setStatus("Could not connect to the server. Check console for details.", true);
                }
            };

            // --- Start the App ---
            try {
                // This function is called by the YouTube API script once it's loaded
                window.onYouTubeIframeAPIReady = () => {
                    initializeVideoAds();
                };
                
                setupEventListeners();
                initializeAppAndData();
                // checkAdminStatus() is now called within onAuthStateChanged and admin collection snapshot
                // No longer needed here as it depends on currentAdmin state which is managed by listeners

                // Handle initial page load based on URL hash
                const initialPage = window.location.hash.substring(1) || 'home';
                showPage(initialPage, true); // Show page without pushing state
                history.replaceState({ pageId: initialPage }, '', `#${initialPage}`); // Set initial state
                
                window.addEventListener('popstate', (event) => {
                    const pageId = (event.state && event.state.pageId) || 'home';
                    showPage(pageId, true);
                });

                // Set an interval to only update live elements, not the whole schedule
                setInterval(updateLiveElements, 1000); // Changed from 10000 to 1000 for faster updates
            } catch(e) {
                console.error("A critical error occurred on startup:", e);
                setStatus("An unexpected error occurred. Please refresh the page.", true);
            }
        });
    </script>
</body>
</html>
