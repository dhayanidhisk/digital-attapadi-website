<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Attappadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            /* Primary brand blues */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #0ea5e9;
            /* header light blue */
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-900: #0b2548;

            /* Accent / success (greens) */
            --secondary-50: #ecfdf5;
            --secondary-100: #d1fae5;
            --secondary-500: #10b981;
            --secondary-600: #059669;

            /* Neutral greys */
            --slate-100: #f3f4f6;
            --slate-200: #e5e7eb;
            --slate-300: #d1d5db;
            --slate-400: #9ca3af;
            --slate-500: #6b7280;
            --slate-600: #4b5563;
            --slate-700: #374151;
            --slate-800: #1f2933;
            --slate-900: #111827;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--slate-100);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--slate-200);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--slate-400);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--slate-500);
        }

        /* General Button Style */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            /* Match header sky-blue tone */
            background-color: #0284c7;
            /* tailwind sky-600 */
            color: white;
            border-radius: 9999px;
            letter-spacing: 0.01em;
        }

        .btn-primary:hover {
            background-color: #0369a1;
            /* tailwind sky-700 */
            box-shadow: 0 4px 8px -2px rgba(3, 105, 161, 0.4);
        }

        .btn-danger {
            background-color: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .btn-secondary {
            background-color: var(--slate-200);
            color: var(--slate-800);
        }

        .btn-secondary:hover {
            background-color: var(--slate-300);
        }

        /* Timeline Styles */
        .timeline-wrapper {
            position: relative;
        }

        .timeline-item {
            position: relative;
            padding-left: 2.5rem;
            padding-bottom: 2rem;
        }

        .timeline-item:not(:last-of-type)::after {
            content: '';
            position: absolute;
            left: calc(1.5rem - 1px);
            top: 1.75rem;
            bottom: -2rem;
            width: 2px;
            background-color: var(--slate-200);
            z-index: 0;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.1875rem;
            top: 1rem;
            height: 0.75rem;
            width: 0.75rem;
            background-color: white;
            border: 2px solid var(--slate-300);
            border-radius: 9999px;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .timeline-item.passed::before {
            background-color: var(--primary-600);
            border-color: var(--primary-600);
        }

        .timeline-item.passed:not(:last-of-type)::after {
            background-color: var(--primary-600);
        }

        .stop-name {
            color: var(--slate-700);
            font-weight: 600;
        }

        .timeline-item.passed .stop-name {
            color: var(--slate-400);
            font-weight: 500;
            text-decoration: line-through;
        }

        /* Live Dot Animation */
        .live-dot-icon {
            position: absolute;
            width: 1rem;
            height: 1rem;
            background-color: var(--primary-500);
            border-radius: 9999px;
            z-index: 10;
            transition: top 2s linear;
            left: 1.0625rem;
            top: -0.25rem;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(14, 165, 233, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);
            }
        }

        /* Sidebar & Navigation */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }

        #sidebar.open {
            transform: translateX(0);
        }

        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
            backdrop-filter: blur(4px);
        }

        .nav-link {
            transition: all 0.2s ease-in-out;
        }

        .nav-link.active {
            background-color: var(--primary-50);
            color: var(--primary-700);
            font-weight: 700;
        }

        .nav-link.active svg {
            color: var(--primary-500);
        }

        /* Align common blue text/icon utilities with header light blue */
        .text-sky-600,
        .text-blue-600 {
            color: var(--primary-500) !important;
        }

        .text-sky-500,
        .text-blue-500 {
            color: var(--primary-500) !important;
        }

        /* New: Make Sidebar navigation scrollable */
        #sidebar-nav {
            height: calc(100% - 70px);
            /* Adjust height for header */
            overflow-y: auto;
        }

        /* Bus Card Expansion */
        .bus-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
        }

        .bus-details.open {
            max-height: 1000px;
            /* A large enough value to accommodate content */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        /* Spinner */
        .spinner {
            border-top-color: var(--primary-600);
            animation: spin 1s linear infinite;
        }

        /* New: Make long forms inside modals scrollable */
        #edit-form {
            max-height: 65vh;
            /* Limit height to 65% of the screen */
            overflow-y: auto;
            /* Add scrollbar if content overflows */
            padding-right: 0.75rem;
            /* Add space for the scrollbar */
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Quill Editor */
        #editor-container {
            height: 250px;
        }

        .ql-toolbar.ql.snow {
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .ql-container.ql.snow {
            border-radius: 0 0 0.5rem 0.5rem;
        }

        /* Fare Matrix Table */
        .fare-matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .fare-matrix-table th,
        .fare-matrix-table td {
            border: 1px solid var(--slate-200);
            padding: 0.5rem;
            text-align: center;
        }

        .fare-matrix-table th {
            background-color: var(--slate-100);
        }

        .fare-matrix-table .header-cell {
            font-weight: 600;
            color: var(--slate-600);
        }

        .fare-matrix-table .disabled-cell {
            background-color: var(--slate-100);
        }

        /* Announcement Banner */
        #announcement-banner {
            overflow: hidden;
            white-space: nowrap;
            text-align: center;
        }

        #announcement-text.scrolling {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
        }

        @keyframes marquee {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .video-ad-container {
            position: relative;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            /* 16:9 aspect ratio */
            height: 0;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
            /* Ensures the iframe corners are clipped */
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .mute-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 9999px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* New CSS for single line origin/destination with horizontal scroll */
        .bus-route-text {
            display: flex;
            /* Make it a flex container for its content spans */
            white-space: nowrap;
            /* Keep content on a single line */
            animation: marquee-route linear infinite;
            /* Initial position will be handled by keyframes */
        }

        /* This is the actual content that will scroll */
        .bus-route-text .marquee-content {
            flex-shrink: 0;
            /* Prevent content from shrinking */
            padding-right: var(--marquee-gap-px);
            /* Add a gap between repetitions */
        }

        /* Hide scrollbar for Webkit browsers (Chrome, Safari) */
        .bus-route-text::-webkit-scrollbar {
            display: none;
        }

        @keyframes marquee-route {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(var(--marquee-distance));
            }
        }

        /* Ensure bus-header clips overflowing content */
        .bus-header {
            overflow: hidden;
            /* This is the key change */
        }
    </style>
</head>

<body class="flex justify-center">

    <div id="app-container" class="w-full max-w-md bg-white min-h-screen shadow-2xl">
        <header class="bg-gradient-to-r from-sky-600 to-cyan-500 sticky top-0 z-20 p-4 text-white shadow-lg">
            <div class="flex justify-between items-center">
                <div class="w-16">
                    <button id="menu-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
                <div class="text-center">
                    <h1 class="text-2xl font-extrabold tracking-tight">Digital Attappadi</h1>
                    <p class="text-xs text-sky-100 opacity-90">Makkal Raja Transport Corporation</p>
                </div>
                <div class="w-16 flex justify-end">
                    <button id="notification-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors relative"
                        title="Enable Notifications">
                        <!-- Bell Icon (Default/Outline) -->
                        <svg id="notif-icon-outline" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <!-- Bell Icon (Solid/Active) - Hidden by default -->
                        <svg id="notif-icon-solid" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden"
                            viewBox="0 0 20 20" fill="currentColor">
                            <path
                                d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
                        </svg>
                        <!-- Bell Icon (Slash/Blocked) - Hidden by default -->
                        <svg id="notif-icon-off" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9M1 1l22 22" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <div id="announcement-banner"
            class="hidden bg-blue-100 border-b-2 border-blue-300 text-blue-800 text-sm font-medium p-2">
            <p id="announcement-text"></p>
        </div>


        <div id="page-container">
            <div id="home-page">
                <div class="p-4 bg-slate-50 border-b border-slate-200">
                    <div class="flex items-center">
                        <div class="relative flex-grow max-w-full">
                            <div class="flex rounded-full shadow-sm bg-white border border-slate-200">
                                <div class="flex items-center pl-4 pr-2 text-slate-400">
                                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <input type="text" id="search-bar"
                                    class="flex-grow min-w-0 px-2 py-2.5 text-sm border-0 focus:ring-0 focus:outline-none placeholder-slate-400"
                                    placeholder="Search by bus name or origin...">
                                <div class="relative flex items-center">
                                    <button id="filter-btn"
                                        class="h-full px-3 border-l border-slate-200 bg-slate-50 hover:bg-slate-100 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M4 5h16M7 12h10M10 19h4" />
                                        </svg>
                                    </button>
                                    <div id="filter-dropdown"
                                        class="hidden absolute right-0 top-full mt-2 w-52 bg-white rounded-xl shadow-xl z-10 py-1 ring-1 ring-black ring-opacity-5">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <main id="schedule-list" class="divide-y divide-slate-200">
                    <div id="status-message" class="p-8 text-center text-slate-500">
                        <div class="flex flex-col justify-center items-center">
                            <div class="spinner h-8 w-8 border-4 border-slate-200 rounded-full"></div>
                            <span class="ml-3 mt-3">Initializing...</span>
                        </div>
                    </div>
                </main>

                <div id="add-bus-container" class="p-4 hidden sticky bottom-0 bg-white border-t border-slate-200">
                    <button id="add-bus-btn" class="w-full btn btn-primary">Add New Bus</button>
                </div>
            </div>

            <div id="fare-calculator-page" class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)]">
                <div class="max-w-md mx-auto">
                    <div class="bg-white rounded-2xl shadow-md border border-slate-200 px-5 py-6 mb-4">
                        <h2
                            class="text-3xl font-extrabold mb-2 text-center text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-blue-700">
                            Fare Calculator</h2>
                        <p class="text-slate-500 text-sm mb-8 text-center">Plan your journey and check ticket prices
                            effortlessly.</p>

                        <div class="space-y-6">
                            <div>
                                <label for="fare-from-stop"
                                    class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">From</label>
                                <div class="relative group">
                                    <div
                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none transition-colors group-hover:text-sky-600">
                                        <!-- From: departure pin icon -->
                                        <svg class="h-5 w-5 text-slate-400 group-hover:text-sky-500 transition-colors"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </div>
                                    <select id="fare-from-stop"
                                        class="block w-full pl-10 pr-10 py-3 rounded-xl border border-slate-200 bg-slate-50 text-sm font-medium text-slate-700 shadow-sm focus:bg-white focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-all appearance-none cursor-pointer hover:bg-white hover:border-sky-300">
                                    </select>
                                    <div
                                        class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="relative">
                                <!-- Connector Line -->
                                <div
                                    class="absolute left-6 -top-3 bottom-full w-0.5 bg-gradient-to-b from-transparent via-slate-300 to-transparent h-6 -z-10">
                                </div>
                            </div>

                            <div>
                                <label for="fare-to-stop"
                                    class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">To</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <!-- To: destination flag icon -->
                                        <svg class="h-5 w-5 text-slate-400 group-hover:text-blue-500 transition-colors"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 21v-8a2 2 0 012-2h14a2 2 0 012 2v8l-6-3-6 3-6-3z" />
                                            <!-- Simplified Flag/Map markerish -->
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 10V3" />
                                        </svg>
                                    </div>
                                    <select id="fare-to-stop"
                                        class="block w-full pl-10 pr-10 py-3 rounded-xl border border-slate-200 bg-slate-50 text-sm font-medium text-slate-700 shadow-sm focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all appearance-none cursor-pointer hover:bg-white hover:border-blue-300">
                                    </select>
                                    <div
                                        class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-slate-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <button id="calculate-fare-btn"
                                class="w-full py-3.5 px-4 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:from-sky-600 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-200 transition-all transform hover:-translate-y-0.5 mt-4">
                                Calculate Fare
                            </button>
                        </div>
                    </div>

                    <div id="fare-result-container" class="mt-4"></div>
                </div>
            </div>

            <div id="ticket-booking-page"
                class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)] flex items-center justify-center">
                <div class="text-center max-w-md mx-auto bg-white p-8 rounded-2xl shadow-md border border-slate-200">
                    <div class="text-6xl mb-4">üéüÔ∏è</div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Ticket Booking</h2>
                    <p class="text-slate-500 text-lg font-medium">Coming Soon</p>
                    <p class="text-slate-400 text-sm mt-2">We are working on this feature. In the future, you will be
                        able to book your tickets here.</p>
                </div>
            </div>

            <div id="feedback-page" class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)]">
                <div
                    class="max-w-md mx-auto bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden mb-4">

                    <!-- Tabs -->
                    <div class="flex border-b border-slate-200">
                        <button onclick="switchFeedbackTab('complaint')" id="tab-complaint"
                            class="flex-1 py-3 text-sm font-medium text-center text-blue-600 border-b-2 border-blue-600 bg-blue-50 focus:outline-none">Complaint</button>
                        <button onclick="switchFeedbackTab('feedback')" id="tab-feedback"
                            class="flex-1 py-3 text-sm font-medium text-center text-slate-500 hover:text-slate-700 focus:outline-none">Feedback</button>
                        <button onclick="switchFeedbackTab('track')" id="tab-track"
                            class="flex-1 py-3 text-sm font-medium text-center text-slate-500 hover:text-slate-700 focus:outline-none">Track
                            Status</button>
                    </div>

                    <div class="p-5">

                        <!-- Header Dynamic Content -->
                        <div id="feedback-header-content" class="mb-6 text-center">
                            <h2 class="text-2xl font-bold mb-1 text-slate-900">Submit Complaint</h2>
                            <p class="text-slate-500 text-sm">Report an incident or issue.</p>
                        </div>
                        <div id="track-header-content" class="mb-6 text-center hidden">
                            <h2 class="text-2xl font-bold mb-1 text-slate-900">Track Status</h2>
                            <p class="text-slate-500 text-sm">Check the status of your complaints.</p>
                        </div>

                        <!-- Form Section -->
                        <form id="feedback-form" class="space-y-5">
                            <input type="hidden" id="feedback-type" value="Complaint">

                            <!-- Row 1: Name & Contact -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div id="name-container" class="relative">
                                    <label
                                        class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wide">Your
                                        Name</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                            </svg>
                                        </div>
                                        <input type="text" id="feedback-name"
                                            class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all sm:text-sm"
                                            placeholder="John Doe">
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wide">Contact
                                        Number <span id="contact-required-label"
                                            class="text-red-500 font-normal normal-case ml-1">(Required)</span></label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                            </svg>
                                        </div>
                                        <input type="tel" id="feedback-contact" required
                                            class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all sm:text-sm"
                                            placeholder="98765 43210">
                                    </div>
                                </div>
                            </div>

                            <!-- Row 2: Category & Bus -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div id="category-container">
                                    <label
                                        class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wide">Category</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                            </svg>
                                        </div>
                                        <select id="feedback-category"
                                            class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all sm:text-sm appearance-none">
                                            <option value="Rash Driving">Rash Driving</option>
                                            <option value="Lost Item">Lost Item</option>
                                            <option value="Cleanliness">Cleanliness</option>
                                            <option value="Staff Behavior">Staff Behavior</option>
                                            <option value="Delay">Bus Delay</option>
                                            <option value="Other">Other</option>
                                        </select>
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                <div id="bus-select-container">
                                    <label
                                        class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wide">Bus
                                        Name</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                            </svg>
                                        </div>
                                        <select id="feedback-bus-select"
                                            class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all sm:text-sm appearance-none">
                                            <option value="">-- Select Bus --</option>
                                        </select>
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 3: Location & Time -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div id="location-container">
                                    <label
                                        class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wide">Incident
                                        Location</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                        </div>
                                        <input type="text" id="feedback-location"
                                            class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all sm:text-sm"
                                            placeholder="e.g., Main Stand">
                                    </div>
                                </div>
                                <div id="time-container">
                                    <label
                                        class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wide">Date
                                        & Time</label>
                                    <div class="relative">
                                        <!-- No interior icon for Date input usually due to browser shadow dom, but we can try outside or transparent -->
                                        <input type="datetime-local" id="feedback-time"
                                            class="block w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all sm:text-sm">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wide">Description</label>
                                <textarea id="feedback-description" rows="3" required
                                    class="block w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all sm:text-sm resize-none"
                                    placeholder="Please describe what happened in detail..."></textarea>
                            </div>

                            <button type="submit" id="submit-feedback-btn"
                                class="w-full py-3.5 px-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg shadow-lg hover:shadow-xl hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-200 transition-all transform hover:-translate-y-0.5">
                                Submit Report
                            </button>
                        </form>

                        <!-- Track Section -->
                        <div id="track-section" class="hidden space-y-4">
                            <div class="flex space-x-2">
                                <input type="tel" id="track-phone-input"
                                    class="flex-1 px-3 py-2 border rounded-md shadow-sm"
                                    placeholder="Enter your mobile number">
                                <button onclick="trackMyComplaints()" class="btn btn-primary">Track</button>
                            </div>
                            <div id="user-complaints-list" class="space-y-3 mt-4">
                                <!-- Results go here -->
                                <p class="text-center text-slate-400 text-sm py-4">Enter number to see your history.</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>



            <div id="manage-fares-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Fares</h2>
                <div class="space-y-4">
                    <div>
                        <input type="text" id="manage-fares-search-bar" placeholder="Search Bus Route..."
                            class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm mb-4">
                        <label for="manage-fares-bus-select" class="block text-sm font-medium text-slate-700">Select Bus
                            Route</label>
                        <select id="manage-fares-bus-select"
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div id="fare-matrix-container" class="overflow-x-auto"></div>
                    <div class="flex space-x-2 mt-4">
                        <button id="download-csv-btn" class="w-full btn btn-secondary hidden">Download CSV</button>
                        <button id="upload-csv-btn" class="w-full btn btn-secondary hidden">Upload CSV</button>
                        <input type="file" id="csv-upload-input" class="hidden" accept=".csv">
                    </div>
                    <button id="save-fares-btn" class="w-full btn btn-primary hidden">Save Fares</button>
                </div>
            </div>

            <div id="manage-announcements-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Announcements</h2>
                <div class="space-y-4">
                    <div>
                        <label for="announcement-input" class="block text-sm font-medium text-slate-700">Announcement
                            Message</label>
                        <textarea id="announcement-input" rows="3"
                            class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                            placeholder="e.g., Service delays due to heavy rain..."></textarea>
                    </div>
                    <button id="publish-announcement-btn" class="w-full btn btn-primary">Add Announcement</button>
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-medium text-slate-900">Active Announcements</h3>
                        <div id="active-announcements-list" class="mt-2 space-y-2">
                            <!-- Announcements will be rendered here dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="manage-ads-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Advertisements</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium text-slate-900">Current Ads</h3>
                        <div id="ads-list-container" class="mt-2 space-y-4">
                        </div>
                    </div>
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-medium text-slate-900">Add New Ad</h3>
                        <form id="ad-form" class="space-y-4 mt-2">
                            <div>
                                <label for="ad-type-select" class="block text-sm font-medium text-slate-700">Ad
                                    Type</label>
                                <select id="ad-type-select"
                                    class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                                    <option value="image" selected>Image Ad</option>
                                    <option value="video">Video Ad</option>
                                </select>
                            </div>
                            <div id="ad-image-inputs">
                                <div>
                                    <label for="ad-image-url-input"
                                        class="block text-sm font-medium text-slate-700">Image
                                        URL</label>
                                    <input type="url" id="ad-image-url-input"
                                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                        placeholder="https://example.com/image.png">
                                </div>
                                <div class="mt-4">
                                    <label for="ad-link-input" class="block text-sm font-medium text-slate-700">Link URL
                                        (when image is clicked)</label>
                                    <input type="url" id="ad-link-input"
                                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                        placeholder="https://example.com">
                                </div>
                            </div>
                            <div id="ad-video-inputs" class="hidden">
                                <label for="ad-video-url-input" class="block text-sm font-medium text-slate-700">YouTube
                                    Video URL</label>
                                <input type="url" id="ad-video-url-input"
                                    class="mt-1 block w-full px-3 py-2 border rounded"
                                    placeholder="https://www.youtube.com/watch?v=...">
                            </div>
                            <div class="mt-4">
                                <label for="ad-position-input" class="block text-sm font-medium text-slate-700">Position
                                    (After which bus number)</label>
                                <input type="number" id="ad-position-input"
                                    class="mt-1 block w-full px-3 py-2 border rounded" placeholder="e.g., 3" min="1"
                                    required>
                            </div>
                            <button id="publish-ad-btn" type="submit" class="w-full btn btn-primary">Publish Ad</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="manage-complaints-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Complaints & Feedback</h2>

                <div class="flex flex-col gap-4 mb-6">
                    <div class="w-full">
                        <input type="text" id="complaints-search-input"
                            placeholder="Search by phone, content, or bus..."
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex items-center space-x-2 overflow-x-auto pb-2">
                        <button onclick="renderComplaintsPage('all')"
                            class="px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-medium transition-colors border border-slate-200">All</button>
                        <button onclick="renderComplaintsPage('New')"
                            class="px-3 py-1.5 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-700 text-xs font-medium transition-colors border border-blue-100">New</button>
                        <button onclick="renderComplaintsPage('Resolved')"
                            class="px-3 py-1.5 rounded-full bg-green-50 hover:bg-green-100 text-green-700 text-xs font-medium transition-colors border border-green-100">Resolved</button>
                        <button onclick="renderComplaintsPage('Dismissed')"
                            class="px-3 py-1.5 rounded-full bg-red-50 hover:bg-red-100 text-red-700 text-xs font-medium transition-colors border border-red-100">Dismissed</button>
                    </div>
                </div>

                <!-- Type Filters -->
                <div class="flex border-b border-slate-200 mb-4">
                    <button id="filter-type-all" onclick="filterComplaintsByType('all')"
                        class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600 focus:outline-none">All
                        Types</button>
                    <button id="filter-type-complaint" onclick="filterComplaintsByType('Complaint')"
                        class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Complaints</button>
                    <button id="filter-type-feedback" onclick="filterComplaintsByType('Feedback')"
                        class="px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Feedback</button>
                </div>

                <div id="complaints-list-container" class="space-y-4">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- Bus Staff Management Page -->
            <div id="manage-staff-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Bus Staff Management</h2>
                <div class="mb-4">
                    <input type="text" id="staff-bus-search" placeholder="Search Bus..."
                        class="w-full px-4 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="staff-bus-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Dynamic Bus Cards -->
                </div>
            </div>

            <!-- Staff Modal -->
            <div id="staff-modal"
                class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50 flex items-center justify-center backdrop-blur-sm">
                <div
                    class="relative mx-auto p-0 border w-full max-w-2xl shadow-xl rounded-xl bg-white m-4 flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center p-5 border-b border-slate-100">
                        <h3 class="text-xl font-bold text-slate-800" id="staff-modal-title">Staff Details</h3>
                        <button onclick="closeStaffModal()"
                            class="text-slate-400 hover:text-slate-500 hover:bg-slate-100 p-2 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="p-5 overflow-y-auto flex-1">
                        <div id="staff-list-container" class="space-y-4 mb-6">
                            <!-- Staff Members List -->
                        </div>

                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h4 class="font-semibold text-slate-800 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                                </svg>
                                Add Staff Member
                            </h4>
                            <form id="add-staff-form" class="space-y-3">
                                <input type="hidden" id="staff-bus-id">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input type="text" id="staff-name" placeholder="Full Name"
                                        class="col-span-1 md:col-span-2 px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required>
                                    <select id="staff-role"
                                        class="px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="Driver">Driver</option>
                                        <option value="Conductor">Conductor</option>
                                        <option value="Helper">Helper</option>
                                        <option value="Cleaner">Cleaner</option>
                                    </select>
                                    <input type="tel" id="staff-contact" placeholder="Phone Number"
                                        class="px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required>
                                    <input type="text" id="staff-locality" placeholder="Locality/Place"
                                        class="px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <input type="date" id="staff-dob"
                                        class="px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        title="Date of Birth">
                                </div>
                                <button type="submit" class="btn btn-primary w-full mt-2 text-sm py-2">Add
                                    Staff</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="about-page" class="hidden p-6">
                <div id="about-content-container" class="prose max-w-none"></div>
            </div>

            <div id="manage-about-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage About Page</h2>
                <form id="about-form" class="space-y-4">
                    <div>
                        <label for="editor-container" class="block text-sm font-medium text-slate-700">Page
                            Content</label>
                        <div id="editor-container" class="mt-1"></div>
                    </div>
                    <button id="save-about-btn" type="submit" class="w-full btn btn-primary">Save About Page</button>
                </form>
            </div>

            <div id="contact-page" class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)]">
                <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                    <div class="bg-white px-6 py-8 text-center text-slate-800 border-b border-slate-100">
                        <h2 class="text-3xl font-bold mb-2">Get in Touch</h2>
                        <p class="text-slate-500 text-sm">We'd love to hear from you. Reach out to us for any
                            queries.</p>
                    </div>

                    <div class="p-8">
                        <div id="contact-info-container" class="space-y-6 text-slate-700"></div>
                    </div>
                </div>
            </div>

            <div id="manage-contact-page" class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)]">
                <div class="max-w-md mx-auto bg-white rounded-2xl shadow-md border border-slate-200 px-5 py-6">
                    <h2 class="text-2xl font-bold mb-4 text-slate-900 text-center">Manage Contact Details</h2>
                    <form id="contact-form" class="space-y-4">
                        <div>
                            <label for="edit-contact-email"
                                class="block text-sm font-medium text-slate-700">Email</label>
                            <input type="email" id="edit-contact-email"
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                required>
                        </div>
                        <div>
                            <label for="edit-contact-phone"
                                class="block text-sm font-medium text-slate-700">Phone</label>
                            <input type="tel" id="edit-contact-phone"
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                required>
                        </div>
                        <div>
                            <label for="edit-contact-address"
                                class="block text-sm font-medium text-slate-700">Address</label>
                            <textarea id="edit-contact-address" rows="3"
                                class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                required></textarea>
                        </div>
                        <div class="border-t pt-4 mt-2">
                            <h3 class="text-sm font-semibold text-slate-800 mb-2">Social Media (optional)</h3>
                            <div class="space-y-3">
                                <div>
                                    <label for="edit-contact-instagram"
                                        class="block text-xs font-medium text-slate-600">Instagram URL</label>
                                    <input type="url" id="edit-contact-instagram"
                                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                        placeholder="https://instagram.com/your-page">
                                </div>
                                <div>
                                    <label for="edit-contact-youtube"
                                        class="block text-xs font-medium text-slate-600">YouTube
                                        URL</label>
                                    <input type="url" id="edit-contact-youtube"
                                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                        placeholder="https://youtube.com/@your-channel">
                                </div>
                                <div>
                                    <label for="edit-contact-linkedin"
                                        class="block text-xs font-medium text-slate-600">LinkedIn
                                        URL</label>
                                    <input type="url" id="edit-contact-linkedin"
                                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                        placeholder="https://www.linkedin.com/company/your-page">
                                </div>
                                <div>
                                    <label for="edit-contact-facebook"
                                        class="block text-xs font-medium text-slate-600">Facebook
                                        URL</label>
                                    <input type="url" id="edit-contact-facebook"
                                        class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                                        placeholder="https://facebook.com/your-page">
                                </div>
                            </div>
                        </div>
                        <button id="save-contact-btn" type="submit" class="w-full btn btn-primary">Save Contact
                            Details</button>
                    </form>
                </div>
            </div>

            <div id="manage-admins-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Admins</h2>
                <div id="admin-list-container" class="space-y-4">
                </div>
                <div class="mt-6">
                    <button id="add-admin-btn" class="w-full btn btn-primary">Add New Admin</button>
                </div>
            </div>

            <div id="my-profile-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">My Profile</h2>
                <div id="my-profile-content" class="space-y-4">
                </div>
            </div>

            <div id="audit-logs-page" class="hidden p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Audit Logs</h2>
                    <button id="clear-audit-logs-btn" class="btn btn-danger hidden">Clear All Logs</button>
                </div>
                <div id="audit-logs-list" class="space-y-4">
                    <p class="text-slate-500">Loading audit logs...</p>
                </div>
            </div>

            <div id="manage-bus-codes-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Bus Codes</h2>

                <div class="mb-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" id="bus-code-search-bar"
                            class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                            placeholder="Search by code or bus name...">
                    </div>
                </div>

                <div id="add-code-container" class="mb-6 p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Add New Code</h3>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="new-bus-code-input"
                            class="uppercase-input flex-grow w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                            placeholder="e.g., AB" maxlength="3">
                        <button id="add-new-bus-code-btn" class="btn btn-primary flex-shrink-0">Add Code</button>
                    </div>
                </div>
                <div id="bus-codes-list-container">
                </div>
            </div>

            <div id="manage-reports-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Reports</h2>
                <div class="relative mb-4">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input type="text" id="reports-search-bar"
                        class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg bg-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
                        placeholder="Search for a bus...">
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                    <p class="text-sm text-slate-600 mb-4">
                        Select the buses you want to include in the report. The report will be downloaded in a CSV
                        format, which can be opened with Excel or Google Sheets.
                    </p>
                    <div id="reports-bus-list-container"
                        class="space-y-3 max-h-96 overflow-y-auto border-t border-b py-4 my-4">
                        <p class="text-slate-500">Loading bus list...</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 mt-4">
                        <button id="download-selected-btn" class="w-full btn btn-primary">Download Selected</button>
                        <button id="download-all-btn" class="w-full btn btn-secondary">Download All Buses</button>
                    </div>
                </div>
            </div>

        </div>


        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-30"></div>

        <!-- Sidebar -->
        <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-40">
            <div class="p-4 border-b flex items-center space-x-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-sky-600" viewBox="0 0 24 24"
                    fill="currentColor">
                    <path
                        d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                </svg>
                <h2 class="text-lg font-bold text-slate-800">Digital Attappadi</h2>
            </div>
            <nav id="sidebar-nav" class="p-2 space-y-1">
                <a href="#" data-page="home"
                    class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üïó</span>
                    <span>Bus Schedule</span>
                </a>
                <a href="#" data-page="fare-calculator"
                    class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üé´</span>
                    <span>Fare Calculator</span>
                </a>
                <a href="#" data-page="ticket-booking"
                    class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üéüÔ∏è</span>
                    <span>Ticket Booking</span>
                </a>
                <a href="#" data-page="feedback"
                    class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üì¢</span>
                    <span>Feedback</span>
                </a>
                <a href="#" data-page="about"
                    class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">‚ÑπÔ∏è</span>
                    <span>About</span>
                </a>
                <a href="#" data-page="contact"
                    class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üìû</span>
                    <span>Contact</span>
                </a>
                <div id="admin-menu-items"></div>
            </nav>
        </div>

        <div id="manage-complaints-page" class="hidden p-6">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Complaints</h2>
            <p class="text-slate-500 mb-4">View and resolve user submitted reports.</p>
            <div class="mb-4 flex space-x-2">
                <button class="btn btn-secondary text-sm" onclick="renderComplaintsPage('all')">All</button>
                <button class="btn btn-secondary text-sm" onclick="renderComplaintsPage('New')">New</button>
                <button class="btn btn-secondary text-sm"
                    onclick="renderComplaintsPage('Investigating')">Investigating</button>
                <button class="btn btn-secondary text-sm" onclick="renderComplaintsPage('Resolved')">Resolved</button>
            </div>
            <div id="complaints-list-container" class="space-y-4">
                <!-- Complaints loaded here -->
            </div>
        </div>

        <!-- Modals (Edit, Confirmation, etc.) -->
        <div id="edit-modal"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-40 flex items-center justify-center p-4">
            <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
                <div class="text-center">
                    <h3 id="modal-title" class="text-xl leading-6 font-bold text-slate-900">Edit Details</h3>
                    <div class="mt-4 px-2 py-3">
                        <form id="edit-form" class="space-y-4"></form>
                    </div>
                    <div class="items-center px-4 py-3 space-y-2">
                        <button id="modal-save" class="w-full btn btn-primary"></button>
                        <button id="modal-cancel" class="w-full btn btn-secondary">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="confirmation-modal"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-slate-900 mt-2">Are you sure?</h3>
                    <div class="mt-2 px-7 py-3">
                        <p id="confirmation-message" class="text-sm text-slate-500"></p>
                    </div>
                    <div class="items-center px-4 py-3 flex gap-2">
                        <button id="confirm-cancel-btn" class="w-full btn btn-secondary">Close</button>
                        <button id="confirm-action-btn" class="w-full btn btn-danger">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="stop-filter-modal"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div class="relative w-full max-w-md mx-auto p-5 border rounded-xl bg-white shadow-2xl">
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-slate-900 text-center">Select your Stop</h3>
                    <div id="stop-filter-list" class="mt-4 max-h-80 overflow-y-auto space-y-2"></div>
                    <!-- Close button removed; modal will close automatically when a stop is selected -->
                </div>
            </div>
        </div>

        <div id="reassign-bus-code-modal"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
                <div class="text-center">
                    <h3 class="text-xl leading-6 font-bold text-slate-900 mb-4">Reassign Bus Code</h3>
                    <p class="text-sm text-slate-600 mb-6">Bus Code <span id="reassign-modal-old-code"
                            class="font-bold text-slate-800"></span> has <span id="reassign-modal-trip-count"
                            class="font-bold text-slate-800"></span> active trips. You must reassign them to another
                        code
                        before deleting this one.</p>
                    <form id="reassign-code-form" class="space-y-4 text-left">
                        <input type="hidden" id="reassign-target-code-id">
                        <input type="hidden" id="reassign-target-code-name">

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Reassignment Option</label>
                            <div class="flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="reassignOption" value="existing"
                                        class="form-radio text-sky-600" checked>
                                    <span class="ml-2 text-sm text-slate-700">Existing Code</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="reassignOption" value="new"
                                        class="form-radio text-sky-600">
                                    <span class="ml-2 text-sm text-slate-700">Create New Code</span>
                                </label>
                            </div>
                        </div>

                        <div id="reassign-existing-container">
                            <label for="reassign-existing-select"
                                class="block text-sm font-medium text-slate-700">Select
                                Code</label>
                            <select id="reassign-existing-select" class="mt-1 block w-full px-3 py-2 border rounded">
                            </select>
                        </div>

                        <div id="reassign-new-container" class="hidden">
                            <label for="reassign-new-input" class="block text-sm font-medium text-slate-700">New Code
                                Name</label>
                            <input type="text" id="reassign-new-input"
                                class="uppercase-input mt-1 block w-full px-3 py-2 border rounded"
                                placeholder="e.g. XYZ" maxlength="3">
                        </div>

                        <div class="items-center pt-4 space-y-2">
                            <button type="submit" class="w-full btn btn-primary">Submit for Review</button>
                            <button type="button" id="reassign-modal-close"
                                class="w-full btn btn-secondary">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="review-reassignment-modal"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <h3 class="text-xl leading-6 font-bold text-slate-900 mb-2">Review Reassignment</h3>
                    <p class="text-sm text-slate-600 mb-6">
                        You are about to reassign <span id="review-trip-count" class="font-bold text-slate-900"></span>
                        trips from Code <span id="review-old-code"
                            class="font-bold text-red-600 border border-red-200 bg-red-50 text-xs px-1 py-0.5 rounded"></span>
                        to Code <span id="review-new-code"
                            class="font-bold text-green-600 border border-green-200 bg-green-50 text-xs px-1 py-0.5 rounded"></span>.
                        <br><br>
                        The old code will be emptied (0 trips).
                    </p>
                    <div class="items-center space-y-2">
                        <button id="review-accept-btn"
                            class="w-full btn btn-primary bg-green-600 hover:bg-green-700">Accept
                            & Execute</button>
                        <button id="review-decline-btn"
                            class="w-full btn btn-secondary text-red-600 hover:bg-red-50 border-red-200">Decline &
                            Revert</button>
                        <button id="review-modal-close" class="w-full btn btn-secondary">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="manage-stops-modal"
            class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
            <div class="relative w-full max-w-md mx-auto p-5 border rounded-xl bg-white shadow-2xl">
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-slate-900 text-center">Manage Filter Stops</h3>
                    <div id="manage-stops-list" class="mt-4 max-h-60 overflow-y-auto divide-y"></div>
                    <div class="mt-4">
                        <select id="add-stop-select" class="w-full px-3 py-2 border rounded"></select>
                        <div id="custom-filter-stop-container" class="hidden mt-2">
                            <input type="text" id="custom-filter-stop-input" class="w-full px-3 py-2 border rounded"
                                placeholder="Enter Custom Stop Name">
                        </div>
                        <button id="add-filter-stop-btn" class="mt-2 w-full btn btn-primary">Add Stop to Filter</button>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="manage-stops-close-btn" class="mt-2 w-full btn btn-secondary">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Notifications -->
        <div id="manage-notifications-page" class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)]">
            <div class="max-w-md mx-auto bg-white rounded-2xl shadow-md border border-slate-200 px-5 py-6">
                <h2 class="text-2xl font-bold mb-4 text-slate-900 text-center">Send Push Notification</h2>
                <p class="text-sm text-slate-500 mb-6 text-center">Send custom alerts to all active users with
                    notification permissions enabled.</p>

                <form id="notification-form" class="space-y-4">
                    <div>
                        <label for="notif-title" class="block text-sm font-medium text-slate-700">Title</label>
                        <input type="text" id="notif-title"
                            class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                            placeholder="e.g. Schedule Change" required>
                    </div>
                    <div>
                        <label for="notif-message" class="block text-sm font-medium text-slate-700">Message</label>
                        <textarea id="notif-message" rows="3"
                            class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm"
                            placeholder="e.g. Bus 123 will be delayed by 10 mins." required></textarea>
                    </div>
                    <button type="submit"
                        class="w-full btn btn-primary bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700">
                        Send Notification
                    </button>
                </form>
            </div>
        </div>

        <!-- Custom Message Box -->
        <div id="message-box"
            class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50 transition-all duration-300">
            <p id="message-text"></p>
        </div>

        <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
        <script src="https://www.youtube.com/iframe_api"></script>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
            import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, arrayUnion, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            import { serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Import serverTimestamp

            // --- Firebase Configuration ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                // Fallback for local development
                apiKey: "AIzaSyAXfcrRz76kWgTfz_lgdFkcWxKl3k-ufac",
                authDomain: "digital-attappadi-live.firebaseapp.com",
                projectId: "digital-attappadi-live",
                storageBucket: "digital-attappadi-live.appspot.com",
                messagingSenderId: "165166679967",
                appId: "1:165166679967:web:6b96e0d85a757393af5faa",
                measurementId: "G-FKXLPE1Y0Q"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'digital-attappadi-live';

            // --- Firebase Services ---
            let app, db, auth, analytics, busCollection, configDocRef, filterStopsDocRef, contactDocRef, aboutDocRef, announcementDocRef, adsCollection, adminsCollection, auditLogsCollection, busCodesCollection, complaintsCollection;

            // --- STATE ---
            let allBuses = [];
            let filterableStops = [];
            let allAds = [];
            let allAdmins = [];
            let allAuditLogs = [];
            let currentAdmin = null;
            let currentAdminPermissions = {};
            let openDropdownId = null;
            let openBusCodeRow = null;
            let openBusCodeAccordion = null;
            let allComplaints = []; // <-- ADD THIS LINE
            let busCodeSearchQuery = '';
            let isAdmin = false;
            let isSuperAdmin = false;
            let currentUserId = null;
            let isAuthReady = false;
            let unsubscribeListeners = [];
            let modalResolve = null;
            let modalReject = null;
            let searchQuery = '';
            let reportsSearchQuery = ''; // <-- ADD THIS LINE
            let currentFilter = 'all';
            let quill = null;
            let predefinedBusNames = [];
            let allBusCodes = [];
            let predefinedStops = [];
            let videoPlayers = {};

            // Reference stop used for ETA calculations and sorting (default: Goolikkadavu Jn)
            let referenceStopName = 'Goolikkadavu Jn';

            // --- DEFAULT MARQUEE SETTINGS (used if not defined per bus) ---
            const DEFAULT_MARQUEE_SPEED_PX_PER_SEC = 50;
            const DEFAULT_MARQUEE_REPEAT_DELAY_SEC = 2;

            // --- DATA CONSTANTS ---
            const SUPER_ADMIN_USERNAME = 'dhayaceoda';
            const SUPER_ADMIN_PASSWORD = '90474470770'; // WARNING: Plaintext password. NOT FOR PRODUCTION.
            const SUPER_ADMIN_NAME = 'Dhaya(Thangakutty)';

            const DEFAULT_PERMISSIONS = {
                manageAnnouncements: false,
                manageFares: false,
                manageAds: false,
                manageAbout: false,
                manageContact: false,
                manageStops: false,
                manageAdmins: false, // Only Super Admin gets this by default, or explicitly granted
                viewAuditLogs: false,
                manageReports: false,
                manageBusCodes: false,
                manageComplaints: false, // <-- Added this
                manageStaff: false
            };

            const BLOOD_GROUPS = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];

            const SHOW_PASSWORD_ICON = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
            const HIDE_PASSWORD_ICON = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;

            document.addEventListener('DOMContentLoaded', () => {
                // Determine reference stop from URL for SPA-style links.
                // Pattern: #home              -> default (Goolikkadavu Jn)
                //          #home/kottathara   -> referenceStopName = 'Kottathara'
                //          #kottathara        -> referenceStopName = 'Kottathara'
                try {
                    const hash = (window.location.hash || '').replace(/^#/, '');
                    let slug = '';
                    if (hash.includes('/')) {
                        const parts = hash.split('/');
                        slug = parts[parts.length - 1];
                    } else if (hash && hash.toLowerCase() !== 'home') {
                        slug = hash;
                    }
                    if (slug) {
                        const prettyName = decodeURIComponent(slug)
                            .replace(/-/g, ' ')
                            .replace(/\b\w/g, c => c.toUpperCase());
                        referenceStopName = prettyName;
                    }
                } catch (e) {
                    console.warn('Unable to parse reference stop from URL hash, using default.', e);
                }
                // --- DOM ELEMENTS ---
                const scheduleList = document.getElementById('schedule-list');
                const statusMessage = document.getElementById('status-message');
                const addBusContainer = document.getElementById('add-bus-container');
                const searchBar = document.getElementById('search-bar');
                const filterDropdown = document.getElementById('filter-dropdown');
                const messageBox = document.getElementById('message-box');
                const messageText = document.getElementById('message-text');
                const adminListContainer = document.getElementById('admin-list-container');
                const addAdminBtn = document.getElementById('add-admin-btn');
                const myProfileContent = document.getElementById('my-profile-content');
                const auditLogsList = document.getElementById('audit-logs-list');


                // --- All functions are defined here before being called ---

                const setStatus = (message, isError = false) => {
                    if (statusMessage) {
                        statusMessage.innerHTML = `<p class="p-8 text-center ${isError ? 'text-red-500' : 'text-slate-500'}">${message}</p>`;
                    }
                };

                const parseTime = (timeString) => {
                    const now = new Date();
                    const [hours, minutes] = timeString.split(':');
                    now.setHours(hours, minutes, 0, 0);
                    return now;
                };

                const formatTime = (dateObject) => dateObject.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

                const formatEta = (minutes, prefix = '') => {
                    if (minutes <= 1) return 'Now';
                    if (minutes < 60) return `${prefix}${minutes}m`;
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    if (remainingMinutes === 0) return `${prefix}${hours}h`;
                    return `${prefix}${hours}h ${remainingMinutes}m`;
                };

                const to12Hour = (time24) => {
                    let [hours, minutes] = time24.split(':');
                    hours = parseInt(hours, 10);
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    let hour12 = hours % 12;
                    if (hour12 === 0) hour12 = 12; // 12 PM or 12 AM
                    return { hour: hour12, minute: minutes, ampm: ampm };
                };

                const to24Hour = (hour, minute, ampm) => {
                    hour = parseInt(hour, 10);
                    minute = String(minute).padStart(2, '0');
                    if (ampm.toUpperCase() === 'PM' && hour < 12) hour += 12;
                    if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0; // Midnight case
                    return `${String(hour).padStart(2, '0')}:${minute}`;
                };

                const showMessage = (message, isError = false) => {
                    messageText.textContent = message;
                    messageBox.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${isError ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'}`;
                    messageBox.classList.remove('opacity-0', 'translate-y-2');
                    setTimeout(() => {
                        messageBox.classList.add('opacity-0', 'translate-y-2');
                        setTimeout(() => messageBox.classList.add('hidden'), 300);
                    }, 2700);
                };

                const updateFilterDropdown = () => {
                    let stopFilterOption = '';
                    // Only show "Manage Stops" if Super Admin, otherwise "Select your Stop" if any filterable stops exist
                    if (isSuperAdmin && currentAdminPermissions.manageStops) {
                        stopFilterOption = `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Manage Stops...</a>`;
                    } else if (filterableStops.length > 0) {
                        stopFilterOption = `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Select your Stop...</a>`;
                    }

                    // NOTE: We no longer expose a UI to change the reference stop; it stays at
                    // Goolikkadavu Jn for the main page. Only basic filters are shown here.
                    let optionsHtml = `
            <a href="#" data-filter="all" class="filter-option ${currentFilter === 'all' ? 'active' : ''} block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">All Buses</a>
            <a href="#" data-filter="live" class="filter-option ${currentFilter === 'live' ? 'active' : ''} block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Live Buses</a>
            <div class="border-t my-1"></div>
            ${stopFilterOption}
        `;
                    filterDropdown.innerHTML = optionsHtml;
                };

                const renderFareMatrix = (busId) => {
                    const fareMatrixContainer = document.getElementById('fare-matrix-container');
                    const saveFaresBtn = document.getElementById('save-fares-btn');
                    const downloadCsvBtn = document.getElementById('download-csv-btn');
                    const uploadCsvBtn = document.getElementById('upload-csv-btn');

                    fareMatrixContainer.innerHTML = '';
                    if (!busId) {
                        saveFaresBtn.classList.add('hidden');
                        downloadCsvBtn.classList.add('hidden');
                        uploadCsvBtn.classList.add('hidden');
                        return;
                    }
                    const bus = allBuses.find(b => b.id === busId);
                    if (!bus || !bus.stops || bus.stops.length < 2) {
                        fareMatrixContainer.innerHTML = '<p class="text-slate-500">This route needs at least two stops to set up fares.</p>';
                        saveFaresBtn.classList.add('hidden');
                        downloadCsvBtn.classList.add('hidden');
                        uploadCsvBtn.classList.add('hidden');
                        return;
                    }

                    let tableHtml = '<table class="fare-matrix-table"><thead><tr><th class="header-cell">From/To</th>';
                    bus.stops.forEach(stop => {
                        tableHtml += `<th class="header-cell">${stop.name}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';

                    bus.stops.forEach((fromStop, i) => {
                        tableHtml += `<tr><td class="header-cell">${fromStop.name}</td>`;
                        let row = fromStop.name;
                        bus.stops.forEach((toStop, j) => {
                            row += ",";
                            if (i >= j) {
                                tableHtml += '<td class="disabled-cell"></td>';
                            } else {
                                const fareKey = `${fromStop.name}_${toStop.name}`;
                                const fareValue = (bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) ? bus.fareMatrix[fareKey] : '';
                                tableHtml += `<td><input type="number" class="w-16 text-center fare-input bg-white border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" data-key="${fareKey}" value="${fareValue}" min="0"></td>`;
                            }
                        });
                        tableHtml += '</tr>';
                    });

                    tableHtml += '</tbody></table>';
                    fareMatrixContainer.innerHTML = tableHtml;
                    // Only show save/download/upload buttons if the current admin has permission
                    if (currentAdminPermissions.manageFares) {
                        saveFaresBtn.classList.remove('hidden');
                        downloadCsvBtn.classList.remove('hidden');
                        uploadCsvBtn.classList.remove('hidden');
                    } else {
                        saveFaresBtn.classList.add('hidden');
                        downloadCsvBtn.classList.add('hidden');
                        uploadCsvBtn.classList.add('hidden');
                    }
                };

                const populateManageFaresBusSelect = () => {
                    const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
                    const searchInput = document.getElementById('manage-fares-search-bar');
                    if (!manageFaresBusSelect) return;

                    const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';
                    const selectedBusId = manageFaresBusSelect.value;

                    manageFaresBusSelect.innerHTML = '<option value="">-- Select a Bus Route --</option>';
                    allBuses
                        .sort((a, b) => parseTime(a.stops[0].scheduledTime) - parseTime(b.stops[0].scheduledTime))
                        .filter(bus => {
                            if (!searchQuery) return true;
                            const busName = (bus.busNumber || '').toLowerCase();
                            const busCode = (bus.busCode || '').toLowerCase();
                            const origin = (bus.origin || '').toLowerCase();
                            const destination = (bus.destination || '').toLowerCase();
                            const idCode = (bus.busIdCode || '').toLowerCase();

                            return busName.includes(searchQuery) ||
                                busCode.includes(searchQuery) ||
                                origin.includes(searchQuery) ||
                                destination.includes(searchQuery) ||
                                idCode.includes(searchQuery);
                        })
                        .forEach(bus => {
                            const option = document.createElement('option');
                            option.value = bus.id;
                            const departureTime = to12Hour(bus.stops[0].scheduledTime);
                            const idText = bus.busIdCode ? ` (ID: ${bus.busIdCode})` : '';
                            option.textContent = `${departureTime.hour}:${departureTime.minute} ${departureTime.ampm} - ${bus.busNumber}${idText}: ${bus.origin} to ${bus.destination}`;
                            manageFaresBusSelect.appendChild(option);
                        });

                    // Attempt to restore selection
                    manageFaresBusSelect.value = selectedBusId;

                    // If the selected bus was filtered out, value will effectively be empty (default option)
                    renderFareMatrix(manageFaresBusSelect.value);
                };

                const populateFareCalculatorStops = () => {
                    const fareFromStop = document.getElementById('fare-from-stop');
                    const fareToStop = document.getElementById('fare-to-stop');
                    if (!fareFromStop || !fareToStop || allBuses.length === 0) return;

                    const allStops = new Set();
                    allBuses.forEach(bus => {
                        if (bus.stops) {
                            bus.stops.forEach(stop => allStops.add(stop.name));
                        }
                    });

                    const sortedStops = [...allStops].sort((a, b) => a.localeCompare(b));

                    fareFromStop.innerHTML = '<option value="">-- Select From --</option>';
                    fareToStop.innerHTML = '<option value="">-- Select To --</option>';

                    sortedStops.forEach(stopName => {
                        const option1 = document.createElement('option');
                        option1.value = stopName;
                        option1.textContent = stopName;
                        fareFromStop.appendChild(option1);

                        const option2 = document.createElement('option');
                        option2.value = stopName;
                        option2.textContent = stopName;
                        fareToStop.appendChild(option2);
                    });
                };

                const showPage = (pageId, fromHistory = false) => {
                    const pageContainer = document.getElementById('page-container');
                    Array.from(pageContainer.children).forEach(page => {
                        page.classList.add('hidden');
                    });
                    const newPage = document.getElementById(`${pageId}-page`);
                    if (newPage) newPage.classList.remove('hidden');

                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                        if (link.dataset.page === pageId) {
                            link.classList.add('active');
                        }
                    });

                    if (!fromHistory) {
                        history.pushState({ pageId: pageId }, '', `#${pageId}`);
                    }

                    if (pageId === 'manage-about' && !quill) {
                        quill = new Quill('#editor-container', {
                            theme: 'snow',
                            modules: {
                                toolbar: [
                                    [{ 'header': [1, 2, 3, false] }],
                                    ['bold', 'italic', 'underline'],
                                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                    ['link', 'clean']
                                ]
                            }
                        });
                        getDoc(aboutDocRef).then(docSnap => {
                            if (docSnap.exists() && quill) {
                                quill.root.innerHTML = docSnap.data().html;
                            }
                        });
                    } else if (pageId === 'fare-calculator') {
                        populateFareCalculatorStops();
                    } else if (pageId === 'manage-fares') {
                        populateManageFaresBusSelect();
                    } else if (pageId === 'manage-ads') {
                        renderAdsList();
                    } else if (pageId === 'manage-admins') {
                        renderAdminsList();
                    } else if (pageId === 'my-profile') {
                        renderMyProfile(); // Render the profile when the page is shown
                    } else if (pageId === 'audit-logs') {
                        renderAuditLogs();
                    } else if (pageId === 'manage-bus-codes') {
                        renderManageBusCodesPage();
                    } else if (pageId === 'manage-reports') {
                        renderReportsPage();
                    } else if (pageId === 'manage-staff') {
                        renderManageStaffPage();
                    }
                    closeSidebar();
                };

                const openSidebar = () => {
                    document.getElementById('sidebar').classList.add('open');
                    document.getElementById('sidebar-overlay').classList.remove('hidden');
                    document.getElementById('sidebar-overlay').style.opacity = '1';
                };

                const closeSidebar = () => {
                    document.getElementById('sidebar').classList.remove('open');
                    document.getElementById('sidebar-overlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('sidebar-overlay').classList.add('hidden'), 300);
                };

                // Helper function to log admin actions
                const logAdminAction = async (actionType, details, entityId = null, entityType = null) => {
                    if (!currentAdmin || !currentAdmin.name) return; // Only log if an admin is logged in
                    try {
                        await addDoc(auditLogsCollection, {
                            timestamp: serverTimestamp(),
                            adminName: currentAdmin.name,
                            actionType: actionType,
                            details: details,
                            entityId: entityId,
                            entityType: entityType
                        });
                    } catch (error) {
                        console.error("Error logging admin action:", error);
                    }
                };

                const renderAuthControls = () => {
                    const adminMenuItems = document.getElementById('admin-menu-items');
                    adminMenuItems.innerHTML = '';
                    if (isAdmin) {
                        const adminName = currentAdmin ? currentAdmin.name : 'Admin';
                        let adminMenuHtml = `<div class="border-t my-2"></div>`;

                        // Add "My Profile" link
                        adminMenuHtml += `
                <a href="#" data-page="my-profile" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">ü™™</span>
                    <span>My Profile</span>
                </a>`;

                        if (currentAdminPermissions.manageAnnouncements) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-announcements" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üì¢</span>
                        <span>Announcements</span>
                    </a>`;
                        }
                        if (currentAdminPermissions.manageFares) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-fares" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üé´</span>
                        <span>Manage Fares</span>
                    </a>`;
                        }
                        if (currentAdminPermissions.manageAds) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-ads" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üì∫</span>
                        <span>Manage Ads</span>
                    </a>`;
                        }
                        if (currentAdminPermissions.manageAbout) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-about" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">‚ÑπÔ∏è</span>
                        <span>Manage About</span>
                    </a>`;
                        }
                        if (currentAdminPermissions.manageContact) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-contact" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üìû</span>
                        <span>Manage Contact</span>
                    </a>`;
                        }
                        if (currentAdminPermissions.manageStops) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-stops" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üöå</span>
                        <span>Manage Stops</span>
                    </a>`;
                        }

                        // Notifications (Available to SuperAdmin or specific permission)
                        if (isSuperAdmin) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-notifications" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üîî</span>
                        <span>Manage Notifications</span>
                    </a>`;
                        }
                        if (isSuperAdmin || currentAdminPermissions.manageBusCodes) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-bus-codes" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üè∑Ô∏è</span>
                        <span>Manage Bus Codes</span>
                    </a>`;
                        }

                        // The "Manage Admins" link is ONLY visible to the Super Admin
                        if (isSuperAdmin) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-admins" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üõ°Ô∏è</span>
                        <span>Manage Admins</span>
                    </a>`;
                        }
                        if (currentAdminPermissions.viewAuditLogs) {
                            adminMenuHtml += `
                    <a href="#" data-page="audit-logs" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üìù</span>
                        <span>Audit Logs</span>
                    </a>`;
                        }

                        if (currentAdminPermissions.manageReports) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-reports" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üìä</span>
                        <span>Manage Reports</span>
                    </a>`;
                        }
                        if (currentAdminPermissions.manageComplaints) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-complaints" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üì¢</span>
                        <span>Manage Complaints</span>
                    </a>`;
                        }

                        if (isSuperAdmin || currentAdminPermissions.manageStaff) {
                            adminMenuHtml += `
                    <a href="#" data-page="manage-staff" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üë∑</span>
                        <span>Manage Staff</span>
                    </a>`;
                        }

                        adminMenuHtml += `
                <div class="border-t my-2"></div>
                <a href="#" id="admin-logout-link" class="nav-link flex items-center whitespace-nowrap px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span class="truncate">Logout (${adminName})</span>
                </a>
            `;
                        adminMenuItems.innerHTML = adminMenuHtml;

                    } else {
                        adminMenuItems.innerHTML = `
                <div class="border-t my-2"></div>
                <a href="#" id="admin-login-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üíº</span>
                    <span>Admin Login</span>
                </a>
                <a href="#" id="super-admin-login-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üè¢</span>
                    <span>Office Login</span>
                </a>
            `;
                    }

                    // Update search placeholder: only mention ID for admins
                    if (searchBar) {
                        searchBar.placeholder = isAdmin
                            ? 'Search by bus name, origin or ID...'
                            : 'Search by bus name or origin...';
                    }

                    addBusContainer.classList.toggle('hidden', !isAdmin);
                };

                // This function is now responsible for setting isAdmin and isSuperAdmin flags
                const checkAdminStatus = () => {
                    isAdmin = currentAdmin !== null;
                    isSuperAdmin = isAdmin && currentAdmin.username === SUPER_ADMIN_USERNAME;
                    renderAuthControls();
                    updateAndRenderSchedule();
                    if (document.getElementById('my-profile-page').classList.contains('hidden') === false) {
                        renderMyProfile(); // Re-render profile if on that page
                    }
                    if (document.getElementById('audit-logs-page').classList.contains('hidden') === false) {
                        renderAuditLogs(); // Re-render audit logs if on that page
                    }
                };

                const login = async (isSuperAdminLogin = false) => {
                    closeSidebar();
                    const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
            <div>
                <label class="block text-left text-sm font-medium text-slate-700">Password</label>
                <div class="relative">
                    <input class="mt-1 w-full px-3 py-2 border rounded pr-10" type="password" name="password" required>
                    <button type="button" class="toggle-password-btn absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 mt-1">
                        ${SHOW_PASSWORD_ICON}
                    </button>
                </div>
            </div>`;
                    try {
                        const data = await showModal(`${isSuperAdminLogin ? 'Office' : 'Admin'} Login`, formHtml, 'Login');

                        // Query Firestore for the admin
                        const q = query(adminsCollection,
                            where("username", "==", data.username),
                            where("password", "==", data.password)); // WARNING: Plaintext password match. NOT FOR PRODUCTION.
                        const querySnapshot = await getDocs(q);

                        if (!querySnapshot.empty) {
                            const loggedInAdmin = querySnapshot.docs[0].data();
                            currentAdmin = { id: querySnapshot.docs[0].id, ...loggedInAdmin };
                            currentAdminPermissions = loggedInAdmin.permissions || {};

                            // If it's a super admin login attempt, ensure it's the actual super admin
                            if (isSuperAdminLogin && loggedInAdmin.username !== SUPER_ADMIN_USERNAME) {
                                showMessage("Invalid Office Login credentials.", true);
                                currentAdmin = null;
                                currentAdminPermissions = {};
                                return;
                            }

                            localStorage.setItem('adminUser', loggedInAdmin.name); // Store name for display
                            showMessage(`${isSuperAdminLogin ? 'Office' : 'Admin'} mode enabled for ${loggedInAdmin.name}.`);
                            logAdminAction('LOGIN', `${loggedInAdmin.name} logged in.`);
                            checkAdminStatus(); // Update UI based on new admin status
                        } else {
                            showMessage("Incorrect username or password.");
                            currentAdmin = null;
                            currentAdminPermissions = {};
                        }
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Login cancelled.");
                        } else {
                            console.error("Login error:", error);
                        }
                    }
                };

                const logout = () => {
                    if (currentAdmin) {
                        logAdminAction('LOGOUT', `${currentAdmin.name} logged out.`);
                    }
                    currentAdmin = null;
                    currentAdminPermissions = {};
                    localStorage.removeItem('adminUser');
                    showMessage(`Logged out.`);
                    openDropdownId = null;
                    checkAdminStatus(); // Update UI based on logged out status
                    closeSidebar();
                };

                const showModal = (title, formHtml, saveButtonText = 'Save Changes') => {
                    const editModal = document.getElementById('edit-modal');
                    const modalTitle = document.getElementById('modal-title');
                    const editForm = document.getElementById('edit-form');
                    const modalSaveBtn = document.getElementById('modal-save');

                    modalTitle.textContent = title;
                    editForm.innerHTML = formHtml;
                    modalSaveBtn.textContent = saveButtonText;

                    editModal.classList.remove('hidden');

                    const setupCustomSelectListener = (selectId, containerId, inputName) => {
                        const selectEl = editForm.querySelector(selectId);
                        const containerEl = editForm.querySelector(containerId);
                        if (selectEl && containerEl) {
                            const toggleVisibility = () => {
                                const isCustom = selectEl.value === 'custom';
                                containerEl.classList.toggle('hidden', !isCustom);
                                const input = containerEl.querySelector(`input[name="${inputName}"]`);
                                if (input) input.required = isCustom;
                            };
                            selectEl.addEventListener('change', toggleVisibility);
                            toggleVisibility();
                        }
                    };

                    setupCustomSelectListener('#bus-name-select', '#custom-bus-name-container', 'custom_busNumber');
                    setupCustomSelectListener('#origin-select', '#custom-origin-container', 'custom_origin');
                    setupCustomSelectListener('#destination-select', '#custom-destination-container', 'custom_destination');
                    setupCustomSelectListener('#stop-name-select', '#custom-stop-name-container', 'custom_name');
                    setupCustomSelectListener('#bus-code-select', '#custom-bus-code-container', 'custom_busCode');


                    const statusTypeSelect = editForm.querySelector('#status-type');
                    if (statusTypeSelect) {
                        const toggleVisibility = () => { // Renamed from toggleStatusMinutes to avoid conflict
                            const statusContainer = editForm.querySelector('#status-minutes-container');
                            if (statusContainer) {
                                statusContainer.classList.toggle('hidden', !['late', 'early'].includes(statusTypeSelect.value));
                            }
                        };
                        statusTypeSelect.addEventListener('change', toggleVisibility);
                        toggleVisibility(); // Call initially to set correct state
                    }
                    // For admin permissions checkboxes
                    const permissionCheckboxes = editForm.querySelectorAll('input[type="checkbox"][name^="permission_"]');
                    if (permissionCheckboxes.length > 0) {
                        permissionCheckboxes.forEach(checkbox => {
                            checkbox.addEventListener('change', () => {
                                // No direct action needed here, form data will be collected on save
                            });
                        });
                    }

                    return new Promise((resolve, reject) => {
                        modalResolve = resolve;
                        modalReject = reject;
                    });
                };

                const hideModal = () => {
                    const editModal = document.getElementById('edit-modal');
                    editModal.classList.add('hidden');
                    document.getElementById('edit-form').innerHTML = '';
                    modalResolve = null;
                    modalReject = null;
                };

                const showConfirmation = (message) => {
                    return new Promise((resolve) => {
                        const confirmationModal = document.getElementById('confirmation-modal');
                        const confirmMessage = document.getElementById('confirmation-message');
                        const confirmActionBtn = document.getElementById('confirm-action-btn');
                        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                        confirmMessage.textContent = message;
                        confirmationModal.classList.remove('hidden');

                        const handleConfirm = () => {
                            cleanup();
                            resolve(true);
                        };
                        const handleCancel = () => {
                            cleanup();
                            resolve(false);
                        };

                        const cleanup = () => {
                            confirmationModal.classList.add('hidden');
                            confirmActionBtn.removeEventListener('click', handleConfirm);
                            confirmCancelBtn.removeEventListener('click', handleCancel);
                        };

                        confirmActionBtn.addEventListener('click', handleConfirm, { once: true });
                        confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
                    });
                };

                const showStopFilterModal = () => {
                    const stopFilterModal = document.getElementById('stop-filter-modal');
                    const stopFilterList = document.getElementById('stop-filter-list');
                    stopFilterList.innerHTML = filterableStops.map(stop =>
                        `<a href="#" data-filter="${stop}" class="filter-option ${currentFilter === stop ? 'active' : ''} flex justify-between items-center p-3 text-left w-full text-sm text-slate-800 rounded-lg hover:bg-sky-50 border border-slate-200">
                <span>${stop}</span>
                <span class="text-sky-500 font-bold">&rarr;</span>
            </a>`
                    ).join('');
                    stopFilterModal.classList.remove('hidden');
                };

                const hideStopFilterModal = () => {
                    document.getElementById('stop-filter-modal').classList.add('hidden');
                };

                const showManageStopsModal = () => {
                    closeSidebar();
                    const manageStopsModal = document.getElementById('manage-stops-modal');
                    const manageStopsList = document.getElementById('manage-stops-list');
                    const addStopSelect = document.getElementById('add-stop-select');

                    manageStopsList.innerHTML = filterableStops.map(stop => `
            <div class="flex justify-between items-center p-2">
                <span>${stop}</span>
                <button data-stop-name="${stop}" class="remove-filter-stop-btn text-red-500 hover:text-red-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        `).join('');

                    const allStops = new Set(predefinedStops);
                    allBuses.forEach(bus => {
                        if (bus.stops) {
                            bus.stops.forEach(stop => allStops.add(stop.name))
                        }
                    });
                    const availableStops = [...allStops].filter(s => !filterableStops.includes(s)).sort();

                    addStopSelect.innerHTML = `<option value="">-- Select Stop to Add --</option>` + availableStops.map(stop => `<option value="${stop}">${stop}</option>`).join('') + '<option value="custom">Other...</option>';

                    const customContainer = document.getElementById('custom-filter-stop-container');
                    const customInput = document.getElementById('custom-filter-stop-input');

                    const toggleCustomInput = () => {
                        if (addStopSelect.value === 'custom') {
                            customContainer.classList.remove('hidden');
                            customInput.focus();
                        } else {
                            customContainer.classList.add('hidden');
                        }
                    };
                    addStopSelect.onchange = toggleCustomInput;
                    toggleCustomInput();

                    manageStopsModal.classList.remove('hidden');
                };

                const hideManageStopsModal = () => {
                    document.getElementById('manage-stops-modal').classList.add('hidden');
                };

                const addSampleDataIfNeeded = async () => {
                    const busSnapshot = await getDocs(busCollection);
                    if (busSnapshot.empty) {
                        console.log("Database is empty. Adding sample bus routes.");
                        const sampleBuses = [
                            {
                                busNumber: "KSRTC",
                                busCode: "KSR", // New field
                                tripNumber: 1, // New field
                                busIdCode: "KSR1", // New composite field
                                origin: "Palakkad",
                                destination: "Anaikkatty",
                                seatCapacity: 48,
                                status: { type: 'on-time', minutes: 0 },
                                stops: [
                                    { name: "Palakkad", scheduledTime: "08:00", waitingTime: 0, displayFare: 0 },
                                    { name: "Mannarkkad", scheduledTime: "09:00", waitingTime: 5, displayFare: 45 },
                                    { name: "Goolikkadavu Jn", scheduledTime: "10:00", waitingTime: 0, displayFare: 45 },
                                    { name: "Kottathara", scheduledTime: "10:30", waitingTime: 0, displayFare: 20 },
                                    { name: "Anaikkatty", scheduledTime: "11:00", waitingTime: 0, displayFare: 20 },
                                ],
                                fareMatrix: {
                                    "Palakkad_Mannarkkad": 45, "Palakkad_Goolikkadavu Jn": 90, "Palakkad_Kottathara": 110, "Palakkad_Anaikkatty": 130,
                                    "Mannarkkad_Goolikkadavu Jn": 45, "Mannarkkad_Kottathara": 65, "Mannarkkad_Anaikkatty": 85,
                                    "Goolikkadavu Jn_Kottathara": 20, "Goolikkadavu Jn_Anaikkatty": 40,
                                    "Kottathara_Anaikkatty": 20
                                },
                                marqueeSpeedPxPerSec: DEFAULT_MARQUEE_SPEED_PX_PER_SEC, // Add default marquee speed
                                marqueeRepeatDelaySec: DEFAULT_MARQUEE_REPEAT_DELAY_SEC // Add default marquee interval
                            }
                        ];
                        try {
                            for (const bus of sampleBuses) {
                                await addDoc(busCollection, bus);
                            }
                        } catch (error) {
                            console.error("Error adding sample bus data:", error);
                        }
                    }

                    const aboutSnapshot = await getDoc(aboutDocRef);
                    if (!aboutSnapshot.exists()) {
                        console.log("About page content is empty. Adding default content.");
                        const defaultAboutContent = {

                            html: `<h2 class="text-2xl font-bold text-slate-800 mb-4">Welcome to Digital Attappadi</h2><p class="text-slate-700 mb-4">This platform is a community-driven initiative to provide reliable, real-time bus tracking for the Makkal Raja Transport Corporation. Our mission is to connect the vibrant communities of the Attappadi region by making travel simpler, more transparent, and predictable for everyone.</p><p class="text-slate-700 mb-4">With Digital Attappadi, you can effortlessly track live bus locations, view detailed routes with all the stops, and get accurate estimated arrival times (ETAs). Whether you're a daily commuter or a visitor exploring the beautiful landscapes of Attappadi, our goal is to ensure you have the most up-to-date information right at your fingertips.</p><p class="text-slate-700">We are continuously working to improve this service. Thank you for being a part of our community. We wish you a safe and pleasant journey!</p>`
                        };
                        try {
                            await setDoc(aboutDocRef, defaultAboutContent);
                        } catch (error) {
                            console.error("Error adding default about content:", error);
                        }
                    }

                    const configSnapshot = await getDoc(configDocRef);
                    if (!configSnapshot.exists()) {
                        console.log("Config document is empty. Adding default lists.");
                        const defaultConfig = {
                            busNames: ['KSRTC', 'SPR', 'SRG', 'KMS', 'RPC', 'Abirami'],
                            stops: ['Anaikkatty', 'Kottathara', 'Agali Jn', 'Goolikkadavu Jn', 'Thavalam', 'Mukkali', 'Mannarkkad', 'Palakkad', 'Coimbatore']
                        };
                        await setDoc(configDocRef, defaultConfig);
                    }

                    // New: Add default Bus Codes if collection is empty
                    const busCodesSnapshot = await getDocs(busCodesCollection);
                    if (busCodesSnapshot.empty) {
                        console.log("Bus Codes collection is empty. Adding default codes.");
                        const defaultCodes = ["AH", "HJ", "KL", "NH", "GF", "FD"];
                        const batch = writeBatch(db);
                        defaultCodes.forEach(code => {
                            const newDocRef = doc(busCodesCollection);
                            batch.set(newDocRef, { code: code });
                        });
                        await batch.commit();
                    }

                    // Add Super Admin if admins collection is empty
                    const adminsSnapshot = await getDocs(adminsCollection);
                    if (adminsSnapshot.empty) {
                        console.log("Admins collection is empty. Adding Super Admin.");
                        await addDoc(adminsCollection, {
                            username: SUPER_ADMIN_USERNAME,
                            password: SUPER_ADMIN_PASSWORD, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                            name: SUPER_ADMIN_NAME,
                            permissions: { // Super Admin gets all permissions
                                manageAnnouncements: true,
                                manageFares: true,
                                manageAds: true,
                                manageAbout: true,
                                manageContact: true,
                                manageStops: true,
                                manageAdmins: true,
                                viewAuditLogs: true // Super Admin can view audit logs
                            }
                        });
                    }

                };

                const handleAddBus = async () => {
                    // Check permission before showing modal
                    if (!isAdmin) { showMessage("Permission denied.", true); return; }

                    const busNameOptions = predefinedBusNames.map(s => `<option value="${s}">${s}</option>`).join('');
                    const busCodeOptions = allBusCodes.map(c => `<option value="${c.code}">${c.code}</option>`).join('');
                    const originOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                    const destinationOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                    const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Bus Name</option>${busNameOptions}<option value="custom">Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name"></div></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-left text-sm font-medium text-slate-700">Bus Code:</label><select id="bus-code-select" name="busCode" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Code</option>${busCodeOptions}<option value="custom">Add New...</option></select><div id="custom-bus-code-container" class="hidden mt-2"><input type="text" name="custom_busCode" class="w-full px-3 py-2 border rounded" placeholder="e.g., HJ"></div></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Trip Number:</label><input type="number" name="tripNumber" class="mt-1 w-full px-3 py-2 border rounded" placeholder="1-10" min="1" max="10" required></div>
            </div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Origin</option>${originOptions}<option value="custom">Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Destination</option>${destinationOptions}<option value="custom">Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Departure Time from Origin:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
        `;
                    try {
                        const data = await showModal('Add New Bus', formHtml, 'Add Bus');

                        if (data.busNumber && !predefinedBusNames.includes(data.busNumber)) {
                            await updateDoc(configDocRef, { busNames: arrayUnion(data.busNumber) });
                        }
                        if (data.busCode && !allBusCodes.some(c => c.code === data.busCode)) {
                            // New code created via "Add New..."
                            await addDoc(busCodesCollection, { code: data.busCode.toUpperCase() });
                        }

                        // Ensure the trip number for this bus code is not already used
                        const proposedTripNumber = Number(data.tripNumber);
                        if (allBuses.some(b => b.busCode === data.busCode.toUpperCase() && Number(b.tripNumber) === proposedTripNumber)) {
                            showMessage(`Trip number ${proposedTripNumber} is already used for bus code "${data.busCode.toUpperCase()}". Please choose a different trip number.`, true);
                            return;
                        }

                        // Ensure the combined bus ID code (CODE + tripNumber) is unique
                        const proposedBusIdCode = `${data.busCode.toUpperCase()}${data.tripNumber}`;
                        if (allBuses.some(b => b.busIdCode === proposedBusIdCode)) {
                            showMessage(`A bus with ID "${proposedBusIdCode}" already exists. Please choose a different code or trip number.`, true);
                            return;
                        }

                        if (data.origin && !predefinedStops.includes(data.origin)) {
                            await updateDoc(configDocRef, { stops: arrayUnion(data.origin) });
                        }
                        if (data.destination && !predefinedStops.includes(data.destination)) {
                            await updateDoc(configDocRef, { stops: arrayUnion(data.destination) });
                        }

                        const scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                        const firstStop = { name: data.origin, scheduledTime: scheduledTime, waitingTime: 0, displayFare: 0 };
                        const newBusIdCode = `${data.busCode.toUpperCase()}${data.tripNumber}`;
                        const newBus = {
                            busNumber: data.busNumber,
                            busCode: data.busCode.toUpperCase(),
                            tripNumber: Number(data.tripNumber),
                            busIdCode: newBusIdCode,
                            origin: data.origin,
                            destination: data.destination,
                            seatCapacity: Number(data.seatCapacity) || null,
                            stops: [firstStop],
                            status: { type: 'on-time', minutes: 0 },
                            fareMatrix: {},
                            marqueeSpeedPxPerSec: DEFAULT_MARQUEE_SPEED_PX_PER_SEC, // Set default speed for new bus
                            marqueeRepeatDelaySec: DEFAULT_MARQUEE_REPEAT_DELAY_SEC // Set default delay for new bus
                        };
                        const docRef = await addDoc(busCollection, newBus);
                        showMessage("New bus route added successfully.");
                        logAdminAction('ADD_BUS', `Added new bus route: ${newBus.busNumber} (ID: ${newBus.busIdCode})`, docRef.id, 'bus');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Add bus operation cancelled.");
                        } else {
                            console.error("Error during add bus operation:", error);
                            showMessage(`Error: Could not add bus. ${error.message}`);
                        }
                    }
                };

                const handleEditBus = async (busId) => {
                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                    const bus = allBuses.find(b => b.id === busId);
                    const isCustomBusName = !predefinedBusNames.includes(bus.busNumber);
                    const isCustomOrigin = !predefinedStops.includes(bus.origin);
                    const isCustomDestination = !predefinedStops.includes(bus.destination);

                    const busNameOptions = predefinedBusNames.map(s => `<option value="${s}" ${!isCustomBusName && s === bus.busNumber ? 'selected' : ''}>${s}</option>`).join('');
                    const busCodeOptions = allBusCodes.map(c => `<option value="${c.code}" ${c.code === bus.busCode ? 'selected' : ''}>${c.code}</option>`).join('');
                    const originOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomOrigin && s === bus.origin ? 'selected' : ''}>${s}</option>`).join('');
                    const destinationOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomDestination && s === bus.destination ? 'selected' : ''}>${s}</option>`).join('');

                    const formHtml = `
            <input type="hidden" name="id" value="${bus.id}">
            <div><label class="block text-left text-sm font-medium text-slate-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded">${busNameOptions}<option value="custom" ${isCustomBusName ? 'selected' : ''}>Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name" value="${isCustomBusName ? bus.busNumber : ''}"></div></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-left text-sm font-medium text-slate-700">Bus Code:</label><select id="bus-code-select" name="busCode" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled>Select Code</option>${busCodeOptions}<option value="custom">Add New...</option></select><div id="custom-bus-code-container" class="hidden mt-2"><input type="text" name="custom_busCode" class="w-full px-3 py-2 border rounded" placeholder="e.g., HJ"></div></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Trip Number:</label><input type="number" name="tripNumber" class="mt-1 w-full px-3 py-2 border rounded" placeholder="1-10" min="1" max="10" value="${bus.tripNumber || ''}" required></div>
            </div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48" value="${bus.seatCapacity || ''}"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded">${originOptions}<option value="custom" ${isCustomOrigin ? 'selected' : ''}>Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin" value="${isCustomOrigin ? bus.origin : ''}"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded">${destinationOptions}<option value="custom" ${isCustomDestination ? 'selected' : ''}>Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination" value="${isCustomDestination ? bus.destination : ''}"></div></div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Marquee Display Settings</h4>
                <div><label class="block text-left text-sm font-medium text-slate-700">Marquee Speed (pixels/second):</label><input type="number" name="marqueeSpeedPxPerSec" class="mt-1 w-full px-3 py-2 border rounded" min="1" value="${bus.marqueeSpeedPxPerSec || DEFAULT_MARQUEE_SPEED_PX_PER_SEC}" required></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Marquee Repeat Delay (seconds):</label><input type="number" name="marqueeRepeatDelaySec" class="mt-1 w-full px-3 py-2 border rounded" step="0.1" min="0" value="${bus.marqueeRepeatDelaySec || DEFAULT_MARQUEE_REPEAT_DELAY_SEC}" required></div>
            </div>
        `;
                    try {
                        const data = await showModal('Edit Bus Route', formHtml);

                        if (data.busNumber && !predefinedBusNames.includes(data.busNumber)) {
                            await updateDoc(configDocRef, { busNames: arrayUnion(data.busNumber) });
                        }
                        if (data.busCode && !allBusCodes.some(c => c.code === data.busCode)) {
                            await addDoc(busCodesCollection, { code: data.busCode.toUpperCase() });
                        }

                        // Ensure the trip number for this bus code is not already used (excluding this bus)
                        const proposedTripNumber = Number(data.tripNumber);
                        if (allBuses.some(b => b.id !== busId && b.busCode === data.busCode.toUpperCase() && Number(b.tripNumber) === proposedTripNumber)) {
                            showMessage(`Trip number ${proposedTripNumber} is already used for bus code "${data.busCode.toUpperCase()}". Please choose a different trip number.`, true);
                            return;
                        }

                        // Ensure the combined bus ID code (CODE + tripNumber) is unique (excluding this bus itself)
                        const proposedBusIdCode = `${data.busCode.toUpperCase()}${data.tripNumber}`;
                        if (allBuses.some(b => b.id !== busId && b.busIdCode === proposedBusIdCode)) {
                            showMessage(`A bus with ID "${proposedBusIdCode}" already exists. Please choose a different code or trip number.`, true);
                            return;
                        }

                        if (data.origin && !predefinedStops.includes(data.origin)) {
                            await updateDoc(configDocRef, { stops: arrayUnion(data.origin) });
                        }
                        if (data.destination && !predefinedStops.includes(data.destination)) {
                            await updateDoc(configDocRef, { stops: arrayUnion(data.destination) });
                        }

                        const busDocRef = doc(db, busCollection.path, busId);
                        const updatedBusIdCode = `${data.busCode.toUpperCase()}${data.tripNumber}`;
                        await updateDoc(busDocRef, {
                            busNumber: data.busNumber,
                            busCode: data.busCode.toUpperCase(),
                            tripNumber: Number(data.tripNumber),
                            busIdCode: updatedBusIdCode,
                            origin: data.origin,
                            destination: data.destination,
                            seatCapacity: Number(data.seatCapacity) || null,
                            marqueeSpeedPxPerSec: Number(data.marqueeSpeedPxPerSec),
                            marqueeRepeatDelaySec: Number(data.marqueeRepeatDelaySec)
                        });
                        showMessage("Bus details updated.");
                        logAdminAction('EDIT_BUS', `Edited bus route: ${bus.busNumber} (ID: ${bus.busIdCode})`, busId, 'bus');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Edit bus operation cancelled.");
                        } else {
                            console.error("Error updating bus:", error);
                            showMessage(`Error: Could not update bus. ${error.message}`);
                        }
                    }
                };

                const handleEditStop = async (busId, stopIndex) => {
                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                    const bus = allBuses.find(b => b.id === busId);
                    const stop = bus.stops[stopIndex];
                    const isCustomStop = !predefinedStops.includes(stop.name);
                    const stopOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomStop && s === stop.name ? 'selected' : ''}>${s}</option>`).join('');
                    const time12 = to12Hour(stop.scheduledTime);
                    const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required>${stopOptions}<option value="custom" ${isCustomStop ? 'selected' : ''}>Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name" value="${isCustomStop ? stop.name : ''}"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" value="${time12.hour}" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" value="${time12.minute}" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option ${time12.ampm === 'AM' ? 'selected' : ''}>AM</option><option ${time12.ampm === 'PM' ? 'selected' : ''}>PM</option></select></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Display Fare for this segment (‚Çπ):</label><input type="number" name="displayFare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="${stop.displayFare || 0}" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="${stop.waitingTime || 0}"></div>
        `;
                    try {
                        const data = await showModal('Edit Stop', formHtml);

                        if (data.name && !predefinedStops.includes(data.name)) {
                            await updateDoc(configDocRef, { stops: arrayUnion(data.name) });
                        }

                        data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                        const newStops = [...bus.stops];
                        newStops[stopIndex] = { ...newStops[stopIndex], name: data.name, scheduledTime: data.scheduledTime, displayFare: Number(data.displayFare) || 0, waitingTime: Number(data.waitingTime) || 0 };
                        newStops.sort((a, b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                        await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                        showMessage("Stop details updated. Please review fares in 'Manage Fares'.");
                        logAdminAction('EDIT_STOP', `Edited stop "${stop.name}" on bus ${bus.busNumber} to "${data.name}"`, busId, 'bus_stop');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Edit stop operation cancelled.");
                        } else {
                            console.error("Error updating stop:", error);
                            showMessage(`Error: Could not update stop. ${error.message}`);
                        }
                    }
                };

                const handleDeleteStop = async (busId, stopIndex) => {
                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                    if (await showConfirmation("This will remove the stop from the route. Are you sure?")) {
                        const bus = allBuses.find(b => b.id === busId);
                        const stopName = bus.stops[stopIndex].name;
                        const newStops = [...bus.stops];
                        newStops.splice(stopIndex, 1);
                        await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                        showMessage("Stop removed.");
                        logAdminAction('DELETE_STOP', `Removed stop "${stopName}" from bus ${bus.busIdCode}`, busId, 'bus_stop');
                    }
                };

                const handleDuplicateBus = async (busId) => {
                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                    const busToDuplicate = allBuses.find(b => b.id === busId);
                    if (!busToDuplicate) {
                        showMessage("Could not find the bus to duplicate.", true);
                        return;
                    }

                    const formHtml = `
            <p class="text-sm text-left text-slate-600 mb-4">Duplicating route: <strong>${busToDuplicate.busNumber} (ID: ${busToDuplicate.busIdCode})</strong>. Enter new trip details.</p>
            <div><label class="block text-left text-sm font-medium text-slate-700">New Trip Number:</label><input type="number" name="tripNumber" class="mt-1 w-full px-3 py-2 border rounded" placeholder="1-10" min="1" max="10" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">New Departure Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
        `;

                    try {
                        const data = await showModal('Duplicate Bus Trip', formHtml, 'Create Duplicate');
                        const newScheduledTime = to24Hour(data.hour, data.minute, data.ampm);

                        const newBus = JSON.parse(JSON.stringify(busToDuplicate));
                        delete newBus.id;

                        const originalDepartureTime = parseTime(newBus.stops[0].scheduledTime);
                        const newDepartureTime = parseTime(newScheduledTime);
                        const timeDifference = newDepartureTime - originalDepartureTime;

                        newBus.stops.forEach(stop => {
                            const oldStopTime = parseTime(stop.scheduledTime);
                            const newStopTime = new Date(oldStopTime.getTime() + timeDifference);
                            stop.scheduledTime = `${String(newStopTime.getHours()).padStart(2, '0')}:${String(newStopTime.getMinutes()).padStart(2, '0')}`;
                        });

                        // Update trip number and ID
                        newBus.tripNumber = Number(data.tripNumber);
                        newBus.busIdCode = `${newBus.busCode}${newBus.tripNumber}`;

                        // Ensure the trip number for this bus code is not already used
                        if (allBuses.some(b => b.busCode === newBus.busCode && Number(b.tripNumber) === newBus.tripNumber)) {
                            showMessage(`Trip number ${newBus.tripNumber} is already used for bus code "${newBus.busCode}". Please choose a different trip number.`, true);
                            return;
                        }

                        // Ensure the new bus ID code is unique
                        if (allBuses.some(b => b.busIdCode === newBus.busIdCode)) {
                            showMessage(`A bus with ID "${newBus.busIdCode}" already exists. Please choose a different trip number.`, true);
                            return;
                        }

                        const docRef = await addDoc(busCollection, newBus);
                        showMessage("Bus trip duplicated successfully.");
                        logAdminAction('DUPLICATE_BUS', `Duplicated bus ${busToDuplicate.busIdCode} to create new trip ${newBus.busIdCode}`, docRef.id, 'bus');

                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Duplicate bus operation cancelled.");
                        } else {
                            console.error("Error duplicating bus:", error);
                            showMessage(`Error: Could not duplicate bus. ${error.message}`);
                        }
                    }
                };

                const handleAddStop = async (busId) => {
                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                    const bus = allBuses.find(b => b.id === busId);
                    const stopOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                    const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select a stop</option>${stopOptions}<option value="custom">Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Display Fare for this segment (‚Çπ):</label><input type="number" name="displayFare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="0" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="0"></div>
        `;
                    try {
                        const data = await showModal('Add Stop', formHtml, 'Add Stop');

                        if (data.name && !predefinedStops.includes(data.name)) {
                            await updateDoc(configDocRef, { stops: arrayUnion(data.name) });
                        }

                        data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                        const newStops = [...bus.stops];
                        newStops.push({ name: data.name, scheduledTime: data.scheduledTime, displayFare: Number(data.displayFare) || 0, waitingTime: Number(data.waitingTime) || 0 });
                        newStops.sort((a, b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                        await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                        showMessage("Stop added. Please review fares in 'Manage Fares'.");
                        logAdminAction('ADD_STOP', `Added stop "${data.name}" to bus ${bus.busNumber}`, busId, 'bus_stop');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Add stop operation cancelled.");
                        } else {
                            console.error("Error adding stop:", error);
                            showMessage(`Error: Could not add stop. ${error.message}`);
                        }
                    }
                };

                const handleUpdateStatus = async (busId) => {
                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                    const bus = allBuses.find(b => b.id === busId);
                    const currentStatus = bus.status || { type: 'on-time', minutes: 0 };

                    // MODIFICATION: Added 'cancelled' option and updated visibility logic
                    const formHtml = `
            <div>
                <label class="block text-left text-sm font-medium text-slate-700">Status</label>
                <select id="status-type" name="type" class="mt-1 w-full px-3 py-2 border rounded">
                    <option value="on-time" ${currentStatus.type === 'on-time' ? 'selected' : ''}>On time</option>
                    <option value="late" ${currentStatus.type === 'late' ? 'selected' : ''}>Late</option>
                    <option value="early" ${currentStatus.type === 'early' ? 'selected' : ''}>Early</option>
                    <option value="cancelled" ${currentStatus.type === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
            </div>
            <div id="status-minutes-container" class="${!['late', 'early'].includes(currentStatus.type) ? 'hidden' : ''}">
                <label class="block text-left text-sm font-medium text-slate-700">Minutes</label>
                <input type="number" name="minutes" class="mt-1 w-full px-3 py-2 border rounded" value="${currentStatus.minutes || 0}">
            </div>
        `;

                    try {
                        const data = await showModal('Update Bus Status', formHtml, 'Update');
                        // MODIFICATION: Updated status object creation logic
                        const newStatus = {
                            type: data.type,
                            minutes: !['late', 'early'].includes(data.type) ? 0 : Number(data.minutes) || 0
                        };
                        await updateDoc(doc(db, busCollection.path, busId), { status: newStatus });
                        showMessage('Bus status updated.');
                        logAdminAction('UPDATE_BUS_STATUS', `Updated status for bus ${bus.busIdCode} to ${newStatus.type} (${newStatus.minutes} min)`, busId, 'bus');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Update status operation cancelled.");
                        } else {
                            console.error("Error updating status:", error);
                            showMessage(`Error: Could not update status. ${error.message}`);
                        }
                    }
                };

                const calculateAndDisplayFare = () => {
                    const fareFromStop = document.getElementById('fare-from-stop');
                    const fareToStop = document.getElementById('fare-to-stop');
                    const fareResultContainer = document.getElementById('fare-result-container');
                    const fromStopName = fareFromStop.value;
                    const toStopName = fareToStop.value;

                    fareResultContainer.innerHTML = '';

                    if (!fromStopName || !toStopName) {
                        fareResultContainer.innerHTML = `<p class="text-yellow-600">Please select both a starting and destination stop.</p>`;
                        return;
                    }

                    if (fromStopName === toStopName) {
                        fareResultContainer.innerHTML = `<p class="text-yellow-600">Starting and destination stops cannot be the same.</p>`;
                        return;
                    }

                    let totalFare = -1;
                    let foundRoute = null;
                    const fareKey = `${fromStopName}_${toStopName}`;
                    const reverseFareKey = `${toStopName}_${fromStopName}`;

                    for (const bus of allBuses) {
                        if (bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) {
                            foundRoute = bus;
                            totalFare = bus.fareMatrix[fareKey];
                            break;
                        }
                        if (bus.fareMatrix && bus.fareMatrix[reverseFareKey] !== undefined) {
                            foundRoute = bus;
                            totalFare = bus.fareMatrix[reverseFareKey];
                            break;
                        }
                    }

                    if (foundRoute) {
                        fareResultContainer.innerHTML = `
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-lg font-semibold text-green-800">Fare: ‚Çπ${totalFare}</p>
                    <p class="text-sm text-slate-600 mt-1">On bus route: ${foundRoute.busNumber} (${foundRoute.origin} - ${foundRoute.destination})</p>
                </div>
            `;
                    } else {
                        fareResultContainer.innerHTML = `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                                <p class="text-lg font-semibold text-red-800">No direct route found.</p>
                                <p class="text-sm text-slate-600 mt-1">No fare has been set for the trip from "${fromStopName}" to "${toStopName}".</p>
                            </div>
                        `;
                    }
                };

                const handleSaveFares = async () => {
                    if (!currentAdminPermissions.manageFares) { showMessage("Permission denied.", true); return; }
                    const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
                    const busId = manageFaresBusSelect.value;
                    if (!busId) { showMessage("No bus selected.", true); return; }

                    const newFareMatrix = {};
                    let hasError = false;

                    document.querySelectorAll('#fare-matrix-container .fare-input').forEach(input => {
                        if (hasError) return;
                        const fareKey = input.dataset.key;
                        const fareValue = input.value;
                        if (fareValue !== '') {
                            const parsedFare = parseInt(fareValue, 10);
                            if (isNaN(parsedFare) || parsedFare < 0) {
                                showMessage(`Invalid fare for ${fareKey.replace('_', ' to ')}. Please enter a valid number.`, true);
                                hasError = true;
                            }
                            newFareMatrix[fareKey] = parsedFare;
                        }
                    });

                    if (hasError) return;
                    try {
                        const busDocRef = doc(db, busCollection.path, busId);
                        await updateDoc(busDocRef, { fareMatrix: newFareMatrix });
                        showMessage("Fares updated successfully!");
                        const bus = allBuses.find(b => b.id === busId);
                        logAdminAction('UPDATE_FARES', `Updated fare matrix for bus ${bus.busIdCode}`, busId, 'bus');
                    } catch (error) {
                        console.error("Error updating fares:", error);
                        showMessage("Failed to update fares.", true);
                    }
                };

                const handleDownloadCSV = () => {
                    if (!currentAdminPermissions.manageFares) { showMessage("Permission denied.", true); return; }
                    const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
                    const busId = manageFaresBusSelect.value;
                    if (!busId) {
                        showMessage("Please select a bus route to download fares.", true);
                        return;
                    }

                    const bus = allBuses.find(b => b.id === busId);
                    if (!bus || !bus.stops || bus.stops.length < 2) {
                        showMessage("Not enough data to generate a CSV.", true);
                        return;
                    }

                    const stops = bus.stops.map(s => s.name);
                    let csvContent = "data:text/csv;charset=utf-8,";

                    // Header Row
                    csvContent += "From/To," + stops.join(",") + "\r\n";

                    // Data Rows
                    bus.stops.forEach((fromStop, i) => {
                        let row = fromStop.name;
                        bus.stops.forEach((toStop, j) => {
                            row += ",";
                            if (i < j) {
                                const fareKey = `${fromStop.name}_${toStop.name}`;
                                const fare = (bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) ? bus.fareMatrix[fareKey] : "";
                                row += fare;
                            }
                        });
                        csvContent += row + "\r\n";
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    const fileName = `${bus.busNumber.replace(/\s+/g, '_')}_${bus.busIdCode}_fares.csv`;
                    link.setAttribute("download", fileName);
                    document.body.appendChild(link); // Required for Firefox

                    link.click();
                    document.body.removeChild(link);
                    showMessage("Fare matrix download started.");
                    logAdminAction('DOWNLOAD_FARES_CSV', `Downloaded fare matrix CSV for bus ${bus.busIdCode}`, busId, 'bus');
                };

                const getYoutubeVideoId = (url) => {
                    try {
                        const urlObj = new URL(url);
                        if (urlObj.hostname === 'youtu.be') {
                            return urlObj.pathname.slice(1);
                        } else if (urlObj.hostname.includes('youtube.com')) {
                            return urlObj.searchParams.get('v');
                        }
                    } catch (e) {
                        console.error("Invalid video URL", e);
                        return null;
                    }
                    return null;
                };

                const initializeVideoAds = () => {
                    const videoPlaceholders = document.querySelectorAll('[data-video-id]');
                    videoPlaceholders.forEach(placeholder => {
                        const adId = placeholder.dataset.adId;
                        const videoId = placeholder.dataset.videoId;
                        if (videoId && !videoPlayers[adId]) {
                            const player = new YT.Player(placeholder.id, {
                                videoId: videoId,
                                playerVars: {
                                    'autoplay': 1,
                                    'mute': 1,
                                    'controls': 0,
                                    'loop': 1,
                                    'playlist': videoId,
                                    'playsinline': 1,
                                    'modestbranding': 1
                                },
                                events: {
                                    'onReady': (event) => {
                                        videoPlayers[adId] = event.target;
                                    }
                                }
                            });
                        }
                    });
                };

                const renderAdsList = () => {
                    const adsListContainer = document.getElementById('ads-list-container');
                    adsListContainer.innerHTML = '';
                    if (allAds.length === 0) {
                        adsListContainer.innerHTML = '<p class="text-slate-500">No advertisements have been added yet.</p>';
                        return;
                    }
                    allAds.forEach(ad => {
                        const adElement = document.createElement('div');
                        adElement.className = 'p-4 border rounded-lg flex items-center justify-between';

                        let adContentHtml = '';
                        if (ad.adType === 'video') {
                            adContentHtml = `
                    <div>
                        <p class="font-semibold text-sm">‚ñ∂Ô∏è Video Ad</p>
                        <p class="font-semibold">Position: After bus #${ad.position}</p>
                        <a href="${ad.videoUrl}" target="_blank" class="text-xs text-sky-600 hover:underline truncate">${ad.videoUrl}</a>
                    </div>
                `;
                        } else {
                            adContentHtml = `
                    <div class="flex items-center space-x-4">
                        <img src="${ad.imageUrl}" class="h-16 w-16 object-cover rounded-md" onerror="this.src='https://placehold.co/64x64/e2e8f0/475569?text=Image'"/>
                        <div>
                            <p class="font-semibold text-sm">üñºÔ∏è Image Ad</p>
                            <p class="font-semibold">Position: After bus #${ad.position}</p>
                            <a href="${ad.link}" target="_blank" class="text-xs text-sky-600 hover:underline truncate">${ad.link || 'No link'}</a>
                        </div>
                    </div>
                `;
                        }

                        adElement.innerHTML = `
                ${adContentHtml}
                <button data-ad-id="${ad.id}" class="remove-ad-btn p-2 rounded-full hover:bg-red-100 text-red-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
            `;
                        adsListContainer.appendChild(adElement);
                    });
                };

                const renderSchedule = (data) => {
                    videoPlayers = {}; // Clear old player references
                    scheduleList.innerHTML = '';
                    const adsByPosition = allAds.reduce((acc, ad) => {
                        acc[ad.position] = ad;
                        return acc;
                    }, {});

                    const showAdminControls = isAdmin;

                    if (data.length === 0) {
                        if (searchQuery || currentFilter !== 'all') {
                            setStatus(`No results found.`);
                        } else {
                            const message = isAdmin
                                ? "No buses found. Click 'Add New Bus' to create a schedule."
                                : "No buses found for today's schedule.";
                            setStatus(message);
                        }
                        return;
                    }

                    data.forEach((bus, busIndex) => {

                        // MODIFICATION: Handle cancelled buses first
                        if (bus.status?.type === 'cancelled') {
                            const listItem = document.createElement('div');
                            // 'relative' is added to position the admin buttons correctly
                            listItem.className = 'bus-item relative p-4 flex items-center border-b border-slate-200 opacity-70 bg-slate-50';

                            let cancelledHtml = `
                    <span class="text-4xl mr-4 flex-shrink-0">üö´</span>
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-sm text-slate-800 truncate">${bus.busNumber}: ${bus.origin} &rarr; ${bus.destination}</p>
                        ${isAdmin && bus.busIdCode ? `<p class="text-xs font-bold text-slate-600">ID: ${bus.busIdCode}</p>` : ''}
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-red-700 font-semibold text-sm">Cancelled</p>
                    </div>
                `;

                            // If admin is logged in, add the control buttons so they can edit it
                            if (isAdmin) {
                                const adminControlsHtml = `
                        <div class="absolute top-2 right-2 flex space-x-1">
                            <button title="Update Status" class="update-status-btn p-1.5 rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition-colors" data-bus-id="${bus.id}">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button title="Edit Bus" class="edit-bus-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-bus-id="${bus.id}">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button title="Delete Bus" class="delete-bus-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" data-bus-id="${bus.id}">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                                listItem.innerHTML = adminControlsHtml + cancelledHtml;
                            } else {
                                listItem.innerHTML = cancelledHtml;
                            }

                            scheduleList.appendChild(listItem);
                            return; // Stop processing this bus and move to the next one
                        }

                        let arrivalText, arrivalColor, arrivalSize;

                        if (bus.isFinished) {
                            arrivalText = 'Completed';
                            arrivalColor = 'text-slate-500 font-semibold';
                            arrivalSize = 'text-xs';
                        } else if (bus.etaAtGoolikkadavu === null) {
                            arrivalText = 'N/A';
                            arrivalColor = 'text-slate-500 font-semibold';
                            arrivalSize = 'text-xs'; // Changed
                        } else if (bus.etaAtGoolikkadavu < 0) {
                            arrivalText = 'Departed';
                            arrivalColor = 'text-slate-500 font-semibold';
                            arrivalSize = 'text-xs';
                        }
                        else {
                            arrivalText = formatEta(bus.etaAtGoolikkadavu);
                            arrivalColor = bus.etaAtGoolikkadavu <= 10 ? 'text-red-600 font-bold' : 'text-slate-900 font-semibold';
                            arrivalSize = 'text-sm';
                        }

                        const isDropdownOpen = openDropdownId === bus.id;

                        let stopsHtml = '';
                        bus.stops.forEach((stop, index) => {
                            const passedClass = stop.isPassed ? 'passed' : '';

                            const fareText = index > 0 ? `<p class="text-xs text-green-600 font-semibold">‚Çπ${stop.displayFare || 0}</p>` : '';
                            const waitTimeText = stop.waitingTime > 0 ? `<p class="text-xs text-sky-600 mt-1">‚òï Take Coffee Cup üïí ${stop.waitingTime} min wait</p>` : '';

                            const editButtons = showAdminControls ? `
                    <div class="flex items-center space-x-2">
                        ${fareText}
                        <button class="edit-stop-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded" data-bus-id="${bus.id}" data-stop-index="${index}">Edit</button>
                        <button class="delete-stop-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded" data-bus-id="${bus.id}" data-stop-index="${index}">Del</button>
                    </div>
                ` : `
                    <div class="text-right">
                        <p class="text-sm font-medium text-slate-600">${formatTime(new Date(stop.actualArrivalTime))}</p>
                        ${fareText}
                    </div>
                `;

                            stopsHtml += `
                    <div class="timeline-item ${passedClass}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="stop-name">${stop.name}</p>
                                <p class="text-xs text-slate-500">${stop.stopArrivalText}</p>
                                ${waitTimeText}
                            </div>
                            ${editButtons}
                        </div>
                    </div>`;
                        });

                        let addStopButtonHtml = '';
                        if (showAdminControls) {
                            addStopButtonHtml = `<div class="p-2 border-t mt-2 flex justify-around"><button class="add-stop-btn text-sm font-medium text-sky-600 hover:text-sky-800" data-bus-id="${bus.id}">+ Add Stop</button><button class="update-status-btn text-sm font-medium text-sky-600 hover:text-sky-800" data-bus-id="${bus.id}">Update Status</button></div>`;
                        }

                        const editBusButtons = showAdminControls ? `
                <div class="absolute top-2 right-2 flex space-x-1">
                    <button title="Duplicate Trip" class="duplicate-bus-btn p-1.5 rounded-full bg-green-100 text-green-700 hover:bg-green-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2-2H9a2 2 0 01-2-2V9z" /><path d="M3 3a2 2 0 00-2 2v6a2 2 0 002 2h1V9a4 4 0 014-4h5V5a2 2 0 00-2-2H3z" /></svg></button>
                    <button title="Edit Bus" class="edit-bus-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                    <button title="Delete Bus" class="delete-bus-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                </div>
            `: '';

                        let subtext = '';
                        if (bus.status && bus.status.type !== 'on-time') {
                            subtext = `<span class="${bus.status.type === 'late' ? 'text-red-600' : 'text-blue-600'}">${bus.status.minutes} min ${bus.status.type}</span>`;
                        } else {
                            subtext = `<span class="text-green-600">On time</span>`;
                        }

                        if (bus.seatCapacity) {
                            subtext += ` <span class="text-slate-400 mx-1">|</span> <span>üí∫ ${bus.seatCapacity}</span>`;
                        }

                        if (isAdmin && bus.busIdCode) {
                            subtext += ` <span class="text-slate-400 mx-1">|</span> <span class="font-bold text-slate-700">ID: ${bus.busIdCode}</span>`;
                        }

                        const listItem = document.createElement('div');
                        listItem.className = `bus-item relative border-b border-slate-200`;
                        listItem.dataset.busId = bus.id;
                        listItem.innerHTML = `
                ${editBusButtons}
                <div class="bus-header p-4 flex items-center cursor-pointer hover:bg-slate-50 transition-colors" data-bus-id="${bus.id}">
                    <span class="text-4xl mr-4 flex-shrink-0">üöç</span>
                    <div class="flex-grow min-w-0">
                        <div class="flex items-baseline mb-1 space-x-2">
                            <p class="font-bold text-xs text-slate-800 flex-shrink-0">${bus.busNumber}:</p>
                            <div class="relative flex-grow overflow-hidden">
                                <div class="bus-route-text text-xs font-medium text-slate-600" data-original-route="${bus.origin} &rarr; ${bus.destination}">
                                    <span class="marquee-content">${bus.origin} &rarr; ${bus.destination}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 text-xs font-medium mt-1">${subtext}</div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="${arrivalColor} ${arrivalSize}" data-eta-text-id="${bus.id}">${arrivalText}</p>
                    </div>
                </div>
                <div id="details-${bus.id}" class="bus-details bg-slate-50 px-4 ${isDropdownOpen ? 'open' : ''}">
                    <div class="timeline-wrapper">
                        ${stopsHtml}
                        ${bus.stops.length > 0 && !bus.isFinished ? `<span class="live-dot-icon" data-live-dot-id="${bus.id}"></span>` : ''}
                    </div>
                    ${addStopButtonHtml}
                </div>`;
                        scheduleList.appendChild(listItem);

                        const ad = adsByPosition[busIndex + 1];
                        if (ad) {
                            const adItem = document.createElement('div');
                            adItem.className = 'p-4 border-b border-slate-200';
                            let adHtml = '';

                            if (ad.adType === 'video' && ad.videoUrl) {
                                const videoId = getYoutubeVideoId(ad.videoUrl);
                                if (videoId) {
                                    adHtml = `
                            <div class="video-ad-container">
                                <div class="video-container">
                                    <div id="youtube-player-${ad.id}" data-video-id="${videoId}" data-ad-id="${ad.id}"></div>
                                </div>
                                <button class="mute-btn" data-ad-id="${ad.id}" title="Toggle Sound">
                                    <svg class="h-5 w-5" id="mute-icon-on-${ad.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l-2.25-2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                                    <svg class="h-5 w-5 hidden" id="mute-icon-off-${ad.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                                </button>
                            </div>
                        `;
                                }
                            } else if (ad.adType === 'image' && ad.imageUrl) {
                                adHtml = `<a href="${ad.link || '#'}" target="_blank" rel="noopener noreferrer"><img src="${ad.imageUrl}" alt="Advertisement" class="w-full h-auto rounded-lg" onerror="this.parentElement.style.display='none'"></a>`;
                            }

                            adItem.innerHTML = adHtml;
                            scheduleList.appendChild(adItem);
                        }

                        // Automatic scrolling for bus route text
                        const busRouteTextWrapper = listItem.querySelector('.bus-route-text').parentElement; // This is the new overflow-hidden div
                        const busRouteTextElement = listItem.querySelector('.bus-route-text'); // This is the flex container
                        const marqueeContentSpan = busRouteTextElement.querySelector('.marquee-content'); // Get one of the content spans

                        if (marqueeContentSpan && busRouteTextWrapper) {
                            // Use setTimeout to ensure layout calculation is complete
                            setTimeout(() => {
                                const singleTextWidth = marqueeContentSpan.scrollWidth; // Width of one copy of the text
                                const containerWidth = busRouteTextWrapper.clientWidth;

                                // Use bus-specific marquee settings, or fall back to defaults
                                const currentMarqueeSpeed = bus.marqueeSpeedPxPerSec !== undefined ? bus.marqueeSpeedPxPerSec : DEFAULT_MARQUEE_SPEED_PX_PER_SEC;
                                const currentMarqueeDelay = bus.marqueeRepeatDelaySec !== undefined ? bus.marqueeRepeatDelaySec : DEFAULT_MARQUEE_REPEAT_DELAY_SEC;

                                // Only apply marquee if text is wider than container
                                if (singleTextWidth > containerWidth) {
                                    // Add a second span for continuous loop if it doesn't exist
                                    let secondMarqueeContent = busRouteTextElement.children[1];
                                    if (!secondMarqueeContent) {
                                        secondMarqueeContent = document.createElement('span');
                                        secondMarqueeContent.className = 'marquee-content';
                                        secondMarqueeContent.setAttribute('aria-hidden', 'true'); // Hide from screen readers
                                        secondMarqueeContent.innerHTML = busRouteTextElement.dataset.originalRoute;
                                        busRouteTextElement.appendChild(secondMarqueeContent);
                                    }

                                    const gapPx = currentMarqueeDelay * currentMarqueeSpeed; // Distance traveled during the delay period

                                    // The animation needs to move the combined content by the width of one text plus the gap
                                    const totalScrollDistance = singleTextWidth + gapPx;
                                    const animationDuration = totalScrollDistance / currentMarqueeSpeed;

                                    busRouteTextElement.style.setProperty('--marquee-gap-px', `${gapPx}px`);
                                    busRouteTextElement.style.setProperty('--marquee-distance', `-${totalScrollDistance}px`);
                                    busRouteTextElement.style.animationName = 'marquee-route';
                                    busRouteTextElement.style.animationDuration = `${animationDuration}s`;
                                } else {
                                    // No need to scroll, remove animation
                                    busRouteTextElement.style.animationName = '';
                                }
                            }, 0); // Use 0ms timeout to defer execution until after render
                        }
                    });

                    // Initialize any new video players
                    if (typeof YT !== 'undefined' && YT.Player) {
                        initializeVideoAds();
                    }
                };

                const updateAndRenderSchedule = () => {
                    if (!isAuthReady) return;
                    const liveBusData = calculateLiveBusData();
                    let filteredBusData = filterAndSortBuses(liveBusData);
                    renderSchedule(filteredBusData);
                };

                const updateLiveElements = () => {
                    if (!isAuthReady) return;
                    const liveBusData = calculateLiveBusData();
                    let filteredBusData = filterAndSortBuses(liveBusData);

                    filteredBusData.forEach(bus => {
                        const busElement = document.querySelector(`.bus-item[data-bus-id="${bus.id}"]`);
                        if (!busElement) return; // Element not on screen, skip it

                        // Update ETA Text
                        const etaElement = busElement.querySelector(`[data-eta-text-id="${bus.id}"]`);
                        if (etaElement) {
                            let arrivalText, arrivalColor, arrivalSize;
                            if (bus.isFinished) {
                                arrivalText = 'Completed';
                                arrivalColor = 'text-slate-500 font-semibold';
                                arrivalSize = 'text-xs';
                            } else if (bus.etaAtGoolikkadavu === null) {
                                arrivalText = 'N/A';
                                arrivalColor = 'text-slate-500 font-semibold';
                                arrivalSize = 'text-xs'; // Changed
                            } else if (bus.etaAtGoolikkadavu < 0) {
                                arrivalText = 'Departed';
                                arrivalColor = 'text-slate-500 font-semibold';
                                arrivalSize = 'text-xs';
                            } else {
                                arrivalText = formatEta(bus.etaAtGoolikkadavu);
                                arrivalColor = bus.etaAtGoolikkadavu <= 10 ? 'text-red-600 font-bold' : 'text-slate-900 font-semibold';
                                arrivalSize = 'text-sm';
                            }
                            etaElement.textContent = arrivalText;
                            etaElement.className = `${arrivalColor} ${arrivalSize}`;
                        }

                        // Update Live Dot Position
                        const liveDot = busElement.querySelector(`[data-live-dot-id="${bus.id}"]`);
                        if (liveDot) {
                            const timelineItems = busElement.querySelectorAll('.timeline-item');
                            const index = bus.liveIconPositionIndex;
                            const floorIndex = Math.min(Math.floor(index), timelineItems.length - 1);
                            const fraction = index - floorIndex;

                            if (timelineItems.length > floorIndex && floorIndex >= 0) {
                                const centerAlignmentOffset = 14;
                                const floorItem = timelineItems[floorIndex];
                                const floorTop = floorItem.offsetTop + centerAlignmentOffset;
                                let topPosition = floorTop;
                                if (fraction > 0 && floorIndex < timelineItems.length - 1) {
                                    const ceilItem = timelineItems[floorIndex + 1];
                                    const ceilTop = ceilItem.offsetTop + centerAlignmentOffset;
                                    topPosition = floorTop + (ceilTop - floorTop) * fraction;
                                }
                                liveDot.style.top = `${topPosition}px`;
                            }
                        }
                    });
                };

                const calculateLiveBusData = () => {
                    const currentTime = new Date();
                    return allBuses.map(bus => {
                        const status = bus.status || { type: 'on-time', minutes: 0 };

                        // MODIFICATION: Handle cancelled buses
                        if (status.type === 'cancelled') {
                            return {
                                ...bus,
                                isFinished: true, // Treat it as finished for sorting/filtering
                                etaAtGoolikkadavu: null,
                                liveIconPositionIndex: 0,
                                stops: [] // No need to process stops
                            };
                        }

                        let statusOffset = 0;
                        if (status.type === 'late') {
                            statusOffset = status.minutes * 60000;
                        } else if (status.type === 'early') {
                            statusOffset = -status.minutes * 60000;
                        }

                        if (!bus.stops || bus.stops.length === 0) {
                            return { ...bus, stops: [], etaAtGoolikkadavu: null, liveIconPositionIndex: 0, isFinished: true };
                        }

                        const processedStops = bus.stops.map(stop => {
                            const actualArrivalTime = new Date(parseTime(stop.scheduledTime).getTime() + statusOffset);
                            const departureTime = new Date(actualArrivalTime.getTime() + (stop.waitingTime || 0) * 60000);
                            const isPassed = departureTime.getTime() < currentTime.getTime();
                            let stopArrivalText = `Scheduled ${formatTime(actualArrivalTime)}`;
                            if (isPassed) {
                                stopArrivalText = 'Departed';
                            } else if (actualArrivalTime.getTime() < currentTime.getTime()) {
                                stopArrivalText = 'Arrived';
                            }
                            return { ...stop, isPassed, stopArrivalText, actualArrivalTime, departureTime };
                        });

                        // Use the configured reference stop instead of hardcoded Goolikkadavu Jn
                        const referenceStop = processedStops.find(stop => stop.name === referenceStopName);
                        let etaAtGoolikkadavu = null;
                        if (referenceStop) {
                            etaAtGoolikkadavu = Math.round((referenceStop.actualArrivalTime.getTime() - currentTime.getTime()) / 60000);
                        }

                        const isFinished = processedStops.every(stop => stop.isPassed);

                        let liveIconPositionIndex = 0;
                        const nextStopIndex = processedStops.findIndex(stop => !stop.isPassed);

                        if (isFinished) {
                            liveIconPositionIndex = processedStops.length;
                        } else if (nextStopIndex > 0) {
                            const lastStop = processedStops[nextStopIndex - 1];
                            const currentNextStop = processedStops[nextStopIndex];
                            const lastStopDepartureTime = lastStop.departureTime.getTime();
                            const nextStopArrivalTime = currentNextStop.actualArrivalTime.getTime();

                            if (currentTime.getTime() >= lastStop.actualArrivalTime.getTime() && currentTime.getTime() < lastStopDepartureTime) {
                                liveIconPositionIndex = nextStopIndex - 1;
                            } else {
                                const segmentDuration = nextStopArrivalTime - lastStopDepartureTime;
                                if (segmentDuration > 0) {
                                    const progressInSegment = (currentTime.getTime() - lastStopDepartureTime) / segmentDuration;
                                    liveIconPositionIndex = (nextStopIndex - 1) + Math.min(1, Math.max(0, progressInSegment));
                                } else {
                                    liveIconPositionIndex = nextStopIndex - 1;
                                }
                            }
                        } else if (nextStopIndex === 0) {
                            const firstStop = processedStops[0];
                            const departureTime = parseTime(bus.stops[0].scheduledTime).getTime() + statusOffset;
                            const arrivalTime = firstStop.actualArrivalTime.getTime();
                            const segmentDuration = arrivalTime - departureTime;
                            if (segmentDuration > 0) {
                                const progressInSegment = (currentTime.getTime() - departureTime) / segmentDuration;
                                liveIconPositionIndex = progressInSegment;
                                liveIconPositionIndex = Math.min(1, Math.max(0, liveIconPositionIndex));
                            } else {
                                liveIconPositionIndex = 0;
                            }
                        }

                        return { ...bus, stops: processedStops, etaAtGoolikkadavu, liveIconPositionIndex, isFinished };
                    });
                };

                const filterAndSortBuses = (liveBusData) => {
                    let filteredBusData = liveBusData;

                    // Apply text search (bus name + origin for everyone, ID only for admins)
                    if (searchQuery) {
                        filteredBusData = filteredBusData.filter(bus => {
                            const busName = bus.busNumber.toLowerCase();
                            const origin = bus.origin.toLowerCase();
                            const matchesBasic = busName.includes(searchQuery) || origin.includes(searchQuery);

                            // Only allow searching by bus ID code for admins
                            if (isAdmin) {
                                const busIdCode = (bus.busIdCode || '').toLowerCase();
                                return matchesBasic || busIdCode.includes(searchQuery);
                            }

                            return matchesBasic;
                        });
                    }

                    // Apply current filter (live / by stop / all)
                    if (currentFilter === 'live') {
                        filteredBusData = filteredBusData.filter(bus => !bus.isFinished);
                    } else if (currentFilter !== 'all') {
                        filteredBusData = filteredBusData.filter(bus =>
                            bus.stops.some(stop => stop.name === currentFilter)
                        );
                    }

                    // Helper: sort by ETA at reference stop, then by first-stop time
                    const sortByEtaThenTime = (list) => {
                        list.sort((a, b) => {
                            const sortA = a.isFinished ? Infinity : a.etaAtGoolikkadavu;
                            const sortB = b.isFinished ? Infinity : b.etaAtGoolikkadavu;
                            const finalSortA = sortA === null ? Infinity - 1 : sortA;
                            const finalSortB = sortB === null ? Infinity - 1 : sortB;

                            if (finalSortA < finalSortB) return -1;
                            if (finalSortA > finalSortB) return 1;

                            const timeA = a.stops.length > 0 ? parseTime(a.stops[0].scheduledTime) : 0;
                            const timeB = b.stops.length > 0 ? parseTime(b.stops[0].scheduledTime) : 0;
                            return timeA - timeB;
                        });
                    };

                    // --- Group into: recent departed (top), live, completed/older ---
                    const departedRecent = [];
                    const liveList = [];
                    const completedList = [];

                    filteredBusData.forEach(bus => {
                        const eta = bus.etaAtGoolikkadavu;

                        if (bus.isFinished) {
                            // Fully completed route -> bottom section
                            completedList.push(bus);
                        } else if (eta != null && eta < 0) {
                            // Has passed the reference stop but route not fully finished yet
                            // Keep only last 15 minutes of departures in a small "Departed" block
                            if (eta >= -15) {
                                departedRecent.push(bus);
                            } else {
                                // Older than 15 minutes -> treat like completed, send to bottom
                                completedList.push(bus);
                            }
                        } else {
                            // Not yet at reference stop -> live buses block in the middle
                            liveList.push(bus);
                        }
                    });

                    // Sort each group
                    // Departed: most recently departed first (eta closest to 0, e.g. -1, -5, -10 ...)
                    departedRecent.sort((a, b) => {
                        const aEta = a.etaAtGoolikkadavu ?? -Infinity;
                        const bEta = b.etaAtGoolikkadavu ?? -Infinity;
                        return bEta - aEta; // -1 comes before -10
                    });

                    // Limit departed section to max 2 buses
                    const topDeparted = departedRecent.slice(0, 2);

                    // Live + completed use the normal ETA/time sort
                    sortByEtaThenTime(liveList);
                    sortByEtaThenTime(completedList);

                    // Final order on main page:
                    // 1. Departed (max 2, last 15 minutes)
                    // 2. Live buses
                    // 3. Completed / older buses
                    return [...topDeparted, ...liveList, ...completedList];
                };

                const renderAdminsList = () => {
                    adminListContainer.innerHTML = '';
                    if (!isSuperAdmin) {
                        adminListContainer.innerHTML = '<p class="text-red-500">You do not have permission to manage admins.</p>';
                        addAdminBtn.classList.add('hidden');
                        return;
                    }
                    addAdminBtn.classList.remove('hidden');

                    if (allAdmins.length === 0) {
                        adminListContainer.innerHTML = '<p class="text-slate-500">No admin accounts found.</p>';
                        return;
                    }

                    allAdmins.forEach(admin => {
                        const permissionsSummary = Object.keys(admin.permissions || {})
                            .filter(key => admin.permissions[key])
                            .map(key => key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim())
                            .join(', ');

                        const profileImageHtml = admin.profileImageUrl ?
                            `<img src="${admin.profileImageUrl}" alt="Profile" class="w-16 h-16 rounded-full object-cover mr-4" onerror="this.src='https://placehold.co/64x64/e2e8f0/475569?text=Admin'"/>` :
                            `<div class="w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xl font-bold mr-4">üë§</div>`;

                        const adminElement = document.createElement('div');
                        adminElement.className = 'p-4 border rounded-lg flex items-center justify-between';
                        adminElement.innerHTML = `
                <div class="flex items-center">
                    ${profileImageHtml}
                    <div>
                        <p class="font-semibold text-slate-800">${admin.name} (${admin.username})</p>
                        <p class="text-sm text-slate-600">Father: ${admin.fatherName || 'N/A'}</p>
                        <p class="text-sm text-slate-600">Contact: ${admin.contactNumber || 'N/A'}</p>
                        <p class="text-sm text-slate-600">Email: ${admin.email || 'N/A'}</p>
                        <p class="text-sm text-slate-600">Blood Group: ${admin.bloodGroup || 'N/A'}</p>
                        <p class="text-sm text-slate-600">Permissions: ${permissionsSummary || 'None'}</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button data-admin-id="${admin.id}" class="edit-admin-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" title="Edit Admin">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    ${admin.username !== SUPER_ADMIN_USERNAME ? `
                    <button data-admin-id="${admin.id}" class="delete-admin-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" title="Delete Admin">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>` : ''}
                </div>
            `;
                        adminListContainer.appendChild(adminElement);
                    });
                };

                const handleAddAdmin = async () => {
                    if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
                    const permissionOptions = Object.keys(DEFAULT_PERMISSIONS).map(key => {
                        const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
                        return `<div class="flex items-center"><input type="checkbox" name="permission_${key}" id="permission_${key}" class="h-4 w-4 text-sky-600 border-gray-300 rounded"><label for="permission_${key}" class="ml-2 text-sm text-slate-700">${label}</label></div>`;
                    }).join('');

                    const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}">${group}</option>`).join('');

                    const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
            <div>
                <label class="block text-left text-sm font-medium text-slate-700">Password</label>
                <div class="relative">
                    <input class="mt-1 w-full px-3 py-2 border rounded pr-10" type="password" name="password" required>
                    <button type="button" class="toggle-password-btn absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 mt-1">
                        ${SHOW_PASSWORD_ICON}
                    </button>
                </div>
            </div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" required></div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                    <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                        <option value="">-- Select Blood Group --</option>
                        ${bloodGroupOptions}
                    </select>
                </div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL (for now)</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg"></div>
            </div>
            <div class="mt-4"><p class="block text-left text-sm font-medium text-slate-700">Permissions:</p><div class="grid grid-cols-2 gap-2 mt-2">${permissionOptions}</div></div>
        `;
                    try {
                        const data = await showModal('Add New Admin', formHtml, 'Add Admin');
                        const newPermissions = {};
                        Object.keys(DEFAULT_PERMISSIONS).forEach(key => {
                            newPermissions[key] = data[`permission_${key}`] === 'on';
                        });

                        // Ensure manageAdmins permission is only granted to Super Admin
                        if (!isSuperAdmin) {
                            newPermissions.manageAdmins = false;
                        }

                        const newAdmin = {
                            username: data.username,
                            password: data.password, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                            name: data.name,
                            fatherName: data.fatherName || '',
                            contactNumber: data.contactNumber || '',
                            email: data.email || '',
                            bloodGroup: data.bloodGroup || '',
                            profileImageUrl: data.profileImageUrl || '',
                            permissions: newPermissions
                        };
                        const docRef = await addDoc(adminsCollection, newAdmin);
                        showMessage("New admin added successfully.");
                        logAdminAction('ADD_ADMIN', `Added new admin: ${newAdmin.name} (${newAdmin.username})`, docRef.id, 'admin');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Add admin operation cancelled.");
                        } else {
                            console.error("Error adding admin:", error);
                            showMessage(`Error: Could not add admin. ${error.message}`);
                        }
                    }
                };

                const handleEditAdmin = async (adminId) => {
                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                    const adminToEdit = allAdmins.find(a => a.id === adminId);
                    if (!adminToEdit) { showMessage("Admin not found.", true); return; }

                    const permissionOptions = Object.keys(DEFAULT_PERMISSIONS).map(key => {
                        const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
                        const isChecked = adminToEdit.permissions && adminToEdit.permissions[key] ? 'checked' : '';
                        const isDisabled = (adminToEdit.username === SUPER_ADMIN_USERNAME && key === 'manageAdmins') ? 'disabled' : ''; // Super Admin always has manageAdmins
                        return `<div class="flex items-center"><input type="checkbox" name="permission_${key}" id="permission_${key}" class="h-4 w-4 text-sky-600 border-gray-300 rounded" ${isChecked} ${isDisabled}><label for="permission_${key}" class="ml-2 text-sm text-slate-700">${label}</label></div>`;
                    }).join('');

                    const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}" ${adminToEdit.bloodGroup === group ? 'selected' : ''}>${group}</option>`).join('');

                    const formHtml = `
            <input type="hidden" name="id" value="${adminToEdit.id}">
            <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded bg-gray-100" type="text" name="username" value="${adminToEdit.username}" readonly></div>
            <div>
                <label class="block text-left text-sm font-medium text-slate-700">Password</label>
                <div class="relative">
                    <input class="mt-1 w-full px-3 py-2 border rounded pr-10" type="password" name="password" value="${adminToEdit.password}">
                    <button type="button" class="toggle-password-btn absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 mt-1">
                        ${SHOW_PASSWORD_ICON}
                    </button>
                </div>
            </div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" value="${adminToEdit.name}" required></div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName" value="${adminToEdit.fatherName || ''}"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber" value="${adminToEdit.contactNumber || ''}"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email" value="${adminToEdit.email || ''}"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                    <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                        <option value="">-- Select Blood Group --</option>
                        ${bloodGroupOptions}
                    </select>
                </div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL (for now)</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg" value="${adminToEdit.profileImageUrl || ''}"></div>
            </div>
            <div class="mt-4"><p class="block text-left text-sm font-medium text-slate-700">Permissions:</p><div class="grid grid-cols-2 gap-2 mt-2">${permissionOptions}</div></div>
        `;
                    try {
                        const data = await showModal('Edit Admin', formHtml, 'Save Changes');
                        const updatedPermissions = {};
                        Object.keys(DEFAULT_PERMISSIONS).forEach(key => {
                            updatedPermissions[key] = data[`permission_${key}`] === 'on';
                        });

                        // Ensure Super Admin always has manageAdmins permission, even if unchecked in form
                        if (adminToEdit.username === SUPER_ADMIN_USERNAME) {
                            updatedPermissions.manageAdmins = true;
                        }

                        await updateDoc(doc(db, adminsCollection.path, adminId), {
                            password: data.password, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                            name: data.name,
                            fatherName: data.fatherName || '',
                            contactNumber: data.contactNumber || '',
                            email: data.email || '',
                            bloodGroup: data.bloodGroup || '',
                            profileImageUrl: data.profileImageUrl || '',
                            permissions: updatedPermissions
                        });
                        showMessage("Admin updated successfully.");
                        logAdminAction('EDIT_ADMIN', `Edited admin: ${adminToEdit.name} (${adminToEdit.username})`, adminId, 'admin');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Edit admin operation cancelled.");
                        } else {
                            console.error("Error updating admin:", error);
                            showMessage(`Error: Could not update admin. ${error.message}`);
                        }
                    }
                };

                const handleDeleteAdmin = async (adminId) => {
                    if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
                    const adminToDelete = allAdmins.find(a => a.id === adminId);
                    if (!adminToDelete) { showMessage("Admin not found.", true); return; }

                    if (adminToDelete.username === SUPER_ADMIN_USERNAME) {
                        showMessage("The Super Admin account cannot be deleted.", true);
                        return;
                    }

                    if (await showConfirmation(`Are you sure you want to delete admin "${adminToDelete.name}"? This action cannot be undone.`)) {
                        try {
                            await deleteDoc(doc(db, adminsCollection.path, adminId));
                            showMessage("Admin deleted successfully.");
                            logAdminAction('DELETE_ADMIN', `Deleted admin: ${adminToDelete.name} (${adminToDelete.username})`, adminId, 'admin');
                        }
                        catch (error) {
                            console.error("Error deleting admin:", error);
                            showMessage(`Error: Could not delete admin. ${error.message}`);
                        }
                    }
                };

                const renderMyProfile = () => {
                    myProfileContent.innerHTML = ''; // Clear previous content
                    if (!currentAdmin) {
                        myProfileContent.innerHTML = '<p class="text-slate-500">Please log in to view your profile.</p>';
                        return;
                    }

                    const profileImageHtml = currentAdmin.profileImageUrl ?
                        `<img src="${currentAdmin.profileImageUrl}" alt="Profile" class="w-24 h-24 rounded-full object-cover mx-auto mb-4" onerror="this.src='https://placehold.co/96x96/e2e8f0/475569?text=Admin'"/>` :
                        `<div class="w-24 h-24 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-4xl font-bold mx-auto mb-4">üë§</div>`;

                    const permissionsListHtml = Object.keys(currentAdmin.permissions || {})
                        .filter(key => currentAdmin.permissions[key])
                        .map(key => {
                            const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
                            return `<li class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>${label}</li>`;
                        })
                        .join('');

                    // Conditionally render clickable links, ensuring values are not empty strings
                    const contactNumberHtml = (currentAdmin.contactNumber && String(currentAdmin.contactNumber).trim() !== '') ? `<a href="tel:${currentAdmin.contactNumber}" class="text-sky-600 hover:underline">${currentAdmin.contactNumber}</a>` : 'N/A';
                    const emailHtml = (currentAdmin.email && String(currentAdmin.email).trim() !== '') ? `<a href="mailto:${currentAdmin.email}" class="text-sky-600 hover:underline">${currentAdmin.email}</a>` : 'N/A';

                    let profileHtml = `
            <div class="text-center">
                ${profileImageHtml}
                <h3 class="text-xl font-bold text-slate-900">${currentAdmin.name}</h3>
                <p class="text-sm text-slate-600">@${currentAdmin.username}</p>
            </div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                <p class="text-sm text-slate-700"><strong>Father's Name:</strong> ${currentAdmin.fatherName || 'N/A'}</p>
                <p class="text-sm text-slate-700"><strong>Contact Number:</strong> ${contactNumberHtml}</p>
                <p class="text-sm text-slate-700"><strong>Email:</strong> ${emailHtml}</p>
                <p class="text-sm text-slate-700"><strong>Blood Group:</strong> ${currentAdmin.bloodGroup || 'N/A'}</p>
            </div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Permissions</h4>
                <ul class="list-none p-0 m-0 text-sm text-slate-700">
                    ${permissionsListHtml || '<li class="text-slate-500">No specific permissions assigned.</li>'}
                </ul>
            </div>
            <div class="mt-6 space-y-3">
                <button id="edit-my-profile-btn" class="w-full btn btn-primary">Edit Profile</button>
                <button id="change-my-password-btn" class="w-full btn btn-secondary">Change Password</button>
            </div>
        `;
                    myProfileContent.innerHTML = profileHtml;
                };

                const handleEditMyProfile = async () => {
                    if (!currentAdmin) { showMessage("Not logged in as admin.", true); return; }

                    const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}" ${currentAdmin.bloodGroup === group ? 'selected' : ''}>${group}</option>`).join('');

                    const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" value="${currentAdmin.name || ''}" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName" value="${currentAdmin.fatherName || ''}"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber" value="${currentAdmin.contactNumber || ''}"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email" value="${currentAdmin.email || ''}"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                    <option value="">-- Select Blood Group --</option>
                    ${bloodGroupOptions}
                </select>
            </div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg" value="${currentAdmin.profileImageUrl || ''}"></div>
        `;

                    try {
                        const data = await showModal('Edit My Profile', formHtml, 'Save Changes');
                        await updateDoc(doc(db, adminsCollection.path, currentAdmin.id), {
                            name: data.name,
                            fatherName: data.fatherName || '',
                            contactNumber: data.contactNumber || '',
                            email: data.email || '',
                            bloodGroup: data.bloodGroup || '',
                            profileImageUrl: data.profileImageUrl || ''
                        });
                        showMessage("Profile updated successfully.");
                        logAdminAction('EDIT_MY_PROFILE', `Updated own profile details`, currentAdmin.id, 'admin');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Edit profile cancelled.");
                        } else {
                            console.error("Error updating profile:", error);
                            showMessage(`Error updating profile: ${error.message}`, true);
                        }
                    }
                };

                const handleChangeMyPassword = async () => {
                    if (!currentAdmin) { showMessage("Not logged in as admin.", true); return; }

                    const formHtml = `
            <div>
                <label class="block text-left text-sm font-medium text-slate-700">Old Password</label>
                <div class="relative">
                    <input class="mt-1 w-full px-3 py-2 border rounded pr-10" type="password" name="oldPassword" required>
                    <button type="button" class="toggle-password-btn absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 mt-1">
                        ${SHOW_PASSWORD_ICON}
                    </button>
                </div>
            </div>
            <div>
                <label class="block text-left text-sm font-medium text-slate-700">New Password</label>
                <div class="relative">
                    <input class="mt-1 w-full px-3 py-2 border rounded pr-10" type="password" name="newPassword" required>
                    <button type="button" class="toggle-password-btn absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 mt-1">
                        ${SHOW_PASSWORD_ICON}
                    </button>
                </div>
            </div>
            <div>
                <label class="block text-left text-sm font-medium text-slate-700">Confirm New Password</label>
                <div class="relative">
                    <input class="mt-1 w-full px-3 py-2 border rounded pr-10" type="password" name="confirmNewPassword" required>
                    <button type="button" class="toggle-password-btn absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700 mt-1">
                        ${SHOW_PASSWORD_ICON}
                    </button>
                </div>
            </div>
        `;

                    try {
                        const data = await showModal('Change Password', formHtml, 'Change Password');

                        if (data.oldPassword !== currentAdmin.password) { // WARNING: Plaintext comparison
                            showMessage("Old password is incorrect.", true);
                            return;
                        }
                        if (data.newPassword !== data.confirmNewPassword) {
                            showMessage("New passwords do not match.", true);
                            return;
                        }
                        if (data.newPassword.length < 6) {
                            showMessage("New password must be at least 6 characters long.", true);
                            return;
                        }

                        await updateDoc(doc(db, adminsCollection.path, currentAdmin.id), {
                            password: data.newPassword // WARNING: Plaintext update
                        });
                        showMessage("Password changed successfully.");
                        logAdminAction('CHANGE_MY_PASSWORD', `Changed own password`, currentAdmin.id, 'admin');
                    } catch (error) {
                        if (error.message.includes("Modal cancelled")) {
                            console.log("Change password cancelled.");
                        } else {
                            console.error("Error changing password:", error);
                            showMessage(`Error changing password: ${error.message}`, true);
                        }
                    }
                };

                const renderAuditLogs = () => {
                    const auditLogsList = document.getElementById('audit-logs-list');
                    const clearLogsBtn = document.getElementById('clear-audit-logs-btn');
                    auditLogsList.innerHTML = '';

                    if (clearLogsBtn) clearLogsBtn.classList.add('hidden');

                    if (!currentAdminPermissions.viewAuditLogs) {
                        auditLogsList.innerHTML = '<p class="text-red-500">You do not have permission to view audit logs.</p>';
                        return;
                    }

                    if (isSuperAdmin && clearLogsBtn) {
                        clearLogsBtn.classList.remove('hidden');
                    }

                    if (allAuditLogs.length === 0) {
                        auditLogsList.innerHTML = '<p class="text-slate-500">No audit logs available.</p>';
                        return;
                    }

                    const logsHtml = allAuditLogs.map(log => {
                        const timestamp = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                        return `
                <div class="p-3 border rounded-lg bg-slate-50">
                    <p class="text-xs text-slate-500">${timestamp}</p>
                    <p class="text-sm text-slate-800"><strong>${log.adminName || 'Unknown Admin'}</strong>: ${log.details}</p>
                    ${log.entityType ? `<p class="text-xs text-slate-600">Entity: ${log.entityType} (ID: ${log.entityId})</p>` : ''}
                </div>
            `;
                    }).join('');
                    auditLogsList.innerHTML = logsHtml;
                };


                const renderReportsPage = () => {
                    const listContainer = document.getElementById('reports-bus-list-container');
                    if (!listContainer) return;

                    if (!isSuperAdmin && !currentAdminPermissions.manageReports) {
                        listContainer.innerHTML = '<p class="text-red-500">You do not have permission to manage reports.</p>';
                        document.getElementById('download-selected-btn').classList.add('hidden');
                        document.getElementById('download-all-btn').classList.add('hidden');
                        return;
                    }

                    document.getElementById('download-selected-btn').classList.remove('hidden');
                    document.getElementById('download-all-btn').classList.remove('hidden');

                    // Group by bus name + code so that KMS with code KM and KMS with code KMS are separate
                    const busesByNameAndCode = allBuses.reduce((acc, bus) => {
                        const name = bus.busNumber;
                        const code = bus.busCode || '';
                        if (!name) return acc;
                        const key = `${name}__${code}`; // internal key
                        if (!acc[key]) {
                            acc[key] = { trips: [], busName: name, busCode: code };
                        }
                        acc[key].trips.push(bus);
                        return acc;
                    }, {});

                    const groupKeys = Object.keys(busesByNameAndCode).sort((a, b) => {
                        const A = busesByNameAndCode[a];
                        const B = busesByNameAndCode[b];
                        const nameCmp = A.busName.localeCompare(B.busName);
                        if (nameCmp !== 0) return nameCmp;
                        return A.busCode.localeCompare(B.busCode);
                    });

                    const filteredKeys = groupKeys.filter(key => {
                        const group = busesByNameAndCode[key];
                        const label = `${group.busName} ${group.busCode}`.toLowerCase();
                        return label.includes(reportsSearchQuery);
                    });

                    if (filteredKeys.length === 0) {
                        listContainer.innerHTML = '<p class="text-slate-500">No buses found matching your search.</p>';
                        return;
                    }

                    const listHtml = filteredKeys.map(key => {
                        const group = busesByNameAndCode[key];
                        const tripCount = group.trips.length;
                        const busName = group.busName;
                        const busCode = group.busCode || '';

                        return `
                <div class="flex items-center p-2 rounded-md hover:bg-slate-50">
                    <input id="bus-report-${key}" type="checkbox" value="${key}" class="bus-report-checkbox h-5 w-5 text-sky-600 border-slate-300 rounded focus:ring-sky-500">
                    <label for="bus-report-${key}" class="ml-3 flex-grow cursor-pointer">
                        <span class="font-medium text-slate-800">${busName} ${busCode}</span>
                        <span class="text-sm text-slate-500 ml-2">(${tripCount}-Trips)</span>
                    </label>
                </div>
            `;
                    }).join('');

                    listContainer.innerHTML = listHtml;
                };

                // START: New function to generate and download the report
                const downloadBusReportCSV = (selectedBusNames) => {
                    if (selectedBusNames.length === 0) {
                        showMessage("No buses were selected for the report.", true);
                        return;
                    }

                    // 1. Filter all trips to get only the ones for the selected bus groups (name + code)
                    const tripsForReport = allBuses.filter(bus => {
                        const key = `${bus.busNumber}__${bus.busCode || ''}`;
                        return selectedBusNames.includes(key);
                    });

                    // 2. Group the filtered trips by their bus name + code key
                    const busesByGroupKey = tripsForReport.reduce((acc, bus) => {
                        const key = `${bus.busNumber}__${bus.busCode || ''}`;
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(bus);
                        return acc;
                    }, {});

                    let csvContent = []; // We'll build the report line by line in this array

                    // 3. Process each selected bus group one by one
                    for (const groupKey of selectedBusNames) {
                        const trips = busesByGroupKey[groupKey];
                        if (!trips || trips.length === 0) continue;

                        const [busName, busCode] = groupKey.split('__');

                        // -- Gather Header Info for this bus --
                        const firstTrip = trips[0];
                        const codeLabel = busCode || (firstTrip.busCode || 'N/A');
                        const route = `${firstTrip.origin} ‚Üí ${firstTrip.destination}`;
                        const seats = firstTrip.seatCapacity || 'N/A';

                        // Find all unique stop names across all trips for this bus to create the columns
                        const allStopsSet = new Set();
                        trips.forEach(trip => trip.stops.forEach(stop => allStopsSet.add(stop.name)));
                        const uniqueStops = Array.from(allStopsSet);
                        // Sort unique stops by their appearance order in the first trip's schedule.
                        // Stops not found in the first trip will be appended at the end.
                        uniqueStops.sort((a, b) => {
                            const orderA = firstTrip.stops.findIndex(s => s.name === a);
                            const orderB = firstTrip.stops.findIndex(s => s.name === b);

                            // If both stops are in firstTrip, sort by their index
                            if (orderA !== -1 && orderB !== -1) {
                                return orderA - orderB;
                            }
                            // If only stop A is in firstTrip, A comes first
                            if (orderA !== -1) {
                                return -1;
                            }
                            // If only stop B is in firstTrip, B comes first
                            if (orderB !== -1) {
                                return 1;
                            }
                            // If neither are in firstTrip, sort alphabetically
                            return a.localeCompare(b);
                        });


                        // -- Build CSV rows for this bus (name + code) --
                        csvContent.push(`"Bus Name-${busName}", , ,"Bus Code-${codeLabel}"`); // Add commas for spacing
                        csvContent.push(`"Route","${route}", ,"Seats","${seats}","Stops (Count)","${uniqueStops.length}"`);

                        // Header row for stop times
                        const stopHeaders = uniqueStops.map(stop => `"${stop}"`).join(',');
                        csvContent.push(`,${stopHeaders}`); // Leading comma to align under stops

                        // Data rows for each trip
                        trips.sort((a, b) => a.tripNumber - b.tripNumber).forEach(trip => {
                            const tripRow = [`"${trip.busIdCode || 'N/A'}"`];
                            const waitRow = ['']; // A second row just for wait times

                            uniqueStops.forEach(stopName => {
                                const stopData = trip.stops.find(s => s.name === stopName);
                                if (stopData) {
                                    const time12 = to12Hour(stopData.scheduledTime);
                                    tripRow.push(`"${time12.hour}:${time12.minute} ${time12.ampm}"`);
                                    if (stopData.waitingTime > 0) {
                                        waitRow.push(`"${stopData.waitingTime}m wait"`);
                                    } else {
                                        waitRow.push('');
                                    }
                                } else {
                                    tripRow.push(''); // Empty cell if the trip doesn't have this stop
                                    waitRow.push('');
                                }
                            });
                            csvContent.push(tripRow.join(','));
                            // Add the wait time row only if it contains any wait times
                            if (waitRow.some(val => val !== '')) {
                                csvContent.push(waitRow.join(','));
                            }
                        });

                        csvContent.push(''); // Add a blank line for spacing between buses
                    }

                    // 4. Trigger the download
                    const csvString = csvContent.join('\r\n');
                    const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvString);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "bus_report.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                // END: New function to generate and download the report

                const handleClearAuditLogs = async () => {
                    if (!isSuperAdmin) {
                        showMessage("Permission denied. Only the Super Admin can clear audit logs.", true);
                        return;
                    }

                    const confirmed = await showConfirmation("Are you sure you want to permanently delete ALL audit logs? This action cannot be undone.");
                    if (!confirmed) {
                        return;
                    }

                    showMessage("Clearing all audit logs, please wait...");

                    try {
                        const logsSnapshot = await getDocs(auditLogsCollection);
                        if (logsSnapshot.empty) {
                            showMessage("No logs to clear.");
                            return;
                        }

                        const batch = writeBatch(db);
                        logsSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        await batch.commit();

                        // IMPORTANT: Log this action itself
                        await logAdminAction('CLEAR_AUDIT_LOGS', `Cleared all audit logs.`);

                        showMessage("All audit logs have been cleared successfully.");
                        // The onSnapshot listener will automatically refresh the view

                    } catch (error) {
                        console.error("Error clearing audit logs:", error);
                        showMessage("An error occurred while clearing the audit logs.", true);
                    }
                };


                const renderManageBusCodesPage = () => {
                    // Target the new container directly
                    const listContainer = document.getElementById('bus-codes-list-container');
                    const addCodeContainer = document.getElementById('add-code-container');
                    listContainer.innerHTML = ''; // Always clear the container first

                    const canManageBusCodes = isSuperAdmin || currentAdminPermissions.manageBusCodes;

                    if (!canManageBusCodes) {
                        if (addCodeContainer) addCodeContainer.classList.add('hidden');
                        // Do not render the table container at all if not permitted
                        listContainer.innerHTML = '<div class="bg-white rounded-lg shadow-sm border border-red-200 p-4 text-red-500">You do not have permission to manage bus codes.</div>';
                        return;
                    }

                    if (addCodeContainer) addCodeContainer.classList.remove('hidden');
                    if (addCodeContainer) addCodeContainer.classList.remove('hidden');

                    const busesByCode = allBuses.reduce((acc, bus) => {
                        const code = bus.busCode || 'UNCATEGORIZED';
                        if (!acc[code]) { acc[code] = []; }
                        acc[code].push(bus);
                        return acc;
                    }, {});

                    const filteredCodes = allBusCodes.filter(codeObj => {
                        if (!busCodeSearchQuery) return true;
                        const associatedBusesForCode = busesByCode[codeObj.code];
                        const busName = (associatedBusesForCode && associatedBusesForCode.length > 0 && associatedBusesForCode[0].busNumber) || '';
                        return codeObj.code.toLowerCase().includes(busCodeSearchQuery) || busName.toLowerCase().includes(busCodeSearchQuery);
                    });

                    const sortedMasterCodes = filteredCodes.sort((a, b) => a.code.localeCompare(b.code));
                    const totalCount = sortedMasterCodes.length;
                    const totalTrips = sortedMasterCodes.reduce((acc, codeObj) => {
                        const associatedBuses = busesByCode[codeObj.code] || [];
                        return acc + associatedBuses.length;
                    }, 0);

                    // This HTML string builds the entire "Existing Codes" card with its title, table, and content.
                    let cardHtml = `
    <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-bold text-slate-800">Bus Codes</h2>
        <button onclick="showPage('manage-staff-page'); renderManageStaffPage();" class="btn btn-sm btn-secondary flex items-center shadow-sm border border-slate-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            Manage Bus Staff
        </button>
    </div>
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-x-auto">
        <h3 class="text-lg font-semibold text-slate-800 p-4 border-b border-slate-200">Existing Codes (${totalCount}) <span class="text-sm font-normal text-slate-500 ml-2">Total Trips: ${totalTrips}</span></h3>
    `;

                    if (totalCount === 0) {
                        cardHtml += `<p class="text-slate-500 p-4">No codes have been added yet.</p>`;
                    } else {
                        cardHtml += `
            <table class="w-full text-sm text-left table-fixed">
                <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                    <tr>
                        <th scope="col" class="px-4 py-3">Bus Name</th>
                        <th scope="col" class="px-4 py-3">Code</th>
                        <th scope="col" class="px-4 py-3">Trip Count</th>
                        <th scope="col" class="px-4 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

                        sortedMasterCodes.forEach(codeObj => {
                            const associatedBuses = busesByCode[codeObj.code] || [];
                            const tripCount = associatedBuses.length;
                            const isUnused = tripCount === 0;
                            const busName = isUnused ? `<span class="text-slate-400">Unused</span>` : (associatedBuses.length > 0 ? associatedBuses[0].busNumber : 'N/A');
                            const isRowOpen = openBusCodeRow === codeObj.code;

                            let actionButtonHtml = '';

                            if (codeObj.pendingReplacementCode) {
                                if (isSuperAdmin) {
                                    // Review Icon (Yellow/Orange) - Interactive for Super Admin
                                    actionButtonHtml = `<button class="review-reassignment-btn text-yellow-500 hover:text-yellow-600 p-2" 
                                        data-code-id="${codeObj.id}" 
                                        data-code-name="${codeObj.code}" 
                                        data-trip-count="${tripCount}"
                                        data-new-code="${codeObj.pendingReplacementCode}"
                                        title="Review Reassignment for '${codeObj.code}'">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                                        </svg>
                                    </button>`;
                                } else {
                                    // Static Badge for Sub-Admins
                                    actionButtonHtml = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200" title="Reassignment pending Super Admin review">
                                        Pending
                                    </span>`;
                                }
                            } else if (isUnused) {
                                // Standard Delete (Red)
                                actionButtonHtml = `<button class="delete-bus-code-btn text-red-500 hover:text-red-700 p-2" data-code-id="${codeObj.id}" data-code-name="${codeObj.code}" title="Delete Code '${codeObj.code}'"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`;
                            } else {
                                // Reassign (Grey but clickable)
                                actionButtonHtml = `<button class="reassign-bus-code-btn text-slate-400 hover:text-slate-600 p-2" 
                                    data-code-id="${codeObj.id}" 
                                    data-code-name="${codeObj.code}" 
                                    data-trip-count="${tripCount}"
                                    title="Reassign or Delete Code '${codeObj.code}'">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>`;
                            }

                            const rowClass = isUnused ? '' : 'bus-code-row cursor-pointer hover:bg-slate-50';
                            const rowDataAttr = isUnused ? '' : `data-bus-code="${codeObj.code}"`;

                            cardHtml += `
                <tr class="border-b border-slate-200 ${rowClass}" ${rowDataAttr}>
                    <td class="px-4 py-3 font-medium text-slate-900">${busName}</td>
                    <td class="px-4 py-3 font-bold">${codeObj.code}</td>
                    <td class="px-4 py-3">${tripCount}</td>
                    <td class="px-4 py-3 text-right">${actionButtonHtml}</td>
                </tr>
            `;

                            if (isRowOpen) {
                                associatedBuses.sort((a, b) => {
                                    const timeA = (a.stops && a.stops.length > 0) ? a.stops[0].scheduledTime : '23:59';
                                    const timeB = (b.stops && b.stops.length > 0) ? b.stops[0].scheduledTime : '23:59';
                                    return timeA.localeCompare(timeB);
                                });

                                const tripDetailsHtml = associatedBuses.map(trip => {
                                    const departure = (trip.stops && trip.stops.length > 0)
                                        ? to12Hour(trip.stops[0].scheduledTime)
                                        : { hour: 'N', minute: '/A', ampm: '' };
                                    return `<div class="text-xs p-2 border-t border-slate-200">${departure.hour}:${departure.minute} ${departure.ampm} - ${trip.origin} to ${trip.destination}</div>`;
                                }).join('');

                                cardHtml += `
                    <tr>
                        <td colspan="4" class="p-2 bg-slate-50">
                            <div class="text-slate-600">${tripDetailsHtml}</div>
                        </td>
                    </tr>
                `;
                            }
                        });

                        cardHtml += `</tbody></table></div>`; // Close the table and the overflow-x-auto div
                    }

                    cardHtml += `</div>`; // Close the main card container
                    listContainer.innerHTML = cardHtml;
                };

                // --- Bus Staff Management Logic ---

                let staffBusSearchQuery = '';

                const renderManageStaffPage = () => {
                    const listContainer = document.getElementById('staff-bus-list');
                    if (!listContainer) return;
                    listContainer.innerHTML = '';

                    // Check perm
                    if (!isSuperAdmin && !currentAdminPermissions.manageStaff) {
                        listContainer.innerHTML = '<div class="col-span-full text-red-500 text-center">Permission Denied</div>';
                        return;
                    }

                    // Group buses by (busNumber + busCode)
                    const groupedBuses = {};
                    allBuses.forEach(bus => {
                        // Use a composite key. Fallback to ID if no number/code (shouldn't happen often)
                        const key = `${bus.busNumber || 'Unknown'}_${bus.busCode || 'NoCode'}`;
                        if (!groupedBuses[key]) {
                            groupedBuses[key] = {
                                ...bus,
                                tripCount: 0,
                                allIds: [] // Store all document IDs for this group
                            };
                        }
                        groupedBuses[key].tripCount++;
                        groupedBuses[key].allIds.push(bus.id);
                    });

                    const filteredGroups = Object.values(groupedBuses).filter(group => {
                        if (!staffBusSearchQuery) return true;
                        const q = staffBusSearchQuery.toLowerCase();
                        return (group.busNumber && group.busNumber.toLowerCase().includes(q)) ||
                            (group.origin && group.origin.toLowerCase().includes(q)) ||
                            (group.destination && group.destination.toLowerCase().includes(q));
                    });

                    if (filteredGroups.length === 0) {
                        listContainer.innerHTML = '<div class="col-span-full text-center text-slate-500">No buses found.</div>';
                        return;
                    }

                    listContainer.innerHTML = filteredGroups.map(group => {
                        const staffCount = group.staff ? group.staff.length : 0;
                        const safeNum = (group.busNumber || '').replace(/'/g, "\\'");
                        const safeCode = (group.busCode || '').replace(/'/g, "\\'");

                        return `
                        <div class="group bg-white rounded-xl shadow-sm border border-slate-100 hover:shadow-xl hover:border-blue-100 transition-all duration-300 cursor-pointer overflow-hidden relative" onclick="openStaffModal('${safeNum}', '${safeCode}')">
                            <!-- Decorative Gradient bg -->
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-600"></div>
                            
                            <div class="p-5">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-xl text-slate-800 group-hover:text-blue-600 transition-colors">${group.busNumber}</h3>
                                        <p class="text-sm font-medium text-slate-500 mt-0.5">${group.origin} <span class="text-slate-300">|</span> ${group.destination}</p>
                                    </div>
                                    <div class="px-2 py-1 bg-slate-50 rounded text-xs font-mono text-slate-500 border border-slate-100">${group.busCode || 'N/A'}</div>
                                </div>

                                <!-- Stats Grid -->
                                <div class="grid grid-cols-2 gap-4 mt-6">
                                    <!-- Staff Stat -->
                                    <div class="flex flex-col items-center justify-center p-3 rounded-lg bg-indigo-50 border border-indigo-100 group-hover:bg-indigo-100 transition-colors">
                                        <p class="text-xs text-indigo-600 font-semibold uppercase tracking-wider mb-1">Staff</p>
                                        <p class="text-2xl font-bold text-indigo-900 leading-none">${staffCount}</p>
                                    </div>

                                    <!-- Trips Stat -->
                                    <div class="flex flex-col items-center justify-center p-3 rounded-lg bg-emerald-50 border border-emerald-100 group-hover:bg-emerald-100 transition-colors">
                                        <p class="text-xs text-emerald-600 font-semibold uppercase tracking-wider mb-1">Trips</p>
                                        <p class="text-2xl font-bold text-emerald-900 leading-none">${group.tripCount}</p>
                                    </div>
                                </div>

                                <div class="mt-5 flex items-center justify-end">
                                    <span class="text-sm font-medium text-slate-400 group-hover:text-blue-600 transition-colors flex items-center">
                                        Manage Staff 
                                        <svg class="w-4 h-4 ml-1 transform group-hover:translate-x-1 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                                    </span>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                };

                window.openStaffModal = (busNumber, busCode) => {
                    // Find ALL buses matching this descriptor
                    const matchingBuses = allBuses.filter(b =>
                        (b.busNumber || '') === busNumber && (b.busCode || '') === busCode
                    );

                    if (matchingBuses.length === 0) return;

                    const primaryBus = matchingBuses[0]; // Use first one as source of truth for staff display

                    const modal = document.getElementById('staff-modal');
                    const title = document.getElementById('staff-modal-bus-name');
                    // Store the group identifiers in hidden fields or data attributes
                    const formBusId = document.getElementById('staff-bus-id'); // We'll re-purpose this or add new ones

                    if (modal) {
                        modal.classList.remove('hidden');
                        modal.dataset.busNumber = busNumber;
                        modal.dataset.busCode = busCode;
                    }

                    if (title) title.textContent = `Staff for ${primaryBus.busNumber} (${matchingBuses.length} Trips)`;
                    if (formBusId) formBusId.value = primaryBus.id; // Still keeping one ID might be useful for fallback, but we rely on dataset now

                    renderStaffList(primaryBus);
                };

                window.closeStaffModal = () => {
                    document.getElementById('staff-modal').classList.add('hidden');
                };

                const renderStaffList = (bus) => {
                    const container = document.getElementById('staff-list-container');
                    if (!container) return;

                    if (!bus.staff || bus.staff.length === 0) {
                        container.innerHTML = '<p class="text-center text-slate-500 py-4">No staff members added yet.</p>';
                        return;
                    }

                    container.innerHTML = bus.staff.map((member, index) => `
                        <div class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg shadow-sm">
                            <div>
                                <p class="font-bold text-slate-800">${member.name} <span class="text-xs font-normal text-slate-500">(${member.role})</span></p>
                                <div class="flex items-center gap-3 mt-1">
                                    <a href="tel:${member.contact}" class="flex items-center text-xs text-blue-600 hover:underline">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                        ${member.contact}
                                    </a>
                                    ${member.locality ? `<span class="text-xs text-slate-400">| ${member.locality}</span>` : ''}
                                </div>
                            </div>
                            ${(isSuperAdmin || currentAdminPermissions.manageStaff) ? `
                            <button onclick="deleteStaff('${index}')" class="text-red-500 hover:text-red-700 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>` : ''}
                        </div>
                    `).join('');
                };

                const addStaff = async (e) => {
                    e.preventDefault();

                    const modal = document.getElementById('staff-modal');
                    const busNumber = modal.dataset.busNumber;
                    const busCode = modal.dataset.busCode;

                    const name = document.getElementById('staff-name').value;
                    const role = document.getElementById('staff-role').value;
                    const contact = document.getElementById('staff-contact').value;
                    const locality = document.getElementById('staff-locality').value;
                    const dob = document.getElementById('staff-dob').value;

                    if (!busNumber) {
                        showMessage("Error: Bus context missing. Please re-open modal.", true);
                        return;
                    }

                    try {
                        // Find ALL buses matching this group
                        const matchingBuses = allBuses.filter(b =>
                            (b.busNumber || '') === busNumber && (b.busCode || '') === busCode
                        );

                        if (matchingBuses.length === 0) {
                            showMessage("No matching buses found to update.", true);
                            return;
                        }

                        const newStaff = { name, role, contact, locality, dob };

                        // Perform Batch Update to keep them in sync
                        const batch = writeBatch(db);

                        matchingBuses.forEach(bus => {
                            const currentStaff = bus.staff || [];
                            const updatedStaff = [...currentStaff, newStaff];
                            const busRef = doc(db, busCollection.path, bus.id); // Use correct collection path
                            batch.update(busRef, { staff: updatedStaff });
                        });

                        await batch.commit();

                        showMessage(`Staff added to ${matchingBuses.length} trips.`);
                        document.getElementById('add-staff-form').reset();

                        // Optimistic Update (Update all local buses)
                        matchingBuses.forEach(bus => {
                            if (!bus.staff) bus.staff = [];
                            bus.staff.push(newStaff);
                        });

                        renderStaffList(matchingBuses[0]); // Re-render list
                        renderManageStaffPage(); // Update counts on main page

                    } catch (error) {
                        console.error("Error adding staff:", error);
                        showMessage("Failed to add staff member.", true);
                    }
                };

                window.deleteStaff = async (index) => {
                    if (!confirm("Are you sure you want to remove this staff member?")) return;

                    const modal = document.getElementById('staff-modal');
                    const busNumber = modal.dataset.busNumber;
                    const busCode = modal.dataset.busCode;

                    try {
                        const matchingBuses = allBuses.filter(b =>
                            (b.busNumber || '') === busNumber && (b.busCode || '') === busCode
                        );

                        if (matchingBuses.length === 0) return;

                        const batch = writeBatch(db);

                        matchingBuses.forEach(bus => {
                            const currentStaff = bus.staff || [];
                            const updatedStaff = currentStaff.filter((_, i) => i !== index);
                            const busRef = doc(db, busCollection.path, bus.id);
                            batch.update(busRef, { staff: updatedStaff });
                        });

                        await batch.commit();

                        showMessage("Staff member removed from all trips.");

                        // Optimistic Update
                        matchingBuses.forEach(bus => {
                            if (bus.staff) {
                                bus.staff = bus.staff.filter((_, i) => i !== index);
                            }
                        });

                        renderStaffList(matchingBuses[0]);
                        renderManageStaffPage();
                    } catch (error) {
                        console.error("Error deleting staff:", error);
                        showMessage("Failed to remove staff.", true);
                    }
                };

                window.switchFeedbackTab = (tab) => {
                    // Update Tab Styles
                    ['complaint', 'feedback', 'track'].forEach(type => {
                        const btn = document.getElementById(`tab-${type}`);
                        if (type === tab) {
                            btn.classList.remove('text-slate-500', 'hover:text-slate-700', 'border-transparent');
                            btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                        } else {
                            btn.classList.add('text-slate-500', 'hover:text-slate-700');
                            btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-blue-50');
                        }
                    });

                    // Update Visibility & State
                    const form = document.getElementById('feedback-form');
                    const trackSection = document.getElementById('track-section');
                    const headerContent = document.getElementById('feedback-header-content');
                    const trackHeaderContent = document.getElementById('track-header-content');
                    const typeInput = document.getElementById('feedback-type');
                    const requiredLabel = document.getElementById('contact-required-label');
                    const contactInput = document.getElementById('feedback-contact');

                    if (tab === 'track') {
                        form.classList.add('hidden');
                        trackSection.classList.remove('hidden');
                        headerContent.classList.add('hidden');
                        trackHeaderContent.classList.remove('hidden');
                    } else {
                        form.classList.remove('hidden');
                        trackSection.classList.add('hidden');
                        headerContent.classList.remove('hidden');
                        trackHeaderContent.classList.add('hidden');
                        typeInput.value = tab === 'complaint' ? 'Complaint' : 'Feedback';

                        // Contact requirement logic
                        const categoryContainer = document.getElementById('category-container');
                        const busContainer = document.getElementById('bus-select-container');
                        const timeContainer = document.getElementById('time-container');
                        const locationContainer = document.getElementById('location-container');

                        // Dynamic Header & Fields
                        const headerTitle = headerContent.querySelector('h2');
                        const headerDesc = headerContent.querySelector('p');

                        if (tab === 'complaint') {
                            // Rich Header for Complaint
                            headerTitle.innerHTML = '<span class="text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-orange-600">Submit Complaint</span>';
                            headerDesc.textContent = "Report an incident or issue regarding our service.";

                            requiredLabel.classList.remove('hidden');
                            contactInput.placeholder = "Required to track status";
                            contactInput.required = true;

                            // Show full form for complaints
                            categoryContainer.classList.remove('hidden');
                            busContainer.classList.remove('hidden');
                            timeContainer.classList.remove('hidden');
                            locationContainer.classList.remove('hidden');
                        } else {
                            // Rich Header for Feedback
                            headerTitle.innerHTML = '<span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">Share Your Feedback</span>';
                            headerDesc.textContent = "Help us improve your travel experience.";

                            requiredLabel.classList.add('hidden');
                            contactInput.placeholder = "Optional";
                            contactInput.required = false;

                            // Simplify form for feedback (Single box style)
                            categoryContainer.classList.add('hidden');
                            busContainer.classList.add('hidden');
                            timeContainer.classList.add('hidden');
                            locationContainer.classList.add('hidden');
                        }
                    }
                };

                window.trackMyComplaints = async () => {
                    const phoneInput = document.getElementById('track-phone-input');
                    const resultsContainer = document.getElementById('user-complaints-list');
                    const phone = phoneInput.value.trim();

                    if (!phone) {
                        showMessage("Please enter your phone number.", true);
                        return;
                    }

                    resultsContainer.innerHTML = '<div class="flex justify-center p-4"><div class="spinner border-4 border-blue-200 h-6 w-6 rounded-full"></div></div>';

                    try {
                        const q = query(complaintsCollection, where("contact", "==", phone), orderBy("timestamp", "desc"));
                        const querySnapshot = await getDocs(q);

                        if (querySnapshot.empty) {
                            resultsContainer.innerHTML = '<p class="text-center text-slate-500 py-4">No records found for this number.</p>';
                            return;
                        }

                        resultsContainer.innerHTML = querySnapshot.docs.map(doc => {
                            const data = doc.data();
                            const statusColor = data.status === 'Resolved' ? 'bg-green-100 text-green-800' : (data.status === 'New' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800');
                            return `
                                <div class="bg-slate-50 p-3 rounded border border-slate-200 text-sm">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="font-bold text-slate-700">${data.category}</span>
                                        <span class="px-2 py-0.5 rounded text-xs font-medium ${statusColor}">${data.status}</span>
                                    </div>
                                    <p class="text-slate-600 mb-1">${data.description}</p>
                                    <div class="text-xs text-slate-400">
                                        ${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : ''} 
                                        ${data.busRoute ? ` ‚Ä¢ ${data.busRoute}` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');

                    } catch (err) {
                        console.error("Error tracking complaints:", err);
                        // Start the retry by creating the index query failed 
                        // Actually, Firestore might error if index missing. 
                        resultsContainer.innerHTML = '<p class="text-center text-red-500 py-4">Error fetching records. (Index might be building)</p>';
                    }
                };

                const populateFeedbackBusSelect = () => {
                    const select = document.getElementById('feedback-bus-select');
                    if (!select) return;
                    const currentVal = select.value;
                    select.innerHTML = '<option value="">-- Select Bus --</option>';

                    // Unique names ONLY (Merge duplicates)
                    const uniqueNames = new Set();
                    allBuses.forEach(b => {
                        if (b.busNumber) uniqueNames.add(b.busNumber.trim());
                    });

                    const sortedNames = Array.from(uniqueNames).sort();

                    sortedNames.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });

                    if (currentVal) select.value = currentVal;
                };

                // Complaints State
                let complaintsFilterStatus = 'all';
                let complaintsTypeFilter = 'all';
                let complaintsSearchQuery = '';

                window.filterComplaintsByType = (type) => {
                    complaintsTypeFilter = type;
                    // Update UI
                    ['all', 'complaint', 'feedback'].forEach(t => {
                        const btn = document.getElementById(`filter-type-${t}`);
                        if (t === type.toLowerCase()) {
                            btn.classList.remove('text-slate-500', 'hover:text-slate-700', 'border-transparent');
                            btn.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                        } else {
                            btn.classList.add('text-slate-500', 'hover:text-slate-700', 'border-transparent');
                            btn.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                        }
                    });
                    renderComplaintsPage();
                };

                const renderComplaintsPage = (status = null) => {
                    if (status) complaintsFilterStatus = status;

                    const container = document.getElementById('complaints-list-container');
                    if (!container) return;
                    container.innerHTML = '';

                    if (!isAdmin || !currentAdminPermissions.manageComplaints) {
                        container.innerHTML = '<p class="text-red-500">Permission denied.</p>';
                        return;
                    }

                    // Apply Filters
                    let filtered = allComplaints;

                    // 1. Status Filter
                    if (complaintsFilterStatus !== 'all') {
                        filtered = filtered.filter(c => c.status === complaintsFilterStatus);
                    }

                    // 2. Type Filter
                    if (complaintsTypeFilter !== 'all') {
                        filtered = filtered.filter(c => c.type === complaintsTypeFilter);
                    }

                    // 3. Search Filter
                    if (complaintsSearchQuery) {
                        const q = complaintsSearchQuery.toLowerCase();
                        filtered = filtered.filter(c =>
                            (c.contact && c.contact.includes(q)) ||
                            (c.description && c.description.toLowerCase().includes(q)) ||
                            (c.busRoute && c.busRoute.toLowerCase().includes(q)) ||
                            (c.category && c.category.toLowerCase().includes(q))
                        );
                    }

                    if (filtered.length === 0) {
                        container.innerHTML = '<div class="text-center text-slate-500 py-8">No records found matching filters.</div>';
                        return;
                    }

                    container.innerHTML = filtered.map(complaint => {
                        const statusColors = {
                            'New': 'bg-blue-100 text-blue-800',
                            'Resolved': 'bg-green-100 text-green-800',
                            'Dismissed': 'bg-red-100 text-red-800'
                        };
                        const badgeColor = statusColors[complaint.status] || 'bg-gray-100 text-gray-800';
                        const typeBadge = complaint.type === 'Feedback'
                            ? '<span class="px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 mr-2">Feedback</span>'
                            : '<span class="px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800 mr-2">Complaint</span>';

                        return `
                        <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm transition-all hover:shadow-md">
                            <div class="flex flex-col md:flex-row justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        ${typeBadge}
                                        <h3 class="font-bold text-slate-800 text-lg">${complaint.category}</h3>
                                        <span class="ml-3 px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeColor}">
                                            ${complaint.status}
                                        </span>
                                    </div>
                                    <p class="text-slate-600 text-sm mb-3">${complaint.description}</p>
                                    <div class="flex flex-wrap gap-y-1 gap-x-4 text-xs text-slate-500">
                                        <div class="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                            ${complaint.timestamp ? new Date(complaint.timestamp.seconds * 1000).toLocaleString() : 'N/A'}
                                        </div>
                                        ${complaint.busRoute ? `
                                        <div class="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                            ${complaint.busRoute}
                                        </div>` : ''}
                                        ${complaint.contact ? `
                                        <div class="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                            ${complaint.contact}
                                        </div>` : ''}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2 min-w-[140px]">
                                    <select onchange="updateComplaintStatus('${complaint.id}', this.value)" class="text-xs border-slate-300 rounded shadow-sm focus:ring-blue-500 focus:border-blue-500 px-2 py-1">
                                        <option value="New" ${complaint.status === 'New' ? 'selected' : ''}>Mark as New</option>
                                        <option value="Resolved" ${complaint.status === 'Resolved' ? 'selected' : ''}>Mark as Resolved</option>
                                        <option value="Dismissed" ${complaint.status === 'Dismissed' ? 'selected' : ''}>Dismiss</option>
                                    </select>
                                    <button onclick="if(confirm('Delete this record?')) deleteComplaint('${complaint.id}')" class="text-red-500 hover:text-red-700 p-1 self-end transition-colors" title="Delete Record">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                };


                window.renderComplaintsPage = renderComplaintsPage;

                window.updateComplaintStatus = async (id, status) => {
                    if (!isAdmin) return;
                    try {
                        await updateDoc(doc(db, complaintsCollection.path, id), { status });
                        showMessage(`Complaint marked as ${status}.`);
                    } catch (e) {
                        console.error(e);
                        showMessage("Error updating status.", true);
                    }
                };

                window.deleteComplaint = async (id) => {
                    if (!isAdmin) return;
                    if (!await showConfirmation("Delete this complaint?")) return;
                    try {
                        await deleteDoc(doc(db, complaintsCollection.path, id));
                        showMessage("Complaint deleted.");
                    } catch (e) {
                        console.error(e);
                        showMessage("Error deleting complaint.", true);
                    }
                };

                const setupEventListeners = () => {
                    const complaintsSearchInput = document.getElementById('complaints-search-input');
                    if (complaintsSearchInput) {
                        complaintsSearchInput.addEventListener('input', (e) => {
                            complaintsSearchQuery = e.target.value;
                            renderComplaintsPage();
                        });
                    }
                    const manageFaresSearchBar = document.getElementById('manage-fares-search-bar');
                    if (manageFaresSearchBar) {
                        manageFaresSearchBar.addEventListener('input', () => {
                            populateManageFaresBusSelect();
                        });
                    }

                    // Staff Search
                    const staffSearch = document.getElementById('staff-bus-search');
                    if (staffSearch) {
                        staffSearch.addEventListener('input', (e) => {
                            staffBusSearchQuery = e.target.value;
                            renderManageStaffPage();
                        });
                    }

                    // Add Staff Form
                    const addStaffForm = document.getElementById('add-staff-form');
                    if (addStaffForm) {
                        addStaffForm.addEventListener('submit', addStaff);
                    }

                    // Use event delegation on the document for all clicks
                    document.addEventListener('click', async (e) => {
                        const target = e.target;
                        const button = target.closest('button');
                        const navLink = target.closest('.nav-link');
                        const header = target.closest('.bus-header');
                        const filterOption = target.closest('.filter-option');
                        const busCodeRow = target.closest('.bus-code-row');

                        // NEW: Handle bus code row clicks for accordion
                        if (busCodeRow && !button) { // Make sure we're not clicking a button inside the row
                            e.preventDefault();
                            const busCode = busCodeRow.dataset.busCode;
                            openBusCodeRow = openBusCodeRow === busCode ? null : busCode;
                            renderManageBusCodesPage();
                        }

                        // NEW: Toggle Password Visibility
                        const toggleBtn = target.closest('.toggle-password-btn');
                        if (toggleBtn) {
                            const container = toggleBtn.closest('.relative');
                            const input = container.querySelector('input');
                            if (input) {
                                if (input.type === 'password') {
                                    input.type = 'text';
                                    toggleBtn.innerHTML = HIDE_PASSWORD_ICON;
                                } else {
                                    input.type = 'password';
                                    toggleBtn.innerHTML = SHOW_PASSWORD_ICON;
                                }
                            }
                        }

                        // Sidebar controls
                        if (target.closest('#menu-btn')) openSidebar();
                        if (target.id === 'sidebar-overlay') closeSidebar();

                        // Close filter dropdown when clicking outside search/filter area
                        const filterArea = document.querySelector('#filter-btn')?.parentElement?.parentElement;
                        if (filterDropdown && !filterDropdown.classList.contains('hidden')) {
                            if (!target.closest('#filter-btn') && !target.closest('#filter-dropdown')) {
                                filterDropdown.classList.add('hidden');
                            }
                        }

                        if (navLink) {
                            e.preventDefault();
                            const pageId = navLink.dataset.page || (navLink.id ? navLink.id.replace('-link', '') : null);
                            if (pageId === 'admin-logout') logout();
                            else if (pageId === 'admin-login') login(false);
                            else if (pageId === 'super-admin-login') login(true);
                            else if (pageId === 'manage-stops') showManageStopsModal();
                            else if (pageId) showPage(pageId);
                        }

                        // Filter Dropdown options
                        if (filterOption) {
                            e.preventDefault();

                            // Reference-stop options inside dropdown
                            const refStop = filterOption.dataset.refStop;
                            if (refStop) {
                                referenceStopName = refStop;
                                // Update URL hash so the link can be shared (#kottathara, #thavalam, etc.)
                                const slug = refStop.toLowerCase().replace(/\s+/g, '');
                                window.location.hash = slug;
                                updateAndRenderSchedule();
                                showMessage(`Showing times for ${refStop}.`);
                                filterDropdown.classList.add('hidden');
                                return;
                            }

                            const filterValue = filterOption.dataset.filter;
                            if (filterValue === 'select-stop') {
                                if (isSuperAdmin && currentAdminPermissions.manageStops) showManageStopsModal();
                                else showStopFilterModal();
                            } else {
                                currentFilter = filterValue;
                                updateAndRenderSchedule();
                                updateFilterDropdown();
                                // If a stop was chosen from the "Select your Stop" modal, close it as well
                                hideStopFilterModal();
                            }
                            filterDropdown.classList.add('hidden');
                        }

                        // Main page controls
                        if (button) {
                            // Mute button
                            if (button.matches('.mute-btn')) {
                                const adId = button.dataset.adId;
                                const player = videoPlayers[adId];
                                if (player && typeof player.isMuted === 'function') {
                                    const onIcon = document.getElementById(`mute-icon-on-${adId}`);
                                    const offIcon = document.getElementById(`mute-icon-off-${adId}`);
                                    if (player.isMuted()) {
                                        player.unMute();
                                        onIcon.classList.add('hidden');
                                        offIcon.classList.remove('hidden');
                                    } else {
                                        player.mute();
                                        onIcon.classList.remove('hidden');
                                        offIcon.classList.add('hidden');
                                    }
                                }
                            }

                            // Home page buttons
                            if (button.id === 'add-bus-btn') handleAddBus();
                            if (button.id === 'filter-btn') {
                                e.stopPropagation();
                                filterDropdown.classList.toggle('hidden');
                            }

                            // Bus item admin buttons
                            const busId = button.dataset.busId;
                            if (busId) {
                                const stopIndex = parseInt(button.dataset.stopIndex, 10);
                                if (button.matches('.edit-bus-btn')) handleEditBus(busId);
                                else if (button.matches('.delete-bus-btn')) {
                                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                                    if (await showConfirmation("This will permanently delete the entire bus route. This action cannot be undone.")) {
                                        await deleteDoc(doc(db, busCollection.path, busId));
                                        showMessage("Bus route deleted.");
                                        const bus = allBuses.find(b => b.id === busId);
                                        logAdminAction('DELETE_BUS', `Deleted bus route: ${bus.busNumber} (${bus.busIdCode})`, busId, 'bus');
                                    }
                                }
                                else if (button.matches('.duplicate-bus-btn')) handleDuplicateBus(busId);
                                else if (button.matches('.add-stop-btn')) handleAddStop(busId);
                                else if (button.matches('.edit-stop-btn')) handleEditStop(busId, stopIndex);
                                else if (button.matches('.delete-stop-btn')) {
                                    if (!isAdmin) { showMessage("Permission denied.", true); return; }
                                    if (await showConfirmation("This will remove the stop from the route. Are you sure?")) {
                                        const bus = allBuses.find(b => b.id === busId);
                                        const stopName = bus.stops[stopIndex].name;
                                        const newStops = [...bus.stops];
                                        newStops.splice(stopIndex, 1);
                                        await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                                        showMessage("Stop removed.");
                                        logAdminAction('DELETE_STOP', `Removed stop "${stopName}" from bus ${bus.busIdCode}`, busId, 'bus_stop');
                                    }
                                }
                                else if (button.matches('.update-status-btn')) handleUpdateStatus(busId);
                            }

                            // Modal buttons
                            if (button.id === 'modal-save') {
                                const editForm = document.getElementById('edit-form');
                                if (editForm.checkValidity()) {
                                    const formData = new FormData(editForm);
                                    let data = Object.fromEntries(formData.entries());
                                    if (data.busNumber === 'custom') data.busNumber = data.custom_busNumber;
                                    if (data.busCode === 'custom') data.busCode = data.custom_busCode.toUpperCase();
                                    if (data.origin === 'custom') data.origin = data.custom_origin;
                                    if (data.destination === 'custom') data.destination = data.custom_destination;
                                    if (data.name === 'custom') data.name = data.custom_name;
                                    ['custom_busNumber', 'custom_busCode', 'custom_origin', 'custom_destination', 'custom_name'].forEach(key => delete data[key]);
                                    if (modalResolve) modalResolve(data);
                                    hideModal();
                                } else {
                                    editForm.reportValidity();
                                }
                            }
                            if (button.id === 'modal-cancel') {
                                if (modalReject) modalReject(new Error("Modal cancelled by user."));
                                hideModal();
                            }
                            if (button.id === 'confirm-cancel-btn') document.getElementById('confirmation-modal').classList.add('hidden');
                            if (button.id === 'stop-filter-cancel') hideStopFilterModal();
                            if (button.id === 'manage-stops-close-btn') hideManageStopsModal();

                            // Other page buttons
                            if (button.id === 'calculate-fare-btn') calculateAndDisplayFare();
                            // üëá PASTE THE NEW BUTTON LOGIC HERE
                            if (button.id === 'download-selected-btn') {
                                const selectedCheckboxes = document.querySelectorAll('.bus-report-checkbox:checked');
                                const selectedGroupKeys = Array.from(selectedCheckboxes).map(cb => cb.value);
                                downloadBusReportCSV(selectedGroupKeys);
                            }

                            if (button.id === 'download-all-btn') {
                                const allCheckboxes = document.querySelectorAll('.bus-report-checkbox');
                                const allGroupKeys = Array.from(allCheckboxes).map(cb => cb.value);
                                downloadBusReportCSV(allGroupKeys);
                            }
                            if (button.id === 'save-fares-btn') handleSaveFares();
                            if (button.id === 'download-csv-btn') handleDownloadCSV();
                            if (button.id === 'upload-csv-btn') document.getElementById('csv-upload-input').click();
                            if (button.id === 'publish-announcement-btn') {
                                if (!currentAdminPermissions.manageAnnouncements) { showMessage("Permission denied.", true); return; }
                                const text = document.getElementById('announcement-input').value.trim();
                                if (text) {
                                    const newMessage = {
                                        id: crypto.randomUUID(),
                                        text: text,
                                        active: true,
                                        createdAt: Date.now()
                                    };
                                    // Use setDoc with merge to ensure we can create the messages array if it doesn't exist
                                    await setDoc(announcementDocRef, {
                                        messages: arrayUnion(newMessage)
                                    }, { merge: true });

                                    showMessage("Announcement added.");
                                    document.getElementById('announcement-input').value = '';
                                    logAdminAction('PUBLISH_ANNOUNCEMENT', `Added announcement: "${text}"`);
                                }
                            }
                            // Delete Announcement Button
                            if (button.matches('.delete-announcement-btn')) {
                                const deleteId = button.dataset.id;
                                if (!deleteId) return;
                                if (!currentAdminPermissions.manageAnnouncements) { showMessage("Permission denied.", true); return; }

                                try {
                                    // We need to read the doc to filter the array, as we only have the ID
                                    const snap = await getDoc(announcementDocRef);
                                    if (snap.exists()) {
                                        const data = snap.data();
                                        const messages = data.messages || [];
                                        const fileteredMessages = messages.filter(m => m.id !== deleteId);
                                        // Update the doc with the new array
                                        await updateDoc(announcementDocRef, { messages: fileteredMessages });
                                        showMessage("Announcement deleted.");
                                        logAdminAction('DELETE_ANNOUNCEMENT', `Deleted announcement ID: ${deleteId}`);
                                    }
                                } catch (error) {
                                    console.error("Error deleting announcement:", error);
                                    showMessage("Error deleting announcement.", true);
                                }
                            }
                            if (button.matches('.remove-ad-btn')) {
                                if (!currentAdminPermissions.manageAds) { showMessage("Permission denied.", true); return; }
                                const adId = button.dataset.adId;
                                const ad = allAds.find(a => a.id === adId);
                                if (await showConfirmation("Are you sure you want to remove this advertisement?")) {
                                    await deleteDoc(doc(db, adsCollection.path, adId));
                                    showMessage("Advertisement removed successfully.");
                                    logAdminAction('DELETE_AD', `Removed ad (Type: ${ad.adType}, Position: ${ad.position})`, adId, 'ad');
                                }
                            }
                            if (button.id === 'add-filter-stop-btn') {
                                if (!currentAdminPermissions.manageStops) { showMessage("Permission denied.", true); return; }
                                const addStopSelect = document.getElementById('add-stop-select');
                                const customInput = document.getElementById('custom-filter-stop-input');
                                let stopToAdd = addStopSelect.value === 'custom' ? customInput.value.trim() : addStopSelect.value;
                                if (stopToAdd && !filterableStops.includes(stopToAdd)) {
                                    const newStops = [...new Set([...filterableStops, stopToAdd])].sort();
                                    await setDoc(filterStopsDocRef, { stops: newStops });
                                    showMessage(`Added "${stopToAdd}" to filters.`);
                                    logAdminAction('ADD_FILTER_STOP', `Added "${stopToAdd}" to filterable stops.`, null, 'filter_stop');
                                    showManageStopsModal();
                                } else if (!stopToAdd) {
                                    showMessage("Please select or enter a stop name.");
                                } else {
                                    showMessage(`"${stopToAdd}" is already in the filter list.`);
                                }
                            }
                            if (button.matches('.remove-filter-stop-btn')) {
                                if (!currentAdminPermissions.manageStops) { showMessage("Permission denied.", true); return; }
                                const stopName = button.dataset.stopName;
                                const newStops = filterableStops.filter(s => s !== stopName);
                                await setDoc(filterStopsDocRef, { stops: newStops });
                                showMessage(`Removed "${stopName}" from filters.`);
                                logAdminAction('REMOVE_FILTER_STOP', `Removed "${stopName}" from filterable stops.`, null, 'filter_stop');
                                showManageStopsModal();
                            }
                            // Admin management buttons
                            if (button.id === 'add-admin-btn') handleAddAdmin();
                            if (button.matches('.edit-admin-btn')) handleEditAdmin(button.dataset.adminId);
                            if (button.matches('.delete-admin-btn')) handleDeleteAdmin(button.dataset.adminId);
                            // My Profile buttons
                            if (button.id === 'edit-my-profile-btn') handleEditMyProfile();
                            if (button.id === 'change-my-password-btn') handleChangeMyPassword();
                            if (button.id === 'clear-audit-logs-btn') handleClearAuditLogs();

                            // Bus Codes Page Buttons
                            if (button.id === 'add-new-bus-code-btn') {
                                if (!isSuperAdmin && !currentAdminPermissions.manageBusCodes) { showMessage("Permission denied.", true); return; }
                                const input = document.getElementById('new-bus-code-input');
                                const newCode = input.value.trim().toUpperCase();
                                if (newCode && allBusCodes.every(c => c.code !== newCode)) {
                                    try {
                                        const docRef = await addDoc(busCodesCollection, { code: newCode });
                                        showMessage(`Bus code "${newCode}" added.`);
                                        logAdminAction('ADD_BUS_CODE', `Added new bus code: ${newCode}`, docRef.id, 'bus_code');
                                        input.value = '';
                                    } catch (error) {
                                        showMessage("Error adding bus code.", true);
                                        console.error("Error adding bus code:", error);
                                    }
                                } else if (!newCode) {
                                    showMessage("Bus code cannot be empty.", true);
                                } else {
                                    showMessage(`Bus code "${newCode}" already exists.`, true);
                                }
                            }
                            const deleteCodeBtn = button.closest('.delete-bus-code-btn');
                            if (deleteCodeBtn) {
                                if (!isSuperAdmin && !currentAdminPermissions.manageBusCodes) { showMessage("Permission denied.", true); return; }
                                const codeId = deleteCodeBtn.dataset.codeId;
                                const codeName = deleteCodeBtn.dataset.codeName;
                                if (await showConfirmation(`Are you sure you want to permanently delete the code "${codeName}"? This cannot be undone.`)) {
                                    try {
                                        await deleteDoc(doc(db, busCodesCollection.path, codeId));
                                        showMessage(`Bus code "${codeName}" was deleted.`);
                                        logAdminAction('DELETE_BUS_CODE', `Deleted bus code: ${codeName}`, codeId, 'bus_code');
                                    } catch (error) {
                                        console.error("Error deleting bus code:", error);
                                        showMessage("Error: Could not delete the bus code.", true);
                                    }
                                }
                            }

                            // --- REASSIGNMENT LOGIC START ---
                            const reassignBtn = button.closest('.reassign-bus-code-btn');
                            if (reassignBtn) {
                                if (!isSuperAdmin && !currentAdminPermissions.manageBusCodes) { showMessage("Permission denied.", true); return; }
                                const codeId = reassignBtn.dataset.codeId;
                                const codeName = reassignBtn.dataset.codeName;
                                const tripCount = reassignBtn.dataset.tripCount;

                                // Populate Modal
                                document.getElementById('reassign-modal-old-code').textContent = codeName;
                                document.getElementById('reassign-modal-trip-count').textContent = tripCount;
                                document.getElementById('reassign-target-code-id').value = codeId;
                                document.getElementById('reassign-target-code-name').value = codeName;

                                // Prepare Option List (Exclude current code)
                                const select = document.getElementById('reassign-existing-select');
                                select.innerHTML = allBusCodes
                                    .filter(c => c.code !== codeName)
                                    .map(c => `<option value="${c.code}">${c.code}</option>`)
                                    .join('');

                                // Show Modal
                                document.getElementById('reassign-bus-code-modal').classList.remove('hidden');
                            }

                            const reviewBtn = button.closest('.review-reassignment-btn');
                            if (reviewBtn) {
                                if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
                                const codeId = reviewBtn.dataset.codeId;
                                const codeName = reviewBtn.dataset.codeName;
                                const tripCount = reviewBtn.dataset.tripCount;
                                const newCode = reviewBtn.dataset.newCode;

                                // Populate Review Modal
                                document.getElementById('review-trip-count').textContent = tripCount;
                                document.getElementById('review-old-code').textContent = codeName;
                                document.getElementById('review-new-code').textContent = newCode;

                                // Store data on the accept/decline buttons for easy access
                                const acceptBtn = document.getElementById('review-accept-btn');
                                const declineBtn = document.getElementById('review-decline-btn');
                                acceptBtn.dataset.codeId = codeId;
                                acceptBtn.dataset.oldCode = codeName;
                                acceptBtn.dataset.newCode = newCode;
                                declineBtn.dataset.codeId = codeId;

                                // Show Modal
                                document.getElementById('review-reassignment-modal').classList.remove('hidden');
                            }
                            // --- REASSIGNMENT LOGIC END ---
                        }

                        // Bus header click for accordion
                        if (header && !button) {
                            const busId = header.dataset.busId;
                            openDropdownId = openDropdownId === busId ? null : busId;
                            updateAndRenderSchedule();
                        }
                        else if (target.closest('.bus-code-header')) {
                            e.preventDefault();
                            const busCode = target.closest('.bus-code-header').dataset.busCode;
                            openBusCodeAccordion = openBusCodeAccordion === busCode ? null : busCode;
                            renderManageBusCodesPage();
                        }
                    });

                    // --- NEW MODAL LISTENERS START ---

                    // Reassign Modal - Toggle Input Options
                    const reassignOptionRadios = document.querySelectorAll('input[name="reassignOption"]');
                    const existingContainer = document.getElementById('reassign-existing-container');
                    const newContainer = document.getElementById('reassign-new-container');

                    reassignOptionRadios.forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            if (e.target.value === 'existing') {
                                existingContainer.classList.remove('hidden');
                                newContainer.classList.add('hidden');
                            } else {
                                existingContainer.classList.add('hidden');
                                newContainer.classList.remove('hidden');
                            }
                        });
                    });

                    // Reassign Modal - Close
                    document.getElementById('reassign-modal-close').addEventListener('click', () => {
                        document.getElementById('reassign-bus-code-modal').classList.add('hidden');
                        document.getElementById('reassign-code-form').reset();
                        // Reset defaults
                        document.querySelector('input[name="reassignOption"][value="existing"]').checked = true;
                        existingContainer.classList.remove('hidden');
                        newContainer.classList.add('hidden');
                    });

                    // Reassign Modal - Submit
                    document.getElementById('reassign-code-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        if (!isSuperAdmin && !currentAdminPermissions.manageBusCodes) { showMessage("Permission denied.", true); return; }

                        const codeId = document.getElementById('reassign-target-code-id').value;
                        const option = document.querySelector('input[name="reassignOption"]:checked').value;
                        let targetCode = '';

                        if (option === 'existing') {
                            targetCode = document.getElementById('reassign-existing-select').value;
                        } else {
                            targetCode = document.getElementById('reassign-new-input').value.trim().toUpperCase();
                            if (!targetCode || targetCode.length < 2 || targetCode.length > 3) { // Assuming 2 or 3 chars based on common bus codes
                                showMessage("New code must be 2 or 3 characters long.", true);
                                return;
                            }
                            if (allBusCodes.some(c => c.code === targetCode)) {
                                showMessage(`Code "${targetCode}" already exists. Please select 'Existing Code' option.`, true);
                                return;
                            }
                        }

                        try {
                            // Update the bus code doc to allow review
                            await updateDoc(doc(db, busCodesCollection.path, codeId), {
                                pendingReplacementCode: targetCode
                            });
                            showMessage("Submitted for review.");
                            document.getElementById('reassign-bus-code-modal').classList.add('hidden');
                        } catch (err) {
                            console.error("Error submitting for review:", err);
                            showMessage("Error submitting request.", true);
                        }
                    });

                    // Review Modal - Close
                    document.getElementById('review-modal-close').addEventListener('click', () => {
                        document.getElementById('review-reassignment-modal').classList.add('hidden');
                    });

                    // Review Modal - Decline
                    document.getElementById('review-decline-btn').addEventListener('click', async (e) => {
                        const codeId = e.target.dataset.codeId;
                        if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }

                        try {
                            await updateDoc(doc(db, busCodesCollection.path, codeId), {
                                pendingReplacementCode: null // Set to null to indicate no pending replacement
                            });
                            showMessage("Reassignment declined.");
                            document.getElementById('review-reassignment-modal').classList.add('hidden');
                        } catch (err) {
                            console.error("Error declining reassignment:", err);
                            showMessage("Error declining request.", true);
                        }
                    });

                    // Review Modal - Accept
                    document.getElementById('review-accept-btn').addEventListener('click', async (e) => {
                        const btn = e.target; // or e.currentTarget
                        const codeId = btn.dataset.codeId;
                        const oldCode = btn.dataset.oldCode;
                        const newCode = btn.dataset.newCode;

                        if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }

                        showMessage("Processing reassignment...");

                        try {
                            const batch = writeBatch(db);

                            // 1. Create New Code Doc if it doesn't exist
                            const existingNewCode = allBusCodes.find(c => c.code === newCode);
                            if (!existingNewCode) {
                                const newCodeRef = doc(busCodesCollection);
                                batch.set(newCodeRef, { code: newCode });
                            }

                            // 2. Update all buses with oldCode to newCode
                            // We need to query them. but we have `allBuses` in memory. 
                            // Better to query via Firestore to be safe? Or iterate allBuses and get refs.
                            // Limit batch size is 500. Assuming < 500 buses.
                            const busesToUpdate = allBuses.filter(b => b.busCode === oldCode);
                            busesToUpdate.forEach(bus => {
                                const busRef = doc(db, busCollection.path, bus.id);
                                batch.update(busRef, { busCode: newCode });
                            });

                            // 3. Empty the Old Code Doc (Remove pending status, it will now have 0 trips)
                            const oldCodeRef = doc(db, busCodesCollection.path, codeId);
                            batch.update(oldCodeRef, { pendingReplacementCode: null });

                            await batch.commit();

                            showMessage(`Successfully reassigned ${busesToUpdate.length} trips. Code ${oldCode} is now empty.`);
                            logAdminAction('REASSIGN_BUS_CODE', `Reassigned ${busesToUpdate.length} trips from ${oldCode} to ${newCode}. Emptied ${oldCode}.`, codeId, 'bus_code');

                            document.getElementById('review-reassignment-modal').classList.add('hidden');

                        } catch (err) {
                            console.error("Error executing reassignment:", err);
                            showMessage("Error executing reassignment. Check console.", true);
                        }
                    });

                    // --- NEW MODAL LISTENERS END ---

                    // Form Submissions
                    document.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const form = e.target;
                        if (form.id === 'ad-form') {
                            if (!currentAdminPermissions.manageAds) { showMessage("Permission denied.", true); return; }
                            const adType = form.querySelector('#ad-type-select').value;
                            const position = form.querySelector('#ad-position-input').value;
                            let newAd = { position: Number(position), adType };

                            if (adType === 'image') {
                                newAd.imageUrl = form.querySelector('#ad-image-url-input').value.trim();
                                newAd.link = form.querySelector('#ad-link-input').value.trim();
                                if (!newAd.imageUrl) {
                                    showMessage("Image URL is required for an image ad.", true);
                                    return;
                                }
                            } else { // video
                                newAd.videoUrl = form.querySelector('#ad-video-url-input').value.trim();
                                if (!newAd.videoUrl) {
                                    showMessage("Video URL is required for a video ad.", true);
                                    return;
                                }
                            }

                            if (!newAd.position) {
                                showMessage("Position is a required field.", true);
                                return;
                            }

                            const docRef = await addDoc(adsCollection, newAd);
                            showMessage("Advertisement published.");
                            form.reset();
                            document.getElementById('ad-type-select').dispatchEvent(new Event('change'));
                            logAdminAction('PUBLISH_AD', `Published new ad (Type: ${newAd.adType}, Position: ${newAd.position})`, docRef.id, 'ad');
                        }
                        if (form.id === 'about-form') {
                            if (!currentAdminPermissions.manageAbout) { showMessage("Permission denied.", true); return; }
                            await setDoc(aboutDocRef, { html: quill.root.innerHTML });
                            showMessage("About page updated.");
                            logAdminAction('UPDATE_ABOUT_PAGE', `Updated "About Us" page content.`);
                        }
                        if (form.id === 'contact-form') {
                            if (!currentAdminPermissions.manageContact) { showMessage("Permission denied.", true); return; }
                            const email = form.querySelector('#edit-contact-email').value.trim();
                            const phone = form.querySelector('#edit-contact-phone').value.trim();
                            const address = form.querySelector('#edit-contact-address').value.trim();
                            const instagram = form.querySelector('#edit-contact-instagram')?.value.trim() || '';
                            const youtube = form.querySelector('#edit-contact-youtube')?.value.trim() || '';
                            const linkedin = form.querySelector('#edit-contact-linkedin')?.value.trim() || '';
                            const facebook = form.querySelector('#edit-contact-facebook')?.value.trim() || '';
                            await setDoc(contactDocRef, { email, phone, address, instagram, youtube, linkedin, facebook });
                            showMessage("Contact details updated.");
                            logAdminAction('UPDATE_CONTACT_INFO', `Updated contact information (Email: ${email}, Phone: ${phone}).`);
                        }
                    });

                    // Other specific input listeners
                    searchBar.addEventListener('input', (e) => {
                        searchQuery = e.target.value.toLowerCase();
                        updateAndRenderSchedule();
                    });

                    // Ensure any input with class "uppercase-input" stays 3 letters and uppercase
                    document.querySelectorAll('.uppercase-input').forEach(input => {
                        input.addEventListener('input', (e) => {
                            let value = e.target.value || '';
                            // Keep only letters, uppercase them, and limit to 3 characters
                            value = value.replace(/[^a-zA-Z]/g, '').toUpperCase().slice(0, 3);
                            e.target.value = value;
                        });
                    });

                    const reportsSearchBar = document.getElementById('reports-search-bar');
                    if (reportsSearchBar) {
                        reportsSearchBar.addEventListener('input', (e) => {
                            reportsSearchQuery = e.target.value.toLowerCase();
                            renderReportsPage();
                        });
                    }

                    const downloadSelectedBtn = document.getElementById('download-selected-btn');
                    if (downloadSelectedBtn) {
                        downloadSelectedBtn.addEventListener('click', () => {
                            const selectedCheckboxes = document.querySelectorAll('.bus-report-checkbox:checked');
                            const selectedGroupKeys = Array.from(selectedCheckboxes).map(cb => cb.value);
                            downloadBusReportCSV(selectedGroupKeys);
                        });
                    }

                    const downloadAllBtn = document.getElementById('download-all-btn');
                    if (downloadAllBtn) {
                        downloadAllBtn.addEventListener('click', () => {
                            const allCheckboxes = document.querySelectorAll('.bus-report-checkbox');
                            const allGroupKeys = Array.from(allCheckboxes).map(cb => cb.value);
                            downloadBusReportCSV(allGroupKeys);
                        });
                    }
                    // üëÜ END OF NEW EVENT LISTENERS

                    const busCodeSearchBar = document.getElementById('bus-code-search-bar');
                    if (busCodeSearchBar) {
                        busCodeSearchBar.addEventListener('input', (e) => {
                            busCodeSearchQuery = e.target.value.toLowerCase();
                            renderManageBusCodesPage();
                        });
                    }

                    document.getElementById('manage-fares-bus-select').addEventListener('change', (e) => {
                        renderFareMatrix(e.target.value);
                    });

                    document.getElementById('ad-type-select').addEventListener('change', (e) => {
                        const adType = e.target.value;
                        const imageInputs = document.getElementById('ad-image-inputs');
                        const videoInputs = document.getElementById('ad-video-inputs');
                        const imageUrlInput = document.getElementById('ad-image-url-input');
                        const videoUrlInput = document.getElementById('ad-video-url-input');

                        if (adType === 'image') {
                            imageInputs.classList.remove('hidden');
                            videoInputs.classList.add('hidden');
                            imageUrlInput.required = true;
                            videoUrlInput.required = false;
                        } else {
                            imageInputs.classList.add('hidden');
                            videoInputs.classList.remove('hidden');
                            imageUrlInput.required = false;
                            videoUrlInput.required = true;
                        }
                    });

                    // Feedback Submit
                    const feedbackForm = document.getElementById('feedback-form');
                    if (feedbackForm) {
                        feedbackForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const submitBtn = document.getElementById('submit-feedback-btn');
                            const originalText = submitBtn.textContent;
                            submitBtn.textContent = 'Submitting...';
                            submitBtn.disabled = true;

                            try {
                                const category = document.getElementById('feedback-category').value;
                                const busRoute = document.getElementById('feedback-bus-select').value;
                                const time = document.getElementById('feedback-time').value;
                                const description = document.getElementById('feedback-description').value;
                                const contact = document.getElementById('feedback-contact').value;
                                const type = document.getElementById('feedback-type').value;
                                const name = document.getElementById('feedback-name').value;
                                const location = document.getElementById('feedback-location').value;

                                await addDoc(complaintsCollection, {
                                    type, // Add type
                                    category,
                                    busRoute,
                                    time,
                                    description,
                                    contact,
                                    name, // Add name
                                    location, // Add location
                                    status: 'New',
                                    timestamp: serverTimestamp()
                                });
                                showMessage("Feedback submitted successfully. Thank you!");
                                feedbackForm.reset();
                                showPage('home');
                            } catch (err) {
                                console.error("Error submitting feedback:", err);
                                showMessage("Error submitting feedback. Please try again.", true);
                            } finally {
                                submitBtn.textContent = originalText;
                                submitBtn.disabled = false;
                            }
                        });
                    }
                };

                const initializeAppAndData = async () => {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    try {
                        analytics = getAnalytics(app);
                    } catch (e) {
                        console.log("Analytics not available in this environment.");
                    }

                    // Define collections and document references
                    const publicDataPath = `artifacts/${appId}/public/data`;
                    busCollection = collection(db, `${publicDataPath}/buses`);
                    configDocRef = doc(db, `${publicDataPath}/config/predefined`);
                    busCodesCollection = collection(db, `${publicDataPath}/busCodes`); // New
                    complaintsCollection = collection(db, `${publicDataPath}/complaints`);
                    filterStopsDocRef = doc(db, `${publicDataPath}/config/filterStops`);
                    contactDocRef = doc(db, `${publicDataPath}/config/contact`);
                    aboutDocRef = doc(db, `${publicDataPath}/config/about`);
                    announcementDocRef = doc(db, `${publicDataPath}/config/announcement`);
                    adsCollection = collection(db, `${publicDataPath}/advertisements`);
                    adminsCollection = collection(db, `${publicDataPath}/admins`);
                    auditLogsCollection = collection(db, `${publicDataPath}/auditLogs`); // New: Audit Logs collection

                    onAuthStateChanged(auth, (user) => {
                        unsubscribeListeners.forEach(unsub => unsub());
                        unsubscribeListeners = [];

                        if (user) {
                            currentUserId = user.uid;
                            console.log("Authenticated User ID:", currentUserId);

                            // Listen to admins collection to update currentAdmin and permissions
                            const unsubAdmins = onSnapshot(adminsCollection, (snapshot) => {
                                allAdmins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                // If an admin was logged in, try to find their updated data
                                if (currentAdmin) {
                                    const updatedAdmin = allAdmins.find(a => a.username === currentAdmin.username);
                                    if (updatedAdmin) {
                                        currentAdmin = updatedAdmin;
                                        currentAdminPermissions = updatedAdmin.permissions || {};
                                    } else {
                                        // Current admin was deleted from Firestore
                                        logout();
                                    }
                                }
                                checkAdminStatus(); // Re-evaluate admin status and render controls
                                renderAdminsList(); // Re-render admin list if on that page
                            });
                            unsubscribeListeners.push(unsubAdmins);

                            const unsubConfig = onSnapshot(configDocRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    const configData = docSnap.data();
                                    predefinedBusNames = configData.busNames || [];
                                    predefinedStops = configData.stops || [];
                                }
                            });
                            unsubscribeListeners.push(unsubConfig);

                            // New: Listen to bus codes
                            // New: Listen to bus codes
                            const unsubBusCodes = onSnapshot(busCodesCollection, (snapshot) => {
                                console.log('Bus Codes snapshot received:', snapshot.docs.map(d => d.data())); // <-- ADD THIS LINE
                                allBusCodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.code.localeCompare(b.code));
                                // This new part checks if we are on the right page and tells it to refresh
                                const manageBusCodesPage = document.getElementById('manage-bus-codes-page');
                                if (manageBusCodesPage && !manageBusCodesPage.classList.contains('hidden')) {
                                    renderManageBusCodesPage();
                                }
                            });
                            unsubscribeListeners.push(unsubBusCodes);


                            const unsubBuses = onSnapshot(busCollection, (snapshot) => {
                                allBuses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                // Populate feedback dropdown
                                populateFeedbackBusSelect();
                                if (!isAuthReady) {
                                    isAuthReady = true;
                                    addSampleDataIfNeeded(); // This will also initialize Super Admin if needed
                                }
                                updateAndRenderSchedule();
                                const activePageId = document.querySelector('#page-container > div:not(.hidden)')?.id.replace('-page', '');
                                if (activePageId === 'manage-fares') populateManageFaresBusSelect();
                                if (activePageId === 'fare-calculator') populateFareCalculatorStops();
                                if (activePageId === 'manage-bus-codes') renderManageBusCodesPage();
                            }, (error) => {
                                console.error("Error fetching bus data:", error);
                                setStatus("Error loading schedule. Please check connection.", true);
                            });
                            unsubscribeListeners.push(unsubBuses);

                            const unsubAds = onSnapshot(adsCollection, (snapshot) => {
                                allAds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                renderAdsList();
                                updateAndRenderSchedule();
                            });
                            unsubscribeListeners.push(unsubAds);

                            const unsubAnnouncements = onSnapshot(announcementDocRef, (docSnap) => {
                                const textEl = document.getElementById('announcement-text');
                                const bannerEl = document.getElementById('announcement-banner');

                                let activeMessages = [];
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    if (data.messages && Array.isArray(data.messages)) {
                                        activeMessages = data.messages;
                                    } else if (data.text && data.active) {
                                        // Backward compatibility for single announcement
                                        activeMessages = [{ id: 'legacy', text: data.text, active: true }];
                                    }
                                }

                                if (activeMessages.length > 0) {
                                    const combinedText = activeMessages.map(m => m.text).join('  ***  ');
                                    textEl.textContent = combinedText;
                                    bannerEl.classList.remove('hidden');

                                    // Marquee animation logic
                                    setTimeout(() => {
                                        if (textEl.scrollWidth > bannerEl.clientWidth) {
                                            textEl.classList.add('scrolling');
                                            // Adjust speed based on length
                                            const duration = textEl.scrollWidth / 40;
                                            textEl.style.animationDuration = `${duration}s`;
                                        } else {
                                            textEl.classList.remove('scrolling');
                                            textEl.style.animationDuration = '';
                                        }
                                    }, 100);
                                } else {
                                    textEl.textContent = '';
                                    bannerEl.classList.add('hidden');
                                    textEl.classList.remove('scrolling');
                                }

                                // Render Admin List
                                if (isAdmin && currentAdminPermissions.manageAnnouncements) {
                                    const listContainer = document.getElementById('active-announcements-list');
                                    // Check if listContainer exists (it might be on a page not currently rendered, but the div is in DOM? 
                                    // Actually the div is in DOM always if SPA structure is static)
                                    if (listContainer) {
                                        if (activeMessages.length === 0) {
                                            listContainer.innerHTML = '<p class="text-slate-500 italic p-2">No active announcements.</p>';
                                        } else {
                                            listContainer.innerHTML = activeMessages.map(m => `
                                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-md border border-slate-200">
                                                    <span class="text-sm text-slate-700 font-medium">${m.text}</span>
                                                    <button type="button" class="delete-announcement-btn p-1.5 text-red-500 hover:bg-red-50 hover:text-red-700 rounded transition-colors" data-id="${m.id}" title="Delete">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            `).join('');
                                        }
                                    }
                                }
                            });
                            unsubscribeListeners.push(unsubAnnouncements);

                            const unsubFilters = onSnapshot(filterStopsDocRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    filterableStops = docSnap.data().stops || [];
                                } else {
                                    filterableStops = [];
                                }
                                updateFilterDropdown();
                            });
                            unsubscribeListeners.push(unsubFilters);

                            const unsubContact = onSnapshot(contactDocRef, (docSnap) => {
                                const contactInfoContainer = document.getElementById('contact-info-container');
                                const editContactEmail = document.getElementById('edit-contact-email');
                                const editContactPhone = document.getElementById('edit-contact-phone');
                                const editContactAddress = document.getElementById('edit-contact-address');
                                const editContactInstagram = document.getElementById('edit-contact-instagram');
                                const editContactYoutube = document.getElementById('edit-contact-youtube');
                                const editContactLinkedin = document.getElementById('edit-contact-linkedin');
                                const editContactFacebook = document.getElementById('edit-contact-facebook');

                                if (docSnap.exists()) {
                                    const contact = docSnap.data();

                                    const instagramUrl = contact.instagram || '';
                                    const youtubeUrl = contact.youtube || '';
                                    const linkedinUrl = contact.linkedin || '';
                                    const facebookUrl = contact.facebook || '';

                                    const socialsContainer = document.createElement('div');
                                    let socialsHtml = '';
                                    if (instagramUrl || youtubeUrl || linkedinUrl || facebookUrl) {
                                        socialsHtml += '<div class="mt-8 pt-6 border-t border-slate-100">';
                                        socialsHtml += '<p class="font-bold text-slate-800 text-sm mb-4 uppercase tracking-wide">Follow us on social media</p>';
                                        socialsHtml += '<div class="flex flex-wrap gap-4">';

                                        const baseBtnClass = 'w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-500 hover:bg-white hover:text-teal-600 hover:shadow-md border border-slate-200 transition-all duration-300';

                                        if (instagramUrl) {
                                            socialsHtml += `
                                    <a href="${instagramUrl}" target="_blank" rel="noopener noreferrer" class="${baseBtnClass}" aria-label="Instagram">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M7 2C4.243 2 2 4.243 2 7v10c0 2.757 2.243 5 5 5h10c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H7zm0 2h10c1.654 0 3 1.346 3 3v10c0 1.654-1.346 3-3 3H7c-1.654 0-3-1.346-3-3V7c0-1.654 1.346-3 3-3zm11 1a1 1 0 100 2 1 1 0 000-2zM12 7a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z" />
                                        </svg>
                                    </a>`;
                                        }
                                        if (youtubeUrl) {
                                            socialsHtml += `
                                    <a href="${youtubeUrl}" target="_blank" rel="noopener noreferrer" class="${baseBtnClass} hover:text-red-600" aria-label="YouTube">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M21.8 8.001a2.75 2.75 0 00-1.94-1.948C18.23 5.5 12 5.5 12 5.5s-6.23 0-7.86.553A2.75 2.75 0 002.2 8.001 28.37 28.37 0 002 12a28.37 28.37 0 00.2 3.999 2.75 2.75 0 001.94 1.948C5.77 18.5 12 18.5 12 18.5s6.23 0 7.86-.553a2.75 2.75 0 001.94-1.948A28.37 28.37 0 0022 12a28.37 28.37 0 00-.2-3.999zM10 15.25v-6.5L15.5 12 10 15.25z" />
                                        </svg>
                                    </a>`;
                                        }
                                        if (linkedinUrl) {
                                            socialsHtml += `
                                    <a href="${linkedinUrl}" target="_blank" rel="noopener noreferrer" class="${baseBtnClass} hover:text-blue-700" aria-label="LinkedIn">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M4.98 3.5C4.98 4.88 3.88 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1 4.98 2.12 4.98 3.5zM.2 8.5h4.6V23H.2V8.5zM8.34 8.5H12.8v1.97h.06c.62-1.17 2.14-2.4 4.4-2.4 4.7 0 5.57 3.1 5.57 7.13V23h-4.6v-6.3c0-1.5-.03-3.42-2.08-3.42-2.08 0-2.4 1.62-2.4 3.3V23H8.34V8.5z" />
                                        </svg>
                                    </a>`;
                                        }
                                        if (facebookUrl) {
                                            socialsHtml += `
                                    <a href="${facebookUrl}" target="_blank" rel="noopener noreferrer" class="${baseBtnClass} hover:text-blue-600" aria-label="Facebook">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M13 3h3a1 1 0 011 1v3h-2.5A1.5 1.5 0 0013 8.5V11h3.5a1 1 0 01.98 1.196l-.5 2.5A1 1 0 0116 15H13v6h-3v-6H7a1 1 0 01-1-1v-2.5A1 1 0 017 11h3V8.5A5.5 5.5 0 0115.5 3H16h-3z" />
                                        </svg>
                                    </a>`;
                                        }
                                        socialsHtml += '</div></div>';
                                    }

                                    contactInfoContainer.innerHTML = `
                            <p class="text-center font-medium mb-6 text-slate-500">Makkal Raja Transport Corporation</p>
                            
                            <div class="space-y-4">
                                <div class="flex items-start p-4 bg-slate-50 rounded-xl border border-slate-100 hover:shadow-sm transition-shadow">
                                     <div class="w-10 h-10 rounded-full bg-white flex-shrink-0 flex items-center justify-center text-teal-600 shadow-sm mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                                    </div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-0.5">Email</p>
                                        <a href="mailto:${contact.email}" class="text-slate-800 font-medium hover:text-teal-600 transition-colors">${contact.email}</a>
                                    </div>
                                </div>

                                <div class="flex items-start p-4 bg-slate-50 rounded-xl border border-slate-100 hover:shadow-sm transition-shadow">
                                     <div class="w-10 h-10 rounded-full bg-white flex-shrink-0 flex items-center justify-center text-teal-600 shadow-sm mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                    </div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-0.5">Phone</p>
                                        <a href="tel:${contact.phone}" class="text-slate-800 font-medium hover:text-teal-600 transition-colors">${contact.phone}</a>
                                    </div>
                                </div>

                                <div class="flex items-start p-4 bg-slate-50 rounded-xl border border-slate-100 hover:shadow-sm transition-shadow">
                                     <div class="w-10 h-10 rounded-full bg-white flex-shrink-0 flex items-center justify-center text-teal-600 shadow-sm mr-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    </div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wide mb-0.5">Address</p>
                                        <p class="text-slate-800 font-medium">${contact.address ? contact.address.replace(/\n/g, '<br>') : ''}</p>
                                    </div>
                                </div>
                            </div>

                            ${socialsHtml}
                        `;

                                    // Always prefill manage-contact inputs when they exist in the DOM
                                    if (editContactEmail) editContactEmail.value = contact.email || '';
                                    if (editContactPhone) editContactPhone.value = contact.phone || '';
                                    if (editContactAddress) editContactAddress.value = contact.address || '';
                                    if (editContactInstagram) editContactInstagram.value = instagramUrl;
                                    if (editContactYoutube) editContactYoutube.value = youtubeUrl;
                                    if (editContactLinkedin) editContactLinkedin.value = linkedinUrl;
                                    if (editContactFacebook) editContactFacebook.value = facebookUrl;
                                }
                            });
                            unsubscribeListeners.push(unsubContact);

                            const unsubAbout = onSnapshot(aboutDocRef, (docSnap) => {
                                const aboutContentContainer = document.getElementById('about-content-container');
                                if (docSnap.exists()) {
                                    const about = docSnap.data();
                                    aboutContentContainer.innerHTML = about.html;
                                    if (quill && isAdmin && currentAdminPermissions.manageAbout) {
                                        quill.root.innerHTML = about.html;
                                    }
                                }
                            });
                            unsubscribeListeners.push(unsubAbout);

                            // New: Listener for Audit Logs
                            const unsubAuditLogs = onSnapshot(query(auditLogsCollection, orderBy('timestamp', 'desc')), (snapshot) => {
                                allAuditLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                renderAuditLogs(); // Re-render audit logs whenever they change
                            });
                            unsubscribeListeners.push(unsubAuditLogs);

                            // Listener for Complaints
                            const unsubComplaints = onSnapshot(query(complaintsCollection, orderBy('timestamp', 'desc')), (snapshot) => {
                                allComplaints = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                if (isAdmin && currentAdminPermissions.manageComplaints) {
                                    renderComplaintsPage();
                                }
                            });
                            unsubscribeListeners.push(unsubComplaints);



                        } else {
                            console.log("User is signed out.");
                            currentAdmin = null;
                            currentAdminPermissions = {};
                            isAdmin = false;
                            isSuperAdmin = false;
                            isAuthReady = false; // Reset auth ready flag on sign out
                            setStatus("Authenticating...", false);
                            renderAuthControls(); // Ensure controls are updated for signed out state
                            updateAndRenderSchedule(); // Re-render schedule for public view
                            renderAuditLogs(); // Clear audit logs on logout
                        }
                    });

                    try {
                        console.log("Attempting to sign in...");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            console.log("Firebase connection successful with custom token!");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Firebase connection successful anonymously!");
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        setStatus("Could not connect to the server. Check console for details.", true);
                    }
                };

                // --- Notification Logic ---
                const checkNotificationPermission = () => {
                    updateNotificationIcon(Notification.permission);
                };

                const updateNotificationIcon = (permission) => {
                    const btn = document.getElementById('notification-btn');
                    const iconOutline = document.getElementById('notif-icon-outline');
                    const iconSolid = document.getElementById('notif-icon-solid');
                    const iconOff = document.getElementById('notif-icon-off');

                    if (!btn || !iconOutline || !iconSolid || !iconOff) return;

                    // Reset all
                    iconOutline.classList.add('hidden');
                    iconSolid.classList.add('hidden');
                    iconOff.classList.add('hidden');
                    btn.classList.remove('text-sky-200', 'text-white', 'text-red-300');

                    if (permission === 'granted') {
                        iconSolid.classList.remove('hidden');
                        btn.title = "Notifications Active";
                    } else if (permission === 'denied') {
                        iconOff.classList.remove('hidden');
                        btn.classList.add('text-sky-200'); // Dimmed
                        btn.title = "Notifications Blocked";
                    } else {
                        // Default
                        iconOutline.classList.remove('hidden');
                        btn.title = "Enable Notifications";
                    }
                };

                const handleNotificationClick = () => {
                    if (!("Notification" in window)) {
                        alert("This browser does not support desktop notifications");
                        return;
                    }

                    if (Notification.permission === "granted") {
                        // Already granted
                        sendNotification("Notifications Active", "You will receive updates about buses.");
                    } else if (Notification.permission !== "denied") {
                        Notification.requestPermission().then((permission) => {
                            updateNotificationIcon(permission);
                            if (permission === "granted") {
                                sendNotification("Welcome!", "You have enabled notifications for Digital Attappadi.");
                            }
                        });
                    } else {
                        // Denied
                        alert("Notifications are blocked. Please enable them in your browser settings.");
                    }
                };

                const sendNotification = (title, body) => {
                    if (Notification.permission === "granted") {
                        try {
                            new Notification(title, {
                                body: body,
                                icon: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png'
                            });
                        } catch (e) {
                            console.error("Notification error:", e);
                        }
                    }
                };

                // Admin: Send Notification
                const notificationForm = document.getElementById('notification-form');
                if (notificationForm) {
                    notificationForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const title = document.getElementById('notif-title').value;
                        const message = document.getElementById('notif-message').value;

                        try {
                            const notificationsRef = collection(db, 'notifications');
                            await addDoc(notificationsRef, {
                                title: title,
                                message: message,
                                timestamp: serverTimestamp()
                            });
                            alert("Notification Sent!");
                            notificationForm.reset();
                        } catch (error) {
                            console.error("Error sending notification:", error);
                            alert("Failed to send notification.");
                        }
                    });
                }

                // Client: Listen for new notifications
                let notificationUnsubscribe = null;
                const listenForNotifications = () => {
                    if (notificationUnsubscribe) return; // Already listening

                    const notificationsRef = collection(db, 'notifications');
                    // Refactored Logic: Use 'isFirstRun' to ignore initial history, then show all new additions.
                    // This avoids issues with client/server clock skew.

                    let isFirstRun = true;
                    // Limit to last 10 to avoid excessive initial reads, though we ignore them
                    const q = query(notificationsRef, orderBy('timestamp', 'desc'));

                    notificationUnsubscribe = onSnapshot(q, (snapshot) => {
                        console.log("DEBUG: Snapshot received. Size:", snapshot.size, "FirstRun:", isFirstRun);

                        if (isFirstRun) {
                            isFirstRun = false;
                            console.log("DEBUG: Initial load complete. Ignoring existing docs.");
                            return;
                        }

                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                const data = change.doc.data();
                                console.log("DEBUG: New notification detected!", data);
                                sendNotification(data.title, data.message);
                            }
                        });
                    });
                };

                /* Old logic removed to fix matching errors */
                const _unused_placeholder = () => {
                    if (notificationUnsubscribe) return; // Already listening

                    const notificationsRef = collection(db, 'notifications');
                    // Listen to notifications created AFTER app load
                    // Note: Firestore query limitation - simplest is validatng client-side or relying on 'added' type
                    // Ideally we'd query by timestamp > now, but getting 'now' in server time is tricky without a roundtrip
                    // For "Free" logic: We'll just listen to the collection and check local time or rely on 'added' event for new docs.
                    // Important: 'onSnapshot' fires for ALL existing docs first. We must skip those.

                    const loadTime = new Date();

                    const q = query(notificationsRef, orderBy('timestamp', 'desc')); // Get latest

                    notificationUnsubscribe = onSnapshot(q, (snapshot) => {
                        console.log("DEBUG: Notification snapshot received", snapshot.size);
                        snapshot.docChanges().forEach((change) => {
                            console.log("DEBUG: Change type", change.type, change.doc.data());
                            if (change.type === "added") {
                                const data = change.doc.data();
                                const notifTime = data.timestamp ? data.timestamp.toDate() : new Date(); // Treat null (local) as now
                                console.log("DEBUG: Time check", { hasTimestamp: !!data.timestamp, notifTime, loadTime, isNew: notifTime > loadTime });

                                // Logic update: Handle null timestamp (local write) as valid new notification
                                if (!data.timestamp || notifTime > loadTime) {
                                    console.log("DEBUG: Triggering notification", data.title);
                                    sendNotification(data.title, data.message);
                                }
                            }
                        });
                    });
                };


                // --- Start the App ---
                try {
                    // This function is called by the YouTube API script once it's loaded
                    window.onYouTubeIframeAPIReady = () => {
                        initializeVideoAds();
                    };

                    setupEventListeners();
                    initializeAppAndData();

                    // Init Notifications
                    checkNotificationPermission();
                    listenForNotifications();
                    const notifBtn = document.getElementById('notification-btn');
                    if (notifBtn) notifBtn.addEventListener('click', handleNotificationClick);

                    // Handle initial page load based on URL hash
                    const initialPage = window.location.hash.substring(1) || 'home';
                    showPage(initialPage, true); // Show page without pushing state
                    history.replaceState({ pageId: initialPage }, '', `#${initialPage}`);

                    window.addEventListener('popstate', (event) => {
                        const pageId = (event.state && event.state.pageId) || 'home';
                        showPage(pageId, true);
                    });

                    // Set an interval to only update live elements, not the whole schedule
                    setInterval(updateLiveElements, 1000); // Changed from 10000 to 1000 for faster updates
                } catch (e) {
                    console.error("A critical error occurred on startup:", e);
                    setStatus("An unexpected error occurred. Please refresh the page.", true);
                }
            });
        </script>
</body>

</html>