<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Attappadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-900: #0c4a6e;

            --secondary-50: #ecfdf5;
            --secondary-100: #d1fae5;
            --secondary-500: #10b981;
            --secondary-600: #059669;

            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334152;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--slate-100);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--slate-200); }
        ::-webkit-scrollbar-thumb { background: var(--slate-400); border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--slate-500); }

        /* General Button Style */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: var(--primary-600);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-700);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .btn-secondary {
            background-color: var(--slate-200);
            color: var(--slate-800);
        }
        .btn-secondary:hover {
            background-color: var(--slate-300);
        }

        /* Timeline Styles */
        .timeline-wrapper { position: relative; }
        .timeline-item { position: relative; padding-left: 2.5rem; padding-bottom: 2rem; }
        
        .timeline-item:not(:last-of-type)::after {
            content: '';
            position: absolute;
            left: calc(1.5rem - 1px);
            top: 1.75rem;
            bottom: -2rem;
            width: 2px;
            background-color: var(--slate-200);
            z-index: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.1875rem;
            top: 1rem;
            height: 0.75rem;
            width: 0.75rem;
            background-color: white;
            border: 2px solid var(--slate-300);
            border-radius: 9999px;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-item.passed::before {
            background-color: var(--primary-600);
            border-color: var(--primary-600);
        }
        .timeline-item.passed:not(:last-of-type)::after {
            background-color: var(--primary-600);
        }
        .stop-name { color: var(--slate-700); font-weight: 600; }
        .timeline-item.passed .stop-name { color: var(--slate-400); font-weight: 500; text-decoration: line-through; }

        /* Live Dot Animation */
        .live-dot-icon {
            position: absolute;
            width: 1rem; height: 1rem;
            background-color: var(--primary-500);
            border-radius: 9999px;
            z-index: 10;
            transition: top 2s linear;
            left: 1.0625rem;
            top: -0.25rem;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }

        /* Sidebar & Navigation */
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; backdrop-filter: blur(4px); }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active {
            background-color: var(--primary-50);
            color: var(--primary-700);
            font-weight: 700;
        }
        .nav-link.active svg { color: var(--primary-600); }

        /* Bus Card Expansion */
        .bus-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
        }
        .bus-details.open {
            max-height: 1000px;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        /* Spinner */
        .spinner {
            border-top-color: var(--primary-600);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Quill Editor */
        #editor-container { height: 250px; }
        .ql-toolbar.ql-snow { border-radius: 0.5rem 0.5rem 0 0; }
        .ql-container.ql-snow { border-radius: 0 0 0.5rem 0.5rem; }

        /* Fare Matrix Table */
        .fare-matrix-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .fare-matrix-table th, .fare-matrix-table td { border: 1px solid var(--slate-200); padding: 0.5rem; text-align: center; }
        .fare-matrix-table th { background-color: var(--slate-100); }
        .fare-matrix-table input { width: 4rem; text-align: center; border: 1px solid var(--slate-300); border-radius: 0.25rem; }
        .fare-matrix-table .header-cell { font-weight: 600; color: var(--slate-600); }
        .fare-matrix-table .disabled-cell { background-color: var(--slate-100); }

        /* Announcement Banner */
        #announcement-banner { overflow: hidden; white-space: nowrap; }
        #announcement-text.scrolling {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0%   { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="flex justify-center">

    <div id="app-container" class="w-full max-w-md bg-white min-h-screen shadow-2xl">
        <!-- Header -->
        <header class="bg-gradient-to-r from-sky-600 to-cyan-500 sticky top-0 z-20 p-4 text-white shadow-lg">
             <div class="flex justify-between items-center">
                 <div class="w-16">
                     <button id="menu-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                         </svg>
                     </button>
                 </div>
                 <div class="text-center">
                     <h1 class="text-2xl font-extrabold tracking-tight">Digital Attappadi</h1>
                     <p class="text-xs text-sky-100 opacity-90">Makkal Raja Transport Corporation</p>
                 </div>
                 <div class="w-16"></div> <!-- Spacer -->
             </div>
        </header>
        
        <div id="announcement-banner" class="hidden bg-blue-100 border-b-2 border-blue-300 text-blue-800 text-sm font-medium p-2">
            <p id="announcement-text"></p>
        </div>

        <div id="page-container">
            <!-- Home Page Content -->
            <div id="home-page">
                <!-- Search and Filter Bar -->
                <div class="p-4 bg-slate-50 border-b border-slate-200">
                    <div class="flex items-center space-x-2">
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <input type="text" id="search-bar" class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Search by bus name or origin...">
                        </div>
                        <div class="relative">
                            <button id="filter-btn" class="p-2.5 border border-slate-300 rounded-lg bg-white hover:bg-slate-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                </svg>
                            </button>
                            <div id="filter-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-10 py-1 ring-1 ring-black ring-opacity-5">
                                <!-- Filter options populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bus Schedule List -->
                <main id="schedule-list" class="divide-y divide-slate-200">
                     <div id="status-message" class="p-8 text-center text-slate-500">
                         <div class="flex flex-col justify-center items-center">
                             <div class="spinner h-8 w-8 border-4 border-slate-200 rounded-full"></div>
                             <span class="ml-3 mt-3">Initializing...</span>
                         </div>
                     </div>
                </main>
                
                <div id="add-bus-container" class="p-4 hidden">
                    <button id="add-bus-btn" class="w-full btn btn-primary">Add New Bus</button>
                </div>
            </div>

            <!-- Other Pages (Fare Calculator, Manage Fares, etc.) -->
            <div id="fare-calculator-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Fare Calculator</h2>
                <div class="space-y-4">
                    <div>
                        <label for="fare-from-stop" class="block text-sm font-medium text-slate-700">From</label>
                        <select id="fare-from-stop" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="fare-to-stop" class="block text-sm font-medium text-slate-700">To</label>
                        <select id="fare-to-stop" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md"></select>
                    </div>
                    <button id="calculate-fare-btn" class="w-full btn btn-primary">Calculate Fare</button>
                </div>
                <div id="fare-result-container" class="mt-6"></div>
            </div>
            
            <div id="manage-fares-page" class="hidden p-6">
                 <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Fares</h2>
                 <div class="space-y-4">
                     <div>
                         <label for="manage-fares-bus-select" class="block text-sm font-medium text-slate-700">Select Bus Route</label>
                         <select id="manage-fares-bus-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md"></select>
                     </div>
                     <div id="fare-matrix-container" class="overflow-x-auto"></div>
                     <div class="flex space-x-2 mt-4">
                         <button id="download-csv-btn" class="w-full btn btn-secondary hidden">Download CSV</button>
                         <button id="upload-csv-btn" class="w-full btn btn-secondary hidden">Upload CSV</button>
                         <input type="file" id="csv-upload-input" class="hidden" accept=".csv">
                     </div>
                      <button id="save-fares-btn" class="w-full btn btn-primary hidden">Save Fares</button>
                 </div>
            </div>

            <div id="manage-announcements-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Announcements</h2>
                <div class="space-y-4">
                    <div>
                        <label for="announcement-input" class="block text-sm font-medium text-slate-700">Announcement Message</label>
                        <textarea id="announcement-input" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="e.g., Service delays due to heavy rain..."></textarea>
                    </div>
                    <button id="publish-announcement-btn" class="w-full btn btn-primary">Publish Announcement</button>
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-medium text-slate-900">Current Announcement</h3>
                        <div id="current-announcement-container" class="mt-2 p-3 bg-slate-50 rounded-md text-sm text-slate-700 min-h-[40px]"></div>
                        <button id="clear-announcement-btn" class="mt-2 w-full btn btn-danger">Clear Announcement</button>
                    </div>
                </div>
            </div>

             <div id="manage-ads-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Advertisements</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium text-slate-900">Current Ads</h3>
                        <div id="ads-list-container" class="mt-2 space-y-4">
                            <!-- List of ads will be populated here -->
                        </div>
                    </div>
                    <div class="border-t pt-6">
                         <h3 class="text-lg font-medium text-slate-900">Add New Ad</h3>
                        <form id="ad-form" class="space-y-4 mt-2">
                            <div>
                                <label for="ad-image-url-input" class="block text-sm font-medium text-slate-700">Image URL</label>
                                <input type="url" id="ad-image-url-input" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://example.com/image.png" required>
                            </div>
                             <div>
                                <label for="ad-link-input" class="block text-sm font-medium text-slate-700">Link URL (Optional)</label>
                                <input type="url" id="ad-link-input" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://example.com">
                            </div>
                            <div>
                                <label for="ad-position-input" class="block text-sm font-medium text-slate-700">Position (After which bus number)</label>
                                <input type="number" id="ad-position-input" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="e.g., 3" min="1" required>
                            </div>
                            <button id="publish-ad-btn" type="submit" class="w-full btn btn-primary">Publish Ad</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="about-page" class="hidden p-6">
                <div id="about-content-container" class="prose max-w-none"></div>
            </div>
            
            <div id="manage-about-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage About Page</h2>
                <form id="about-form" class="space-y-4">
                    <div>
                        <label for="editor-container" class="block text-sm font-medium text-slate-700">Page Content</label>
                        <div id="editor-container" class="mt-1"></div>
                    </div>
                    <button id="save-about-btn" type="submit" class="w-full btn btn-primary">Save About Page</button>
                </form>
            </div>

            <div id="contact-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Contact Information</h2>
                <div id="contact-info-container" class="space-y-4 text-slate-700"></div>
            </div>
            
            <div id="manage-contact-page" class="hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Contact Details</h2>
                <form id="contact-form" class="space-y-4">
                    <div>
                        <label for="edit-contact-email" class="block text-sm font-medium text-slate-700">Email</label>
                        <input type="email" id="edit-contact-email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="edit-contact-phone" class="block text-sm font-medium text-slate-700">Phone</label>
                        <input type="tel" id="edit-contact-phone" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="edit-contact-address" class="block text-sm font-medium text-slate-700">Address</label>
                        <textarea id="edit-contact-address" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required></textarea>
                    </div>
                    <button id="save-contact-btn" type="submit" class="w-full btn btn-primary">Save Contact Details</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-30"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-40">
        <div class="p-4 border-b flex items-center space-x-3">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-sky-600" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
             </svg>
            <h2 class="text-lg font-bold text-slate-800">Digital Attappadi</h2>
        </div>
        <nav id="sidebar-nav" class="p-2 space-y-1">
            <a href="#" data-page="home" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Bus Schedule</span>
            </a>
            <a href="#" data-page="fare-calculator" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3m6 0h-3m-3 6v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3" />
                </svg>
                <span>Fare Calculator</span>
            </a>
            <a href="#" data-page="about" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>About</span>
            </a>
            <a href="#" data-page="contact" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <span>Contact</span>
            </a>
            <div id="admin-menu-items"></div>
        </nav>
    </div>

    <!-- Modals (Edit, Confirmation, etc.) -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-40 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
            <div class="text-center">
                <h3 id="modal-title" class="text-xl leading-6 font-bold text-slate-900">Edit Details</h3>
                <div class="mt-4 px-2 py-3">
                    <form id="edit-form" class="space-y-4"></form>
                </div>
                <div class="items-center px-4 py-3 space-y-2">
                    <button id="modal-save" class="w-full btn btn-primary"></button>
                    <button id="modal-cancel" class="w-full btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-slate-900 mt-2">Are you sure?</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirmation-message" class="text-sm text-slate-500"></p>
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="confirm-cancel-btn" class="w-full btn btn-secondary">Close</button>
                    <button id="confirm-action-btn" class="w-full btn btn-danger">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="stop-filter-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-5 border rounded-xl bg-white shadow-2xl">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900 text-center">Select your Stop</h3>
                <div id="stop-filter-list" class="mt-4 max-h-80 overflow-y-auto space-y-2"></div>
                <div class="items-center px-4 py-3">
                    <button id="stop-filter-cancel" class="mt-2 w-full btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="manage-stops-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-5 border rounded-xl bg-white shadow-2xl">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900 text-center">Manage Filter Stops</h3>
                <div id="manage-stops-list" class="mt-4 max-h-60 overflow-y-auto divide-y"></div>
                <div class="mt-4">
                    <select id="add-stop-select" class="w-full px-3 py-2 border rounded-md"></select>
                    <div id="custom-filter-stop-container" class="hidden mt-2">
                        <input type="text" id="custom-filter-stop-input" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name">
                    </div>
                    <button id="add-filter-stop-btn" class="mt-2 w-full btn btn-primary">Add Stop to Filter</button>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="manage-stops-close-btn" class="mt-2 w-full btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50 transition-all duration-300">
        <p id="message-text"></p>
    </div>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAXfcrRz76kWgTfz_lgdFkcWxKl3k-ufac",
            authDomain: "digital-attappadi-live.firebaseapp.com",
            projectId: "digital-attappadi-live",
            storageBucket: "digital-attappadi-live.appspot.com",
            messagingSenderId: "165166679967",
            appId: "1:165166679967:web:6b96e0d85a757393af5faa",
            measurementId: "G-FKXLPE1Y0Q"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'digital-attappadi-live';

        // --- Firebase Services ---
        let app, db, auth, analytics, busCollection, configDocRef, filterStopsDocRef, contactDocRef, aboutDocRef, announcementDocRef, adsCollection;

        // --- STATE ---
        let allBuses = [];
        let filterableStops = [];
        let allAds = [];
        let openDropdownId = null; 
        let isAdmin = false;
        let currentUserId = null;
        let isAuthReady = false;
        let unsubscribeListeners = [];
        let modalResolve = null;
        let modalReject = null;
        let searchQuery = '';
        let currentFilter = 'all';
        let quill = null;
        let predefinedBusNames = [];
        let predefinedStops = [];

        // --- DATA CONSTANTS ---
        const adminUsers = [
            { username: 'dhayaceoda', password: '90474470770', name: 'Dhaya(Thangakutty)' },
            { username: 'poonutty', password: '0313', name: 'Madhu(Poonutty)' }
        ];
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const scheduleList = document.getElementById('schedule-list');
            const statusMessage = document.getElementById('status-message');
            const addBusContainer = document.getElementById('add-bus-container');
            const searchBar = document.getElementById('search-bar');
            const filterDropdown = document.getElementById('filter-dropdown');
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            // --- All functions are defined here before being called ---

            const setStatus = (message, isError = false) => {
                if (statusMessage) {
                    statusMessage.innerHTML = `<p class="p-8 text-center ${isError ? 'text-red-500' : 'text-slate-500'}">${message}</p>`;
                }
            };

            const parseTime = (timeString) => {
                const now = new Date();
                const [hours, minutes] = timeString.split(':');
                now.setHours(hours, minutes, 0, 0);
                return now;
            };

            const formatTime = (dateObject) => dateObject.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            const formatEta = (minutes, prefix = '') => {
                if (minutes <= 1) return 'Now';
                if (minutes < 60) return `${prefix}${minutes}m`;
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                if (remainingMinutes === 0) return `${prefix}${hours}h`;
                return `${prefix}${hours}h ${remainingMinutes}m`;
            };
            
            const to12Hour = (time24) => {
                let [hours, minutes] = time24.split(':');
                hours = parseInt(hours, 10);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                let hour12 = hours % 12;
                if (hour12 === 0) hour12 = 12;
                return { hour: hour12, minute: minutes, ampm: ampm };
            };

            const to24Hour = (hour, minute, ampm) => {
                hour = parseInt(hour, 10);
                minute = String(minute).padStart(2, '0');
                if (ampm.toUpperCase() === 'PM' && hour < 12) hour += 12;
                if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0;
                return `${String(hour).padStart(2, '0')}:${minute}`;
            };
            
            const showMessage = (message) => {
                messageText.textContent = message;
                messageBox.classList.remove('hidden', 'opacity-0', 'translate-y-2');
                setTimeout(() => {
                    messageBox.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => messageBox.classList.add('hidden'), 300);
                }, 2700);
            };

            const updateFilterDropdown = () => {
                let stopFilterOption = '';
                if (isAdmin) {
                    stopFilterOption = `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Manage Stops...</a>`;
                } else if (filterableStops.length > 0) {
                    stopFilterOption = `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Select your Stop...</a>`;
                }

                let optionsHtml = `
                    <a href="#" data-filter="all" class="filter-option ${currentFilter === 'all' ? 'active' : ''} block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">All Buses</a>
                    <a href="#" data-filter="live" class="filter-option ${currentFilter === 'live' ? 'active' : ''} block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Live Buses</a>
                    ${stopFilterOption}
                `;
                filterDropdown.innerHTML = optionsHtml;
            };

            const renderFareMatrix = (busId) => {
                const fareMatrixContainer = document.getElementById('fare-matrix-container');
                const saveFaresBtn = document.getElementById('save-fares-btn');
                const downloadCsvBtn = document.getElementById('download-csv-btn');
                const uploadCsvBtn = document.getElementById('upload-csv-btn');

                fareMatrixContainer.innerHTML = '';
                if (!busId) {
                    saveFaresBtn.classList.add('hidden');
                    downloadCsvBtn.classList.add('hidden');
                    uploadCsvBtn.classList.add('hidden');
                    return;
                }
                const bus = allBuses.find(b => b.id === busId);
                if (!bus || !bus.stops || bus.stops.length < 2) {
                    fareMatrixContainer.innerHTML = '<p class="text-slate-500">This route needs at least two stops to set up fares.</p>';
                    saveFaresBtn.classList.add('hidden');
                    downloadCsvBtn.classList.add('hidden');
                    uploadCsvBtn.classList.add('hidden');
                    return;
                }

                let tableHtml = '<table class="fare-matrix-table"><thead><tr><th class="header-cell">From/To</th>';
                bus.stops.forEach(stop => {
                    tableHtml += `<th class="header-cell">${stop.name}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';

                bus.stops.forEach((fromStop, i) => {
                    tableHtml += `<tr><td class="header-cell">${fromStop.name}</td>`;
                    bus.stops.forEach((toStop, j) => {
                        if (i >= j) {
                            tableHtml += '<td class="disabled-cell"></td>';
                        } else {
                            const fareKey = `${fromStop.name}_${toStop.name}`;
                            const fareValue = (bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) ? bus.fareMatrix[fareKey] : '';
                            tableHtml += `<td><input type="number" class="fare-input" data-key="${fareKey}" value="${fareValue}" min="0"></td>`;
                        }
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';
                fareMatrixContainer.innerHTML = tableHtml;
                saveFaresBtn.classList.remove('hidden');
                downloadCsvBtn.classList.remove('hidden');
                uploadCsvBtn.classList.remove('hidden');
            };

            const populateManageFaresBusSelect = () => {
                const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
                if (!manageFaresBusSelect) return;
                const selectedBusId = manageFaresBusSelect.value;
                manageFaresBusSelect.innerHTML = '<option value="">-- Select a Bus Route --</option>';
                allBuses
                  .sort((a,b) => parseTime(a.stops[0].scheduledTime) - parseTime(b.stops[0].scheduledTime))
                  .forEach(bus => {
                    const option = document.createElement('option');
                    option.value = bus.id;
                    const departureTime = to12Hour(bus.stops[0].scheduledTime);
                    option.textContent = `${departureTime.hour}:${departureTime.minute} ${departureTime.ampm} - ${bus.busNumber}: ${bus.origin} to ${bus.destination}`;
                    manageFaresBusSelect.appendChild(option);
                });
                manageFaresBusSelect.value = selectedBusId;
                renderFareMatrix(selectedBusId);
            };

            const populateFareCalculatorStops = () => {
                const fareFromStop = document.getElementById('fare-from-stop');
                const fareToStop = document.getElementById('fare-to-stop');
                if (!fareFromStop || !fareToStop || allBuses.length === 0) return;

                const allStops = new Set();
                allBuses.forEach(bus => {
                    if (bus.stops) {
                        bus.stops.forEach(stop => allStops.add(stop.name));
                    }
                });

                const sortedStops = [...allStops].sort((a, b) => a.localeCompare(b));

                fareFromStop.innerHTML = '<option value="">-- Select From --</option>';
                fareToStop.innerHTML = '<option value="">-- Select To --</option>';

                sortedStops.forEach(stopName => {
                    const option1 = document.createElement('option');
                    option1.value = stopName;
                    option1.textContent = stopName;
                    fareFromStop.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = stopName;
                    option2.textContent = stopName;
                    fareToStop.appendChild(option2);
                });
            };

            const showPage = (pageId) => {
                const pageContainer = document.getElementById('page-container');
                Array.from(pageContainer.children).forEach(page => {
                    page.classList.add('hidden');
                });
                const newPage = document.getElementById(`${pageId}-page`);
                if(newPage) newPage.classList.remove('hidden');
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === pageId) {
                        link.classList.add('active');
                    }
                });

                if (pageId === 'manage-about' && !quill) {
                    quill = new Quill('#editor-container', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['link', 'clean']
                            ]
                        }
                    });
                    getDoc(aboutDocRef).then(docSnap => {
                        if (docSnap.exists() && quill) {
                            quill.root.innerHTML = docSnap.data().html;
                        }
                    });
                } else if (pageId === 'fare-calculator') {
                    populateFareCalculatorStops();
                } else if (pageId === 'manage-fares') {
                    populateManageFaresBusSelect();
                } else if (pageId === 'manage-ads') {
                    renderAdsList();
                }
                closeSidebar();
            };

            const openSidebar = () => {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebar-overlay').classList.remove('hidden');
                document.getElementById('sidebar-overlay').style.opacity = '1';
            };

            const closeSidebar = () => {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebar-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('sidebar-overlay').classList.add('hidden'), 300);
            };

            const renderAuthControls = () => {
                const adminMenuItems = document.getElementById('admin-menu-items');
                adminMenuItems.innerHTML = '';
                if (isAdmin) {
                    const adminName = localStorage.getItem('adminUser');
                    adminMenuItems.innerHTML = `
                        <div class="border-t my-2"></div>
                        <a href="#" data-page="manage-announcements" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6 3 3 0 000 6z" /></svg>
                            <span>Announcements</span>
                        </a>
                         <a href="#" data-page="manage-fares" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3m6 0h-3m-3 6v-3m-3 3h3m-3-10h-3m9 4v-3m-6 3h-3m6 0h3" /></svg>
                             <span>Manage Fares</span>
                         </a>
                        <a href="#" data-page="manage-ads" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" /></svg>
                            <span>Manage Ads</span>
                        </a>
                         <a href="#" data-page="manage-about" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                             <span>Manage About</span>
                         </a>
                        <a href="#" data-page="manage-contact" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h2m4 0h-4m4 0l-4-4m4 4l4 4" /></svg>
                            <span>Manage Contact</span>
                        </a>
                        <a href="#" data-page="manage-stops" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                             <span>Manage Stops</span>
                        </a>
                        <div class="border-t my-2"></div>
                        <a href="#" id="admin-logout-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            <span>Logout (${adminName || 'Admin'})</span>
                        </a>
                    `;
                } else {
                    adminMenuItems.innerHTML = `
                        <div class="border-t my-2"></div>
                        <a href="#" id="admin-login-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            <span>Admin Login</span>
                        </a>
                    `;
                }
                addBusContainer.classList.toggle('hidden', !isAdmin);
            };

            const checkAdminStatus = () => {
                isAdmin = localStorage.getItem('isAdmin') === 'true';
                renderAuthControls();
                updateAndRenderSchedule();
            };

            const login = async () => {
                closeSidebar();
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" required></div>`;
                try {
                    const data = await showModal('Admin Login', formHtml, 'Login');
                    const user = adminUsers.find(u => u.username === data.username && u.password === data.password);
                    
                    if (user) {
                        localStorage.setItem('isAdmin', 'true');
                        localStorage.setItem('adminUser', user.name);
                        showMessage(`Admin mode enabled for ${user.name}.`);
                        checkAdminStatus();
                    } else {
                        showMessage("Incorrect username or password.");
                    }
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Admin login cancelled.");
                    } else {
                        console.error("Login error:", error);
                    }
                }
            };

            const logout = () => {
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminUser');
                showMessage(`Admin logged out.`);
                openDropdownId = null;
                checkAdminStatus();
                closeSidebar();
            };

            const showModal = (title, formHtml, saveButtonText = 'Save Changes') => {
                const editModal = document.getElementById('edit-modal');
                const modalTitle = document.getElementById('modal-title');
                const editForm = document.getElementById('edit-form');
                const modalSaveBtn = document.getElementById('modal-save');
                
                modalTitle.textContent = title;
                editForm.innerHTML = formHtml;
                modalSaveBtn.textContent = saveButtonText;
                
                editModal.classList.remove('hidden');
                
                const setupCustomSelectListener = (selectId, containerId) => {
                    const selectEl = editForm.querySelector(selectId);
                    const containerEl = editForm.querySelector(containerId);
                    if (selectEl && containerEl) {
                        const toggleVisibility = () => {
                            const isCustom = selectEl.value === 'custom';
                            containerEl.classList.toggle('hidden', !isCustom);
                            const input = containerEl.querySelector('input');
                            if (input) input.required = isCustom;
                        };
                        selectEl.addEventListener('change', toggleVisibility);
                        toggleVisibility();
                    }
                };

                setupCustomSelectListener('#bus-name-select', '#custom-bus-name-container');
                setupCustomSelectListener('#origin-select', '#custom-origin-container');
                setupCustomSelectListener('#destination-select', '#custom-destination-container');
                setupCustomSelectListener('#stop-name-select', '#custom-stop-name-container');

                const statusTypeSelect = editForm.querySelector('#status-type');
                if (statusTypeSelect) {
                    const toggleStatusMinutes = () => {
                        const statusContainer = editForm.querySelector('#status-minutes-container');
                        if(statusContainer) {
                            statusContainer.classList.toggle('hidden', statusTypeSelect.value === 'on-time');
                        }
                    };
                    statusTypeSelect.addEventListener('change', toggleStatusMinutes);
                    toggleStatusMinutes();
                }

                return new Promise((resolve, reject) => {
                    modalResolve = resolve;
                    modalReject = reject;
                });
            };
            
            const hideModal = () => {
                const editModal = document.getElementById('edit-modal');
                editModal.classList.add('hidden');
                document.getElementById('edit-form').innerHTML = '';
                modalResolve = null;
                modalReject = null;
            };

            const showConfirmation = (message) => {
                return new Promise((resolve) => {
                    const confirmationModal = document.getElementById('confirmation-modal');
                    const confirmMessage = document.getElementById('confirmation-message');
                    const confirmActionBtn = document.getElementById('confirm-action-btn');
                    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

                    confirmMessage.textContent = message;
                    confirmationModal.classList.remove('hidden');

                    const handleConfirm = () => {
                        cleanup();
                        resolve(true);
                    };
                    const handleCancel = () => {
                        cleanup();
                        resolve(false);
                    };
                    
                    const cleanup = () => {
                        confirmationModal.classList.add('hidden');
                        confirmActionBtn.removeEventListener('click', handleConfirm);
                        confirmCancelBtn.removeEventListener('click', handleCancel);
                    };

                    confirmActionBtn.addEventListener('click', handleConfirm, { once: true });
                    confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
                });
            };

            const showStopFilterModal = () => {
                const stopFilterModal = document.getElementById('stop-filter-modal');
                const stopFilterList = document.getElementById('stop-filter-list');
                stopFilterList.innerHTML = filterableStops.map(stop => 
                    `<a href="#" data-filter="${stop}" class="filter-option ${currentFilter === stop ? 'active' : ''} flex justify-between items-center p-3 text-left w-full text-sm text-slate-800 rounded-lg hover:bg-sky-50 border border-slate-200">
                        <span>${stop}</span>
                        <span class="text-sky-500 font-bold">&rarr;</span>
                    </a>`
                ).join('');
                stopFilterModal.classList.remove('hidden');
            };

            const hideStopFilterModal = () => {
                document.getElementById('stop-filter-modal').classList.add('hidden');
            };

            const showManageStopsModal = () => {
                closeSidebar();
                const manageStopsModal = document.getElementById('manage-stops-modal');
                const manageStopsList = document.getElementById('manage-stops-list');
                const addStopSelect = document.getElementById('add-stop-select');
                
                manageStopsList.innerHTML = filterableStops.map(stop => `
                    <div class="flex justify-between items-center p-2">
                        <span>${stop}</span>
                        <button data-stop-name="${stop}" class="remove-filter-stop-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `).join('');

                const allStops = new Set(predefinedStops);
                allBuses.forEach(bus => {
                    if (bus.stops) {
                        bus.stops.forEach(stop => allStops.add(stop.name))
                    }
                });
                const availableStops = [...allStops].filter(s => !filterableStops.includes(s)).sort();
                
                addStopSelect.innerHTML = `<option value="">-- Select Stop to Add --</option>` + availableStops.map(stop => `<option value="${stop}">${stop}</option>`).join('') + '<option value="custom">Other...</option>';
                
                const customContainer = document.getElementById('custom-filter-stop-container');
                const customInput = document.getElementById('custom-filter-stop-input');
                
                const toggleCustomInput = () => {
                    if (addStopSelect.value === 'custom') {
                        customContainer.classList.remove('hidden');
                        customInput.focus();
                    } else {
                        customContainer.classList.add('hidden');
                    }
                };
                addStopSelect.onchange = toggleCustomInput;
                toggleCustomInput(); 

                manageStopsModal.classList.remove('hidden');
            };

            const hideManageStopsModal = () => {
                document.getElementById('manage-stops-modal').classList.add('hidden');
            };

            const addSampleDataIfNeeded = async () => {
                const busSnapshot = await getDocs(busCollection);
                if (busSnapshot.empty) {
                    console.log("Database is empty. Adding sample bus routes.");
                    const sampleBuses = [
                        {
                            busNumber: "KSRTC",
                            origin: "Palakkad",
                            destination: "Anaikkatty",
                            seatCapacity: 48,
                            status: { type: 'on-time', minutes: 0 },
                            stops: [
                                { name: "Palakkad", scheduledTime: "08:00", waitingTime: 0, displayFare: 0 },
                                { name: "Mannarkkad", scheduledTime: "09:00", waitingTime: 5, displayFare: 45 },
                                { name: "Goolikkadavu Jn", scheduledTime: "10:00", waitingTime: 0, displayFare: 45 },
                                { name: "Kottathara", scheduledTime: "10:30", waitingTime: 0, displayFare: 20 },
                                { name: "Anaikkatty", scheduledTime: "11:00", waitingTime: 0, displayFare: 20 },
                            ],
                            fareMatrix: {
                                "Palakkad_Mannarkkad": 45, "Palakkad_Goolikkadavu Jn": 90, "Palakkad_Kottathara": 110, "Palakkad_Anaikkatty": 130,
                                "Mannarkkad_Goolikkadavu Jn": 45, "Mannarkkad_Kottathara": 65, "Mannarkkad_Anaikkatty": 85,
                                "Goolikkadavu Jn_Kottathara": 20, "Goolikkadavu Jn_Anaikkatty": 40,
                                "Kottathara_Anaikkatty": 20
                            }
                        }
                    ];
                    try {
                        for (const bus of sampleBuses) {
                            await addDoc(busCollection, bus);
                        }
                    } catch (error) {
                        console.error("Error adding sample bus data:", error);
                    }
                }

                const aboutSnapshot = await getDoc(aboutDocRef);
                if (!aboutSnapshot.exists()) {
                     console.log("About page content is empty. Adding default content.");
                     const defaultAboutContent = {
                         html: `<h2 class="text-2xl font-bold text-slate-800 mb-4">Welcome to Digital Attappadi</h2><p class="text-slate-700 mb-4">This platform is a community-driven initiative to provide reliable, real-time bus tracking for the Makkal Raja Transport Corporation. Our mission is to connect the vibrant communities of the Attappadi region by making travel simpler, more transparent, and predictable for everyone.</p><p class="text-slate-700 mb-4">With Digital Attappadi, you can effortlessly track live bus locations, view detailed routes with all the stops, and get accurate estimated arrival times (ETAs). Whether you're a daily commuter or a visitor exploring the beautiful landscapes of Attappadi, our goal is to ensure you have the most up-to-date information right at your fingertips.</p><p class="text-slate-700">We are continuously working to improve this service. Thank you for being a part of our community. We wish you a safe and pleasant journey!</p>`
                     };
                     try {
                         await setDoc(aboutDocRef, defaultAboutContent);
                     } catch(error) {
                         console.error("Error adding default about content:", error);
                     }
                }

                const configSnapshot = await getDoc(configDocRef);
                if (!configSnapshot.exists()) {
                    console.log("Config document is empty. Adding default lists.");
                    const defaultConfig = {
                        busNames: ['KSRTC', 'SPR', 'SRG', 'KMS', 'RPC', 'Abirami'],
                        stops: ['Anaikkatty', 'Kottathara', 'Agali Jn', 'Goolikkadavu Jn', 'Thavalam', 'Mukkali', 'Mannarkkad', 'Palakkad']
                    };
                    await setDoc(configDocRef, defaultConfig);
                }

            };

            const handleAddBus = async () => {
                const busNameOptions = predefinedBusNames.map(s => `<option value="${s}">${s}</option>`).join('');
                const originOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const destinationOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Bus Name</option>${busNameOptions}<option value="custom">Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Origin</option>${originOptions}<option value="custom">Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Destination</option>${destinationOptions}<option value="custom">Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Departure Time from Origin:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                `;
                try {
                    const data = await showModal('Add New Bus', formHtml, 'Add Bus');
                    
                    if (data.busNumber && !predefinedBusNames.includes(data.busNumber)) {
                        await updateDoc(configDocRef, { busNames: arrayUnion(data.busNumber) });
                    }
                    if (data.origin && !predefinedStops.includes(data.origin)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.origin) });
                    }
                    if (data.destination && !predefinedStops.includes(data.destination)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.destination) });
                    }

                    const scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const firstStop = { name: data.origin, scheduledTime: scheduledTime, waitingTime: 0, displayFare: 0 };
                    const newBus = { 
                        busNumber: data.busNumber, 
                        origin: data.origin, 
                        destination: data.destination,
                        seatCapacity: Number(data.seatCapacity) || null,
                        stops: [firstStop],
                        status: { type: 'on-time', minutes: 0 },
                        fareMatrix: {}
                    };
                    await addDoc(busCollection, newBus);
                    showMessage("New bus route added successfully.");
                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add bus operation cancelled.");
                    } else {
                        console.error("Error during add bus operation:", error);
                        showMessage(`Error: Could not add bus. ${error.message}`);
                    }
                }
            };

            const handleEditBus = async (busId) => {
                const bus = allBuses.find(b => b.id === busId);
                const isCustomBusName = !predefinedBusNames.includes(bus.busNumber);
                const isCustomOrigin = !predefinedStops.includes(bus.origin);
                const isCustomDestination = !predefinedStops.includes(bus.destination);

                const busNameOptions = predefinedBusNames.map(s => `<option value="${s}" ${!isCustomBusName && s === bus.busNumber ? 'selected' : ''}>${s}</option>`).join('');
                const originOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomOrigin && s === bus.origin ? 'selected' : ''}>${s}</option>`).join('');
                const destinationOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomDestination && s === bus.destination ? 'selected' : ''}>${s}</option>`).join('');
                
                const formHtml = `
                    <input type="hidden" name="id" value="${bus.id}">
                    <div><label class="block text-left text-sm font-medium text-slate-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded">${busNameOptions}<option value="custom" ${isCustomBusName ? 'selected' : ''}>Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name" value="${isCustomBusName ? bus.busNumber : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48" value="${bus.seatCapacity || ''}"></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded">${originOptions}<option value="custom" ${isCustomOrigin ? 'selected' : ''}>Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin" value="${isCustomOrigin ? bus.origin : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded">${destinationOptions}<option value="custom" ${isCustomDestination ? 'selected' : ''}>Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination" value="${isCustomDestination ? bus.destination : ''}"></div></div>
                `;
                try {
                    const data = await showModal('Edit Bus Route', formHtml);
                    
                    if (data.busNumber && !predefinedBusNames.includes(data.busNumber)) {
                        await updateDoc(configDocRef, { busNames: arrayUnion(data.busNumber) });
                    }
                    if (data.origin && !predefinedStops.includes(data.origin)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.origin) });
                    }
                    if (data.destination && !predefinedStops.includes(data.destination)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.destination) });
                    }

                    const busDocRef = doc(db, busCollection.path, busId);
                    await updateDoc(busDocRef, {
                        busNumber: data.busNumber,
                        origin: data.origin,
                        destination: data.destination,
                        seatCapacity: Number(data.seatCapacity) || null
                    });
                    showMessage("Bus details updated.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit bus operation cancelled.");
                    } else {
                        console.error("Error updating bus:", error);
                        showMessage(`Error: Could not update bus. ${error.message}`);
                    }
                }
            };

            const handleEditStop = async (busId, stopIndex) => {
                const bus = allBuses.find(b => b.id === busId);
                const stop = bus.stops[stopIndex];
                const isCustomStop = !predefinedStops.includes(stop.name);
                const stopOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomStop && s === stop.name ? 'selected' : ''}>${s}</option>`).join('');
                const time12 = to12Hour(stop.scheduledTime);
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required>${stopOptions}<option value="custom" ${isCustomStop ? 'selected' : ''}>Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name" value="${isCustomStop ? stop.name : ''}"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" value="${time12.hour}" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" value="${time12.minute}" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option ${time12.ampm === 'AM' ? 'selected' : ''}>AM</option><option ${time12.ampm === 'PM' ? 'selected' : ''}>PM</option></select></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Display Fare for this segment ():</label><input type="number" name="displayFare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="${stop.displayFare || 0}" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="${stop.waitingTime || 0}"></div>
                `;
                try {
                    const data = await showModal('Edit Stop', formHtml);
                    
                    if (data.name && !predefinedStops.includes(data.name)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.name) });
                    }

                    data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const newStops = [...bus.stops];
                    newStops[stopIndex] = { ...newStops[stopIndex], name: data.name, scheduledTime: data.scheduledTime, displayFare: Number(data.displayFare) || 0, waitingTime: Number(data.waitingTime) || 0 };
                    newStops.sort((a,b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                    showMessage("Stop details updated. Please review fares in 'Manage Fares'.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Edit stop operation cancelled.");
                    } else {
                        console.error("Error updating stop:", error);
                        showMessage(`Error: Could not update stop. ${error.message}`);
                    }
                }
            };
            
            const handleDuplicateBus = async (busId) => {
                const busToDuplicate = allBuses.find(b => b.id === busId);
                if (!busToDuplicate) {
                    showMessage("Could not find the bus to duplicate.", true);
                    return;
                }

                const formHtml = `
                    <p class="text-sm text-left text-slate-600 mb-4">Duplicating route: <strong>${busToDuplicate.busNumber} (${busToDuplicate.origin} to ${busToDuplicate.destination})</strong>. Please enter the new departure time.</p>
                    <div><label class="block text-left text-sm font-medium text-slate-700">New Departure Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                `;

                try {
                    const data = await showModal('Duplicate Bus Trip', formHtml, 'Create Duplicate');
                    const newScheduledTime = to24Hour(data.hour, data.minute, data.ampm);

                    const newBus = JSON.parse(JSON.stringify(busToDuplicate));
                    delete newBus.id; 
                    
                    const originalDepartureTime = parseTime(newBus.stops[0].scheduledTime);
                    const newDepartureTime = parseTime(newScheduledTime);
                    const timeDifference = newDepartureTime - originalDepartureTime;

                    newBus.stops.forEach(stop => {
                        const oldStopTime = parseTime(stop.scheduledTime);
                        const newStopTime = new Date(oldStopTime.getTime() + timeDifference);
                        stop.scheduledTime = `${String(newStopTime.getHours()).padStart(2, '0')}:${String(newStopTime.getMinutes()).padStart(2, '0')}`;
                    });

                    await addDoc(busCollection, newBus);
                    showMessage("Bus trip duplicated successfully.");

                } catch (error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Duplicate bus operation cancelled.");
                    } else {
                        console.error("Error duplicating bus:", error);
                        showMessage(`Error: Could not duplicate bus. ${error.message}`);
                    }
                }
            };

            const handleAddStop = async (busId) => {
                const bus = allBuses.find(b => b.id === busId);
                const stopOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
                const formHtml = `
                    <div><label class="block text-left text-sm font-medium text-slate-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select a stop</option>${stopOptions}<option value="custom">Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name"></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Display Fare for this segment ():</label><input type="number" name="displayFare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="0" required></div>
                    <div><label class="block text-left text-sm font-medium text-slate-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="0"></div>
                `;
                try {
                    const data = await showModal('Add Stop', formHtml, 'Add Stop');
                    
                    if (data.name && !predefinedStops.includes(data.name)) {
                        await updateDoc(configDocRef, { stops: arrayUnion(data.name) });
                    }

                    data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
                    const newStops = [...bus.stops, { name: data.name, scheduledTime: data.scheduledTime, displayFare: Number(data.displayFare) || 0, waitingTime: Number(data.waitingTime) || 0 }];
                    newStops.sort((a, b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                    showMessage("Stop added to route. Please update fares in 'Manage Fares'.");
                } catch(error) {
                    if (error.message.includes("Modal cancelled")) {
                        console.log("Add stop operation cancelled.");
                    } else {
                        console.error("Error adding stop:", error);
                        showMessage(`Error: Could not add stop. ${error.message}`);
                    }
                }
            };
            
            const handleUpdateStatus = async (busId) => {
                const bus = allBuses.find(b => b.id === busId);
                const currentStatus = bus.status || { type: 'on-time', minutes: 0 };
                
                const formHtml = `
                    <div>
                        <label class="block text-left text-sm font-medium text-slate-700">Status</label>
                        <select id="status-type" name="type" class="mt-1 w-full px-3 py-2 border rounded">
                            <option value="on-time" ${currentStatus.type === 'on-time' ? 'selected' : ''}>On time</option>
                            <option value="late" ${currentStatus.type === 'late' ? 'selected' : ''}>Late</option>
                            <option value="early" ${currentStatus.type === 'early' ? 'selected' : ''}>Early</option>
                        </select>
                    </div>
                    <div id="status-minutes-container" class="${currentStatus.type === 'on-time' ? 'hidden' : ''}">
                        <label class="block text-left text-sm font-medium text-slate-700">Minutes</label>
                        <input type="number" name="minutes" class="mt-1 w-full px-3 py-2 border rounded" value="${currentStatus.minutes || 0}">
                    </div>
                `;

                try {
                    const data = await showModal('Update Bus Status', formHtml, 'Update');
                    const newStatus = {
                        type: data.type,
                        minutes: data.type === 'on-time' ? 0 : Number(data.minutes) || 0
                    };
                    await updateDoc(doc(db, busCollection.path, busId), { status: newStatus });
                    showMessage('Bus status updated.');
                } catch(error) {
                     if (error.message.includes("Modal cancelled")) {
                           console.log("Update status operation cancelled.");
                     } else {
                           console.error("Error updating status:", error);
                           showMessage(`Error: Could not update status. ${error.message}`);
                     }
                }
            };
            
            const calculateAndDisplayFare = () => {
                const fareFromStop = document.getElementById('fare-from-stop');
                const fareToStop = document.getElementById('fare-to-stop');
                const fareResultContainer = document.getElementById('fare-result-container');
                const fromStopName = fareFromStop.value;
                const toStopName = fareToStop.value;

                fareResultContainer.innerHTML = ''; 

                if (!fromStopName || !toStopName) {
                    fareResultContainer.innerHTML = `<p class="text-yellow-600">Please select both a starting and destination stop.</p>`;
                    return;
                }

                if (fromStopName === toStopName) {
                    fareResultContainer.innerHTML = `<p class="text-yellow-600">Starting and destination stops cannot be the same.</p>`;
                    return;
                }

                let totalFare = -1;
                let foundRoute = null;
                const fareKey = `${fromStopName}_${toStopName}`;
                const reverseFareKey = `${toStopName}_${fromStopName}`;

                for (const bus of allBuses) {
                    if(bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) {
                        foundRoute = bus;
                        totalFare = bus.fareMatrix[fareKey];
                        break;
                    }
                    if(bus.fareMatrix && bus.fareMatrix[reverseFareKey] !== undefined) {
                        foundRoute = bus;
                        totalFare = bus.fareMatrix[reverseFareKey];
                        break;
                    }
                }

                if (foundRoute) {
                    fareResultContainer.innerHTML = `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-lg font-semibold text-green-800">Fare: ${totalFare}</p>
                            <p class="text-sm text-slate-600 mt-1">On bus route: ${foundRoute.busNumber} (${foundRoute.origin} - ${foundRoute.destination})</p>
                        </div>
                    `;
                } else {
                    fareResultContainer.innerHTML = `
                         <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                             <p class="text-lg font-semibold text-red-800">No direct route found.</p>
                             <p class="text-sm text-slate-600 mt-1">No fare has been set for the trip from "${fromStopName}" to "${toStopName}".</p>
                         </div>
                    `;
                }
            };

            const handleSaveFares = async () => {
                const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
                const busId = manageFaresBusSelect.value;
                if (!busId) { showMessage("No bus selected.", true); return; }
                
                const newFareMatrix = {};
                let hasError = false;

                document.querySelectorAll('#fare-matrix-container .fare-input').forEach(input => {
                    if (hasError) return;
                    const fareKey = input.dataset.key;
                    const fareValue = input.value;
                    if (fareValue !== '') {
                        const parsedFare = parseInt(fareValue, 10);
                        if (isNaN(parsedFare) || parsedFare < 0) {
                            showMessage(`Invalid fare for ${fareKey.replace('_', ' to ')}. Please enter a valid number.`, true);
                            hasError = true;
                        }
                        newFareMatrix[fareKey] = parsedFare;
                    }
                });

                if (hasError) return;
                try {
                    const busDocRef = doc(db, busCollection.path, busId);
                    await updateDoc(busDocRef, { fareMatrix: newFareMatrix });
                    showMessage("Fares updated successfully!");
                } catch (error) {
                    console.error("Error updating fares:", error);
                    showMessage("Failed to update fares.", true);
                }
            };
            
            const renderAdsList = () => {
                const adsListContainer = document.getElementById('ads-list-container');
                adsListContainer.innerHTML = '';
                if (allAds.length === 0) {
                    adsListContainer.innerHTML = '<p class="text-slate-500">No advertisements have been added yet.</p>';
                    return;
                }
                allAds.forEach(ad => {
                    const adElement = document.createElement('div');
                    adElement.className = 'p-4 border rounded-lg flex items-center justify-between';
                    adElement.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <img src="${ad.imageUrl}" class="h-16 w-16 object-cover rounded-md" onerror="this.src='https://placehold.co/64x64/e2e8f0/475569?text=Image'"/>
                            <div>
                                <p class="font-semibold">Position: After bus #${ad.position}</p>
                                <a href="${ad.link}" target="_blank" class="text-sm text-sky-600 hover:underline truncate">${ad.link || 'No link'}</a>
                            </div>
                        </div>
                        <button data-ad-id="${ad.id}" class="remove-ad-btn p-2 rounded-full hover:bg-red-100 text-red-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    adsListContainer.appendChild(adElement);
                });
            };

            const renderSchedule = (data) => {
                scheduleList.innerHTML = ''; 
                const adsByPosition = allAds.reduce((acc, ad) => {
                    acc[ad.position] = ad;
                    return acc;
                }, {});

                const showAdminControls = isAdmin;

                if (data.length === 0) {
                    if (searchQuery || currentFilter !== 'all') {
                        setStatus(`No results found.`);
                    } else {
                        const message = isAdmin
                            ? "No buses found. Click 'Add New Bus' to create a schedule."
                            : "No buses found for today's schedule.";
                        setStatus(message);
                    }
                    return;
                }
                
                data.forEach((bus, busIndex) => {
                    let arrivalText, arrivalColor, arrivalSize;

                    if (bus.isFinished) {
                        arrivalText = 'Completed';
                        arrivalColor = 'text-slate-500 font-semibold';
                        arrivalSize = 'text-xs';
                    } else if (bus.etaAtGoolikkadavu === null) {
                        arrivalText = 'N/A';
                        arrivalColor = 'text-slate-500 font-semibold';
                        arrivalSize = 'text-sm';
                    } else if (bus.etaAtGoolikkadavu < 0) {
                        arrivalText = 'Departed';
                        arrivalColor = 'text-slate-500 font-semibold';
                        arrivalSize = 'text-xs';
                    }
                    else {
                        arrivalText = formatEta(bus.etaAtGoolikkadavu);
                        arrivalColor = bus.etaAtGoolikkadavu <= 1 ? 'text-red-600 font-bold' : 'text-slate-900 font-semibold';
                        arrivalSize = 'text-sm';
                    }
                    
                    const isDropdownOpen = openDropdownId === bus.id;

                    let stopsHtml = '';
                    bus.stops.forEach((stop, index) => {
                        const passedClass = stop.isPassed ? 'passed' : '';
                        
                        const fareText = index > 0 ? `<p class="text-xs text-green-600 font-semibold">${stop.displayFare || 0}</p>` : '';
                        const waitTimeText = stop.waitingTime > 0 ? `<p class="text-xs text-sky-600 mt-1"> Take Coffee Cup  ${stop.waitingTime} min wait</p>` : '';

                        const editButtons = showAdminControls ? `
                            <div class="flex items-center space-x-2">
                                ${fareText}
                                <button class="edit-stop-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded" data-bus-id="${bus.id}" data-stop-index="${index}">Edit</button>
                                <button class="delete-stop-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded" data-bus-id="${bus.id}" data-stop-index="${index}">Del</button>
                            </div>
                        ` : `
                            <div class="text-right">
                                <p class="text-sm font-medium text-slate-600">${formatTime(new Date(stop.actualArrivalTime))}</p>
                                ${fareText}
                            </div>
                        `;
                        
                        stopsHtml += `
                            <div class="timeline-item ${passedClass}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="stop-name">${stop.name}</p>
                                        <p class="text-xs text-slate-500">${stop.stopArrivalText}</p>
                                        ${waitTimeText}
                                    </div>
                                    ${editButtons}
                                </div>
                            </div>`;
                    });
                    
                    let addStopButtonHtml = '';
                    if (showAdminControls) {
                        addStopButtonHtml = `<div class="p-2 border-t mt-2 flex justify-around"><button class="add-stop-btn text-sm font-medium text-sky-600 hover:text-sky-800" data-bus-id="${bus.id}">+ Add Stop</button><button class="update-status-btn text-sm font-medium text-sky-600 hover:text-sky-800" data-bus-id="${bus.id}">Update Status</button></div>`;
                    }

                    const editBusButtons = showAdminControls ? `
                        <div class="absolute top-2 right-2 flex space-x-1">
                            <button title="Duplicate Trip" class="duplicate-bus-btn p-1.5 rounded-full bg-green-100 text-green-700 hover:bg-green-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2-2H9a2 2 0 01-2-2V9z" /><path d="M3 3a2 2 0 00-2 2v6a2 2 0 002 2h1V9a4 4 0 014-4h5V5a2 2 0 00-2-2H3z" /></svg></button>
                            <button title="Edit Bus" class="edit-bus-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button title="Delete Bus" class="delete-bus-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>
                    `: '';

                    let subtext = '';
                    if (bus.status && bus.status.type !== 'on-time') {
                        subtext = `<span class="${bus.status.type === 'late' ? 'text-red-600' : 'text-blue-600'}">${bus.status.minutes} min ${bus.status.type}</span>`;
                    } else {
                        subtext = `<span class="text-green-600">On time</span>`;
                    }
                    
                    if (bus.seatCapacity) {
                        subtext += ` <span class="text-slate-400 mx-1">|</span> <span> ${bus.seatCapacity}</span>`;
                    }

                    const listItem = document.createElement('div');
                    listItem.className = `bus-item relative border-b border-slate-200`;
                    listItem.innerHTML = `
                        ${editBusButtons}
                        <div class="bus-header p-4 flex items-center cursor-pointer hover:bg-slate-50 transition-colors" data-bus-id="${bus.id}">
                            <span class="text-4xl mr-4"></span>
                            <div class="flex-grow">
                                 <div class="flex items-baseline mb-1">
                                     <p class="font-bold text-base text-slate-800">${bus.busNumber}:</p>
                                     <p class="text-sm font-medium text-slate-600 ml-2">${bus.origin} &rarr; ${bus.destination}</p>
                                 </div>
                                 <div class="flex items-center space-x-1 text-xs font-medium mt-1">${subtext}</div>
                            </div>
                            <div class="text-right"><p class="${arrivalColor} ${arrivalSize}">${arrivalText}</p></div>
                        </div>
                        <div id="details-${bus.id}" class="bus-details bg-slate-50 px-4 ${isDropdownOpen ? 'open' : ''}">
                            <div class="timeline-wrapper">
                                ${stopsHtml}
                                ${bus.stops.length > 0 && !bus.isFinished ? `<span class="live-dot-icon"></span>` : ''}
                            </div>
                            ${addStopButtonHtml}
                        </div>`;
                    scheduleList.appendChild(listItem);

                    // Dynamically calculate and set the live dot's position after rendering the element
                    const liveDot = listItem.querySelector('.live-dot-icon');
                    if (liveDot && bus.stops && bus.stops.length > 0) {
                        const timelineItems = listItem.querySelectorAll('.timeline-item');
                        const index = bus.liveIconPositionIndex;
                        const floorIndex = Math.min(Math.floor(index), timelineItems.length - 1);
                        const fraction = index - floorIndex;

                        if (timelineItems.length > floorIndex && floorIndex >= 0) {
                            // Offset to align the center of the live dot (1rem height) with the center of the static dot (0.75rem height, top: 1rem)
                            // Static dot center = top + 1rem + (0.75rem / 2) = top + 1.375rem
                            // Live dot center = new_top + (1rem / 2) = new_top + 0.5rem
                            // To align centers: new_top + 0.5rem = item.offsetTop + 1.375rem
                            // => new_top = item.offsetTop + 0.875rem
                            const centerAlignmentOffset = 14; // 0.875rem * 16px/rem

                            const floorItem = timelineItems[floorIndex];
                            const floorTop = floorItem.offsetTop + centerAlignmentOffset;

                            let topPosition = floorTop;

                            if (fraction > 0 && floorIndex < timelineItems.length - 1) {
                                const ceilItem = timelineItems[floorIndex + 1];
                                const ceilTop = ceilItem.offsetTop + centerAlignmentOffset;
                                topPosition = floorTop + (ceilTop - floorTop) * fraction;
                            }
                            liveDot.style.top = `${topPosition}px`;
                        }
                    }

                    const ad = adsByPosition[busIndex + 1];
                    if (ad) {
                        const adItem = document.createElement('div');
                        adItem.className = 'p-4 border-b border-slate-200';
                        let adHtml = `<img src="${ad.imageUrl}" alt="Advertisement" class="w-full h-auto rounded-lg" onerror="this.parentElement.style.display='none'">`;
                        if(ad.link){
                            adHtml = `<a href="${ad.link}" target="_blank" rel="noopener noreferrer">${adHtml}</a>`;
                        }
                        adItem.innerHTML = adHtml;
                        scheduleList.appendChild(adItem);
                    }
                });
            };

            const updateAndRenderSchedule = () => {
                if (!isAuthReady) return; 
                const currentTime = new Date();
                
                let liveBusData = allBuses.map(bus => {
                    const status = bus.status || { type: 'on-time', minutes: 0 };
                    let statusOffset = 0;
                    if (status.type === 'late') {
                        statusOffset = status.minutes * 60000;
                    } else if (status.type === 'early') {
                        statusOffset = -status.minutes * 60000;
                    }

                    if (!bus.stops || bus.stops.length === 0) {
                        return { ...bus, stops: [], etaAtGoolikkadavu: null, liveIconPositionIndex: 0, isFinished: true };
                    }
                    
                    const processedStops = bus.stops.map(stop => {
                        const actualArrivalTime = new Date(parseTime(stop.scheduledTime).getTime() + statusOffset);
                        const departureTime = new Date(actualArrivalTime.getTime() + (stop.waitingTime || 0) * 60000);
                        const isPassed = departureTime.getTime() < currentTime.getTime();
                        let stopArrivalText = `Scheduled ${formatTime(actualArrivalTime)}`;
                        if (isPassed) {
                            stopArrivalText = 'Departed';
                        } else if (actualArrivalTime.getTime() < currentTime.getTime()) {
                            stopArrivalText = 'Arrived';
                        }
                        return { ...stop, isPassed, stopArrivalText, actualArrivalTime, departureTime };
                    });

                    const goolikkadavuStop = processedStops.find(stop => stop.name === 'Goolikkadavu Jn');
                    let etaAtGoolikkadavu = null;
                    if (goolikkadavuStop) {
                        etaAtGoolikkadavu = Math.round((goolikkadavuStop.actualArrivalTime.getTime() - currentTime.getTime()) / 60000);
                    }

                    const isFinished = processedStops.every(stop => stop.isPassed);

                    let liveIconPositionIndex = 0;
                    const nextStopIndex = processedStops.findIndex(stop => !stop.isPassed);
                    
                    if (isFinished) {
                        liveIconPositionIndex = processedStops.length;
                    } else if (nextStopIndex > 0) {
                        const lastStop = processedStops[nextStopIndex - 1];
                        const currentNextStop = processedStops[nextStopIndex];
                        
                        const lastStopDepartureTime = lastStop.departureTime.getTime();
                        const nextStopArrivalTime = currentNextStop.actualArrivalTime.getTime();
                        
                        if (currentTime.getTime() >= lastStop.actualArrivalTime.getTime() && currentTime.getTime() < lastStopDepartureTime) {
                            liveIconPositionIndex = nextStopIndex - 1;
                        } else {
                            const segmentDuration = nextStopArrivalTime - lastStopDepartureTime;
                            if (segmentDuration > 0) {
                                const progressInSegment = (currentTime.getTime() - lastStopDepartureTime) / segmentDuration;
                                liveIconPositionIndex = (nextStopIndex - 1) + Math.min(1, Math.max(0, progressInSegment));
                            } else {
                                liveIconPositionIndex = nextStopIndex - 1;
                            }
                        }
                    } else if (nextStopIndex === 0) {
                         const firstStop = processedStops[0];
                         const departureTime = parseTime(bus.stops[0].scheduledTime).getTime() + statusOffset; // Departure from origin
                         const arrivalTime = firstStop.actualArrivalTime.getTime();
                         const segmentDuration = arrivalTime - departureTime;
                         if(segmentDuration > 0) {
                             const progressInSegment = (currentTime.getTime() - departureTime) / segmentDuration;
                             liveIconPositionIndex = progressInSegment;
                             liveIconPositionIndex = Math.min(1, Math.max(0, liveIconPositionIndex));
                         } else {
                             liveIconPositionIndex = 0;
                         }
                    }
                    
                    return { ...bus, stops: processedStops, etaAtGoolikkadavu, liveIconPositionIndex, isFinished };
                });

                let filteredBusData = liveBusData;
                if (searchQuery) {
                    filteredBusData = filteredBusData.filter(bus => {
                        const busName = bus.busNumber.toLowerCase();
                        const origin = bus.origin.toLowerCase();
                        return busName.includes(searchQuery) || origin.includes(searchQuery);
                    });
                }
                
                if (currentFilter === 'live') {
                    filteredBusData = filteredBusData.filter(bus => !bus.isFinished);
                } else if (currentFilter !== 'all') {
                    filteredBusData = filteredBusData.filter(bus => 
                        bus.stops.some(stop => stop.name === currentFilter)
                    );
                }

                filteredBusData.sort((a, b) => {
                    const timeA = a.stops.length > 0 ? parseTime(a.stops[0].scheduledTime) : 0;
                    const timeB = b.stops.length > 0 ? parseTime(b.stops[0].scheduledTime) : 0;
                    
                    if (!timeA && !timeB) return 0;
                    if (!timeA) return 1;
                    if (!timeB) return -1;

                    return timeA - timeB;
                });
                
                renderSchedule(filteredBusData);
            };
            
            const setupEventListeners = () => {
                // Use event delegation on the document for all clicks
                document.addEventListener('click', async (e) => {
                    const target = e.target;
                    const button = target.closest('button');
                    const navLink = target.closest('.nav-link');
                    const header = target.closest('.bus-header');
                    const filterOption = target.closest('.filter-option');

                    // Sidebar controls
                    if (target.closest('#menu-btn')) openSidebar();
                    if (target.id === 'sidebar-overlay') closeSidebar();
                    if (navLink) {
                        e.preventDefault();
                        const pageId = navLink.dataset.page || (navLink.id ? navLink.id.replace('-link', '') : null);
                        if (pageId === 'admin-logout') logout();
                        else if (pageId === 'admin-login') login();
                        else if (pageId === 'manage-stops') showManageStopsModal();
                        else if (pageId) showPage(pageId);
                    }

                    // Filter Dropdown options
                    if (filterOption) {
                         e.preventDefault();
                         const filterValue = filterOption.dataset.filter;
                         if (filterValue === 'select-stop') {
                             if (isAdmin) showManageStopsModal();
                             else showStopFilterModal();
                         } else {
                             currentFilter = filterValue;
                             updateAndRenderSchedule();
                             updateFilterDropdown();
                         }
                         filterDropdown.classList.add('hidden');
                    }

                    // Main page controls
                    if (button) {
                        // Home page buttons
                        if (button.id === 'add-bus-btn') handleAddBus();
                        if (button.id === 'filter-btn') {
                            e.stopPropagation();
                            filterDropdown.classList.toggle('hidden');
                        }
                        
                        // Bus item admin buttons
                        const busId = button.dataset.busId;
                        if (busId) {
                            const stopIndex = parseInt(button.dataset.stopIndex, 10);
                            if (button.matches('.edit-bus-btn')) handleEditBus(busId);
                            else if (button.matches('.delete-bus-btn')) {
                                if (await showConfirmation("This will permanently delete the entire bus route. This action cannot be undone.")) {
                                    await deleteDoc(doc(db, busCollection.path, busId));
                                    showMessage("Bus route deleted.");
                                }
                            }
                            else if (button.matches('.duplicate-bus-btn')) handleDuplicateBus(busId);
                            else if (button.matches('.add-stop-btn')) handleAddStop(busId);
                            else if (button.matches('.edit-stop-btn')) handleEditStop(busId, stopIndex);
                            else if (button.matches('.delete-stop-btn')) {
                                if (await showConfirmation("This will remove the stop from the route. Are you sure?")) {
                                    const bus = allBuses.find(b => b.id === busId);
                                    const newStops = [...bus.stops];
                                    newStops.splice(stopIndex, 1);
                                    await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
                                    showMessage("Stop removed.");
                                }
                            }
                            else if (button.matches('.update-status-btn')) handleUpdateStatus(busId);
                        }

                        // Modal buttons
                        if (button.id === 'modal-save') {
                             const editForm = document.getElementById('edit-form');
                             if (editForm.checkValidity()) {
                                 const formData = new FormData(editForm);
                                 let data = Object.fromEntries(formData.entries());
                                 if(data.busNumber === 'custom') data.busNumber = data.custom_busNumber;
                                 if(data.origin === 'custom') data.origin = data.custom_origin;
                                 if(data.destination === 'custom') data.destination = data.custom_destination;
                                 if(data.name === 'custom') data.name = data.custom_name;
                                 ['custom_busNumber', 'custom_origin', 'custom_destination', 'custom_name'].forEach(key => delete data[key]);
                                 if (modalResolve) modalResolve(data);
                                 hideModal();
                             } else {
                                 editForm.reportValidity();
                             }
                        }
                        if (button.id === 'modal-cancel') {
                            if (modalReject) modalReject(new Error("Modal cancelled by user."));
                            hideModal();
                        }
                        if (button.id === 'confirm-cancel-btn') document.getElementById('confirmation-modal').classList.add('hidden');
                        if (button.id === 'stop-filter-cancel') hideStopFilterModal();
                        if (button.id === 'manage-stops-close-btn') hideManageStopsModal();
                        
                        // Other page buttons
                        if (button.id === 'calculate-fare-btn') calculateAndDisplayFare();
                        if (button.id === 'save-fares-btn') handleSaveFares();
                        if (button.id === 'download-csv-btn') { /* Download logic */ }
                        if (button.id === 'upload-csv-btn') document.getElementById('csv-upload-input').click();
                        if (button.id === 'publish-announcement-btn') {
                            const text = document.getElementById('announcement-input').value.trim();
                            if (text) {
                                await setDoc(announcementDocRef, { text: text, active: true });
                                showMessage("Announcement published.");
                                document.getElementById('announcement-input').value = '';
                            }
                        }
                        if (button.id === 'clear-announcement-btn') {
                            await setDoc(announcementDocRef, { text: '', active: false });
                            showMessage("Announcement cleared.");
                        }
                        if (button.matches('.remove-ad-btn')) {
                            const adId = button.dataset.adId;
                            if (await showConfirmation("Are you sure you want to remove this advertisement?")) {
                               await deleteDoc(doc(db, adsCollection.path, adId));
                               showMessage("Advertisement removed successfully.");
                           }
                        }
                        if (button.id === 'add-filter-stop-btn') {
                            const addStopSelect = document.getElementById('add-stop-select');
                            const customInput = document.getElementById('custom-filter-stop-input');
                            let stopToAdd = addStopSelect.value === 'custom' ? customInput.value.trim() : addStopSelect.value;
                            if (stopToAdd && !filterableStops.includes(stopToAdd)) {
                                const newStops = [...new Set([...filterableStops, stopToAdd])].sort();
                                await setDoc(filterStopsDocRef, { stops: newStops });
                                showMessage(`Added "${stopToAdd}" to filters.`);
                                showManageStopsModal();
                            } else if (!stopToAdd) {
                                showMessage("Please select or enter a stop name.");
                            } else {
                                showMessage(`"${stopToAdd}" is already in the filter list.`);
                            }
                        }
                        if (button.matches('.remove-filter-stop-btn')) {
                            const stopName = button.dataset.stopName;
                            const newStops = filterableStops.filter(s => s !== stopName);
                            await setDoc(filterStopsDocRef, { stops: newStops });
                            showMessage(`Removed "${stopName}" from filters.`);
                            showManageStopsModal();
                        }
                    }
                    
                    // Bus header click for accordion
                    if (header && !button) {
                        const busId = header.dataset.busId;
                        openDropdownId = openDropdownId === busId ? null : busId;
                        updateAndRenderSchedule();
                    }
                });

                // Form Submissions
                document.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    if (form.id === 'ad-form') {
                        const imageUrl = form.querySelector('#ad-image-url-input').value.trim();
                        const link = form.querySelector('#ad-link-input').value.trim();
                        const position = form.querySelector('#ad-position-input').value;
                        if (!imageUrl || !position) {
                            showMessage("Image URL and Position are required.", true);
                            return;
                        }
                        await addDoc(adsCollection, { imageUrl, link, position: Number(position) });
                        showMessage("Advertisement published.");
                        form.reset();
                    }
                    if (form.id === 'about-form') {
                        await setDoc(aboutDocRef, { html: quill.root.innerHTML });
                        showMessage("About page updated.");
                    }
                    if (form.id === 'contact-form') {
                        const email = form.querySelector('#edit-contact-email').value;
                        const phone = form.querySelector('#edit-contact-phone').value;
                        const address = form.querySelector('#edit-contact-address').value;
                        await setDoc(contactDocRef, { email, phone, address });
                        showMessage("Contact details updated.");
                    }
                });

                // Other specific input listeners
                searchBar.addEventListener('input', (e) => {
                    searchQuery = e.target.value.toLowerCase();
                    updateAndRenderSchedule();
                });

                document.getElementById('manage-fares-bus-select').addEventListener('change', (e) => {
                    renderFareMatrix(e.target.value);
                });
            };

            const initializeAppAndData = async () => {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                try {
                    analytics = getAnalytics(app);
                } catch (e) {
                    console.log("Analytics not available in this environment.");
                }

                onAuthStateChanged(auth, (user) => {
                    unsubscribeListeners.forEach(unsub => unsub());
                    unsubscribeListeners = [];

                    if (user) {
                        currentUserId = user.uid;
                        console.log("Authenticated User ID:", currentUserId);
                        
                        const publicDataPath = `artifacts/${appId}/public/data`;
                        busCollection = collection(db, `${publicDataPath}/buses`);
                        configDocRef = doc(db, `${publicDataPath}/config/predefined`);
                        filterStopsDocRef = doc(db, `${publicDataPath}/config/filterStops`);
                        contactDocRef = doc(db, `${publicDataPath}/config/contact`);
                        aboutDocRef = doc(db, `${publicDataPath}/config/about`);
                        announcementDocRef = doc(db, `${publicDataPath}/config/announcement`);
                        adsCollection = collection(db, `${publicDataPath}/advertisements`);

                        const unsubConfig = onSnapshot(configDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const configData = docSnap.data();
                                predefinedBusNames = configData.busNames || [];
                                predefinedStops = configData.stops || [];
                            }
                        });
                        unsubscribeListeners.push(unsubConfig);

                        const unsubBuses = onSnapshot(busCollection, (snapshot) => {
                            allBuses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            if (!isAuthReady) {
                                isAuthReady = true;
                                addSampleDataIfNeeded();
                            }
                            updateAndRenderSchedule();
                            const activePageId = document.querySelector('#page-container > div:not(.hidden)')?.id;
                            if (activePageId === 'manage-fares-page') populateManageFaresBusSelect();
                            if (activePageId === 'fare-calculator-page') populateFareCalculatorStops();
                        }, (error) => {
                            console.error("Error fetching bus data:", error);
                            setStatus("Error loading schedule. Please check connection.", true);
                        });
                        unsubscribeListeners.push(unsubBuses);

                        const unsubAds = onSnapshot(adsCollection, (snapshot) => {
                            allAds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderAdsList();
                            updateAndRenderSchedule();
                        });
                        unsubscribeListeners.push(unsubAds);

                        const unsubAnnouncements = onSnapshot(announcementDocRef, (docSnap) => {
                            const textEl = document.getElementById('announcement-text');
                            const bannerEl = document.getElementById('announcement-banner');
                            if (docSnap.exists() && docSnap.data().active && docSnap.data().text) {
                                const text = docSnap.data().text;
                                textEl.textContent = text;
                                bannerEl.classList.remove('hidden');

                                setTimeout(() => {
                                    if (textEl.scrollWidth > bannerEl.clientWidth) {
                                        textEl.classList.add('scrolling');
                                        const duration = textEl.scrollWidth / 40; 
                                        textEl.style.animationDuration = `${duration}s`;
                                    } else {
                                        textEl.classList.remove('scrolling');
                                        textEl.style.animationDuration = '';
                                    }
                                }, 100);

                                if (isAdmin) {
                                    document.getElementById('current-announcement-container').textContent = text;
                                }
                            } else {
                                bannerEl.classList.add('hidden');
                                textEl.classList.remove('scrolling');
                                if (isAdmin) {
                                    document.getElementById('current-announcement-container').textContent = 'No active announcement.';
                                }
                            }
                        });
                        unsubscribeListeners.push(unsubAnnouncements);

                        const unsubFilters = onSnapshot(filterStopsDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                filterableStops = docSnap.data().stops || [];
                            } else {
                                filterableStops = [];
                            }
                            updateFilterDropdown();
                        });
                        unsubscribeListeners.push(unsubFilters);

                        const unsubContact = onSnapshot(contactDocRef, (docSnap) => {
                            const contactInfoContainer = document.getElementById('contact-info-container');
                            const editContactEmail = document.getElementById('edit-contact-email');
                            const editContactPhone = document.getElementById('edit-contact-phone');
                            const editContactAddress = document.getElementById('edit-contact-address');

                            if (docSnap.exists()) {
                                const contact = docSnap.data();
                                contactInfoContainer.innerHTML = `
                                    <p>For inquiries, feedback, or support, please reach out to us:</p>
                                    <p><strong>Makkal Raja Transport Corporation</strong></p>
                                    <p>Email: <a href="mailto:${contact.email}" class="text-sky-600 hover:underline">${contact.email}</a></p>
                                    <p>Phone: ${contact.phone}</p>
                                    <p>Address: ${contact.address}</p>
                                `;
                                editContactEmail.value = contact.email;
                                editContactPhone.value = contact.phone;
                                editContactAddress.value = contact.address;
                            }
                        });
                        unsubscribeListeners.push(unsubContact);

                        const unsubAbout = onSnapshot(aboutDocRef, (docSnap) => {
                            const aboutContentContainer = document.getElementById('about-content-container');
                            if (docSnap.exists()) {
                                const about = docSnap.data();
                                aboutContentContainer.innerHTML = about.html;
                                if (quill) {
                                    quill.root.innerHTML = about.html;
                                }
                            }
                        });
                        unsubscribeListeners.push(unsubAbout);

                    } else {
                        console.log("User is signed out.");
                        isAuthReady = false;
                        setStatus("Authenticating...", false);
                    }
                });

                try {
                    console.log("Attempting to sign in...");
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Firebase connection successful with custom token!");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase connection successful anonymously!");
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    setStatus("Could not connect to the server. Check console for details.", true);
                }
            };

            // --- Start the App ---
            try {
                setupEventListeners();
                initializeAppAndData();
                checkAdminStatus();
                showPage('home');
            } catch(e) {
                console.error("A critical error occurred on startup:", e);
                setStatus("An unexpected error occurred. Please refresh the page.", true);
            }
        });
    </script>
</body>
</html>
