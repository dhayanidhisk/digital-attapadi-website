<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Attappadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            /* Primary brand blues */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #0ea5e9; /* header light blue */
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-900: #0b2548;

            /* Accent / success (greens) */
            --secondary-50: #ecfdf5;
            --secondary-100: #d1fae5;
            --secondary-500: #10b981;
            --secondary-600: #059669;

            /* Neutral greys */
            --slate-100: #f3f4f6;
            --slate-200: #e5e7eb;
            --slate-300: #d1d5db;
            --slate-400: #9ca3af;
            --slate-500: #6b7280;
            --slate-600: #4b5563;
            --slate-700: #374151;
            --slate-800: #1f2933;
            --slate-900: #111827;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--slate-100);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--slate-200); }
        ::-webkit-scrollbar-thumb { background: var(--slate-400); border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--slate-500); }

        /* General Button Style */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
        }
.btn-primary {
            /* Match header sky-blue tone */
            background-color: #0284c7; /* tailwind sky-600 */
            color: white;
            border-radius: 9999px;
            letter-spacing: 0.01em;
        }
        .btn-primary:hover {
            background-color: #0369a1; /* tailwind sky-700 */
            box-shadow: 0 4px 8px -2px rgba(3,105,161,0.4);
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .btn-secondary {
            background-color: var(--slate-200);
            color: var(--slate-800);
        }
        .btn-secondary:hover {
            background-color: var(--slate-300);
        }

        /* Timeline Styles */
        .timeline-wrapper { position: relative; }
        .timeline-item { position: relative; padding-left: 2.5rem; padding-bottom: 2rem; }
        
        .timeline-item:not(:last-of-type)::after {
            content: '';
            position: absolute;
            left: calc(1.5rem - 1px);
            top: 1.75rem;
            bottom: -2rem;
            width: 2px;
            background-color: var(--slate-200);
            z-index: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.1875rem;
            top: 1rem;
            height: 0.75rem;
            width: 0.75rem;
            background-color: white;
            border: 2px solid var(--slate-300);
            border-radius: 9999px;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .timeline-item.passed::before {
            background-color: var(--primary-600);
            border-color: var(--primary-600);
        }
        .timeline-item.passed:not(:last-of-type)::after {
            background-color: var(--primary-600);
        }
        .stop-name { color: var(--slate-700); font-weight: 600; }
        .timeline-item.passed .stop-name { color: var(--slate-400); font-weight: 500; text-decoration: line-through; }

        /* Live Dot Animation */
        .live-dot-icon {
            position: absolute;
            width: 1rem; height: 1rem;
            background-color: var(--primary-500);
            border-radius: 9999px;
            z-index: 10;
            transition: top 2s linear;
            left: 1.0625rem;
            top: -0.25rem;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%  { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }

        /* Sidebar & Navigation */
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; backdrop-filter: blur(4px); }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active {
            background-color: var(--primary-50);
            color: var(--primary-700);
            font-weight: 700;
        }
        .nav-link.active svg { color: var(--primary-500); }

        /* Align common blue text/icon utilities with header light blue */
        .text-sky-600,
        .text-blue-600 {
            color: var(--primary-500) !important;
        }
        .text-sky-500,
        .text-blue-500 {
            color: var(--primary-500) !important;
        }
        /* New: Make Sidebar navigation scrollable */
        #sidebar-nav {
            height: calc(100% - 70px); /* Adjust height for header */
            overflow-y: auto;
        }

        /* Bus Card Expansion */
        .bus-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-top: 0;
            padding-bottom: 0;
        }
        .bus-details.open {
            max-height: 1000px; /* A large enough value to accommodate content */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        /* Spinner */
        .spinner {
            border-top-color: var(--primary-600);
            animation: spin 1s linear infinite;
        }
        /* New: Make long forms inside modals scrollable */
        #edit-form {
            max-height: 65vh; /* Limit height to 65% of the screen */
            overflow-y: auto; /* Add scrollbar if content overflows */
            padding-right: 0.75rem; /* Add space for the scrollbar */
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Quill Editor */
        #editor-container { height: 250px; }
        .ql-toolbar.ql.snow { border-radius: 0.5rem 0.5rem 0 0; }
        .ql-container.ql.snow { border-radius: 0 0 0.5rem 0.5rem; }

        /* Fare Matrix Table */
        .fare-matrix-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .fare-matrix-table th, .fare-matrix-table td { border: 1px solid var(--slate-200); padding: 0.5rem; text-align: center; }
        .fare-matrix-table th { background-color: var(--slate-100); }
        .fare-matrix-table .header-cell { font-weight: 600; color: var(--slate-600); }
        .fare-matrix-table .disabled-cell { background-color: var(--slate-100); }

        /* Announcement Banner */
        #announcement-banner { overflow: hidden; white-space: nowrap; }
        #announcement-text.scrolling {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0%  { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .video-ad-container {
            position: relative;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden; /* Ensures the iframe corners are clipped */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .mute-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            z-index: 10;
            background-color: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 9999px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* New CSS for single line origin/destination with horizontal scroll */
        .bus-route-text {
            display: flex; /* Make it a flex container for its content spans */
            white-space: nowrap; /* Keep content on a single line */
            animation: marquee-route linear infinite;
            /* Initial position will be handled by keyframes */
        }

        /* This is the actual content that will scroll */
        .bus-route-text .marquee-content {
            flex-shrink: 0; /* Prevent content from shrinking */
            padding-right: var(--marquee-gap-px); /* Add a gap between repetitions */
        }

        /* Hide scrollbar for Webkit browsers (Chrome, Safari) */
        .bus-route-text::-webkit-scrollbar {
            display: none;
        }

        @keyframes marquee-route {
            0%   { transform: translateX(0); }
            100% { transform: translateX(var(--marquee-distance)); }
        }

        /* Ensure bus-header clips overflowing content */
        .bus-header {
            overflow: hidden; /* This is the key change */
        }
    </style>
</head>
<body class="flex justify-center">

    <div id="app-container" class="w-full max-w-md bg-white min-h-screen shadow-2xl">
    <header class="bg-gradient-to-r from-sky-600 to-cyan-500 sticky top-0 z-20 p-4 text-white shadow-lg">
         <div class="flex justify-between items-center">
             <div class="w-16">
                 <button id="menu-btn" class="p-2 rounded-full hover:bg-white/20 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                     </svg>
                 </button>
             </div>
             <div class="text-center">
                 <h1 class="text-2xl font-extrabold tracking-tight">Digital Attappadi</h1>
                 <p class="text-xs text-sky-100 opacity-90">Makkal Raja Transport Corporation</p>
             </div>
             <div class="w-16"></div> </div>
    </header>

    <div id="announcement-banner" class="hidden bg-blue-100 border-b-2 border-blue-300 text-blue-800 text-sm font-medium p-2">
        <p id="announcement-text"></p>
    </div>

    
        <div id="page-container">
    <div id="home-page">
        <div class="p-4 bg-slate-50 border-b border-slate-200">
            <div class="flex items-center">
                <div class="relative flex-grow max-w-full">
                    <div class="flex rounded-full shadow-sm bg-white border border-slate-200">
                        <div class="flex items-center pl-4 pr-2 text-slate-400">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" id="search-bar" class="flex-grow min-w-0 px-2 py-2.5 text-sm border-0 focus:ring-0 focus:outline-none placeholder-slate-400" placeholder="Search by bus name or origin...">
                        <div class="relative flex items-center">
                            <button id="filter-btn" class="h-full px-3 border-l border-slate-200 bg-slate-50 hover:bg-slate-100 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 5h16M7 12h10M10 19h4" />
                                </svg>
                            </button>
                            <div id="filter-dropdown" class="hidden absolute right-0 top-full mt-2 w-52 bg-white rounded-xl shadow-xl z-10 py-1 ring-1 ring-black ring-opacity-5">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main id="schedule-list" class="divide-y divide-slate-200">
            <div id="status-message" class="p-8 text-center text-slate-500">
                <div class="flex flex-col justify-center items-center">
                    <div class="spinner h-8 w-8 border-4 border-slate-200 rounded-full"></div>
                    <span class="ml-3 mt-3">Initializing...</span>
                </div>
            </div>
        </main>

        <div id="add-bus-container" class="p-4 hidden sticky bottom-0 bg-white border-t border-slate-200">
            <button id="add-bus-btn" class="w-full btn btn-primary">Add New Bus</button>
        </div>
    </div>

    <div id="fare-calculator-page" class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)]">
        <div class="max-w-md mx-auto">
            <div class="bg-white rounded-2xl shadow-md border border-slate-200 px-5 py-6 mb-4">
                <h2 class="text-2xl font-bold mb-1 text-slate-900 text-center">Fare Calculator</h2>
                <p class="text-slate-500 text-sm mb-6 text-center">Choose your start and end stops to see the ticket price.</p>

                <div class="space-y-4">
                    <div>
                        <label for="fare-from-stop" class="block text-xs font-semibold uppercase tracking-wide text-slate-500 mb-1">From</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <!-- From: departure pin icon -->
                                <svg class="h-4 w-4 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11a3 3 0 100-6 3 3 0 000 6z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s7-4.35 7-11a7 7 0 10-14 0c0 6.65 7 11 7 11z" />
                                </svg>
                            </div>
                            <select id="fare-from-stop" class="block w-full pl-9 pr-3 py-2.5 rounded-xl border border-slate-300 bg-slate-50 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="fare-to-stop" class="block text-xs font-semibold uppercase tracking-wide text-slate-500 mb-1">To</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <!-- To: destination flag icon -->
                                <svg class="h-4 w-4 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4v16" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4h9l-2 4 2 4H6" />
                                </svg>
                            </div>
                            <select id="fare-to-stop" class="block w-full pl-9 pr-3 py-2.5 rounded-xl border border-slate-300 bg-slate-50 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            </select>
                        </div>
                    </div>

                    <button id="calculate-fare-btn" class="mt-2 w-full btn btn-primary text-sm font-semibold">Calculate Fare</button>
                </div>
            </div>

            <div id="fare-result-container" class="mt-4"></div>
        </div>
    </div>

    <div id="manage-fares-page" class="hidden p-6">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Fares</h2>
        <div class="space-y-4">
            <div>
                <label for="manage-fares-bus-select" class="block text-sm font-medium text-slate-700">Select Bus Route</label>
                <select id="manage-fares-bus-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md"></select>
            </div>
            <div id="fare-matrix-container" class="overflow-x-auto"></div>
            <div class="flex space-x-2 mt-4">
                <button id="download-csv-btn" class="w-full btn btn-secondary hidden">Download CSV</button>
                <button id="upload-csv-btn" class="w-full btn btn-secondary hidden">Upload CSV</button>
                <input type="file" id="csv-upload-input" class="hidden" accept=".csv">
            </div>
            <button id="save-fares-btn" class="w-full btn btn-primary hidden">Save Fares</button>
        </div>
    </div>

    <div id="manage-announcements-page" class="hidden p-6">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Announcements</h2>
        <div class="space-y-4">
            <div>
                <label for="announcement-input" class="block text-sm font-medium text-slate-700">Announcement Message</label>
                <textarea id="announcement-input" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="e.g., Service delays due to heavy rain..."></textarea>
            </div>
            <button id="publish-announcement-btn" class="w-full btn btn-primary">Publish Announcement</button>
            <div class="border-t pt-4">
                <h3 class="text-lg font-medium text-slate-900">Current Announcement</h3>
                <div id="current-announcement-container" class="mt-2 p-3 bg-slate-50 rounded-md text-sm text-slate-700 min-h-[40px]"></div>
                <button id="clear-announcement-btn" class="mt-2 w-full btn btn-danger">Clear Announcement</button>
            </div>
        </div>
    </div>

    <div id="manage-ads-page" class="hidden p-6">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Advertisements</h2>
        <div class="space-y-6">
            <div>
                <h3 class="text-lg font-medium text-slate-900">Current Ads</h3>
                <div id="ads-list-container" class="mt-2 space-y-4">
                </div>
            </div>
            <div class="border-t pt-6">
                <h3 class="text-lg font-medium text-slate-900">Add New Ad</h3>
                <form id="ad-form" class="space-y-4 mt-2">
                    <div>
                        <label for="ad-type-select" class="block text-sm font-medium text-slate-700">Ad Type</label>
                        <select id="ad-type-select" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                            <option value="image" selected>Image Ad</option>
                            <option value="video">Video Ad</option>
                        </select>
                    </div>
                    <div id="ad-image-inputs">
                        <div>
                            <label for="ad-image-url-input" class="block text-sm font-medium text-slate-700">Image URL</label>
                            <input type="url" id="ad-image-url-input" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://example.com/image.png">
                        </div>
                        <div class="mt-4">
                            <label for="ad-link-input" class="block text-sm font-medium text-slate-700">Link URL (when image is clicked)</label>
                            <input type="url" id="ad-link-input" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://example.com">
                        </div>
                    </div>
                    <div id="ad-video-inputs" class="hidden">
                        <label for="ad-video-url-input" class="block text-sm font-medium text-slate-700">YouTube Video URL</label>
                        <input type="url" id="ad-video-url-input" class="mt-1 block w-full px-3 py-2 border rounded" placeholder="https://www.youtube.com/watch?v=...">
                    </div>
                    <div class="mt-4">
                        <label for="ad-position-input" class="block text-sm font-medium text-slate-700">Position (After which bus number)</label>
                        <input type="number" id="ad-position-input" class="mt-1 block w-full px-3 py-2 border rounded" placeholder="e.g., 3" min="1" required>
                    </div>
                    <button id="publish-ad-btn" type="submit" class="w-full btn btn-primary">Publish Ad</button>
                </form>
            </div>
        </div>
    </div>

    <div id="about-page" class="hidden p-6">
        <div id="about-content-container" class="prose max-w-none"></div>
    </div>

    <div id="manage-about-page" class="hidden p-6">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage About Page</h2>
        <form id="about-form" class="space-y-4">
            <div>
                <label for="editor-container" class="block text-sm font-medium text-slate-700">Page Content</label>
                <div id="editor-container" class="mt-1"></div>
            </div>
            <button id="save-about-btn" type="submit" class="w-full btn btn-primary">Save About Page</button>
        </form>
    </div>

    <div id="contact-page" class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)]">
        <div class="max-w-md mx-auto bg-white rounded-2xl shadow-md border border-slate-200 px-5 py-6">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 text-center">Contact Information</h2>
            <div id="contact-info-container" class="space-y-3 text-slate-700 text-sm"></div>
        </div>
    </div>

    <div id="manage-contact-page" class="hidden px-4 py-6 bg-slate-50 min-h-[calc(100vh-64px)]">
        <div class="max-w-md mx-auto bg-white rounded-2xl shadow-md border border-slate-200 px-5 py-6">
            <h2 class="text-2xl font-bold mb-4 text-slate-900 text-center">Manage Contact Details</h2>
            <form id="contact-form" class="space-y-4">
                <div>
                    <label for="edit-contact-email" class="block text-sm font-medium text-slate-700">Email</label>
                    <input type="email" id="edit-contact-email" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="edit-contact-phone" class="block text-sm font-medium text-slate-700">Phone</label>
                    <input type="tel" id="edit-contact-phone" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="edit-contact-address" class="block text-sm font-medium text-slate-700">Address</label>
                    <textarea id="edit-contact-address" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" required></textarea>
                </div>
                <div class="border-t pt-4 mt-2">
                    <h3 class="text-sm font-semibold text-slate-800 mb-2">Social Media (optional)</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="edit-contact-instagram" class="block text-xs font-medium text-slate-600">Instagram URL</label>
                            <input type="url" id="edit-contact-instagram" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://instagram.com/your-page">
                        </div>
                        <div>
                            <label for="edit-contact-youtube" class="block text-xs font-medium text-slate-600">YouTube URL</label>
                            <input type="url" id="edit-contact-youtube" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://youtube.com/@your-channel">
                        </div>
                        <div>
                            <label for="edit-contact-linkedin" class="block text-xs font-medium text-slate-600">LinkedIn URL</label>
                            <input type="url" id="edit-contact-linkedin" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://www.linkedin.com/company/your-page">
                        </div>
                        <div>
                            <label for="edit-contact-facebook" class="block text-xs font-medium text-slate-600">Facebook URL</label>
                            <input type="url" id="edit-contact-facebook" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="https://facebook.com/your-page">
                        </div>
                    </div>
                </div>
                <button id="save-contact-btn" type="submit" class="w-full btn btn-primary">Save Contact Details</button>
            </form>
        </div>
    </div>

    <div id="manage-admins-page" class="hidden p-6">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Admins</h2>
        <div id="admin-list-container" class="space-y-4">
        </div>
        <div class="mt-6">
            <button id="add-admin-btn" class="w-full btn btn-primary">Add New Admin</button>
        </div>
    </div>

    <div id="my-profile-page" class="hidden p-6">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">My Profile</h2>
        <div id="my-profile-content" class="space-y-4">
        </div>
    </div>

    <div id="audit-logs-page" class="hidden p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-slate-800">Audit Logs</h2>
            <button id="clear-audit-logs-btn" class="btn btn-danger hidden">Clear All Logs</button>
        </div>
        <div id="audit-logs-list" class="space-y-4">
            <p class="text-slate-500">Loading audit logs...</p>
        </div>
    </div>

    <div id="manage-bus-codes-page" class="hidden p-6">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Bus Codes</h2>

        <div class="mb-4">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                <input type="text" id="bus-code-search-bar" class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Search by code or bus name...">
            </div>
        </div>

        <div id="add-code-container" class="mb-6 p-4 bg-white rounded-lg border border-slate-200 shadow-sm">
            <h3 class="text-lg font-semibold text-slate-800 mb-3">Add New Code</h3>
            <div class="flex items-center space-x-3">
                <input type="text" id="new-bus-code-input" class="uppercase-input flex-grow w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., AB" maxlength="3">
                <button id="add-new-bus-code-btn" class="btn btn-primary flex-shrink-0">Add Code</button>
            </div>
        </div>
        <div id="bus-codes-list-container">
        </div>
    </div>

    <div id="manage-reports-page" class="hidden p-6">
        <h2 class="text-2xl font-bold mb-6 text-slate-800">Manage Reports</h2>
        <div class="relative mb-4">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
            </div>
            <input type="text" id="reports-search-bar" class="block w-full pl-10 pr-3 py-2.5 border border-slate-300 rounded-lg bg-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Search for a bus...">
        </div>
        <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
            <p class="text-sm text-slate-600 mb-4">
                Select the buses you want to include in the report. The report will be downloaded in a CSV format, which can be opened with Excel or Google Sheets.
            </p>
            <div id="reports-bus-list-container" class="space-y-3 max-h-96 overflow-y-auto border-t border-b py-4 my-4">
                <p class="text-slate-500">Loading bus list...</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <button id="download-selected-btn" class="w-full btn btn-primary">Download Selected</button>
                <button id="download-all-btn" class="w-full btn btn-secondary">Download All Buses</button>
            </div>
        </div>
    </div>

</div> 


    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-30"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-40">
        <div class="p-4 border-b flex items-center space-x-3">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-sky-600" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
             </svg>
            <h2 class="text-lg font-bold text-slate-800">Digital Attappadi</h2>
        </div>
        <nav id="sidebar-nav" class="p-2 space-y-1">
    <a href="#" data-page="home" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
        <span class="w-5 mr-3 text-xl text-center">üïó</span>
        <span>Bus Schedule</span>
    </a>
    <a href="#" data-page="fare-calculator" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
        <span class="w-5 mr-3 text-xl text-center">üé´</span>
        <span>Fare Calculator</span>
    </a>
    <a href="#" data-page="about" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
        <span class="w-5 mr-3 text-xl text-center">‚ÑπÔ∏è</span>
        <span>About</span>
    </a>
    <a href="#" data-page="contact" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
        <span class="w-5 mr-3 text-xl text-center">üìû</span>
        <span>Contact</span>
    </a>
    <div id="admin-menu-items"></div>
</nav>
    </div>

    <!-- Modals (Edit, Confirmation, etc.) -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-40 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
            <div class="text-center">
                <h3 id="modal-title" class="text-xl leading-6 font-bold text-slate-900">Edit Details</h3>
                <div class="mt-4 px-2 py-3">
                    <form id="edit-form" class="space-y-4"></form>
                </div>
                <div class="items-center px-4 py-3 space-y-2">
                    <button id="modal-save" class="w-full btn btn-primary"></button>
                    <button id="modal-cancel" class="w-full btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-6 border rounded-xl bg-white shadow-2xl">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-slate-900 mt-2">Are you sure?</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirmation-message" class="text-sm text-slate-500"></p>
                </div>
                <div class="items-center px-4 py-3 flex gap-2">
                    <button id="confirm-cancel-btn" class="w-full btn btn-secondary">Close</button>
                    <button id="confirm-action-btn" class="w-full btn btn-danger">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="stop-filter-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-5 border rounded-xl bg-white shadow-2xl">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900 text-center">Select your Stop</h3>
                <div id="stop-filter-list" class="mt-4 max-h-80 overflow-y-auto space-y-2"></div>
                <!-- Close button removed; modal will close automatically when a stop is selected -->
            </div>
        </div>
    </div>

    <div id="manage-stops-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative w-full max-w-md mx-auto p-5 border rounded-xl bg-white shadow-2xl">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-slate-900 text-center">Manage Filter Stops</h3>
                <div id="manage-stops-list" class="mt-4 max-h-60 overflow-y-auto divide-y"></div>
                <div class="mt-4">
                    <select id="add-stop-select" class="w-full px-3 py-2 border rounded"></select>
                    <div id="custom-filter-stop-container" class="hidden mt-2">
                        <input type="text" id="custom-filter-stop-input" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name">
                    </div>
                    <button id="add-filter-stop-btn" class="mt-2 w-full btn btn-primary">Add Stop to Filter</button>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="manage-stops-close-btn" class="mt-2 w-full btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="hidden fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50 transition-all duration-300">
        <p id="message-text"></p>
    </div>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
   <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, arrayUnion, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Import serverTimestamp

// --- Firebase Configuration ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    // Fallback for local development
    apiKey: "AIzaSyAXfcrRz76kWgTfz_lgdFkcWxKl3k-ufac",
    authDomain: "digital-attappadi-live.firebaseapp.com",
    projectId: "digital-attappadi-live",
    storageBucket: "digital-attappadi-live.appspot.com",
    messagingSenderId: "165166679967",
    appId: "1:165166679967:web:6b96e0d85a757393af5faa",
    measurementId: "G-FKXLPE1Y0Q"
};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'digital-attappadi-live';

// --- Firebase Services ---
let app, db, auth, analytics, busCollection, configDocRef, filterStopsDocRef, contactDocRef, aboutDocRef, announcementDocRef, adsCollection, adminsCollection, auditLogsCollection, busCodesCollection;

// --- STATE ---
let allBuses = [];
let filterableStops = [];
let allAds = [];
let allAdmins = [];
let allAuditLogs = [];
let currentAdmin = null;
let currentAdminPermissions = {};
let openDropdownId = null;
let openBusCodeRow = null;
let openBusCodeAccordion = null; // <-- ADD THIS LINE
let busCodeSearchQuery = '';
let isAdmin = false;
let isSuperAdmin = false;
let currentUserId = null;
let isAuthReady = false;
let unsubscribeListeners = [];
let modalResolve = null;
let modalReject = null;
let searchQuery = '';
let reportsSearchQuery = ''; // <-- ADD THIS LINE
let currentFilter = 'all';
let quill = null;
let predefinedBusNames = [];
let allBusCodes = [];
let predefinedStops = [];
let videoPlayers = {};

// Reference stop used for ETA calculations and sorting (default: Goolikkadavu Jn)
let referenceStopName = 'Goolikkadavu Jn';

// --- DEFAULT MARQUEE SETTINGS (used if not defined per bus) ---
const DEFAULT_MARQUEE_SPEED_PX_PER_SEC = 50;
const DEFAULT_MARQUEE_REPEAT_DELAY_SEC = 2;

// --- DATA CONSTANTS ---
const SUPER_ADMIN_USERNAME = 'dhayaceoda';
const SUPER_ADMIN_PASSWORD = '90474470770'; // WARNING: Plaintext password. NOT FOR PRODUCTION.
const SUPER_ADMIN_NAME = 'Dhaya(Thangakutty)';

const DEFAULT_PERMISSIONS = {
    manageAnnouncements: false,
    manageFares: false,
    manageAds: false,
    manageAbout: false,
    manageContact: false,
    manageStops: false,
    manageAdmins: false, // Only Super Admin gets this by default, or explicitly granted
    viewAuditLogs: false, // <-- ADD THE COMMA HERE
¬† ¬† manageReports: false
}; // Ensure this closing brace is also present

const BLOOD_GROUPS = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];

document.addEventListener('DOMContentLoaded', () => {
    // Determine reference stop from URL for SPA-style links.
    // Pattern: #home              -> default (Goolikkadavu Jn)
    //          #home/kottathara   -> referenceStopName = 'Kottathara'
    //          #kottathara        -> referenceStopName = 'Kottathara'
    try {
        const hash = (window.location.hash || '').replace(/^#/, '');
        let slug = '';
        if (hash.includes('/')) {
            const parts = hash.split('/');
            slug = parts[parts.length - 1];
        } else if (hash && hash.toLowerCase() !== 'home') {
            slug = hash;
        }
        if (slug) {
            const prettyName = decodeURIComponent(slug)
                .replace(/-/g, ' ')
                .replace(/\b\w/g, c => c.toUpperCase());
            referenceStopName = prettyName;
        }
    } catch (e) {
        console.warn('Unable to parse reference stop from URL hash, using default.', e);
    }
    // --- DOM ELEMENTS ---
    const scheduleList = document.getElementById('schedule-list');
    const statusMessage = document.getElementById('status-message');
    const addBusContainer = document.getElementById('add-bus-container');
    const searchBar = document.getElementById('search-bar');
    const filterDropdown = document.getElementById('filter-dropdown');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const adminListContainer = document.getElementById('admin-list-container');
    const addAdminBtn = document.getElementById('add-admin-btn');
    const myProfileContent = document.getElementById('my-profile-content');
    const auditLogsList = document.getElementById('audit-logs-list');


    // --- All functions are defined here before being called ---

    const setStatus = (message, isError = false) => {
        if (statusMessage) {
            statusMessage.innerHTML = `<p class="p-8 text-center ${isError ? 'text-red-500' : 'text-slate-500'}">${message}</p>`;
        }
    };

    const parseTime = (timeString) => {
        const now = new Date();
        const [hours, minutes] = timeString.split(':');
        now.setHours(hours, minutes, 0, 0);
        return now;
    };

    const formatTime = (dateObject) => dateObject.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

    const formatEta = (minutes, prefix = '') => {
        if (minutes <= 1) return 'Now';
        if (minutes < 60) return `${prefix}${minutes}m`;
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        if (remainingMinutes === 0) return `${prefix}${hours}h`;
        return `${prefix}${hours}h ${remainingMinutes}m`;
    };

    const to12Hour = (time24) => {
        let [hours, minutes] = time24.split(':');
        hours = parseInt(hours, 10);
        const ampm = hours >= 12 ? 'PM' : 'AM';
        let hour12 = hours % 12;
        if (hour12 === 0) hour12 = 12; // 12 PM or 12 AM
        return { hour: hour12, minute: minutes, ampm: ampm };
    };

    const to24Hour = (hour, minute, ampm) => {
        hour = parseInt(hour, 10);
        minute = String(minute).padStart(2, '0');
        if (ampm.toUpperCase() === 'PM' && hour < 12) hour += 12;
        if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0; // Midnight case
        return `${String(hour).padStart(2, '0')}:${minute}`;
    };

    const showMessage = (message, isError = false) => {
        messageText.textContent = message;
        messageBox.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${isError ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'}`;
        messageBox.classList.remove('opacity-0', 'translate-y-2');
        setTimeout(() => {
            messageBox.classList.add('opacity-0', 'translate-y-2');
            setTimeout(() => messageBox.classList.add('hidden'), 300);
        }, 2700);
    };

    const updateFilterDropdown = () => {
        let stopFilterOption = '';
        // Only show "Manage Stops" if Super Admin, otherwise "Select your Stop" if any filterable stops exist
        if (isSuperAdmin && currentAdminPermissions.manageStops) {
            stopFilterOption = `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Manage Stops...</a>`;
        } else if (filterableStops.length > 0) {
            stopFilterOption = `<a href="#" data-filter="select-stop" class="filter-option block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Select your Stop...</a>`;
        }

        // NOTE: We no longer expose a UI to change the reference stop; it stays at
        // Goolikkadavu Jn for the main page. Only basic filters are shown here.
        let optionsHtml = `
            <a href="#" data-filter="all" class="filter-option ${currentFilter === 'all' ? 'active' : ''} block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">All Buses</a>
            <a href="#" data-filter="live" class="filter-option ${currentFilter === 'live' ? 'active' : ''} block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 rounded-md">Live Buses</a>
            <div class="border-t my-1"></div>
            ${stopFilterOption}
        `;
        filterDropdown.innerHTML = optionsHtml;
    };

    const renderFareMatrix = (busId) => {
        const fareMatrixContainer = document.getElementById('fare-matrix-container');
        const saveFaresBtn = document.getElementById('save-fares-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const uploadCsvBtn = document.getElementById('upload-csv-btn');

        fareMatrixContainer.innerHTML = '';
        if (!busId) {
            saveFaresBtn.classList.add('hidden');
            downloadCsvBtn.classList.add('hidden');
            uploadCsvBtn.classList.add('hidden');
            return;
        }
        const bus = allBuses.find(b => b.id === busId);
        if (!bus || !bus.stops || bus.stops.length < 2) {
            fareMatrixContainer.innerHTML = '<p class="text-slate-500">This route needs at least two stops to set up fares.</p>';
            saveFaresBtn.classList.add('hidden');
            downloadCsvBtn.classList.add('hidden');
            uploadCsvBtn.classList.add('hidden');
            return;
        }

        let tableHtml = '<table class="fare-matrix-table"><thead><tr><th class="header-cell">From/To</th>';
        bus.stops.forEach(stop => {
            tableHtml += `<th class="header-cell">${stop.name}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';

        bus.stops.forEach((fromStop, i) => {
            tableHtml += `<tr><td class="header-cell">${fromStop.name}</td>`;
            let row = fromStop.name;
            bus.stops.forEach((toStop, j) => {
                row += ",";
                if (i >= j) {
                    tableHtml += '<td class="disabled-cell"></td>';
                } else {
                    const fareKey = `${fromStop.name}_${toStop.name}`;
                    const fareValue = (bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) ? bus.fareMatrix[fareKey] : '';
                    tableHtml += `<td><input type="number" class="w-16 text-center fare-input bg-white border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" data-key="${fareKey}" value="${fareValue}" min="0"></td>`;
                }
            });
            tableHtml += '</tr>';
        });

        tableHtml += '</tbody></table>';
        fareMatrixContainer.innerHTML = tableHtml;
        // Only show save/download/upload buttons if the current admin has permission
        if (currentAdminPermissions.manageFares) {
            saveFaresBtn.classList.remove('hidden');
            downloadCsvBtn.classList.remove('hidden');
            uploadCsvBtn.classList.remove('hidden');
        } else {
            saveFaresBtn.classList.add('hidden');
            downloadCsvBtn.classList.add('hidden');
            uploadCsvBtn.classList.add('hidden');
        }
    };

    const populateManageFaresBusSelect = () => {
        const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
        if (!manageFaresBusSelect) return;
        const selectedBusId = manageFaresBusSelect.value;
        manageFaresBusSelect.innerHTML = '<option value="">-- Select a Bus Route --</option>';
        allBuses
            .sort((a,b) => parseTime(a.stops[0].scheduledTime) - parseTime(b.stops[0].scheduledTime))
            .forEach(bus => {
                const option = document.createElement('option');
                option.value = bus.id;
                const departureTime = to12Hour(bus.stops[0].scheduledTime);
                const idText = bus.busIdCode ? ` (ID: ${bus.busIdCode})` : '';
                option.textContent = `${departureTime.hour}:${departureTime.minute} ${departureTime.ampm} - ${bus.busNumber}${idText}: ${bus.origin} to ${bus.destination}`;
                manageFaresBusSelect.appendChild(option);
            });
        manageFaresBusSelect.value = selectedBusId;
        renderFareMatrix(selectedBusId);
    };

    const populateFareCalculatorStops = () => {
        const fareFromStop = document.getElementById('fare-from-stop');
        const fareToStop = document.getElementById('fare-to-stop');
        if (!fareFromStop || !fareToStop || allBuses.length === 0) return;

        const allStops = new Set();
        allBuses.forEach(bus => {
            if (bus.stops) {
                bus.stops.forEach(stop => allStops.add(stop.name));
            }
        });

        const sortedStops = [...allStops].sort((a, b) => a.localeCompare(b));

        fareFromStop.innerHTML = '<option value="">-- Select From --</option>';
        fareToStop.innerHTML = '<option value="">-- Select To --</option>';

        sortedStops.forEach(stopName => {
            const option1 = document.createElement('option');
            option1.value = stopName;
            option1.textContent = stopName;
            fareFromStop.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = stopName;
            option2.textContent = stopName;
            fareToStop.appendChild(option2);
        });
    };

    const showPage = (pageId, fromHistory = false) => {
        const pageContainer = document.getElementById('page-container');
        Array.from(pageContainer.children).forEach(page => {
            page.classList.add('hidden');
        });
        const newPage = document.getElementById(`${pageId}-page`);
        if(newPage) newPage.classList.remove('hidden');

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.page === pageId) {
                link.classList.add('active');
            }
        });

        if (!fromHistory) {
            history.pushState({ pageId: pageId }, '', `#${pageId}`);
        }

        if (pageId === 'manage-about' && !quill) {
            quill = new Quill('#editor-container', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'clean']
                    ]
                }
            });
            getDoc(aboutDocRef).then(docSnap => {
                if (docSnap.exists() && quill) {
                    quill.root.innerHTML = docSnap.data().html;
                }
            });
        } else if (pageId === 'fare-calculator') {
            populateFareCalculatorStops();
        } else if (pageId === 'manage-fares') {
            populateManageFaresBusSelect();
        } else if (pageId === 'manage-ads') {
            renderAdsList();
        } else if (pageId === 'manage-admins') {
            renderAdminsList();
        } else if (pageId === 'my-profile') {
            renderMyProfile(); // Render the profile when the page is shown
        } else if (pageId === 'audit-logs') {
            renderAuditLogs();
        } else if (pageId === 'manage-bus-codes') {
            renderManageBusCodesPage();
         } else if (pageId === 'manage-reports') { 
        renderReportsPage();
    }
        closeSidebar();
    };

    const openSidebar = () => {
        document.getElementById('sidebar').classList.add('open');
        document.getElementById('sidebar-overlay').classList.remove('hidden');
        document.getElementById('sidebar-overlay').style.opacity = '1';
    };

    const closeSidebar = () => {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('sidebar-overlay').classList.add('hidden'), 300);
    };

    // Helper function to log admin actions
    const logAdminAction = async (actionType, details, entityId = null, entityType = null) => {
        if (!currentAdmin || !currentAdmin.name) return; // Only log if an admin is logged in
        try {
            await addDoc(auditLogsCollection, {
                timestamp: serverTimestamp(),
                adminName: currentAdmin.name,
                actionType: actionType,
                details: details,
                entityId: entityId,
                entityType: entityType
            });
        } catch (error) {
            console.error("Error logging admin action:", error);
        }
    };

    const renderAuthControls = () => {
        const adminMenuItems = document.getElementById('admin-menu-items');
        adminMenuItems.innerHTML = '';
        if (isAdmin) {
            const adminName = currentAdmin ? currentAdmin.name : 'Admin';
            let adminMenuHtml = `<div class="border-t my-2"></div>`;

            // Add "My Profile" link
            adminMenuHtml += `
                <a href="#" data-page="my-profile" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">ü™™</span>
                    <span>My Profile</span>
                </a>`;

            if (currentAdminPermissions.manageAnnouncements) {
                adminMenuHtml += `
                    <a href="#" data-page="manage-announcements" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üì¢</span>
                        <span>Announcements</span>
                    </a>`;
            }
            if (currentAdminPermissions.manageFares) {
                adminMenuHtml += `
                    <a href="#" data-page="manage-fares" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üé´</span>
                        <span>Manage Fares</span>
                    </a>`;
            }
            if (currentAdminPermissions.manageAds) {
                adminMenuHtml += `
                    <a href="#" data-page="manage-ads" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üì∫</span>
                        <span>Manage Ads</span>
                    </a>`;
            }
            if (currentAdminPermissions.manageAbout) {
                adminMenuHtml += `
                    <a href="#" data-page="manage-about" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">‚ÑπÔ∏è</span>
                        <span>Manage About</span>
                    </a>`;
            }
            if (currentAdminPermissions.manageContact) {
                adminMenuHtml += `
                    <a href="#" data-page="manage-contact" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üìû</span>
                        <span>Manage Contact</span>
                    </a>`;
            }
            if (currentAdminPermissions.manageStops) {
                adminMenuHtml += `
                    <a href="#" data-page="manage-stops" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üöå</span>
                        <span>Manage Stops</span>
                    </a>`;
            }
            // The "Manage Admins" link is ONLY visible to the Super Admin
            if (isSuperAdmin) {
                adminMenuHtml += `
                    <a href="#" data-page="manage-bus-codes" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üè∑Ô∏è</span>
                        <span>Manage Bus Codes</span>
                    </a>
                    <a href="#" data-page="manage-admins" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üõ°Ô∏è</span>
                        <span>Manage Admins</span>
                    </a>`;
            }
            if (currentAdminPermissions.viewAuditLogs) {
                adminMenuHtml += `
                    <a href="#" data-page="audit-logs" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üìù</span>
                        <span>Audit Logs</span>
                    </a>`;
            }

            if (currentAdminPermissions.manageReports) {
                adminMenuHtml += `
                    <a href="#" data-page="manage-reports" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                        <span class="w-5 mr-3 text-xl text-center">üìä</span>
                        <span>Manage Reports</span>
                    </a>`;
            }

            adminMenuHtml += `
                <div class="border-t my-2"></div>
                <a href="#" id="admin-logout-link" class="nav-link flex items-center whitespace-nowrap px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span class="truncate">Logout (${adminName})</span>
                </a>
            `;
            adminMenuItems.innerHTML = adminMenuHtml;

        } else {
            adminMenuItems.innerHTML = `
                <div class="border-t my-2"></div>
                <a href="#" id="admin-login-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üíº</span>
                    <span>Admin Login</span>
                </a>
                <a href="#" id="super-admin-login-link" class="nav-link flex items-center px-4 py-2.5 text-sm text-slate-700 rounded-md hover:bg-slate-100">
                    <span class="w-5 mr-3 text-xl text-center">üè¢</span>
                    <span>Office Login</span>
                </a>
            `;
        }

        // Update search placeholder: only mention ID for admins
        if (searchBar) {
            searchBar.placeholder = isAdmin
                ? 'Search by bus name, origin or ID...'
                : 'Search by bus name or origin...';
        }

        addBusContainer.classList.toggle('hidden', !isAdmin);
    };

    // This function is now responsible for setting isAdmin and isSuperAdmin flags
    const checkAdminStatus = () => {
        isAdmin = currentAdmin !== null;
        isSuperAdmin = isAdmin && currentAdmin.username === SUPER_ADMIN_USERNAME;
        renderAuthControls();
        updateAndRenderSchedule();
        if (document.getElementById('my-profile-page').classList.contains('hidden') === false) {
            renderMyProfile(); // Re-render profile if on that page
        }
        if (document.getElementById('audit-logs-page').classList.contains('hidden') === false) {
            renderAuditLogs(); // Re-render audit logs if on that page
        }
    };

    const login = async (isSuperAdminLogin = false) => {
        closeSidebar();
        const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" required></div>`;
        try {
            const data = await showModal(`${isSuperAdminLogin ? 'Office' : 'Admin'} Login`, formHtml, 'Login');

            // Query Firestore for the admin
            const q = query(adminsCollection,
                                where("username", "==", data.username),
                                where("password", "==", data.password)); // WARNING: Plaintext password match. NOT FOR PRODUCTION.
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const loggedInAdmin = querySnapshot.docs[0].data();
                currentAdmin = { id: querySnapshot.docs[0].id, ...loggedInAdmin };
                currentAdminPermissions = loggedInAdmin.permissions || {};

                // If it's a super admin login attempt, ensure it's the actual super admin
                if (isSuperAdminLogin && loggedInAdmin.username !== SUPER_ADMIN_USERNAME) {
                    showMessage("Invalid Office Login credentials.", true);
                    currentAdmin = null;
                    currentAdminPermissions = {};
                    return;
                }

                localStorage.setItem('adminUser', loggedInAdmin.name); // Store name for display
                showMessage(`${isSuperAdminLogin ? 'Office' : 'Admin'} mode enabled for ${loggedInAdmin.name}.`);
                logAdminAction('LOGIN', `${loggedInAdmin.name} logged in.`);
                checkAdminStatus(); // Update UI based on new admin status
            } else {
                showMessage("Incorrect username or password.");
                currentAdmin = null;
                currentAdminPermissions = {};
            }
        } catch (error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Login cancelled.");
            } else {
                console.error("Login error:", error);
            }
        }
    };

    const logout = () => {
        if (currentAdmin) {
            logAdminAction('LOGOUT', `${currentAdmin.name} logged out.`);
        }
        currentAdmin = null;
        currentAdminPermissions = {};
        localStorage.removeItem('adminUser');
        showMessage(`Logged out.`);
        openDropdownId = null;
        checkAdminStatus(); // Update UI based on logged out status
        closeSidebar();
    };

    const showModal = (title, formHtml, saveButtonText = 'Save Changes') => {
        const editModal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('modal-title');
        const editForm = document.getElementById('edit-form');
        const modalSaveBtn = document.getElementById('modal-save');

        modalTitle.textContent = title;
        editForm.innerHTML = formHtml;
        modalSaveBtn.textContent = saveButtonText;

        editModal.classList.remove('hidden');

        const setupCustomSelectListener = (selectId, containerId, inputName) => {
            const selectEl = editForm.querySelector(selectId);
            const containerEl = editForm.querySelector(containerId);
            if (selectEl && containerEl) {
                const toggleVisibility = () => {
                    const isCustom = selectEl.value === 'custom';
                    containerEl.classList.toggle('hidden', !isCustom);
                    const input = containerEl.querySelector(`input[name="${inputName}"]`);
                    if (input) input.required = isCustom;
                };
                selectEl.addEventListener('change', toggleVisibility);
                toggleVisibility();
            }
        };

        setupCustomSelectListener('#bus-name-select', '#custom-bus-name-container', 'custom_busNumber');
        setupCustomSelectListener('#origin-select', '#custom-origin-container', 'custom_origin');
        setupCustomSelectListener('#destination-select', '#custom-destination-container', 'custom_destination');
        setupCustomSelectListener('#stop-name-select', '#custom-stop-name-container', 'custom_name');
        setupCustomSelectListener('#bus-code-select', '#custom-bus-code-container', 'custom_busCode');


        const statusTypeSelect = editForm.querySelector('#status-type');
        if (statusTypeSelect) {
            const toggleVisibility = () => { // Renamed from toggleStatusMinutes to avoid conflict
                const statusContainer = editForm.querySelector('#status-minutes-container');
                if(statusContainer) {
                    statusContainer.classList.toggle('hidden', !['late', 'early'].includes(statusTypeSelect.value));
                }
            };
            statusTypeSelect.addEventListener('change', toggleVisibility);
            toggleVisibility(); // Call initially to set correct state
        }
        // For admin permissions checkboxes
        const permissionCheckboxes = editForm.querySelectorAll('input[type="checkbox"][name^="permission_"]');
        if (permissionCheckboxes.length > 0) {
            permissionCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    // No direct action needed here, form data will be collected on save
                });
            });
        }

        return new Promise((resolve, reject) => {
            modalResolve = resolve;
            modalReject = reject;
        });
    };

    const hideModal = () => {
        const editModal = document.getElementById('edit-modal');
        editModal.classList.add('hidden');
        document.getElementById('edit-form').innerHTML = '';
        modalResolve = null;
        modalReject = null;
    };

    const showConfirmation = (message) => {
        return new Promise((resolve) => {
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmMessage = document.getElementById('confirmation-message');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            confirmMessage.textContent = message;
            confirmationModal.classList.remove('hidden');

            const handleConfirm = () => {
                cleanup();
                resolve(true);
            };
            const handleCancel = () => {
                cleanup();
                resolve(false);
            };

            const cleanup = () => {
                confirmationModal.classList.add('hidden');
                confirmActionBtn.removeEventListener('click', handleConfirm);
                confirmCancelBtn.removeEventListener('click', handleCancel);
            };

            confirmActionBtn.addEventListener('click', handleConfirm, { once: true });
            confirmCancelBtn.addEventListener('click', handleCancel, { once: true });
        });
    };

    const showStopFilterModal = () => {
        const stopFilterModal = document.getElementById('stop-filter-modal');
        const stopFilterList = document.getElementById('stop-filter-list');
        stopFilterList.innerHTML = filterableStops.map(stop =>
            `<a href="#" data-filter="${stop}" class="filter-option ${currentFilter === stop ? 'active' : ''} flex justify-between items-center p-3 text-left w-full text-sm text-slate-800 rounded-lg hover:bg-sky-50 border border-slate-200">
                <span>${stop}</span>
                <span class="text-sky-500 font-bold">&rarr;</span>
            </a>`
        ).join('');
        stopFilterModal.classList.remove('hidden');
    };

    const hideStopFilterModal = () => {
        document.getElementById('stop-filter-modal').classList.add('hidden');
    };

    const showManageStopsModal = () => {
        closeSidebar();
        const manageStopsModal = document.getElementById('manage-stops-modal');
        const manageStopsList = document.getElementById('manage-stops-list');
        const addStopSelect = document.getElementById('add-stop-select');

        manageStopsList.innerHTML = filterableStops.map(stop => `
            <div class="flex justify-between items-center p-2">
                <span>${stop}</span>
                <button data-stop-name="${stop}" class="remove-filter-stop-btn text-red-500 hover:text-red-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        `).join('');

        const allStops = new Set(predefinedStops);
        allBuses.forEach(bus => {
            if (bus.stops) {
                bus.stops.forEach(stop => allStops.add(stop.name))
            }
        });
        const availableStops = [...allStops].filter(s => !filterableStops.includes(s)).sort();

        addStopSelect.innerHTML = `<option value="">-- Select Stop to Add --</option>` + availableStops.map(stop => `<option value="${stop}">${stop}</option>`).join('') + '<option value="custom">Other...</option>';

        const customContainer = document.getElementById('custom-filter-stop-container');
        const customInput = document.getElementById('custom-filter-stop-input');

        const toggleCustomInput = () => {
            if (addStopSelect.value === 'custom') {
                customContainer.classList.remove('hidden');
                customInput.focus();
            } else {
                customContainer.classList.add('hidden');
            }
        };
        addStopSelect.onchange = toggleCustomInput;
        toggleCustomInput();

        manageStopsModal.classList.remove('hidden');
    };

    const hideManageStopsModal = () => {
        document.getElementById('manage-stops-modal').classList.add('hidden');
    };

    const addSampleDataIfNeeded = async () => {
        const busSnapshot = await getDocs(busCollection);
        if (busSnapshot.empty) {
            console.log("Database is empty. Adding sample bus routes.");
            const sampleBuses = [
                {
                    busNumber: "KSRTC",
                    busCode: "KSR", // New field
                    tripNumber: 1, // New field
                    busIdCode: "KSR1", // New composite field
                    origin: "Palakkad",
                    destination: "Anaikkatty",
                    seatCapacity: 48,
                    status: { type: 'on-time', minutes: 0 },
                    stops: [
                        { name: "Palakkad", scheduledTime: "08:00", waitingTime: 0, displayFare: 0 },
                        { name: "Mannarkkad", scheduledTime: "09:00", waitingTime: 5, displayFare: 45 },
                        { name: "Goolikkadavu Jn", scheduledTime: "10:00", waitingTime: 0, displayFare: 45 },
                        { name: "Kottathara", scheduledTime: "10:30", waitingTime: 0, displayFare: 20 },
                        { name: "Anaikkatty", scheduledTime: "11:00", waitingTime: 0, displayFare: 20 },
                    ],
                    fareMatrix: {
                        "Palakkad_Mannarkkad": 45, "Palakkad_Goolikkadavu Jn": 90, "Palakkad_Kottathara": 110, "Palakkad_Anaikkatty": 130,
                        "Mannarkkad_Goolikkadavu Jn": 45, "Mannarkkad_Kottathara": 65, "Mannarkkad_Anaikkatty": 85,
                        "Goolikkadavu Jn_Kottathara": 20, "Goolikkadavu Jn_Anaikkatty": 40,
                        "Kottathara_Anaikkatty": 20
                    },
                    marqueeSpeedPxPerSec: DEFAULT_MARQUEE_SPEED_PX_PER_SEC, // Add default marquee speed
                    marqueeRepeatDelaySec: DEFAULT_MARQUEE_REPEAT_DELAY_SEC // Add default marquee interval
                }
            ];
            try {
                for (const bus of sampleBuses) {
                    await addDoc(busCollection, bus);
                }
            } catch (error) {
                console.error("Error adding sample bus data:", error);
            }
        }

        const aboutSnapshot = await getDoc(aboutDocRef);
        if (!aboutSnapshot.exists()) {
            console.log("About page content is empty. Adding default content.");
            const defaultAboutContent = {
                html: `<h2 class="text-2xl font-bold text-slate-800 mb-4">Welcome to Digital Attappadi</h2><p class="text-slate-700 mb-4">This platform is a community-driven initiative to provide reliable, real-time bus tracking for the Makkal Raja Transport Corporation. Our mission is to connect the vibrant communities of the Attappadi region by making travel simpler, more transparent, and predictable for everyone.</p><p class="text-slate-700 mb-4">With Digital Attappadi, you can effortlessly track live bus locations, view detailed routes with all the stops, and get accurate estimated arrival times (ETAs). Whether you're a daily commuter or a visitor exploring the beautiful landscapes of Attappadi, our goal is to ensure you have the most up-to-date information right at your fingertips.</p><p class="text-slate-700">We are continuously working to improve this service. Thank you for being a part of our community. We wish you a safe and pleasant journey!</p>`
            };
            try {
                await setDoc(aboutDocRef, defaultAboutContent);
            } catch(error) {
                console.error("Error adding default about content:", error);
            }
        }

        const configSnapshot = await getDoc(configDocRef);
        if (!configSnapshot.exists()) {
            console.log("Config document is empty. Adding default lists.");
            const defaultConfig = {
                busNames: ['KSRTC', 'SPR', 'SRG', 'KMS', 'RPC', 'Abirami'],
                stops: ['Anaikkatty', 'Kottathara', 'Agali Jn', 'Goolikkadavu Jn', 'Thavalam', 'Mukkali', 'Mannarkkad', 'Palakkad', 'Coimbatore']
            };
            await setDoc(configDocRef, defaultConfig);
        }

        // New: Add default Bus Codes if collection is empty
        const busCodesSnapshot = await getDocs(busCodesCollection);
        if (busCodesSnapshot.empty) {
            console.log("Bus Codes collection is empty. Adding default codes.");
            const defaultCodes = ["AH", "HJ", "KL", "NH", "GF", "FD"];
            const batch = writeBatch(db);
            defaultCodes.forEach(code => {
                const newDocRef = doc(busCodesCollection);
                batch.set(newDocRef, { code: code });
            });
            await batch.commit();
        }

        // Add Super Admin if admins collection is empty
        const adminsSnapshot = await getDocs(adminsCollection);
        if (adminsSnapshot.empty) {
            console.log("Admins collection is empty. Adding Super Admin.");
            await addDoc(adminsCollection, {
                username: SUPER_ADMIN_USERNAME,
                password: SUPER_ADMIN_PASSWORD, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                name: SUPER_ADMIN_NAME,
                permissions: { // Super Admin gets all permissions
                    manageAnnouncements: true,
                    manageFares: true,
                    manageAds: true,
                    manageAbout: true,
                    manageContact: true,
                    manageStops: true,
                    manageAdmins: true,
                    viewAuditLogs: true // Super Admin can view audit logs
                }
            });
        }

    };

        const handleAddBus = async () => {
        // Check permission before showing modal
        if (!isAdmin) { showMessage("Permission denied.", true); return; }

        const busNameOptions = predefinedBusNames.map(s => `<option value="${s}">${s}</option>`).join('');
        const busCodeOptions = allBusCodes.map(c => `<option value="${c.code}">${c.code}</option>`).join('');
        const originOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
        const destinationOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
        const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Bus Name</option>${busNameOptions}<option value="custom">Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name"></div></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-left text-sm font-medium text-slate-700">Bus Code:</label><select id="bus-code-select" name="busCode" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Code</option>${busCodeOptions}<option value="custom">Add New...</option></select><div id="custom-bus-code-container" class="hidden mt-2"><input type="text" name="custom_busCode" class="w-full px-3 py-2 border rounded" placeholder="e.g., HJ"></div></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Trip Number:</label><input type="number" name="tripNumber" class="mt-1 w-full px-3 py-2 border rounded" placeholder="1-10" min="1" max="10" required></div>
            </div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Origin</option>${originOptions}<option value="custom">Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select Destination</option>${destinationOptions}<option value="custom">Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Departure Time from Origin:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
        `;
        try {
            const data = await showModal('Add New Bus', formHtml, 'Add Bus');

            if (data.busNumber && !predefinedBusNames.includes(data.busNumber)) {
                await updateDoc(configDocRef, { busNames: arrayUnion(data.busNumber) });
            }
            if (data.busCode && !allBusCodes.some(c => c.code === data.busCode)) {
                // New code created via "Add New..."
                await addDoc(busCodesCollection, { code: data.busCode.toUpperCase() });
            }

            // Ensure the trip number for this bus name is not already used
            const proposedTripNumber = Number(data.tripNumber);
            if (allBuses.some(b => b.busNumber === data.busNumber && Number(b.tripNumber) === proposedTripNumber)) {
                showMessage(`Trip number ${proposedTripNumber} is already used for bus "${data.busNumber}". Please choose a different trip number.`, true);
                return;
            }

            // Ensure the combined bus ID code (CODE + tripNumber) is unique
            const proposedBusIdCode = `${data.busCode.toUpperCase()}${data.tripNumber}`;
            if (allBuses.some(b => b.busIdCode === proposedBusIdCode)) {
                showMessage(`A bus with ID "${proposedBusIdCode}" already exists. Please choose a different code or trip number.`, true);
                return;
            }

            if (data.origin && !predefinedStops.includes(data.origin)) {
                await updateDoc(configDocRef, { stops: arrayUnion(data.origin) });
            }
            if (data.destination && !predefinedStops.includes(data.destination)) {
                await updateDoc(configDocRef, { stops: arrayUnion(data.destination) });
            }

            const scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
            const firstStop = { name: data.origin, scheduledTime: scheduledTime, waitingTime: 0, displayFare: 0 };
            const newBusIdCode = `${data.busCode.toUpperCase()}${data.tripNumber}`;
            const newBus = {
                busNumber: data.busNumber,
                busCode: data.busCode.toUpperCase(),
                tripNumber: Number(data.tripNumber),
                busIdCode: newBusIdCode,
                origin: data.origin,
                destination: data.destination,
                seatCapacity: Number(data.seatCapacity) || null,
                stops: [firstStop],
                status: { type: 'on-time', minutes: 0 },
                fareMatrix: {},
                marqueeSpeedPxPerSec: DEFAULT_MARQUEE_SPEED_PX_PER_SEC, // Set default speed for new bus
                marqueeRepeatDelaySec: DEFAULT_MARQUEE_REPEAT_DELAY_SEC // Set default delay for new bus
            };
            const docRef = await addDoc(busCollection, newBus);
            showMessage("New bus route added successfully.");
            logAdminAction('ADD_BUS', `Added new bus route: ${newBus.busNumber} (ID: ${newBus.busIdCode})`, docRef.id, 'bus');
        } catch (error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Add bus operation cancelled.");
            } else {
                console.error("Error during add bus operation:", error);
                showMessage(`Error: Could not add bus. ${error.message}`);
            }
        }
    };

    const handleEditBus = async (busId) => {
        if (!isAdmin) { showMessage("Permission denied.", true); return; }
        const bus = allBuses.find(b => b.id === busId);
        const isCustomBusName = !predefinedBusNames.includes(bus.busNumber);
        const isCustomOrigin = !predefinedStops.includes(bus.origin);
        const isCustomDestination = !predefinedStops.includes(bus.destination);

        const busNameOptions = predefinedBusNames.map(s => `<option value="${s}" ${!isCustomBusName && s === bus.busNumber ? 'selected' : ''}>${s}</option>`).join('');
        const busCodeOptions = allBusCodes.map(c => `<option value="${c.code}" ${c.code === bus.busCode ? 'selected' : ''}>${c.code}</option>`).join('');
        const originOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomOrigin && s === bus.origin ? 'selected' : ''}>${s}</option>`).join('');
        const destinationOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomDestination && s === bus.destination ? 'selected' : ''}>${s}</option>`).join('');

        const formHtml = `
            <input type="hidden" name="id" value="${bus.id}">
            <div><label class="block text-left text-sm font-medium text-slate-700">Bus Name:</label><select id="bus-name-select" name="busNumber" class="mt-1 w-full px-3 py-2 border rounded">${busNameOptions}<option value="custom" ${isCustomBusName ? 'selected' : ''}>Other...</option></select><div id="custom-bus-name-container" class="hidden mt-2"><input type="text" name="custom_busNumber" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Bus Name" value="${isCustomBusName ? bus.busNumber : ''}"></div></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-left text-sm font-medium text-slate-700">Bus Code:</label><select id="bus-code-select" name="busCode" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled>Select Code</option>${busCodeOptions}<option value="custom">Add New...</option></select><div id="custom-bus-code-container" class="hidden mt-2"><input type="text" name="custom_busCode" class="w-full px-3 py-2 border rounded" placeholder="e.g., HJ"></div></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Trip Number:</label><input type="number" name="tripNumber" class="mt-1 w-full px-3 py-2 border rounded" placeholder="1-10" min="1" max="10" value="${bus.tripNumber || ''}" required></div>
            </div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Seat Capacity:</label><input type="number" name="seatCapacity" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 48" value="${bus.seatCapacity || ''}"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">From:</label><select id="origin-select" name="origin" class="mt-1 w-full px-3 py-2 border rounded">${originOptions}<option value="custom" ${isCustomOrigin ? 'selected' : ''}>Other...</option></select><div id="custom-origin-container" class="hidden mt-2"><input type="text" name="custom_origin" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Origin" value="${isCustomOrigin ? bus.origin : ''}"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">To:</label><select id="destination-select" name="destination" class="mt-1 w-full px-3 py-2 border rounded">${destinationOptions}<option value="custom" ${isCustomDestination ? 'selected' : ''}>Other...</option></select><div id="custom-destination-container" class="hidden mt-2"><input type="text" name="custom_destination" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Destination" value="${isCustomDestination ? bus.destination : ''}"></div></div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Marquee Display Settings</h4>
                <div><label class="block text-left text-sm font-medium text-slate-700">Marquee Speed (pixels/second):</label><input type="number" name="marqueeSpeedPxPerSec" class="mt-1 w-full px-3 py-2 border rounded" min="1" value="${bus.marqueeSpeedPxPerSec || DEFAULT_MARQUEE_SPEED_PX_PER_SEC}" required></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Marquee Repeat Delay (seconds):</label><input type="number" name="marqueeRepeatDelaySec" class="mt-1 w-full px-3 py-2 border rounded" step="0.1" min="0" value="${bus.marqueeRepeatDelaySec || DEFAULT_MARQUEE_REPEAT_DELAY_SEC}" required></div>
            </div>
        `;
        try {
            const data = await showModal('Edit Bus Route', formHtml);

            if (data.busNumber && !predefinedBusNames.includes(data.busNumber)) {
                await updateDoc(configDocRef, { busNames: arrayUnion(data.busNumber) });
            }
            if (data.busCode && !allBusCodes.some(c => c.code === data.busCode)) {
                await addDoc(busCodesCollection, { code: data.busCode.toUpperCase() });
            }

            // Ensure the trip number for this bus name is not already used (excluding this bus)
            const proposedTripNumber = Number(data.tripNumber);
            if (allBuses.some(b => b.id !== busId && b.busNumber === data.busNumber && Number(b.tripNumber) === proposedTripNumber)) {
                showMessage(`Trip number ${proposedTripNumber} is already used for bus "${data.busNumber}". Please choose a different trip number.`, true);
                return;
            }

            // Ensure the combined bus ID code (CODE + tripNumber) is unique (excluding this bus itself)
            const proposedBusIdCode = `${data.busCode.toUpperCase()}${data.tripNumber}`;
            if (allBuses.some(b => b.id !== busId && b.busIdCode === proposedBusIdCode)) {
                showMessage(`A bus with ID "${proposedBusIdCode}" already exists. Please choose a different code or trip number.`, true);
                return;
            }

            if (data.origin && !predefinedStops.includes(data.origin)) {
                await updateDoc(configDocRef, { stops: arrayUnion(data.origin) });
            }
            if (data.destination && !predefinedStops.includes(data.destination)) {
                await updateDoc(configDocRef, { stops: arrayUnion(data.destination) });
            }

            const busDocRef = doc(db, busCollection.path, busId);
            const updatedBusIdCode = `${data.busCode.toUpperCase()}${data.tripNumber}`;
            await updateDoc(busDocRef, {
                busNumber: data.busNumber,
                busCode: data.busCode.toUpperCase(),
                tripNumber: Number(data.tripNumber),
                busIdCode: updatedBusIdCode,
                origin: data.origin,
                destination: data.destination,
                seatCapacity: Number(data.seatCapacity) || null,
                marqueeSpeedPxPerSec: Number(data.marqueeSpeedPxPerSec),
                marqueeRepeatDelaySec: Number(data.marqueeRepeatDelaySec)
            });
            showMessage("Bus details updated.");
            logAdminAction('EDIT_BUS', `Edited bus route: ${bus.busNumber} (ID: ${bus.busIdCode})`, busId, 'bus');
        } catch(error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Edit bus operation cancelled.");
            } else {
                console.error("Error updating bus:", error);
                showMessage(`Error: Could not update bus. ${error.message}`);
            }
        }
    };

    const handleEditStop = async (busId, stopIndex) => {
        if (!isAdmin) { showMessage("Permission denied.", true); return; }
        const bus = allBuses.find(b => b.id === busId);
        const stop = bus.stops[stopIndex];
        const isCustomStop = !predefinedStops.includes(stop.name);
        const stopOptions = predefinedStops.map(s => `<option value="${s}" ${!isCustomStop && s === stop.name ? 'selected' : ''}>${s}</option>`).join('');
        const time12 = to12Hour(stop.scheduledTime);
        const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required>${stopOptions}<option value="custom" ${isCustomStop ? 'selected' : ''}>Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name" value="${isCustomStop ? stop.name : ''}"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" value="${time12.hour}" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" value="${time12.minute}" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option ${time12.ampm === 'AM' ? 'selected' : ''}>AM</option><option ${time12.ampm === 'PM' ? 'selected' : ''}>PM</option></select></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Display Fare for this segment (‚Çπ):</label><input type="number" name="displayFare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="${stop.displayFare || 0}" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="${stop.waitingTime || 0}"></div>
        `;
        try {
            const data = await showModal('Edit Stop', formHtml);

            if (data.name && !predefinedStops.includes(data.name)) {
                await updateDoc(configDocRef, { stops: arrayUnion(data.name) });
            }

            data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
            const newStops = [...bus.stops];
            newStops[stopIndex] = { ...newStops[stopIndex], name: data.name, scheduledTime: data.scheduledTime, displayFare: Number(data.displayFare) || 0, waitingTime: Number(data.waitingTime) || 0 };
            newStops.sort((a,b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
            await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
            showMessage("Stop details updated. Please review fares in 'Manage Fares'.");
            logAdminAction('EDIT_STOP', `Edited stop "${stop.name}" on bus ${bus.busNumber} to "${data.name}"`, busId, 'bus_stop');
        } catch(error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Edit stop operation cancelled.");
            } else {
                console.error("Error updating stop:", error);
                showMessage(`Error: Could not update stop. ${error.message}`);
            }
        }
    };

    const handleDeleteStop = async (busId, stopIndex) => {
        if (!isAdmin) { showMessage("Permission denied.", true); return; }
        if (await showConfirmation("This will remove the stop from the route. Are you sure?")) {
            const bus = allBuses.find(b => b.id === busId);
            const stopName = bus.stops[stopIndex].name;
            const newStops = [...bus.stops];
            newStops.splice(stopIndex, 1);
            await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
            showMessage("Stop removed.");
            logAdminAction('DELETE_STOP', `Removed stop "${stopName}" from bus ${bus.busIdCode}`, busId, 'bus_stop');
        }
    };

    const handleDuplicateBus = async (busId) => {
        if (!isAdmin) { showMessage("Permission denied.", true); return; }
        const busToDuplicate = allBuses.find(b => b.id === busId);
        if (!busToDuplicate) {
            showMessage("Could not find the bus to duplicate.", true);
            return;
        }

        const formHtml = `
            <p class="text-sm text-left text-slate-600 mb-4">Duplicating route: <strong>${busToDuplicate.busNumber} (ID: ${busToDuplicate.busIdCode})</strong>. Enter new trip details.</p>
            <div><label class="block text-left text-sm font-medium text-slate-700">New Trip Number:</label><input type="number" name="tripNumber" class="mt-1 w-full px-3 py-2 border rounded" placeholder="1-10" min="1" max="10" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">New Departure Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
        `;

        try {
            const data = await showModal('Duplicate Bus Trip', formHtml, 'Create Duplicate');
            const newScheduledTime = to24Hour(data.hour, data.minute, data.ampm);

            const newBus = JSON.parse(JSON.stringify(busToDuplicate));
            delete newBus.id;

            const originalDepartureTime = parseTime(newBus.stops[0].scheduledTime);
            const newDepartureTime = parseTime(newScheduledTime);
            const timeDifference = newDepartureTime - originalDepartureTime;

            newBus.stops.forEach(stop => {
                const oldStopTime = parseTime(stop.scheduledTime);
                const newStopTime = new Date(oldStopTime.getTime() + timeDifference);
                stop.scheduledTime = `${String(newStopTime.getHours()).padStart(2, '0')}:${String(newStopTime.getMinutes()).padStart(2, '0')}`;
            });

            // Update trip number and ID
            newBus.tripNumber = Number(data.tripNumber);
            newBus.busIdCode = `${newBus.busCode}${newBus.tripNumber}`;

            // Ensure the trip number for this bus name is not already used
            if (allBuses.some(b => b.busNumber === newBus.busNumber && Number(b.tripNumber) === newBus.tripNumber)) {
                showMessage(`Trip number ${newBus.tripNumber} is already used for bus "${newBus.busNumber}". Please choose a different trip number.`, true);
                return;
            }

            // Ensure the new bus ID code is unique
            if (allBuses.some(b => b.busIdCode === newBus.busIdCode)) {
                showMessage(`A bus with ID "${newBus.busIdCode}" already exists. Please choose a different trip number.`, true);
                return;
            }

            const docRef = await addDoc(busCollection, newBus);
            showMessage("Bus trip duplicated successfully.");
            logAdminAction('DUPLICATE_BUS', `Duplicated bus ${busToDuplicate.busIdCode} to create new trip ${newBus.busIdCode}`, docRef.id, 'bus');

        } catch (error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Duplicate bus operation cancelled.");
            } else {
                console.error("Error duplicating bus:", error);
                showMessage(`Error: Could not duplicate bus. ${error.message}`);
            }
        }
    };

    const handleAddStop = async (busId) => {
        if (!isAdmin) { showMessage("Permission denied.", true); return; }
        const bus = allBuses.find(b => b.id === busId);
        const stopOptions = predefinedStops.map(s => `<option value="${s}">${s}</option>`).join('');
        const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Stop Name:</label><select id="stop-name-select" name="name" class="mt-1 w-full px-3 py-2 border rounded" required><option value="" disabled selected>Select a stop</option>${stopOptions}<option value="custom">Other...</option></select><div id="custom-stop-name-container" class="hidden mt-2"><input type="text" name="custom_name" class="w-full px-3 py-2 border rounded" placeholder="Enter Custom Stop Name"></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Scheduled Time:</label><div class="flex items-center space-x-2 mt-1"><input type="number" name="hour" class="w-1/3 px-3 py-2 border rounded" placeholder="Hr" min="1" max="12" required><span class="font-bold">:</span><input type="number" name="minute" class="w-1/3 px-3 py-2 border rounded" placeholder="Min" min="0" max="59" required><select name="ampm" class="w-1/3 px-3 py-2 border rounded"><option>AM</option><option>PM</option></select></div></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Display Fare for this segment (‚Çπ):</label><input type="number" name="displayFare" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 25" value="0" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Waiting Time (mins):</label><input type="number" name="waitingTime" class="mt-1 w-full px-3 py-2 border rounded" placeholder="e.g., 5" value="0"></div>
        `;
        try {
            const data = await showModal('Add Stop', formHtml, 'Add Stop');

            if (data.name && !predefinedStops.includes(data.name)) {
                await updateDoc(configDocRef, { stops: arrayUnion(data.name) });
            }

            data.scheduledTime = to24Hour(data.hour, data.minute, data.ampm);
            const newStops = [...bus.stops];
            newStops.push({ name: data.name, scheduledTime: data.scheduledTime, displayFare: Number(data.displayFare) || 0, waitingTime: Number(data.waitingTime) || 0 });
            newStops.sort((a,b) => parseTime(a.scheduledTime) - parseTime(b.scheduledTime));
            await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
            showMessage("Stop added. Please review fares in 'Manage Fares'.");
            logAdminAction('ADD_STOP', `Added stop "${data.name}" to bus ${bus.busNumber}`, busId, 'bus_stop');
        } catch(error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Add stop operation cancelled.");
            } else {
                console.error("Error adding stop:", error);
                showMessage(`Error: Could not add stop. ${error.message}`);
            }
        }
    };

    const handleUpdateStatus = async (busId) => {
        if (!isAdmin) { showMessage("Permission denied.", true); return; }
        const bus = allBuses.find(b => b.id === busId);
        const currentStatus = bus.status || { type: 'on-time', minutes: 0 };

        // MODIFICATION: Added 'cancelled' option and updated visibility logic
        const formHtml = `
            <div>
                <label class="block text-left text-sm font-medium text-slate-700">Status</label>
                <select id="status-type" name="type" class="mt-1 w-full px-3 py-2 border rounded">
                    <option value="on-time" ${currentStatus.type === 'on-time' ? 'selected' : ''}>On time</option>
                    <option value="late" ${currentStatus.type === 'late' ? 'selected' : ''}>Late</option>
                    <option value="early" ${currentStatus.type === 'early' ? 'selected' : ''}>Early</option>
                    <option value="cancelled" ${currentStatus.type === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
            </div>
            <div id="status-minutes-container" class="${!['late', 'early'].includes(currentStatus.type) ? 'hidden' : ''}">
                <label class="block text-left text-sm font-medium text-slate-700">Minutes</label>
                <input type="number" name="minutes" class="mt-1 w-full px-3 py-2 border rounded" value="${currentStatus.minutes || 0}">
            </div>
        `;

        try {
            const data = await showModal('Update Bus Status', formHtml, 'Update');
            // MODIFICATION: Updated status object creation logic
            const newStatus = {
                type: data.type,
                minutes: !['late', 'early'].includes(data.type) ? 0 : Number(data.minutes) || 0
            };
            await updateDoc(doc(db, busCollection.path, busId), { status: newStatus });
            showMessage('Bus status updated.');
            logAdminAction('UPDATE_BUS_STATUS', `Updated status for bus ${bus.busIdCode} to ${newStatus.type} (${newStatus.minutes} min)`, busId, 'bus');
        } catch(error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Update status operation cancelled.");
            } else {
                console.error("Error updating status:", error);
                showMessage(`Error: Could not update status. ${error.message}`);
            }
        }
    };

    const calculateAndDisplayFare = () => {
        const fareFromStop = document.getElementById('fare-from-stop');
        const fareToStop = document.getElementById('fare-to-stop');
        const fareResultContainer = document.getElementById('fare-result-container');
        const fromStopName = fareFromStop.value;
        const toStopName = fareToStop.value;

        fareResultContainer.innerHTML = '';

        if (!fromStopName || !toStopName) {
            fareResultContainer.innerHTML = `<p class="text-yellow-600">Please select both a starting and destination stop.</p>`;
            return;
        }

        if (fromStopName === toStopName) {
            fareResultContainer.innerHTML = `<p class="text-yellow-600">Starting and destination stops cannot be the same.</p>`;
            return;
        }

        let totalFare = -1;
        let foundRoute = null;
        const fareKey = `${fromStopName}_${toStopName}`;
        const reverseFareKey = `${toStopName}_${fromStopName}`;

        for (const bus of allBuses) {
            if(bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) {
                foundRoute = bus;
                totalFare = bus.fareMatrix[fareKey];
                break;
            }
            if(bus.fareMatrix && bus.fareMatrix[reverseFareKey] !== undefined) {
                foundRoute = bus;
                totalFare = bus.fareMatrix[reverseFareKey];
                break;
            }
        }

        if (foundRoute) {
            fareResultContainer.innerHTML = `
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-lg font-semibold text-green-800">Fare: ‚Çπ${totalFare}</p>
                    <p class="text-sm text-slate-600 mt-1">On bus route: ${foundRoute.busNumber} (${foundRoute.origin} - ${foundRoute.destination})</p>
                </div>
            `;
        } else {
            fareResultContainer.innerHTML = `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                                <p class="text-lg font-semibold text-red-800">No direct route found.</p>
                                <p class="text-sm text-slate-600 mt-1">No fare has been set for the trip from "${fromStopName}" to "${toStopName}".</p>
                            </div>
                        `;
        }
    };

    const handleSaveFares = async () => {
        if (!currentAdminPermissions.manageFares) { showMessage("Permission denied.", true); return; }
        const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
        const busId = manageFaresBusSelect.value;
        if (!busId) { showMessage("No bus selected.", true); return; }

        const newFareMatrix = {};
        let hasError = false;

        document.querySelectorAll('#fare-matrix-container .fare-input').forEach(input => {
            if (hasError) return;
            const fareKey = input.dataset.key;
            const fareValue = input.value;
            if (fareValue !== '') {
                const parsedFare = parseInt(fareValue, 10);
                if (isNaN(parsedFare) || parsedFare < 0) {
                    showMessage(`Invalid fare for ${fareKey.replace('_', ' to ')}. Please enter a valid number.`, true);
                    hasError = true;
                }
                newFareMatrix[fareKey] = parsedFare;
            }
        });

        if (hasError) return;
        try {
            const busDocRef = doc(db, busCollection.path, busId);
            await updateDoc(busDocRef, { fareMatrix: newFareMatrix });
            showMessage("Fares updated successfully!");
            const bus = allBuses.find(b => b.id === busId);
            logAdminAction('UPDATE_FARES', `Updated fare matrix for bus ${bus.busIdCode}`, busId, 'bus');
        } catch (error) {
            console.error("Error updating fares:", error);
            showMessage("Failed to update fares.", true);
        }
    };

    const handleDownloadCSV = () => {
        if (!currentAdminPermissions.manageFares) { showMessage("Permission denied.", true); return; }
        const manageFaresBusSelect = document.getElementById('manage-fares-bus-select');
        const busId = manageFaresBusSelect.value;
        if (!busId) {
            showMessage("Please select a bus route to download fares.", true);
            return;
        }

        const bus = allBuses.find(b => b.id === busId);
        if (!bus || !bus.stops || bus.stops.length < 2) {
            showMessage("Not enough data to generate a CSV.", true);
            return;
        }

        const stops = bus.stops.map(s => s.name);
        let csvContent = "data:text/csv;charset=utf-8,";

        // Header Row
        csvContent += "From/To," + stops.join(",") + "\r\n";

        // Data Rows
        bus.stops.forEach((fromStop, i) => {
            let row = fromStop.name;
            bus.stops.forEach((toStop, j) => {
                row += ",";
                if (i < j) {
                    const fareKey = `${fromStop.name}_${toStop.name}`;
                    const fare = (bus.fareMatrix && bus.fareMatrix[fareKey] !== undefined) ? bus.fareMatrix[fareKey] : "";
                    row += fare;
                }
            });
            csvContent += row + "\r\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        const fileName = `${bus.busNumber.replace(/\s+/g, '_')}_${bus.busIdCode}_fares.csv`;
        link.setAttribute("download", fileName);
        document.body.appendChild(link); // Required for Firefox

        link.click();
        document.body.removeChild(link);
        showMessage("Fare matrix download started.");
        logAdminAction('DOWNLOAD_FARES_CSV', `Downloaded fare matrix CSV for bus ${bus.busIdCode}`, busId, 'bus');
    };

    const getYoutubeVideoId = (url) => {
        try {
            const urlObj = new URL(url);
            if (urlObj.hostname === 'youtu.be') {
                return urlObj.pathname.slice(1);
            } else if (urlObj.hostname.includes('youtube.com')) {
                return urlObj.searchParams.get('v');
            }
        } catch (e) {
            console.error("Invalid video URL", e);
            return null;
        }
        return null;
    };

    const initializeVideoAds = () => {
        const videoPlaceholders = document.querySelectorAll('[data-video-id]');
        videoPlaceholders.forEach(placeholder => {
            const adId = placeholder.dataset.adId;
            const videoId = placeholder.dataset.videoId;
            if (videoId && !videoPlayers[adId]) {
                const player = new YT.Player(placeholder.id, {
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 1,
                        'mute': 1,
                        'controls': 0,
                        'loop': 1,
                        'playlist': videoId,
                        'playsinline': 1,
                        'modestbranding': 1
                    },
                    events: {
                        'onReady': (event) => {
                            videoPlayers[adId] = event.target;
                        }
                    }
                });
            }
        });
    };

    const renderAdsList = () => {
        const adsListContainer = document.getElementById('ads-list-container');
        adsListContainer.innerHTML = '';
        if (allAds.length === 0) {
            adsListContainer.innerHTML = '<p class="text-slate-500">No advertisements have been added yet.</p>';
            return;
        }
        allAds.forEach(ad => {
            const adElement = document.createElement('div');
            adElement.className = 'p-4 border rounded-lg flex items-center justify-between';

            let adContentHtml = '';
            if (ad.adType === 'video') {
                adContentHtml = `
                    <div>
                        <p class="font-semibold text-sm">‚ñ∂Ô∏è Video Ad</p>
                        <p class="font-semibold">Position: After bus #${ad.position}</p>
                        <a href="${ad.videoUrl}" target="_blank" class="text-xs text-sky-600 hover:underline truncate">${ad.videoUrl}</a>
                    </div>
                `;
            } else {
                adContentHtml = `
                    <div class="flex items-center space-x-4">
                        <img src="${ad.imageUrl}" class="h-16 w-16 object-cover rounded-md" onerror="this.src='https://placehold.co/64x64/e2e8f0/475569?text=Image'"/>
                        <div>
                            <p class="font-semibold text-sm">üñºÔ∏è Image Ad</p>
                            <p class="font-semibold">Position: After bus #${ad.position}</p>
                            <a href="${ad.link}" target="_blank" class="text-xs text-sky-600 hover:underline truncate">${ad.link || 'No link'}</a>
                        </div>
                    </div>
                `;
            }

            adElement.innerHTML = `
                ${adContentHtml}
                <button data-ad-id="${ad.id}" class="remove-ad-btn p-2 rounded-full hover:bg-red-100 text-red-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
            `;
            adsListContainer.appendChild(adElement);
        });
    };

    const renderSchedule = (data) => {
        videoPlayers = {}; // Clear old player references
        scheduleList.innerHTML = '';
        const adsByPosition = allAds.reduce((acc, ad) => {
            acc[ad.position] = ad;
            return acc;
        }, {});

        const showAdminControls = isAdmin;

        if (data.length === 0) {
            if (searchQuery || currentFilter !== 'all') {
                setStatus(`No results found.`);
            } else {
                const message = isAdmin
                    ? "No buses found. Click 'Add New Bus' to create a schedule."
                    : "No buses found for today's schedule.";
                setStatus(message);
            }
            return;
        }

        data.forEach((bus, busIndex) => {

            // MODIFICATION: Handle cancelled buses first
            if (bus.status?.type === 'cancelled') {
                const listItem = document.createElement('div');
                // 'relative' is added to position the admin buttons correctly
                listItem.className = 'bus-item relative p-4 flex items-center border-b border-slate-200 opacity-70 bg-slate-50';

                let cancelledHtml = `
                    <span class="text-4xl mr-4 flex-shrink-0">üö´</span>
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-sm text-slate-800 truncate">${bus.busNumber}: ${bus.origin} &rarr; ${bus.destination}</p>
                        ${isAdmin && bus.busIdCode ? `<p class="text-xs font-bold text-slate-600">ID: ${bus.busIdCode}</p>` : ''}
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-red-700 font-semibold text-sm">Cancelled</p>
                    </div>
                `;

                // If admin is logged in, add the control buttons so they can edit it
                if (isAdmin) {
                    const adminControlsHtml = `
                        <div class="absolute top-2 right-2 flex space-x-1">
                            <button title="Update Status" class="update-status-btn p-1.5 rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition-colors" data-bus-id="${bus.id}">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button title="Edit Bus" class="edit-bus-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-bus-id="${bus.id}">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button title="Delete Bus" class="delete-bus-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" data-bus-id="${bus.id}">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    listItem.innerHTML = adminControlsHtml + cancelledHtml;
                } else {
                    listItem.innerHTML = cancelledHtml;
                }

                scheduleList.appendChild(listItem);
                return; // Stop processing this bus and move to the next one
            }

            let arrivalText, arrivalColor, arrivalSize;

            if (bus.isFinished) {
                arrivalText = 'Completed';
                arrivalColor = 'text-slate-500 font-semibold';
                arrivalSize = 'text-xs';
            } else if (bus.etaAtGoolikkadavu === null) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† arrivalText = 'N/A';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† arrivalColor = 'text-slate-500 font-semibold';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† arrivalSize = 'text-xs'; // Changed
¬† ¬† ¬† ¬† ¬† ¬† } else if (bus.etaAtGoolikkadavu < 0) {
                arrivalText = 'Departed';
                arrivalColor = 'text-slate-500 font-semibold';
                arrivalSize = 'text-xs';
            }
            else {
                arrivalText = formatEta(bus.etaAtGoolikkadavu);
                arrivalColor = bus.etaAtGoolikkadavu <= 10 ? 'text-red-600 font-bold' : 'text-slate-900 font-semibold';
                arrivalSize = 'text-sm';
            }

            const isDropdownOpen = openDropdownId === bus.id;

            let stopsHtml = '';
            bus.stops.forEach((stop, index) => {
                const passedClass = stop.isPassed ? 'passed' : '';

                const fareText = index > 0 ? `<p class="text-xs text-green-600 font-semibold">‚Çπ${stop.displayFare || 0}</p>` : '';
                const waitTimeText = stop.waitingTime > 0 ? `<p class="text-xs text-sky-600 mt-1">‚òï Take Coffee Cup üïí ${stop.waitingTime} min wait</p>` : '';

                const editButtons = showAdminControls ? `
                    <div class="flex items-center space-x-2">
                        ${fareText}
                        <button class="edit-stop-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded" data-bus-id="${bus.id}" data-stop-index="${index}">Edit</button>
                        <button class="delete-stop-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded" data-bus-id="${bus.id}" data-stop-index="${index}">Del</button>
                    </div>
                ` : `
                    <div class="text-right">
                        <p class="text-sm font-medium text-slate-600">${formatTime(new Date(stop.actualArrivalTime))}</p>
                        ${fareText}
                    </div>
                `;

                stopsHtml += `
                    <div class="timeline-item ${passedClass}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="stop-name">${stop.name}</p>
                                <p class="text-xs text-slate-500">${stop.stopArrivalText}</p>
                                ${waitTimeText}
                            </div>
                            ${editButtons}
                        </div>
                    </div>`;
            });

            let addStopButtonHtml = '';
            if (showAdminControls) {
                addStopButtonHtml = `<div class="p-2 border-t mt-2 flex justify-around"><button class="add-stop-btn text-sm font-medium text-sky-600 hover:text-sky-800" data-bus-id="${bus.id}">+ Add Stop</button><button class="update-status-btn text-sm font-medium text-sky-600 hover:text-sky-800" data-bus-id="${bus.id}">Update Status</button></div>`;
            }

            const editBusButtons = showAdminControls ? `
                <div class="absolute top-2 right-2 flex space-x-1">
                    <button title="Duplicate Trip" class="duplicate-bus-btn p-1.5 rounded-full bg-green-100 text-green-700 hover:bg-green-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2-2H9a2 2 0 01-2-2V9z" /><path d="M3 3a2 2 0 00-2 2v6a2 2 0 002 2h1V9a4 4 0 014-4h5V5a2 2 0 00-2-2H3z" /></svg></button>
                    <button title="Edit Bus" class="edit-bus-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                    <button title="Delete Bus" class="delete-bus-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" data-bus-id="${bus.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                </div>
            `: '';

            let subtext = '';
            if (bus.status && bus.status.type !== 'on-time') {
                subtext = `<span class="${bus.status.type === 'late' ? 'text-red-600' : 'text-blue-600'}">${bus.status.minutes} min ${bus.status.type}</span>`;
            } else {
                subtext = `<span class="text-green-600">On time</span>`;
            }

            if (bus.seatCapacity) {
                subtext += ` <span class="text-slate-400 mx-1">|</span> <span>üí∫ ${bus.seatCapacity}</span>`;
            }

            if (isAdmin && bus.busIdCode) {
                subtext += ` <span class="text-slate-400 mx-1">|</span> <span class="font-bold text-slate-700">ID: ${bus.busIdCode}</span>`;
            }

            const listItem = document.createElement('div');
            listItem.className = `bus-item relative border-b border-slate-200`;
            listItem.dataset.busId = bus.id;
            listItem.innerHTML = `
                ${editBusButtons}
                <div class="bus-header p-4 flex items-center cursor-pointer hover:bg-slate-50 transition-colors" data-bus-id="${bus.id}">
                    <span class="text-4xl mr-4 flex-shrink-0">üöç</span>
                    <div class="flex-grow min-w-0">
                        <div class="flex items-baseline mb-1 space-x-2">
                            <p class="font-bold text-xs text-slate-800 flex-shrink-0">${bus.busNumber}:</p>
                            <div class="relative flex-grow overflow-hidden">
                                <div class="bus-route-text text-xs font-medium text-slate-600" data-original-route="${bus.origin} &rarr; ${bus.destination}">
                                    <span class="marquee-content">${bus.origin} &rarr; ${bus.destination}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 text-xs font-medium mt-1">${subtext}</div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="${arrivalColor} ${arrivalSize}" data-eta-text-id="${bus.id}">${arrivalText}</p>
                    </div>
                </div>
                <div id="details-${bus.id}" class="bus-details bg-slate-50 px-4 ${isDropdownOpen ? 'open' : ''}">
                    <div class="timeline-wrapper">
                        ${stopsHtml}
                        ${bus.stops.length > 0 && !bus.isFinished ? `<span class="live-dot-icon" data-live-dot-id="${bus.id}"></span>` : ''}
                    </div>
                    ${addStopButtonHtml}
                </div>`;
            scheduleList.appendChild(listItem);

            const ad = adsByPosition[busIndex + 1];
            if (ad) {
                const adItem = document.createElement('div');
                adItem.className = 'p-4 border-b border-slate-200';
                let adHtml = '';

                if (ad.adType === 'video' && ad.videoUrl) {
                    const videoId = getYoutubeVideoId(ad.videoUrl);
                    if (videoId) {
                        adHtml = `
                            <div class="video-ad-container">
                                <div class="video-container">
                                    <div id="youtube-player-${ad.id}" data-video-id="${videoId}" data-ad-id="${ad.id}"></div>
                                </div>
                                <button class="mute-btn" data-ad-id="${ad.id}" title="Toggle Sound">
                                    <svg class="h-5 w-5" id="mute-icon-on-${ad.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l-2.25-2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                                    <svg class="h-5 w-5 hidden" id="mute-icon-off-${ad.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
                                </button>
                            </div>
                        `;
                    }
                } else if (ad.adType === 'image' && ad.imageUrl) {
                    adHtml = `<a href="${ad.link || '#'}" target="_blank" rel="noopener noreferrer"><img src="${ad.imageUrl}" alt="Advertisement" class="w-full h-auto rounded-lg" onerror="this.parentElement.style.display='none'"></a>`;
                }

                adItem.innerHTML = adHtml;
                scheduleList.appendChild(adItem);
            }

            // Automatic scrolling for bus route text
            const busRouteTextWrapper = listItem.querySelector('.bus-route-text').parentElement; // This is the new overflow-hidden div
            const busRouteTextElement = listItem.querySelector('.bus-route-text'); // This is the flex container
            const marqueeContentSpan = busRouteTextElement.querySelector('.marquee-content'); // Get one of the content spans

            if (marqueeContentSpan && busRouteTextWrapper) {
                // Use setTimeout to ensure layout calculation is complete
                setTimeout(() => {
                    const singleTextWidth = marqueeContentSpan.scrollWidth; // Width of one copy of the text
                    const containerWidth = busRouteTextWrapper.clientWidth;

                    // Use bus-specific marquee settings, or fall back to defaults
                    const currentMarqueeSpeed = bus.marqueeSpeedPxPerSec !== undefined ? bus.marqueeSpeedPxPerSec : DEFAULT_MARQUEE_SPEED_PX_PER_SEC;
                    const currentMarqueeDelay = bus.marqueeRepeatDelaySec !== undefined ? bus.marqueeRepeatDelaySec : DEFAULT_MARQUEE_REPEAT_DELAY_SEC;

                    // Only apply marquee if text is wider than container
                    if (singleTextWidth > containerWidth) {
                        // Add a second span for continuous loop if it doesn't exist
                        let secondMarqueeContent = busRouteTextElement.children[1];
                        if (!secondMarqueeContent) {
                            secondMarqueeContent = document.createElement('span');
                            secondMarqueeContent.className = 'marquee-content';
                            secondMarqueeContent.setAttribute('aria-hidden', 'true'); // Hide from screen readers
                            secondMarqueeContent.innerHTML = busRouteTextElement.dataset.originalRoute;
                            busRouteTextElement.appendChild(secondMarqueeContent);
                        }

                        const gapPx = currentMarqueeDelay * currentMarqueeSpeed; // Distance traveled during the delay period

                        // The animation needs to move the combined content by the width of one text plus the gap
                        const totalScrollDistance = singleTextWidth + gapPx;
                        const animationDuration = totalScrollDistance / currentMarqueeSpeed;

                        busRouteTextElement.style.setProperty('--marquee-gap-px', `${gapPx}px`);
                        busRouteTextElement.style.setProperty('--marquee-distance', `-${totalScrollDistance}px`);
                        busRouteTextElement.style.animationName = 'marquee-route';
                        busRouteTextElement.style.animationDuration = `${animationDuration}s`;
                    } else {
                        // No need to scroll, remove animation
                        busRouteTextElement.style.animationName = '';
                    }
                }, 0); // Use 0ms timeout to defer execution until after render
            }
        });

        // Initialize any new video players
        if (typeof YT !== 'undefined' && YT.Player) {
            initializeVideoAds();
        }
    };

    const updateAndRenderSchedule = () => {
        if (!isAuthReady) return;
        const liveBusData = calculateLiveBusData();
        let filteredBusData = filterAndSortBuses(liveBusData);
        renderSchedule(filteredBusData);
    };

    const updateLiveElements = () => {
        if (!isAuthReady) return;
        const liveBusData = calculateLiveBusData();
        let filteredBusData = filterAndSortBuses(liveBusData);

        filteredBusData.forEach(bus => {
            const busElement = document.querySelector(`.bus-item[data-bus-id="${bus.id}"]`);
            if (!busElement) return; // Element not on screen, skip it

            // Update ETA Text
            const etaElement = busElement.querySelector(`[data-eta-text-id="${bus.id}"]`);
            if (etaElement) {
                let arrivalText, arrivalColor, arrivalSize;
                if (bus.isFinished) {
                    arrivalText = 'Completed';
                    arrivalColor = 'text-slate-500 font-semibold';
                    arrivalSize = 'text-xs';
                } else if (bus.etaAtGoolikkadavu === null) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† arrivalText = 'N/A';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† arrivalColor = 'text-slate-500 font-semibold';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† arrivalSize = 'text-xs'; // Changed
¬† ¬† ¬† ¬† ¬† ¬†     } else if (bus.etaAtGoolikkadavu < 0) {
                    arrivalText = 'Departed';
                    arrivalColor = 'text-slate-500 font-semibold';
                    arrivalSize = 'text-xs';
                } else {
                    arrivalText = formatEta(bus.etaAtGoolikkadavu);
                    arrivalColor = bus.etaAtGoolikkadavu <= 10 ? 'text-red-600 font-bold' : 'text-slate-900 font-semibold';
                    arrivalSize = 'text-sm';
                }
                etaElement.textContent = arrivalText;
                etaElement.className = `${arrivalColor} ${arrivalSize}`;
            }

            // Update Live Dot Position
            const liveDot = busElement.querySelector(`[data-live-dot-id="${bus.id}"]`);
            if (liveDot) {
                const timelineItems = busElement.querySelectorAll('.timeline-item');
                const index = bus.liveIconPositionIndex;
                const floorIndex = Math.min(Math.floor(index), timelineItems.length - 1);
                const fraction = index - floorIndex;

                if (timelineItems.length > floorIndex && floorIndex >= 0) {
                    const centerAlignmentOffset = 14;
                    const floorItem = timelineItems[floorIndex];
                    const floorTop = floorItem.offsetTop + centerAlignmentOffset;
                    let topPosition = floorTop;
                    if (fraction > 0 && floorIndex < timelineItems.length - 1) {
                        const ceilItem = timelineItems[floorIndex + 1];
                        const ceilTop = ceilItem.offsetTop + centerAlignmentOffset;
                        topPosition = floorTop + (ceilTop - floorTop) * fraction;
                    }
                    liveDot.style.top = `${topPosition}px`;
                }
            }
        });
    };

    const calculateLiveBusData = () => {
        const currentTime = new Date();
        return allBuses.map(bus => {
            const status = bus.status || { type: 'on-time', minutes: 0 };

            // MODIFICATION: Handle cancelled buses
            if (status.type === 'cancelled') {
                return {
                    ...bus,
                    isFinished: true, // Treat it as finished for sorting/filtering
                    etaAtGoolikkadavu: null,
                    liveIconPositionIndex: 0,
                    stops: [] // No need to process stops
                };
            }

            let statusOffset = 0;
            if (status.type === 'late') {
                statusOffset = status.minutes * 60000;
            } else if (status.type === 'early') {
                statusOffset = -status.minutes * 60000;
            }

            if (!bus.stops || bus.stops.length === 0) {
                return { ...bus, stops: [], etaAtGoolikkadavu: null, liveIconPositionIndex: 0, isFinished: true };
            }

            const processedStops = bus.stops.map(stop => {
                const actualArrivalTime = new Date(parseTime(stop.scheduledTime).getTime() + statusOffset);
                const departureTime = new Date(actualArrivalTime.getTime() + (stop.waitingTime || 0) * 60000);
                const isPassed = departureTime.getTime() < currentTime.getTime();
                let stopArrivalText = `Scheduled ${formatTime(actualArrivalTime)}`;
                if (isPassed) {
                    stopArrivalText = 'Departed';
                } else if (actualArrivalTime.getTime() < currentTime.getTime()) {
                    stopArrivalText = 'Arrived';
                }
                return { ...stop, isPassed, stopArrivalText, actualArrivalTime, departureTime };
            });

            // Use the configured reference stop instead of hardcoded Goolikkadavu Jn
            const referenceStop = processedStops.find(stop => stop.name === referenceStopName);
            let etaAtGoolikkadavu = null;
            if (referenceStop) {
                etaAtGoolikkadavu = Math.round((referenceStop.actualArrivalTime.getTime() - currentTime.getTime()) / 60000);
            }

            const isFinished = processedStops.every(stop => stop.isPassed);

            let liveIconPositionIndex = 0;
            const nextStopIndex = processedStops.findIndex(stop => !stop.isPassed);

            if (isFinished) {
                liveIconPositionIndex = processedStops.length;
            } else if (nextStopIndex > 0) {
                const lastStop = processedStops[nextStopIndex - 1];
                const currentNextStop = processedStops[nextStopIndex];
                const lastStopDepartureTime = lastStop.departureTime.getTime();
                const nextStopArrivalTime = currentNextStop.actualArrivalTime.getTime();

                if (currentTime.getTime() >= lastStop.actualArrivalTime.getTime() && currentTime.getTime() < lastStopDepartureTime) {
                    liveIconPositionIndex = nextStopIndex - 1;
                } else {
                    const segmentDuration = nextStopArrivalTime - lastStopDepartureTime;
                    if (segmentDuration > 0) {
                        const progressInSegment = (currentTime.getTime() - lastStopDepartureTime) / segmentDuration;
                        liveIconPositionIndex = (nextStopIndex - 1) + Math.min(1, Math.max(0, progressInSegment));
                    } else {
                        liveIconPositionIndex = nextStopIndex - 1;
                    }
                }
            } else if (nextStopIndex === 0) {
                const firstStop = processedStops[0];
                const departureTime = parseTime(bus.stops[0].scheduledTime).getTime() + statusOffset;
                const arrivalTime = firstStop.actualArrivalTime.getTime();
                const segmentDuration = arrivalTime - departureTime;
                if(segmentDuration > 0) {
                    const progressInSegment = (currentTime.getTime() - departureTime) / segmentDuration;
                    liveIconPositionIndex = progressInSegment;
                    liveIconPositionIndex = Math.min(1, Math.max(0, liveIconPositionIndex));
                } else {
                    liveIconPositionIndex = 0;
                }
            }

            return { ...bus, stops: processedStops, etaAtGoolikkadavu, liveIconPositionIndex, isFinished };
        });
    };

    const filterAndSortBuses = (liveBusData) => {
        let filteredBusData = liveBusData;

        // Apply text search (bus name + origin for everyone, ID only for admins)
        if (searchQuery) {
            filteredBusData = filteredBusData.filter(bus => {
                const busName = bus.busNumber.toLowerCase();
                const origin = bus.origin.toLowerCase();
                const matchesBasic = busName.includes(searchQuery) || origin.includes(searchQuery);

                // Only allow searching by bus ID code for admins
                if (isAdmin) {
                    const busIdCode = (bus.busIdCode || '').toLowerCase();
                    return matchesBasic || busIdCode.includes(searchQuery);
                }

                return matchesBasic;
            });
        }

        // Apply current filter (live / by stop / all)
        if (currentFilter === 'live') {
            filteredBusData = filteredBusData.filter(bus => !bus.isFinished);
        } else if (currentFilter !== 'all') {
            filteredBusData = filteredBusData.filter(bus =>
                bus.stops.some(stop => stop.name === currentFilter)
            );
        }

        // Helper: sort by ETA at reference stop, then by first-stop time
        const sortByEtaThenTime = (list) => {
            list.sort((a, b) => {
                const sortA = a.isFinished ? Infinity : a.etaAtGoolikkadavu;
                const sortB = b.isFinished ? Infinity : b.etaAtGoolikkadavu;
                const finalSortA = sortA === null ? Infinity - 1 : sortA;
                const finalSortB = sortB === null ? Infinity - 1 : sortB;

                if (finalSortA < finalSortB) return -1;
                if (finalSortA > finalSortB) return 1;

                const timeA = a.stops.length > 0 ? parseTime(a.stops[0].scheduledTime) : 0;
                const timeB = b.stops.length > 0 ? parseTime(b.stops[0].scheduledTime) : 0;
                return timeA - timeB;
            });
        };

        // --- Group into: recent departed (top), live, completed/older ---
        const departedRecent = [];
        const liveList = [];
        const completedList = [];

        filteredBusData.forEach(bus => {
            const eta = bus.etaAtGoolikkadavu;

            if (bus.isFinished) {
                // Fully completed route -> bottom section
                completedList.push(bus);
            } else if (eta != null && eta < 0) {
                // Has passed the reference stop but route not fully finished yet
                // Keep only last 15 minutes of departures in a small "Departed" block
                if (eta >= -15) {
                    departedRecent.push(bus);
                } else {
                    // Older than 15 minutes -> treat like completed, send to bottom
                    completedList.push(bus);
                }
            } else {
                // Not yet at reference stop -> live buses block in the middle
                liveList.push(bus);
            }
        });

        // Sort each group
        // Departed: most recently departed first (eta closest to 0, e.g. -1, -5, -10 ...)
        departedRecent.sort((a, b) => {
            const aEta = a.etaAtGoolikkadavu ?? -Infinity;
            const bEta = b.etaAtGoolikkadavu ?? -Infinity;
            return bEta - aEta; // -1 comes before -10
        });

        // Limit departed section to max 2 buses
        const topDeparted = departedRecent.slice(0, 2);

        // Live + completed use the normal ETA/time sort
        sortByEtaThenTime(liveList);
        sortByEtaThenTime(completedList);

        // Final order on main page:
        // 1. Departed (max 2, last 15 minutes)
        // 2. Live buses
        // 3. Completed / older buses
        return [...topDeparted, ...liveList, ...completedList];
    };

    const renderAdminsList = () => {
        adminListContainer.innerHTML = '';
        if (!isSuperAdmin) {
            adminListContainer.innerHTML = '<p class="text-red-500">You do not have permission to manage admins.</p>';
            addAdminBtn.classList.add('hidden');
            return;
        }
        addAdminBtn.classList.remove('hidden');

        if (allAdmins.length === 0) {
            adminListContainer.innerHTML = '<p class="text-slate-500">No admin accounts found.</p>';
            return;
        }

        allAdmins.forEach(admin => {
            const permissionsSummary = Object.keys(admin.permissions || {})
                .filter(key => admin.permissions[key])
                .map(key => key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim())
                .join(', ');

            const profileImageHtml = admin.profileImageUrl ?
                `<img src="${admin.profileImageUrl}" alt="Profile" class="w-16 h-16 rounded-full object-cover mr-4" onerror="this.src='https://placehold.co/64x64/e2e8f0/475569?text=Admin'"/>` :
                `<div class="w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xl font-bold mr-4">üë§</div>`;

            const adminElement = document.createElement('div');
            adminElement.className = 'p-4 border rounded-lg flex items-center justify-between';
            adminElement.innerHTML = `
                <div class="flex items-center">
                    ${profileImageHtml}
                    <div>
                        <p class="font-semibold text-slate-800">${admin.name} (${admin.username})</p>
                        <p class="text-sm text-slate-600">Father: ${admin.fatherName || 'N/A'}</p>
                        <p class="text-sm text-slate-600">Contact: ${admin.contactNumber || 'N/A'}</p>
                        <p class="text-sm text-slate-600">Email: ${admin.email || 'N/A'}</p>
                        <p class="text-sm text-slate-600">Blood Group: ${admin.bloodGroup || 'N/A'}</p>
                        <p class="text-sm text-slate-600">Permissions: ${permissionsSummary || 'None'}</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button data-admin-id="${admin.id}" class="edit-admin-btn p-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors" title="Edit Admin">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    ${admin.username !== SUPER_ADMIN_USERNAME ? `
                    <button data-admin-id="${admin.id}" class="delete-admin-btn p-1.5 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition-colors" title="Delete Admin">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>` : ''}
                </div>
            `;
            adminListContainer.appendChild(adminElement);
        });
    };

    const handleAddAdmin = async () => {
        if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
        const permissionOptions = Object.keys(DEFAULT_PERMISSIONS).map(key => {
            const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
            return `<div class="flex items-center"><input type="checkbox" name="permission_${key}" id="permission_${key}" class="h-4 w-4 text-sky-600 border-gray-300 rounded"><label for="permission_${key}" class="ml-2 text-sm text-slate-700">${label}</label></div>`;
        }).join('');

        const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}">${group}</option>`).join('');

        const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="username" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" required></div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                    <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                        <option value="">-- Select Blood Group --</option>
                        ${bloodGroupOptions}
                    </select>
                </div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL (for now)</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg"></div>
            </div>
            <div class="mt-4"><p class="block text-left text-sm font-medium text-slate-700">Permissions:</p><div class="grid grid-cols-2 gap-2 mt-2">${permissionOptions}</div></div>
        `;
        try {
            const data = await showModal('Add New Admin', formHtml, 'Add Admin');
            const newPermissions = {};
            Object.keys(DEFAULT_PERMISSIONS).forEach(key => {
                newPermissions[key] = data[`permission_${key}`] === 'on';
            });

            // Ensure manageAdmins permission is only granted to Super Admin
            if (!isSuperAdmin) {
                newPermissions.manageAdmins = false;
            }

            const newAdmin = {
                username: data.username,
                password: data.password, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                name: data.name,
                fatherName: data.fatherName || '',
                contactNumber: data.contactNumber || '',
                email: data.email || '',
                bloodGroup: data.bloodGroup || '',
                profileImageUrl: data.profileImageUrl || '',
                permissions: newPermissions
            };
            const docRef = await addDoc(adminsCollection, newAdmin);
            showMessage("New admin added successfully.");
            logAdminAction('ADD_ADMIN', `Added new admin: ${newAdmin.name} (${newAdmin.username})`, docRef.id, 'admin');
        } catch (error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Add admin operation cancelled.");
            } else {
                console.error("Error adding admin:", error);
                showMessage(`Error: Could not add admin. ${error.message}`);
            }
        }
    };

    const handleEditAdmin = async (adminId) => {
        if (!isAdmin) { showMessage("Permission denied.", true); return; }
        const adminToEdit = allAdmins.find(a => a.id === adminId);
        if (!adminToEdit) { showMessage("Admin not found.", true); return; }

        const permissionOptions = Object.keys(DEFAULT_PERMISSIONS).map(key => {
            const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
            const isChecked = adminToEdit.permissions && adminToEdit.permissions[key] ? 'checked' : '';
            const isDisabled = (adminToEdit.username === SUPER_ADMIN_USERNAME && key === 'manageAdmins') ? 'disabled' : ''; // Super Admin always has manageAdmins
            return `<div class="flex items-center"><input type="checkbox" name="permission_${key}" id="permission_${key}" class="h-4 w-4 text-sky-600 border-gray-300 rounded" ${isChecked} ${isDisabled}><label for="permission_${key}" class="ml-2 text-sm text-slate-700">${label}</label></div>`;
        }).join('');

        const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}" ${adminToEdit.bloodGroup === group ? 'selected' : ''}>${group}</option>`).join('');

        const formHtml = `
            <input type="hidden" name="id" value="${adminToEdit.id}">
            <div><label class="block text-left text-sm font-medium text-slate-700">Username</label><input class="mt-1 w-full px-3 py-2 border rounded bg-slate-100" type="text" name="username" value="${adminToEdit.username}" readonly></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="password" value="${adminToEdit.password}" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" value="${adminToEdit.name}" required></div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName" value="${adminToEdit.fatherName || ''}"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber" value="${adminToEdit.contactNumber || ''}"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email" value="${adminToEdit.email || ''}"></div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                    <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                        <option value="">-- Select Blood Group --</option>
                        ${bloodGroupOptions}
                    </select>
                </div>
                <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL (for now)</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg" value="${adminToEdit.profileImageUrl || ''}"></div>
            </div>
            <div class="mt-4"><p class="block text-left text-sm font-medium text-slate-700">Permissions:</p><div class="grid grid-cols-2 gap-2 mt-2">${permissionOptions}</div></div>
        `;
        try {
            const data = await showModal('Edit Admin', formHtml, 'Save Changes');
            const updatedPermissions = {};
            Object.keys(DEFAULT_PERMISSIONS).forEach(key => {
                updatedPermissions[key] = data[`permission_${key}`] === 'on';
            });

            // Ensure Super Admin always has manageAdmins permission, even if unchecked in form
            if (adminToEdit.username === SUPER_ADMIN_USERNAME) {
                updatedPermissions.manageAdmins = true;
            }

            await updateDoc(doc(db, adminsCollection.path, adminId), {
                password: data.password, // WARNING: Plaintext password. NOT FOR PRODUCTION.
                name: data.name,
                fatherName: data.fatherName || '',
                contactNumber: data.contactNumber || '',
                email: data.email || '',
                bloodGroup: data.bloodGroup || '',
                profileImageUrl: data.profileImageUrl || '',
                permissions: updatedPermissions
            });
            showMessage("Admin updated successfully.");
            logAdminAction('EDIT_ADMIN', `Edited admin: ${adminToEdit.name} (${adminToEdit.username})`, adminId, 'admin');
        } catch (error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Edit admin operation cancelled.");
            } else {
                console.error("Error updating admin:", error);
                showMessage(`Error: Could not update admin. ${error.message}`);
            }
        }
    };

    const handleDeleteAdmin = async (adminId) => {
        if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
        const adminToDelete = allAdmins.find(a => a.id === adminId);
        if (!adminToDelete) { showMessage("Admin not found.", true); return; }

        if (adminToDelete.username === SUPER_ADMIN_USERNAME) {
            showMessage("The Super Admin account cannot be deleted.", true);
            return;
        }

        if (await showConfirmation(`Are you sure you want to delete admin "${adminToDelete.name}"? This action cannot be undone.`)) {
            try {
                await deleteDoc(doc(db, adminsCollection.path, adminId));
                showMessage("Admin deleted successfully.");
                logAdminAction('DELETE_ADMIN', `Deleted admin: ${adminToDelete.name} (${adminToDelete.username})`, adminId, 'admin');
            }
            catch (error) {
                console.error("Error deleting admin:", error);
                showMessage(`Error: Could not delete admin. ${error.message}`);
            }
        }
    };

    const renderMyProfile = () => {
        myProfileContent.innerHTML = ''; // Clear previous content
        if (!currentAdmin) {
            myProfileContent.innerHTML = '<p class="text-slate-500">Please log in to view your profile.</p>';
            return;
        }

        const profileImageHtml = currentAdmin.profileImageUrl ?
            `<img src="${currentAdmin.profileImageUrl}" alt="Profile" class="w-24 h-24 rounded-full object-cover mx-auto mb-4" onerror="this.src='https://placehold.co/96x96/e2e8f0/475569?text=Admin'"/>` :
            `<div class="w-24 h-24 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-4xl font-bold mx-auto mb-4">üë§</div>`;

        const permissionsListHtml = Object.keys(currentAdmin.permissions || {})
            .filter(key => currentAdmin.permissions[key])
            .map(key => {
                const label = key.replace('manage', '').replace(/([A-Z])/g, ' $1').trim();
                return `<li class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>${label}</li>`;
            })
            .join('');

        // Conditionally render clickable links, ensuring values are not empty strings
        const contactNumberHtml = (currentAdmin.contactNumber && String(currentAdmin.contactNumber).trim() !== '') ? `<a href="tel:${currentAdmin.contactNumber}" class="text-sky-600 hover:underline">${currentAdmin.contactNumber}</a>` : 'N/A';
        const emailHtml = (currentAdmin.email && String(currentAdmin.email).trim() !== '') ? `<a href="mailto:${currentAdmin.email}" class="text-sky-600 hover:underline">${currentAdmin.email}</a>` : 'N/A';

        let profileHtml = `
            <div class="text-center">
                ${profileImageHtml}
                <h3 class="text-xl font-bold text-slate-900">${currentAdmin.name}</h3>
                <p class="text-sm text-slate-600">@${currentAdmin.username}</p>
            </div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Personal Information</h4>
                <p class="text-sm text-slate-700"><strong>Father's Name:</strong> ${currentAdmin.fatherName || 'N/A'}</p>
                <p class="text-sm text-slate-700"><strong>Contact Number:</strong> ${contactNumberHtml}</p>
                <p class="text-sm text-slate-700"><strong>Email:</strong> ${emailHtml}</p>
                <p class="text-sm text-slate-700"><strong>Blood Group:</strong> ${currentAdmin.bloodGroup || 'N/A'}</p>
            </div>
            <div class="border-t pt-4 mt-4">
                <h4 class="text-md font-medium text-slate-800 mb-2">Permissions</h4>
                <ul class="list-none p-0 m-0 text-sm text-slate-700">
                    ${permissionsListHtml || '<li class="text-slate-500">No specific permissions assigned.</li>'}
                </ul>
            </div>
            <div class="mt-6 space-y-3">
                <button id="edit-my-profile-btn" class="w-full btn btn-primary">Edit Profile</button>
                <button id="change-my-password-btn" class="w-full btn btn-secondary">Change Password</button>
            </div>
        `;
        myProfileContent.innerHTML = profileHtml;
    };

    const handleEditMyProfile = async () => {
        if (!currentAdmin) { showMessage("Not logged in as admin.", true); return; }

        const bloodGroupOptions = BLOOD_GROUPS.map(group => `<option value="${group}" ${currentAdmin.bloodGroup === group ? 'selected' : ''}>${group}</option>`).join('');

        const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="name" value="${currentAdmin.name || ''}" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Father's Name</label><input class="mt-1 w-full px-3 py-2 border rounded" type="text" name="fatherName" value="${currentAdmin.fatherName || ''}"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Contact Number</label><input class="mt-1 w-full px-3 py-2 border rounded" type="tel" name="contactNumber" value="${currentAdmin.contactNumber || ''}"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Email</label><input class="mt-1 w-full px-3 py-2 border rounded" type="email" name="email" value="${currentAdmin.email || ''}"></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Blood Group</label>
                <select name="bloodGroup" class="mt-1 w-full px-3 py-2 border rounded">
                    <option value="">-- Select Blood Group --</option>
                    ${bloodGroupOptions}
                </select>
            </div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Profile Image URL</label><input class="mt-1 w-full px-3 py-2 border rounded" type="url" name="profileImageUrl" placeholder="https://example.com/profile.jpg" value="${currentAdmin.profileImageUrl || ''}"></div>
        `;

        try {
            const data = await showModal('Edit My Profile', formHtml, 'Save Changes');
            await updateDoc(doc(db, adminsCollection.path, currentAdmin.id), {
                name: data.name,
                fatherName: data.fatherName || '',
                contactNumber: data.contactNumber || '',
                email: data.email || '',
                bloodGroup: data.bloodGroup || '',
                profileImageUrl: data.profileImageUrl || ''
            });
            showMessage("Profile updated successfully.");
            logAdminAction('EDIT_MY_PROFILE', `Updated own profile details`, currentAdmin.id, 'admin');
        } catch (error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Edit profile cancelled.");
            } else {
                console.error("Error updating profile:", error);
                showMessage(`Error updating profile: ${error.message}`, true);
            }
        }
    };

    const handleChangeMyPassword = async () => {
        if (!currentAdmin) { showMessage("Not logged in as admin.", true); return; }

        const formHtml = `
            <div><label class="block text-left text-sm font-medium text-slate-700">Old Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="oldPassword" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">New Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="newPassword" required></div>
            <div><label class="block text-left text-sm font-medium text-slate-700">Confirm New Password</label><input class="mt-1 w-full px-3 py-2 border rounded" type="password" name="confirmNewPassword" required></div>
        `;

        try {
            const data = await showModal('Change Password', formHtml, 'Change Password');

            if (data.oldPassword !== currentAdmin.password) { // WARNING: Plaintext comparison
                showMessage("Old password is incorrect.", true);
                return;
            }
            if (data.newPassword !== data.confirmNewPassword) {
                showMessage("New passwords do not match.", true);
                return;
            }
            if (data.newPassword.length < 6) {
                showMessage("New password must be at least 6 characters long.", true);
                return;
            }

            await updateDoc(doc(db, adminsCollection.path, currentAdmin.id), {
                password: data.newPassword // WARNING: Plaintext update
            });
            showMessage("Password changed successfully.");
            logAdminAction('CHANGE_MY_PASSWORD', `Changed own password`, currentAdmin.id, 'admin');
        } catch (error) {
            if (error.message.includes("Modal cancelled")) {
                console.log("Change password cancelled.");
            } else {
                console.error("Error changing password:", error);
                showMessage(`Error changing password: ${error.message}`, true);
            }
        }
    };

    const renderAuditLogs = () => {
        const auditLogsList = document.getElementById('audit-logs-list');
        const clearLogsBtn = document.getElementById('clear-audit-logs-btn');
        auditLogsList.innerHTML = '';

        if(clearLogsBtn) clearLogsBtn.classList.add('hidden');

        if (!currentAdminPermissions.viewAuditLogs) {
            auditLogsList.innerHTML = '<p class="text-red-500">You do not have permission to view audit logs.</p>';
            return;
        }

        if (isSuperAdmin && clearLogsBtn) {
            clearLogsBtn.classList.remove('hidden');
        }

        if (allAuditLogs.length === 0) {
            auditLogsList.innerHTML = '<p class="text-slate-500">No audit logs available.</p>';
            return;
        }

        const logsHtml = allAuditLogs.map(log => {
            const timestamp = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString() : 'N/A';
            return `
                <div class="p-3 border rounded-lg bg-slate-50">
                    <p class="text-xs text-slate-500">${timestamp}</p>
                    <p class="text-sm text-slate-800"><strong>${log.adminName || 'Unknown Admin'}</strong>: ${log.details}</p>
                    ${log.entityType ? `<p class="text-xs text-slate-600">Entity: ${log.entityType} (ID: ${log.entityId})</p>` : ''}
                </div>
            `;
        }).join('');
        auditLogsList.innerHTML = logsHtml;
    };


    const renderReportsPage = () => {
        const listContainer = document.getElementById('reports-bus-list-container');
        if (!listContainer) return;

        if (!currentAdminPermissions.manageReports) {
            listContainer.innerHTML = '<p class="text-red-500">You do not have permission to manage reports.</p>';
            document.getElementById('download-selected-btn').classList.add('hidden');
            document.getElementById('download-all-btn').classList.add('hidden');
            return;
        }
        
        document.getElementById('download-selected-btn').classList.remove('hidden');
        document.getElementById('download-all-btn').classList.remove('hidden');

        // Group by bus name + code so that KMS with code KM and KMS with code KMS are separate
        const busesByNameAndCode = allBuses.reduce((acc, bus) => {
            const name = bus.busNumber;
            const code = bus.busCode || '';
            if (!name) return acc;
            const key = `${name}__${code}`; // internal key
            if (!acc[key]) {
                acc[key] = { trips: [], busName: name, busCode: code };
            }
            acc[key].trips.push(bus);
            return acc;
        }, {});

        const groupKeys = Object.keys(busesByNameAndCode).sort((a, b) => {
            const A = busesByNameAndCode[a];
            const B = busesByNameAndCode[b];
            const nameCmp = A.busName.localeCompare(B.busName);
            if (nameCmp !== 0) return nameCmp;
            return A.busCode.localeCompare(B.busCode);
        });

        const filteredKeys = groupKeys.filter(key => {
            const group = busesByNameAndCode[key];
            const label = `${group.busName} ${group.busCode}`.toLowerCase();
            return label.includes(reportsSearchQuery);
        });
        
        if (filteredKeys.length === 0) {
            listContainer.innerHTML = '<p class="text-slate-500">No buses found matching your search.</p>';
            return;
        }

        const listHtml = filteredKeys.map(key => {
            const group = busesByNameAndCode[key];
            const tripCount = group.trips.length;
            const busName = group.busName;
            const busCode = group.busCode || '';

            return `
                <div class="flex items-center p-2 rounded-md hover:bg-slate-50">
                    <input id="bus-report-${key}" type="checkbox" value="${key}" class="bus-report-checkbox h-5 w-5 text-sky-600 border-slate-300 rounded focus:ring-sky-500">
                    <label for="bus-report-${key}" class="ml-3 flex-grow cursor-pointer">
                        <span class="font-medium text-slate-800">${busName} ${busCode}</span>
                        <span class="text-sm text-slate-500 ml-2">(${tripCount}-Trips)</span>
                    </label>
                </div>
            `;
        }).join('');

        listContainer.innerHTML = listHtml;
    };

    // START: New function to generate and download the report
    const downloadBusReportCSV = (selectedBusNames) => {
        if (selectedBusNames.length === 0) {
            showMessage("No buses were selected for the report.", true);
            return;
        }

        // 1. Filter all trips to get only the ones for the selected bus groups (name + code)
        const tripsForReport = allBuses.filter(bus => {
            const key = `${bus.busNumber}__${bus.busCode || ''}`;
            return selectedBusNames.includes(key);
        });
        
        // 2. Group the filtered trips by their bus name + code key
        const busesByGroupKey = tripsForReport.reduce((acc, bus) => {
            const key = `${bus.busNumber}__${bus.busCode || ''}`;
            if (!acc[key]) acc[key] = [];
            acc[key].push(bus);
            return acc;
        }, {});

        let csvContent = []; // We'll build the report line by line in this array

        // 3. Process each selected bus group one by one
        for (const groupKey of selectedBusNames) {
            const trips = busesByGroupKey[groupKey];
            if (!trips || trips.length === 0) continue;

            const [busName, busCode] = groupKey.split('__');

            // -- Gather Header Info for this bus --
            const firstTrip = trips[0];
            const codeLabel = busCode || (firstTrip.busCode || 'N/A');
            const route = `${firstTrip.origin} ‚Üí ${firstTrip.destination}`;
            const seats = firstTrip.seatCapacity || 'N/A';
            
            // Find all unique stop names across all trips for this bus to create the columns
            const allStopsSet = new Set();
            trips.forEach(trip => trip.stops.forEach(stop => allStopsSet.add(stop.name)));
            const uniqueStops = Array.from(allStopsSet);
            // Sort unique stops by their appearance order in the first trip's schedule.
            // Stops not found in the first trip will be appended at the end.
            uniqueStops.sort((a, b) => {
                const orderA = firstTrip.stops.findIndex(s => s.name === a);
                const orderB = firstTrip.stops.findIndex(s => s.name === b);

                // If both stops are in firstTrip, sort by their index
                if (orderA !== -1 && orderB !== -1) {
                    return orderA - orderB;
                }
                // If only stop A is in firstTrip, A comes first
                if (orderA !== -1) {
                    return -1;
                }
                // If only stop B is in firstTrip, B comes first
                if (orderB !== -1) {
                    return 1;
                }
                // If neither are in firstTrip, sort alphabetically
                return a.localeCompare(b);
            });


            // -- Build CSV rows for this bus (name + code) --
            csvContent.push(`"Bus Name-${busName}", , ,"Bus Code-${codeLabel}"`); // Add commas for spacing
            csvContent.push(`"Route","${route}", ,"Seats","${seats}","Stops (Count)","${uniqueStops.length}"`);
            
            // Header row for stop times
            const stopHeaders = uniqueStops.map(stop => `"${stop}"`).join(',');
            csvContent.push(`,${stopHeaders}`); // Leading comma to align under stops

            // Data rows for each trip
            trips.sort((a,b) => a.tripNumber - b.tripNumber).forEach(trip => {
                const tripRow = [`"${trip.busIdCode || 'N/A'}"`];
                const waitRow = ['']; // A second row just for wait times
                
                uniqueStops.forEach(stopName => {
                    const stopData = trip.stops.find(s => s.name === stopName);
                    if (stopData) {
                        const time12 = to12Hour(stopData.scheduledTime);
                        tripRow.push(`"${time12.hour}:${time12.minute} ${time12.ampm}"`);
                        if (stopData.waitingTime > 0) {
                            waitRow.push(`"${stopData.waitingTime}m wait"`);
                        } else {
                            waitRow.push('');
                        }
                    } else {
                        tripRow.push(''); // Empty cell if the trip doesn't have this stop
                        waitRow.push('');
                    }
                });
                csvContent.push(tripRow.join(','));
                // Add the wait time row only if it contains any wait times
                if (waitRow.some(val => val !== '')) {
                   csvContent.push(waitRow.join(','));
                }
            });

            csvContent.push(''); // Add a blank line for spacing between buses
        }

        // 4. Trigger the download
        const csvString = csvContent.join('\r\n');
        const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvString);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "bus_report.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    // END: New function to generate and download the report

    const handleClearAuditLogs = async () => {
        if (!isSuperAdmin) {
            showMessage("Permission denied. Only the Super Admin can clear audit logs.", true);
            return;
        }

        const confirmed = await showConfirmation("Are you sure you want to permanently delete ALL audit logs? This action cannot be undone.");
        if (!confirmed) {
            return;
        }

        showMessage("Clearing all audit logs, please wait...");

        try {
            const logsSnapshot = await getDocs(auditLogsCollection);
            if (logsSnapshot.empty) {
                showMessage("No logs to clear.");
                return;
            }

            const batch = writeBatch(db);
            logsSnapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit();

            // IMPORTANT: Log this action itself
            await logAdminAction('CLEAR_AUDIT_LOGS', `Cleared all audit logs.`);

            showMessage("All audit logs have been cleared successfully.");
            // The onSnapshot listener will automatically refresh the view

        } catch (error) {
            console.error("Error clearing audit logs:", error);
            showMessage("An error occurred while clearing the audit logs.", true);
        }
    };

    
const renderManageBusCodesPage = () => {
    // Target the new container directly
    const listContainer = document.getElementById('bus-codes-list-container'); 
    const addCodeContainer = document.getElementById('add-code-container');
    listContainer.innerHTML = ''; // Always clear the container first

    if (!isSuperAdmin) {
        if (addCodeContainer) addCodeContainer.classList.add('hidden');
        // Do not render the table container at all if not super admin
        listContainer.innerHTML = '<div class="bg-white rounded-lg shadow-sm border border-red-200 p-4 text-red-500">You do not have permission to manage bus codes.</div>';
        return;
    }
    if (addCodeContainer) addCodeContainer.classList.remove('hidden');

    const busesByCode = allBuses.reduce((acc, bus) => {
        const code = bus.busCode || 'UNCATEGORIZED';
        if (!acc[code]) { acc[code] = []; }
        acc[code].push(bus);
        return acc;
    }, {});

    const filteredCodes = allBusCodes.filter(codeObj => {
        if (!busCodeSearchQuery) return true;
        const associatedBusesForCode = busesByCode[codeObj.code];
        const busName = (associatedBusesForCode && associatedBusesForCode.length > 0 && associatedBusesForCode[0].busNumber) || '';
        return codeObj.code.toLowerCase().includes(busCodeSearchQuery) || busName.toLowerCase().includes(busCodeSearchQuery);
    });
    
    const sortedMasterCodes = filteredCodes.sort((a, b) => a.code.localeCompare(b.code));
    const totalCount = sortedMasterCodes.length;

    // This HTML string builds the entire "Existing Codes" card with its title, table, and content.
    let cardHtml = `
    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-x-auto">
        <h3 class="text-lg font-semibold text-slate-800 p-4 border-b border-slate-200">Existing Codes (${totalCount})</h3>
    `;

    if (totalCount === 0) {
        cardHtml += `<p class="text-slate-500 p-4">No codes have been added yet.</p>`;
    } else {
        cardHtml += `
            <table class="w-full text-sm text-left table-fixed">
                <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                    <tr>
                        <th scope="col" class="px-4 py-3">Bus Name</th>
                        <th scope="col" class="px-4 py-3">Code</th>
                        <th scope="col" class="px-4 py-3">Trip Count</th>
                        <th scope="col" class="px-4 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

        sortedMasterCodes.forEach(codeObj => {
            const associatedBuses = busesByCode[codeObj.code] || [];
            const tripCount = associatedBuses.length;
            const isUnused = tripCount === 0;
            const busName = isUnused ? `<span class="text-slate-400">Unused</span>` : (associatedBuses.length > 0 ? associatedBuses[0].busNumber : 'N/A');
            const isRowOpen = openBusCodeRow === codeObj.code;

            const actionButtonHtml = isUnused
                ? `<button class="delete-bus-code-btn text-red-500 hover:text-red-700 p-2" data-code-id="${codeObj.id}" data-code-name="${codeObj.code}" title="Delete Code '${codeObj.code}'"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`
                : `<button class="text-slate-400 cursor-not-allowed p-2" disabled title="Cannot delete: Code is in use."><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>`;
            
            const rowClass = isUnused ? '' : 'bus-code-row cursor-pointer hover:bg-slate-50';
            const rowDataAttr = isUnused ? '' : `data-bus-code="${codeObj.code}"`;

            cardHtml += `
                <tr class="border-b border-slate-200 ${rowClass}" ${rowDataAttr}>
                    <td class="px-4 py-3 font-medium text-slate-900">${busName}</td>
                    <td class="px-4 py-3 font-bold">${codeObj.code}</td>
                    <td class="px-4 py-3">${tripCount}</td>
                    <td class="px-4 py-3 text-right">${actionButtonHtml}</td>
                </tr>
            `;

            if (isRowOpen) {
                associatedBuses.sort((a, b) => {
                    const timeA = (a.stops && a.stops.length > 0) ? a.stops[0].scheduledTime : '23:59';
                    const timeB = (b.stops && b.stops.length > 0) ? b.stops[0].scheduledTime : '23:59';
                    return timeA.localeCompare(timeB);
                });

                const tripDetailsHtml = associatedBuses.map(trip => {
                    const departure = (trip.stops && trip.stops.length > 0)
                        ? to12Hour(trip.stops[0].scheduledTime)
                        : { hour: 'N', minute: '/A', ampm: '' };
                    return `<div class="text-xs p-2 border-t border-slate-200">${departure.hour}:${departure.minute} ${departure.ampm} - ${trip.origin} to ${trip.destination}</div>`;
                }).join('');

                cardHtml += `
                    <tr>
                        <td colspan="4" class="p-2 bg-slate-50">
                            <div class="text-slate-600">${tripDetailsHtml}</div>
                        </td>
                    </tr>
                `;
            }
        });

        cardHtml += `</tbody></table></div>`; // Close the table and the overflow-x-auto div
    }

    cardHtml += `</div>`; // Close the main card container
    listContainer.innerHTML = cardHtml;
};


    
    const setupEventListeners = () => {
¬† ¬† ¬† ¬† // Use event delegation on the document for all clicks
¬† ¬† ¬† ¬† document.addEventListener('click', async (e) => {
¬† ¬† ¬† ¬† ¬† ¬† const target = e.target;
¬† ¬† ¬† ¬† ¬† ¬† const button = target.closest('button');
¬† ¬† ¬† ¬† ¬† ¬† const navLink = target.closest('.nav-link');
¬† ¬† ¬† ¬† ¬† ¬† const header = target.closest('.bus-header');
¬† ¬† ¬† ¬† ¬† ¬† const filterOption = target.closest('.filter-option');
¬† ¬† ¬† ¬† ¬† ¬† const busCodeRow = target.closest('.bus-code-row');

¬† ¬† ¬† ¬† ¬† ¬† // NEW: Handle bus code row clicks for accordion
¬† ¬† ¬† ¬† ¬† ¬† if (busCodeRow && !button) { // Make sure we're not clicking a button inside the row
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† e.preventDefault();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const busCode = busCodeRow.dataset.busCode;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† openBusCodeRow = openBusCodeRow === busCode ? null : busCode;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† renderManageBusCodesPage();
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† // Sidebar controls
¬† ¬† ¬† ¬† ¬† ¬† if (target.closest('#menu-btn')) openSidebar();
¬† ¬† ¬† ¬† ¬† ¬† if (target.id === 'sidebar-overlay') closeSidebar();

¬† ¬† ¬† ¬† ¬† ¬† // Close filter dropdown when clicking outside search/filter area
¬† ¬† ¬† ¬† ¬† ¬† const filterArea = document.querySelector('#filter-btn')?.parentElement?.parentElement;
¬† ¬† ¬† ¬† ¬† ¬† if (filterDropdown && !filterDropdown.classList.contains('hidden')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!target.closest('#filter-btn') && !target.closest('#filter-dropdown')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† filterDropdown.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† if (navLink) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† e.preventDefault();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const pageId = navLink.dataset.page || (navLink.id ? navLink.id.replace('-link', '') : null);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (pageId === 'admin-logout') logout();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (pageId === 'admin-login') login(false);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (pageId === 'super-admin-login') login(true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (pageId === 'manage-stops') showManageStopsModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (pageId) showPage(pageId);
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† // Filter Dropdown options
¬† ¬† ¬† ¬† ¬† ¬† if (filterOption) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† e.preventDefault();

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Reference-stop options inside dropdown
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const refStop = filterOption.dataset.refStop;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (refStop) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† referenceStopName = refStop;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Update URL hash so the link can be shared (#kottathara, #thavalam, etc.)
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const slug = refStop.toLowerCase().replace(/\s+/g, '');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† window.location.hash = slug;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† updateAndRenderSchedule();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage(`Showing times for ${refStop}.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† filterDropdown.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const filterValue = filterOption.dataset.filter;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (filterValue === 'select-stop') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (isSuperAdmin && currentAdminPermissions.manageStops) showManageStopsModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else showStopFilterModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† currentFilter = filterValue;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† updateAndRenderSchedule();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† updateFilterDropdown();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // If a stop was chosen from the "Select your Stop" modal, close it as well
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† hideStopFilterModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† filterDropdown.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† // Main page controls
¬† ¬† ¬† ¬† ¬† ¬† if (button) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Mute button
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.matches('.mute-btn')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const adId = button.dataset.adId;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const player = videoPlayers[adId];
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (player && typeof player.isMuted === 'function') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const onIcon = document.getElementById(`mute-icon-on-${adId}`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const offIcon = document.getElementById(`mute-icon-off-${adId}`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (player.isMuted()) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† player.unMute();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† onIcon.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† offIcon.classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† player.mute();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† onIcon.classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† offIcon.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Home page buttons
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'add-bus-btn') handleAddBus();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'filter-btn') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† e.stopPropagation();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† filterDropdown.classList.toggle('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Bus item admin buttons
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const busId = button.dataset.busId;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (busId) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const stopIndex = parseInt(button.dataset.stopIndex, 10);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.matches('.edit-bus-btn')) handleEditBus(busId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (button.matches('.delete-bus-btn')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!isAdmin) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (await showConfirmation("This will permanently delete the entire bus route. This action cannot be undone.")) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await deleteDoc(doc(db, busCollection.path, busId));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Bus route deleted.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const bus = allBuses.find(b => b.id === busId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('DELETE_BUS', `Deleted bus route: ${bus.busNumber} (${bus.busIdCode})`, busId, 'bus');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (button.matches('.duplicate-bus-btn')) handleDuplicateBus(busId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (button.matches('.add-stop-btn')) handleAddStop(busId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (button.matches('.edit-stop-btn')) handleEditStop(busId, stopIndex);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (button.matches('.delete-stop-btn')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!isAdmin) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (await showConfirmation("This will remove the stop from the route. Are you sure?")) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const bus = allBuses.find(b => b.id === busId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const stopName = bus.stops[stopIndex].name;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const newStops = [...bus.stops];
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† newStops.splice(stopIndex, 1);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await updateDoc(doc(db, busCollection.path, busId), { stops: newStops });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Stop removed.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('DELETE_STOP', `Removed stop "${stopName}" from bus ${bus.busIdCode}`, busId, 'bus_stop');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (button.matches('.update-status-btn')) handleUpdateStatus(busId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Modal buttons
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'modal-save') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const editForm = document.getElementById('edit-form');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (editForm.checkValidity()) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const formData = new FormData(editForm);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let data = Object.fromEntries(formData.entries());
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(data.busNumber === 'custom') data.busNumber = data.custom_busNumber;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(data.busCode === 'custom') data.busCode = data.custom_busCode.toUpperCase();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(data.origin === 'custom') data.origin = data.custom_origin;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(data.destination === 'custom') data.destination = data.custom_destination;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(data.name === 'custom') data.name = data.custom_name;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ['custom_busNumber', 'custom_busCode', 'custom_origin', 'custom_destination', 'custom_name'].forEach(key => delete data[key]);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (modalResolve) modalResolve(data);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† hideModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† editForm.reportValidity();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'modal-cancel') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (modalReject) modalReject(new Error("Modal cancelled by user."));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† hideModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'confirm-cancel-btn') document.getElementById('confirmation-modal').classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'stop-filter-cancel') hideStopFilterModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'manage-stops-close-btn') hideManageStopsModal();

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Other page buttons
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'calculate-fare-btn') calculateAndDisplayFare();
                // üëá PASTE THE NEW BUTTON LOGIC HERE
        if (button.id === 'download-selected-btn') {
            const selectedCheckboxes = document.querySelectorAll('.bus-report-checkbox:checked');
            const selectedGroupKeys = Array.from(selectedCheckboxes).map(cb => cb.value);
            downloadBusReportCSV(selectedGroupKeys);
        }

        if (button.id === 'download-all-btn') {
            const allCheckboxes = document.querySelectorAll('.bus-report-checkbox');
            const allGroupKeys = Array.from(allCheckboxes).map(cb => cb.value);
            downloadBusReportCSV(allGroupKeys);
        }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'save-fares-btn') handleSaveFares();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'download-csv-btn') handleDownloadCSV();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'upload-csv-btn') document.getElementById('csv-upload-input').click();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'publish-announcement-btn') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!currentAdminPermissions.manageAnnouncements) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const text = document.getElementById('announcement-input').value.trim();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (text) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await setDoc(announcementDocRef, { text: text, active: true });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Announcement published.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('announcement-input').value = '';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('PUBLISH_ANNOUNCEMENT', `Published announcement: "${text}"`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'clear-announcement-btn') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!currentAdminPermissions.manageAnnouncements) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await setDoc(announcementDocRef, { text: '', active: false });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Announcement cleared.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('CLEAR_ANNOUNCEMENT', `Cleared active announcement.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.matches('.remove-ad-btn')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!currentAdminPermissions.manageAds) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const adId = button.dataset.adId;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const ad = allAds.find(a => a.id === adId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (await showConfirmation("Are you sure you want to remove this advertisement?")) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await deleteDoc(doc(db, adsCollection.path, adId));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Advertisement removed successfully.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('DELETE_AD', `Removed ad (Type: ${ad.adType}, Position: ${ad.position})`, adId, 'ad');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'add-filter-stop-btn') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!currentAdminPermissions.manageStops) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const addStopSelect = document.getElementById('add-stop-select');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const customInput = document.getElementById('custom-filter-stop-input');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let stopToAdd = addStopSelect.value === 'custom' ? customInput.value.trim() : addStopSelect.value;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (stopToAdd && !filterableStops.includes(stopToAdd)) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const newStops = [...new Set([...filterableStops, stopToAdd])].sort();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await setDoc(filterStopsDocRef, { stops: newStops });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage(`Added "${stopToAdd}" to filters.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('ADD_FILTER_STOP', `Added "${stopToAdd}" to filterable stops.`, null, 'filter_stop');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showManageStopsModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (!stopToAdd) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Please select or enter a stop name.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage(`"${stopToAdd}" is already in the filter list.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.matches('.remove-filter-stop-btn')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!currentAdminPermissions.manageStops) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const stopName = button.dataset.stopName;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const newStops = filterableStops.filter(s => s !== stopName);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await setDoc(filterStopsDocRef, { stops: newStops });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage(`Removed "${stopName}" from filters.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('REMOVE_FILTER_STOP', `Removed "${stopName}" from filterable stops.`, null, 'filter_stop');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showManageStopsModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Admin management buttons
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'add-admin-btn') handleAddAdmin();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.matches('.edit-admin-btn')) handleEditAdmin(button.dataset.adminId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.matches('.delete-admin-btn')) handleDeleteAdmin(button.dataset.adminId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // My Profile buttons
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'edit-my-profile-btn') handleEditMyProfile();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'change-my-password-btn') handleChangeMyPassword();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'clear-audit-logs-btn') handleClearAuditLogs();

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Bus Codes Page Buttons
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (button.id === 'add-new-bus-code-btn') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const input = document.getElementById('new-bus-code-input');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const newCode = input.value.trim().toUpperCase();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (newCode && allBusCodes.every(c => c.code !== newCode)) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† try {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const docRef = await addDoc(busCodesCollection, { code: newCode });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage(`Bus code "${newCode}" added.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('ADD_BUS_CODE', `Added new bus code: ${newCode}`, docRef.id, 'bus_code');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† input.value = '';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } catch (error) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Error adding bus code.", true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.error("Error adding bus code:", error);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (!newCode) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Bus code cannot be empty.", true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage(`Bus code "${newCode}" already exists.`, true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const deleteCodeBtn = button.closest('.delete-bus-code-btn');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (deleteCodeBtn) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!isSuperAdmin) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const codeId = deleteCodeBtn.dataset.codeId;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const codeName = deleteCodeBtn.dataset.codeName;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (await showConfirmation(`Are you sure you want to permanently delete the code "${codeName}"? This cannot be undone.`)) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† try {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await deleteDoc(doc(db, busCodesCollection.path, codeId));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage(`Bus code "${codeName}" was deleted.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('DELETE_BUS_CODE', `Deleted bus code: ${codeName}`, codeId, 'bus_code');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } catch (error) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.error("Error deleting bus code:", error);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Error: Could not delete the bus code.", true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† // Bus header click for accordion
¬† ¬† ¬† ¬† ¬† ¬† if (header && !button) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const busId = header.dataset.busId;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† openDropdownId = openDropdownId === busId ? null : busId;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† updateAndRenderSchedule();
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† else if (target.closest('.bus-code-header')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† e.preventDefault();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const busCode = target.closest('.bus-code-header').dataset.busCode;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† openBusCodeAccordion = openBusCodeAccordion === busCode ? null : busCode;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† renderManageBusCodesPage();
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† // Form Submissions
¬† ¬† ¬† ¬† document.addEventListener('submit', async (e) => {
¬† ¬† ¬† ¬† ¬† ¬† e.preventDefault();
¬† ¬† ¬† ¬† ¬† ¬† const form = e.target;
¬† ¬† ¬† ¬† ¬† ¬† if (form.id === 'ad-form') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!currentAdminPermissions.manageAds) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const adType = form.querySelector('#ad-type-select').value;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const position = form.querySelector('#ad-position-input').value;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let newAd = { position: Number(position), adType };

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (adType === 'image') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† newAd.imageUrl = form.querySelector('#ad-image-url-input').value.trim();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† newAd.link = form.querySelector('#ad-link-input').value.trim();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!newAd.imageUrl) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Image URL is required for an image ad.", true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else { // video
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† newAd.videoUrl = form.querySelector('#ad-video-url-input').value.trim();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!newAd.videoUrl) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Video URL is required for a video ad.", true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!newAd.position) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Position is a required field.", true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const docRef = await addDoc(adsCollection, newAd);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Advertisement published.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† form.reset();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('ad-type-select').dispatchEvent(new Event('change'));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('PUBLISH_AD', `Published new ad (Type: ${newAd.adType}, Position: ${newAd.position})`, docRef.id, 'ad');
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† if (form.id === 'about-form') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!currentAdminPermissions.manageAbout) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await setDoc(aboutDocRef, { html: quill.root.innerHTML });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("About page updated.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('UPDATE_ABOUT_PAGE', `Updated "About Us" page content.`);
¬† ¬† ¬† ¬† ¬† ¬† }
            if (form.id === 'contact-form') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!currentAdminPermissions.manageContact) { showMessage("Permission denied.", true); return; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const email = form.querySelector('#edit-contact-email').value.trim();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const phone = form.querySelector('#edit-contact-phone').value.trim();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const address = form.querySelector('#edit-contact-address').value.trim();
                const instagram = form.querySelector('#edit-contact-instagram')?.value.trim() || '';
                const youtube = form.querySelector('#edit-contact-youtube')?.value.trim() || '';
                const linkedin = form.querySelector('#edit-contact-linkedin')?.value.trim() || '';
                const facebook = form.querySelector('#edit-contact-facebook')?.value.trim() || '';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await setDoc(contactDocRef, { email, phone, address, instagram, youtube, linkedin, facebook });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† showMessage("Contact details updated.");
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† logAdminAction('UPDATE_CONTACT_INFO', `Updated contact information (Email: ${email}, Phone: ${phone}).`);
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† // Other specific input listeners
        searchBar.addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            updateAndRenderSchedule();
        });

        // Ensure any input with class "uppercase-input" stays 3 letters and uppercase
        document.querySelectorAll('.uppercase-input').forEach(input => {
            input.addEventListener('input', (e) => {
                let value = e.target.value || '';
                // Keep only letters, uppercase them, and limit to 3 characters
                value = value.replace(/[^a-zA-Z]/g, '').toUpperCase().slice(0, 3);
                e.target.value = value;
            });
        });

const reportsSearchBar = document.getElementById('reports-search-bar');
    if (reportsSearchBar) {
        reportsSearchBar.addEventListener('input', (e) => {
            reportsSearchQuery = e.target.value.toLowerCase();
            renderReportsPage(); 
        });
    }

    const downloadSelectedBtn = document.getElementById('download-selected-btn');
    if(downloadSelectedBtn) {
        downloadSelectedBtn.addEventListener('click', () => {
            const selectedCheckboxes = document.querySelectorAll('.bus-report-checkbox:checked');
            const selectedGroupKeys = Array.from(selectedCheckboxes).map(cb => cb.value);
            downloadBusReportCSV(selectedGroupKeys);
        });
    }

    const downloadAllBtn = document.getElementById('download-all-btn');
    if(downloadAllBtn) {
        downloadAllBtn.addEventListener('click', () => {
            const allCheckboxes = document.querySelectorAll('.bus-report-checkbox');
            const allGroupKeys = Array.from(allCheckboxes).map(cb => cb.value);
            downloadBusReportCSV(allGroupKeys);
        });
    }
    // üëÜ END OF NEW EVENT LISTENERS

¬† ¬† ¬† ¬† const busCodeSearchBar = document.getElementById('bus-code-search-bar');
¬† ¬† ¬† ¬† if (busCodeSearchBar) {
¬† ¬† ¬† ¬† ¬† ¬† busCodeSearchBar.addEventListener('input', (e) => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† busCodeSearchQuery = e.target.value.toLowerCase();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† renderManageBusCodesPage();
¬† ¬† ¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† document.getElementById('manage-fares-bus-select').addEventListener('change', (e) => {
¬† ¬† ¬† ¬† ¬† ¬† renderFareMatrix(e.target.value);
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† document.getElementById('ad-type-select').addEventListener('change', (e) => {
¬† ¬† ¬† ¬† ¬† ¬† const adType = e.target.value;
¬† ¬† ¬† ¬† ¬† ¬† const imageInputs = document.getElementById('ad-image-inputs');
¬† ¬† ¬† ¬† ¬† ¬† const videoInputs = document.getElementById('ad-video-inputs');
¬† ¬† ¬† ¬† ¬† ¬† const imageUrlInput = document.getElementById('ad-image-url-input');
¬† ¬† ¬† ¬† ¬† ¬† const videoUrlInput = document.getElementById('ad-video-url-input');

¬† ¬† ¬† ¬† ¬† ¬† if (adType === 'image') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† imageInputs.classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† videoInputs.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† imageUrlInput.required = true;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† videoUrlInput.required = false;
¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† imageInputs.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† videoInputs.classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† imageUrlInput.required = false;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† videoUrlInput.required = true;
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† });
¬† ¬† };

    const initializeAppAndData = async () => {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        try {
            analytics = getAnalytics(app);
        } catch (e) {
            console.log("Analytics not available in this environment.");
        }

        // Define collections and document references
        const publicDataPath = `artifacts/${appId}/public/data`;
        busCollection = collection(db, `${publicDataPath}/buses`);
        configDocRef = doc(db, `${publicDataPath}/config/predefined`);
        busCodesCollection = collection(db, `${publicDataPath}/busCodes`); // New
        filterStopsDocRef = doc(db, `${publicDataPath}/config/filterStops`);
        contactDocRef = doc(db, `${publicDataPath}/config/contact`);
        aboutDocRef = doc(db, `${publicDataPath}/config/about`);
        announcementDocRef = doc(db, `${publicDataPath}/config/announcement`);
        adsCollection = collection(db, `${publicDataPath}/advertisements`);
        adminsCollection = collection(db, `${publicDataPath}/admins`);
        auditLogsCollection = collection(db, `${publicDataPath}/auditLogs`); // New: Audit Logs collection

        onAuthStateChanged(auth, (user) => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            if (user) {
                currentUserId = user.uid;
                console.log("Authenticated User ID:", currentUserId);

                // Listen to admins collection to update currentAdmin and permissions
                const unsubAdmins = onSnapshot(adminsCollection, (snapshot) => {
                    allAdmins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // If an admin was logged in, try to find their updated data
                    if (currentAdmin) {
                        const updatedAdmin = allAdmins.find(a => a.username === currentAdmin.username);
                        if (updatedAdmin) {
                            currentAdmin = updatedAdmin;
                            currentAdminPermissions = updatedAdmin.permissions || {};
                        } else {
                            // Current admin was deleted from Firestore
                            logout();
                        }
                    }
                    checkAdminStatus(); // Re-evaluate admin status and render controls
                    renderAdminsList(); // Re-render admin list if on that page
                });
                unsubscribeListeners.push(unsubAdmins);

                const unsubConfig = onSnapshot(configDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const configData = docSnap.data();
                        predefinedBusNames = configData.busNames || [];
                        predefinedStops = configData.stops || [];
                    }
                });
                unsubscribeListeners.push(unsubConfig);

                // New: Listen to bus codes
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // New: Listen to bus codes
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const unsubBusCodes = onSnapshot(busCodesCollection, (snapshot) => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.log('Bus Codes snapshot received:', snapshot.docs.map(d => d.data())); // <-- ADD THIS LINE
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† allBusCodes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.code.localeCompare(b.code));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // This new part checks if we are on the right page and tells it to refresh
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const manageBusCodesPage = document.getElementById('manage-bus-codes-page');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (manageBusCodesPage && !manageBusCodesPage.classList.contains('hidden')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† renderManageBusCodesPage();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† unsubscribeListeners.push(unsubBusCodes);


                const unsubBuses = onSnapshot(busCollection, (snapshot) => {
                    allBuses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!isAuthReady) {
                        isAuthReady = true;
                        addSampleDataIfNeeded(); // This will also initialize Super Admin if needed
                    }
                    updateAndRenderSchedule();
                    const activePageId = document.querySelector('#page-container > div:not(.hidden)')?.id.replace('-page', '');
                    if (activePageId === 'manage-fares') populateManageFaresBusSelect();
                    if (activePageId === 'fare-calculator') populateFareCalculatorStops();
                }, (error) => {
                    console.error("Error fetching bus data:", error);
                    setStatus("Error loading schedule. Please check connection.", true);
                });
                unsubscribeListeners.push(unsubBuses);

                const unsubAds = onSnapshot(adsCollection, (snapshot) => {
                    allAds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAdsList();
                    updateAndRenderSchedule();
                });
                unsubscribeListeners.push(unsubAds);

                const unsubAnnouncements = onSnapshot(announcementDocRef, (docSnap) => {
                    const textEl = document.getElementById('announcement-text');
                    const bannerEl = document.getElementById('announcement-banner');
                    if (docSnap.exists() && docSnap.data().active && docSnap.data().text) {
                        const text = docSnap.data().text;
                        textEl.textContent = text;
                        bannerEl.classList.remove('hidden');

                        setTimeout(() => {
                            if (textEl.scrollWidth > bannerEl.clientWidth) {
                                textEl.classList.add('scrolling');
                                const duration = textEl.scrollWidth / 40;
                                textEl.style.animationDuration = `${duration}s`;
                            } else {
                                textEl.classList.remove('scrolling');
                                textEl.style.animationDuration = '';
                            }
                        }, 100);

                        if (isAdmin && currentAdminPermissions.manageAnnouncements) {
                            document.getElementById('current-announcement-container').textContent = text;
                        }
                    } else {
                        bannerEl.classList.add('hidden');
                        textEl.classList.remove('scrolling');
                        if (isAdmin && currentAdminPermissions.manageAnnouncements) {
                            document.getElementById('current-announcement-container').textContent = 'No active announcement.';
                        }
                    }
                });
                unsubscribeListeners.push(unsubAnnouncements);

                const unsubFilters = onSnapshot(filterStopsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        filterableStops = docSnap.data().stops || [];
                    } else {
                        filterableStops = [];
                    }
                    updateFilterDropdown();
                });
                unsubscribeListeners.push(unsubFilters);

                const unsubContact = onSnapshot(contactDocRef, (docSnap) => {
                    const contactInfoContainer = document.getElementById('contact-info-container');
                    const editContactEmail = document.getElementById('edit-contact-email');
                    const editContactPhone = document.getElementById('edit-contact-phone');
                    const editContactAddress = document.getElementById('edit-contact-address');
                    const editContactInstagram = document.getElementById('edit-contact-instagram');
                    const editContactYoutube = document.getElementById('edit-contact-youtube');
                    const editContactLinkedin = document.getElementById('edit-contact-linkedin');
                    const editContactFacebook = document.getElementById('edit-contact-facebook');

                    if (docSnap.exists()) {
                        const contact = docSnap.data();

                        const instagramUrl = contact.instagram || '';
                        const youtubeUrl = contact.youtube || '';
                        const linkedinUrl = contact.linkedin || '';
                        const facebookUrl = contact.facebook || '';

                        let socialsHtml = '';
                        if (instagramUrl || youtubeUrl || linkedinUrl || facebookUrl) {
                            socialsHtml += '<div class="mt-4 border-t pt-3">';
                            socialsHtml += '<p class="font-semibold text-slate-800 text-sm">Follow us on social media</p>';
                            socialsHtml += '<div class="flex flex-wrap gap-3 mt-2">';

                            const baseBtnClass = 'w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-sky-50 hover:text-sky-600 border border-slate-200';

                            if (instagramUrl) {
                                socialsHtml += `
                                    <a href="${instagramUrl}" target="_blank" rel="noopener noreferrer" class="${baseBtnClass}" aria-label="Instagram">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M7 2C4.243 2 2 4.243 2 7v10c0 2.757 2.243 5 5 5h10c2.757 0 5-2.243 5-5V7c0-2.757-2.243-5-5-5H7zm0 2h10c1.654 0 3 1.346 3 3v10c0 1.654-1.346 3-3 3H7c-1.654 0-3-1.346-3-3V7c0-1.654 1.346-3 3-3zm11 1a1 1 0 100 2 1 1 0 000-2zM12 7a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z" />
                                        </svg>
                                    </a>`;
                            }
                            if (youtubeUrl) {
                                socialsHtml += `
                                    <a href="${youtubeUrl}" target="_blank" rel="noopener noreferrer" class="${baseBtnClass}" aria-label="YouTube">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M21.8 8.001a2.75 2.75 0 00-1.94-1.948C18.23 5.5 12 5.5 12 5.5s-6.23 0-7.86.553A2.75 2.75 0 002.2 8.001 28.37 28.37 0 002 12a28.37 28.37 0 00.2 3.999 2.75 2.75 0 001.94 1.948C5.77 18.5 12 18.5 12 18.5s6.23 0 7.86-.553a2.75 2.75 0 001.94-1.948A28.37 28.37 0 0022 12a28.37 28.37 0 00-.2-3.999zM10 15.25v-6.5L15.5 12 10 15.25z" />
                                        </svg>
                                    </a>`;
                            }
                            if (linkedinUrl) {
                                socialsHtml += `
                                    <a href="${linkedinUrl}" target="_blank" rel="noopener noreferrer" class="${baseBtnClass}" aria-label="LinkedIn">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M4.98 3.5C4.98 4.88 3.88 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1 4.98 2.12 4.98 3.5zM.2 8.5h4.6V23H.2V8.5zM8.34 8.5H12.8v1.97h.06c.62-1.17 2.14-2.4 4.4-2.4 4.7 0 5.57 3.1 5.57 7.13V23h-4.6v-6.3c0-1.5-.03-3.42-2.08-3.42-2.08 0-2.4 1.62-2.4 3.3V23H8.34V8.5z" />
                                        </svg>
                                    </a>`;
                            }
                            if (facebookUrl) {
                                socialsHtml += `
                                    <a href="${facebookUrl}" target="_blank" rel="noopener noreferrer" class="${baseBtnClass}" aria-label="Facebook">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M13 3h3a1 1 0 011 1v3h-2.5A1.5 1.5 0 0013 8.5V11h3.5a1 1 0 01.98 1.196l-.5 2.5A1 1 0 0116 15H13v6h-3v-6H7a1 1 0 01-1-1v-2.5A1 1 0 017 11h3V8.5A5.5 5.5 0 0115.5 3H16h-3z" />
                                        </svg>
                                    </a>`;
                            }
                            socialsHtml += '</div></div>';
                        }

                        contactInfoContainer.innerHTML = `
                            <p>For inquiries, feedback, or support, please reach out to us:</p>
                            <p><strong>Makkal Raja Transport Corporation</strong></p>
                            <p>Email: <a href="mailto:${contact.email}" class="text-sky-600 hover:underline">${contact.email}</a></p>
                            <p>Phone: <a href="tel:${contact.phone}" class="text-sky-600 hover:underline">${contact.phone}</a></p>
                            <p>Address: ${contact.address}</p>
                            ${socialsHtml}
                        `;

                        // Always prefill manage-contact inputs when they exist in the DOM
                        if (editContactEmail) editContactEmail.value = contact.email || '';
                        if (editContactPhone) editContactPhone.value = contact.phone || '';
                        if (editContactAddress) editContactAddress.value = contact.address || '';
                        if (editContactInstagram) editContactInstagram.value = instagramUrl;
                        if (editContactYoutube) editContactYoutube.value = youtubeUrl;
                        if (editContactLinkedin) editContactLinkedin.value = linkedinUrl;
                        if (editContactFacebook) editContactFacebook.value = facebookUrl;
                    }
                });
                unsubscribeListeners.push(unsubContact);

                const unsubAbout = onSnapshot(aboutDocRef, (docSnap) => {
                    const aboutContentContainer = document.getElementById('about-content-container');
                    if (docSnap.exists()) {
                        const about = docSnap.data();
                        aboutContentContainer.innerHTML = about.html;
                        if (quill && isAdmin && currentAdminPermissions.manageAbout) {
                            quill.root.innerHTML = about.html;
                        }
                    }
                });
                unsubscribeListeners.push(unsubAbout);

                // New: Listener for Audit Logs
                const unsubAuditLogs = onSnapshot(query(auditLogsCollection, orderBy('timestamp', 'desc')), (snapshot) => {
                    allAuditLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAuditLogs(); // Re-render audit logs whenever they change
                });
                unsubscribeListeners.push(unsubAuditLogs);

            } else {
                console.log("User is signed out.");
                currentAdmin = null;
                currentAdminPermissions = {};
                isAdmin = false;
                isSuperAdmin = false;
                isAuthReady = false; // Reset auth ready flag on sign out
                setStatus("Authenticating...", false);
                renderAuthControls(); // Ensure controls are updated for signed out state
                updateAndRenderSchedule(); // Re-render schedule for public view
                renderAuditLogs(); // Clear audit logs on logout
            }
        });

        try {
            console.log("Attempting to sign in...");
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Firebase connection successful with custom token!");
            } else {
                await signInAnonymously(auth);
                console.log("Firebase connection successful anonymously!");
            }
        } catch (error) {
            console.error("Authentication failed:", error);
            setStatus("Could not connect to the server. Check console for details.", true);
        }
    };

    // --- Start the App ---
    try {
        // This function is called by the YouTube API script once it's loaded
        window.onYouTubeIframeAPIReady = () => {
            initializeVideoAds();
        };

        setupEventListeners();
        initializeAppAndData();

        // Handle initial page load based on URL hash
        const initialPage = window.location.hash.substring(1) || 'home';
        showPage(initialPage, true); // Show page without pushing state
        history.replaceState({ pageId: initialPage }, '', `#${initialPage}`);

        window.addEventListener('popstate', (event) => {
            const pageId = (event.state && event.state.pageId) || 'home';
            showPage(pageId, true);
        });

        // Set an interval to only update live elements, not the whole schedule
        setInterval(updateLiveElements, 1000); // Changed from 10000 to 1000 for faster updates
    } catch(e) {
        console.error("A critical error occurred on startup:", e);
        setStatus("An unexpected error occurred. Please refresh the page.", true);
    }
});
¬† ¬† </script>
</body>
</html>

